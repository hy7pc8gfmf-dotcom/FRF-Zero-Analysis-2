# global-verification.yml
name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh', '.github/workflows/global-verification.yml' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨éªŒè¯
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.19  # å®˜æ–¹æ ‡å‡†æ ‡ç­¾ï¼Œç¡®ä¿é•œåƒå¯æ‹‰å–
      options: --user root --network=host  # è§£å†³æƒé™ä¸ç½‘ç»œä¾èµ–é—®é¢˜
    timeout-minutes: 120  # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé€‚é…å¤§è§„æ¨¡ç¼–è¯‘
    env:
      MATHLIB_VERSION: "4.0.0"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      COQC_FLAGS: "-q -w -deprecated-native-compiler-option,-native-compiler-disabled"  # å±è”½æ— å…³è­¦å‘Š
    steps:
      - name: åˆå§‹åŒ–åŸºç¡€ç¯å¢ƒ
        run: |
          # ä¿®å¤ç›®å½•æƒé™ï¼ˆè¦†ç›–æ‰€æœ‰å¯èƒ½çš„å†™å…¥è·¯å¾„ï¼‰
          mkdir -p ${{ env.TEMP_DIR }} ${{ env.REPORT_DIR }}
          chmod -R 777 /__w/_temp/ ${{ github.workspace }}
          echo "âœ… åŸºç¡€ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼ˆæƒé™+ç›®å½•ï¼‰"
          echo "ğŸ“Œ å·¥ä½œç›®å½•ï¼š${{ github.workspace }}"
          echo "ğŸ“Œ ä»£ç ç›®å½•ï¼š${{ github.workspace }}/theories"

      - name: æ£€å‡ºä»£ç ä»“åº“ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
          lfs: true  # æ”¯æŒå¤§æ–‡ä»¶ï¼ˆè‹¥æœ‰å½¢å¼åŒ–éªŒè¯ç›¸å…³èµ„æºï¼‰

      - name: å‰ç½®æ ¡éªŒï¼ˆé¿å…æ— æ•ˆæµç¨‹ï¼‰
        run: |
          cd ${{ github.workspace }}
          # æ ¡éªŒæ ¸å¿ƒç›®å½•å­˜åœ¨æ€§
          if [ ! -d "theories" ]; then
            echo "âŒ æ ¸å¿ƒä»£ç ç›®å½• theories ä¸å­˜åœ¨ï¼ŒGitæ‹‰å–å¤±è´¥" && exit 1
          fi
          if [ ! -f "CoqProject" ]; then
            echo "âŒ å…³é”®é…ç½®æ–‡ä»¶ CoqProject ç¼ºå¤±ï¼Œæ— æ³•ç¼–è¯‘" && exit 1
          fi
          # æ ¡éªŒCaseF_Logic.vå­˜åœ¨ï¼ˆä¼˜åŒ–åæ ¸å¿ƒæ¨¡å—ï¼‰
          if [ ! -f "theories/CaseF_Logic.v" ]; then
            echo "âš ï¸ ä¼˜åŒ–ç›®æ ‡æ¨¡å— theories/CaseF_Logic.v æœªæ‰¾åˆ°ï¼Œå°†è·³è¿‡è¯¥æ¨¡å—éªŒè¯"
          fi
          echo "âœ… å‰ç½®æ ¡éªŒé€šè¿‡ï¼ˆç›®å½•+å…³é”®æ–‡ä»¶å­˜åœ¨ï¼‰"

      - name: ç¼“å­˜ä¼˜åŒ–ï¼ˆä¾èµ–+ç¼–è¯‘äº§ç‰©ï¼‰
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            _build
            **/*.vo
            **/*.glob
            **/*.v.d
          key: ${{ runner.os }}-coq-${{ env.MATHLIB_VERSION }}-global-${{ github.sha }}-${{ hashFiles('CoqProject', 'Makefile') }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.MATHLIB_VERSION }}-global-
            ${{ runner.os }}-coq-${{ env.MATHLIB_VERSION }}-

      - name: ä¾èµ–å®‰è£…ï¼ˆä¸¥æ ¼ç‰ˆæœ¬æ§åˆ¶ï¼‰
        run: |
          cd ${{ github.workspace }}
          set -euo pipefail  # ä¸¥æ ¼é”™è¯¯å¤„ç†ï¼Œé¿å…é™é»˜å¤±è´¥

          # åˆå§‹åŒ–Opamç¯å¢ƒ
          opam init --disable-sandboxing -y --no-setup
          eval $(opam env --set-switch)
          opam update -y

          # å®‰è£…åŸºç¡€ä¾èµ–
          opam install -y coq-equations coq-extraction coq-bignums

          # å®‰è£…æŒ‡å®šç‰ˆæœ¬Mathlibï¼ˆä¸¥æ ¼åŒ¹é…ï¼‰
          if ! opam list --short --all | grep -q "coq-mathlib ${MATHLIB_VERSION}"; then
            echo "âŒ Mathlib ${MATHLIB_VERSION} ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œæ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§" && exit 1
          fi
          if ! opam list | grep -q "coq-mathlib.*${MATHLIB_VERSION}"; then
            echo "ğŸ“¥ å®‰è£…Mathlib ${MATHLIB_VERSION}ï¼ˆé¦–æ¬¡å®‰è£…ï¼Œçº¦5-10åˆ†é’Ÿï¼‰"
            opam install -y coq-mathlib=${MATHLIB_VERSION}
          else
            echo "ğŸ“Œ Mathlib ${MATHLIB_VERSION} å·²ç¼“å­˜ï¼Œç›´æ¥å¤ç”¨"
          fi

          # ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒï¼ˆå…³é”®æ­¥éª¤ï¼‰
          echo "=== ä¾èµ–ç‰ˆæœ¬æ ¡éªŒ ==="
          COQ_VERSION=$(coqc --version | head -n1 | awk '{print $3}')
          if [[ ! $COQ_VERSION =~ ^8.19 ]]; then
            echo "âŒ Coqç‰ˆæœ¬ä¸å…¼å®¹ï¼ˆå½“å‰ï¼š$COQ_VERSIONï¼Œéœ€8.19ç³»åˆ—ï¼‰" && exit 1
          fi
          MATHLIB_INSTALLED=$(opam list --short coq-mathlib | awk '{print $2}')
          if [ "$MATHLIB_INSTALLED" != "${MATHLIB_VERSION}" ]; then
            echo "âŒ Mathlibç‰ˆæœ¬ä¸åŒ¹é…ï¼ˆå®‰è£…ï¼š$MATHLIB_INSTALLEDï¼Œéœ€ï¼š$MATHLIB_VERSIONï¼‰" && exit 1
          fi
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼ˆç‰ˆæœ¬ä¸€è‡´ï¼‰"

      - name: ç”Ÿæˆç¼–è¯‘é…ç½®ï¼ˆMakefileï¼‰
        run: |
          cd ${{ github.workspace }}
          set -euo pipefail

          # ç”ŸæˆMakefileï¼ˆå…¼å®¹æ¨¡æ¿ï¼‰
          if [ -f "Makefile.template" ]; then
            coq_makefile -f CoqProject -o Makefile -extra Makefile.template
            echo "ğŸ“Œ ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ç”ŸæˆMakefile"
          else
            coq_makefile -f CoqProject -o Makefile
            echo "ğŸ“Œ ä½¿ç”¨é»˜è®¤æ¨¡æ¿ç”ŸæˆMakefile"
          fi

          # æ ¡éªŒå…¨å±€ç›®æ ‡å­˜åœ¨
          if ! grep -q "^${GLOBAL_TARGET}:" Makefile; then
            echo "âŒ Makefileä¸­æœªå®šä¹‰å…¨å±€ç¼–è¯‘ç›®æ ‡ '${GLOBAL_TARGET}'ï¼Œæ·»åŠ é»˜è®¤ç›®æ ‡"
            echo -e "\n${GLOBAL_TARGET}: all.vos" >> Makefile
          fi
          echo "âœ… Makefileç”Ÿæˆå®Œæˆ"

      - name: å…¨å±€å½¢å¼åŒ–ç¼–è¯‘ï¼ˆå¹¶è¡Œä¼˜åŒ–ï¼‰
        run: |
          cd ${{ github.workspace }}
          set -euo pipefail
          eval $(opam env --set-switch)

          # ç¼–è¯‘å‚æ•°ä¼˜åŒ–ï¼ˆå¹¶è¡Œ+æ—¥å¿—è¾“å‡ºï¼‰
          PARALLEL_JOBS=$(nproc --ignore=2)  # é¢„ç•™2æ ¸é¿å…èµ„æºè€—å°½
          echo "=== å¼€å§‹å…¨å±€ç¼–è¯‘ï¼ˆ${PARALLEL_JOBS}æ ¸å¹¶è¡Œï¼‰ ==="
          echo "ğŸ“Œ ç¼–è¯‘å‘½ä»¤ï¼šmake -j${PARALLEL_JOBS} ${GLOBAL_TARGET} COQCFLAGS='${COQC_FLAGS}'"
          make -j${PARALLEL_JOBS} ${GLOBAL_TARGET} COQCFLAGS="${COQC_FLAGS}" 2>&1 | tee ${{ env.REPORT_DIR }}/global-compile.log

          # ç¼–è¯‘å®Œæ•´æ€§æ ¡éªŒï¼ˆæ ¸å¿ƒæ¨¡å—å¿…æŸ¥ï¼‰
          echo -e "\n=== ç¼–è¯‘å®Œæ•´æ€§æ ¡éªŒ ==="
          required_modules=(
            "theories/FRF_MetaTheory.vo"
            "theories/FRF2_CrossSystem.vo"
            "theories/CaseF_Logic.vo"  # ä¼˜åŒ–åæ ¸å¿ƒæ¨¡å—
            "theories/FRF_CS_Null_Common.vo"
            "lib/Algebra.vo"
            "extensions/Quantum/QFT_FRF.vo"
          )
          missing_modules=()
          for mod in "${required_modules[@]}"; do
            if [ ! -f "$mod" ]; then
              missing_modules+=("$mod")
            fi
          done

          # CoqProjectä¸­æ‰€æœ‰.væ–‡ä»¶æ ¡éªŒ
          while IFS= read -r v_file; do
            vo_file="${v_file%.v}.vo"
            if [ ! -f "$vo_file" ] && [[ ! " ${missing_modules[@]} " =~ " $vo_file " ]]; then
              missing_modules+=("$vo_file")
            fi
          done < <(grep -E '^[^#].*\.v$' CoqProject | sed 's/^[[:space:]]*//')

          # è¾“å‡ºç¼ºå¤±æ¨¡å—å¹¶å¤±è´¥
          if [ ${#missing_modules[@]} -ne 0 ]; then
            echo -e "\nâŒ ä»¥ä¸‹æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼ˆæœªç”Ÿæˆ.voæ–‡ä»¶ï¼‰ï¼š"
            printf '  - %s\n' "${missing_modules[@]}"
            exit 1
          fi
          echo "âœ… å…¨å±€ç¼–è¯‘å®Œæˆï¼ˆæ‰€æœ‰æ¨¡å—å‡ç”Ÿæˆ.voæ–‡ä»¶ï¼‰"

      - name: å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒï¼ˆcoqchkï¼‰
        run: |
          cd ${{ github.workspace }}
          eval $(opam env --set-switch)

          echo "=== å¼€å§‹å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥ ==="
          # é€’å½’æ£€æŸ¥ä¾èµ–å…³ç³»ï¼Œå±è”½æ— å…³è­¦å‘Š
          coqchk -silent -recursive -norecursive-include $(find theories/ lib/ extensions/ -name "*.vo") 2>&1 | tee ${{ env.REPORT_DIR }}/global-coqchk.log

          # æ ¡éªŒcoqchké€€å‡ºç ï¼ˆ0=æˆåŠŸï¼Œé0=é€»è¾‘çŸ›ç›¾ï¼‰
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo -e "\nâŒ å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼Œå­˜åœ¨é€»è¾‘çŸ›ç›¾æˆ–ä¾èµ–ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡ï¼ˆæ— é€»è¾‘çŸ›ç›¾ï¼‰"

      - name: ç”Ÿæˆè¯¦ç»†éªŒè¯æŠ¥å‘Š
        run: |
          cd ${{ github.workspace }}
          set -euo pipefail

          # åŸºç¡€ä¿¡æ¯
          COQ_VERSION=$(coqc --version | head -n1 | awk '{print $3}')
          MATHLIB_INSTALLED=$(opam list --short coq-mathlib | awk '{print $2}')
          TOTAL_FILES=$(grep -E '^[^#].*\.v$' CoqProject | wc -l)
          SUCCESS_FILES=$(find theories/ lib/ extensions/ -name "*.vo" | wc -l)

          # ç”ŸæˆMarkdownæŠ¥å‘Š
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md <<EOF
# FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š
## éªŒè¯æ¦‚è§ˆ
| é¡¹ç›®                | å†…å®¹                                                                 |
|---------------------|----------------------------------------------------------------------|
| éªŒè¯æ—¶é—´            | $(date +'%Y-%m-%d %H:%M:%S')                                          |
| è§¦å‘äº‹ä»¶            | ${{ github.event_name }}                                               |
| æäº¤å“ˆå¸Œ            | ${{ github.sha }}                                                     |
| Coqç‰ˆæœ¬             | $COQ_VERSION                                                          |
| Mathlibç‰ˆæœ¬         | $MATHLIB_INSTALLED                                                    |
| æ€»æ–‡ä»¶æ•°            | $TOTAL_FILES                                                          |
| æˆåŠŸéªŒè¯æ–‡ä»¶æ•°      | $SUCCESS_FILES                                                        |
| éªŒè¯çŠ¶æ€            | âœ… å…¨éƒ¨é€šè¿‡ï¼ˆç¼–è¯‘+é€»è¾‘ä¸€è‡´æ€§ï¼‰                                          |

## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
EOF

          # æ ¸å¿ƒæ¨¡å—çŠ¶æ€è¯¦æƒ…
          core_modules=(
            "theories/FRF_MetaTheory.vo:FRFå…ƒç†è®ºæ ¸å¿ƒ"
            "theories/CaseF_Logic.vo:é€»è¾‘ç³»ç»Ÿé›¶æ¦‚å¿µéªŒè¯ï¼ˆä¼˜åŒ–æ¨¡å—ï¼‰"
            "theories/FRF2_CrossSystem.vo:è·¨ç³»ç»Ÿé›¶æ€å°„æ ¸å¿ƒ"
            "extensions/Quantum/QFT_FRF.vo:é‡å­åœºè®ºç»Ÿä¸€æ¥å£"
            "lib/Algebra.vo:ä»£æ•°åŸºç¡€æ¨¡å—"
          )
          for mod_desc in "${core_modules[@]}"; do
            mod="${mod_desc%%:*}"
            desc="${mod_desc#*:}"
            if [ -f "$mod" ]; then
              echo "- âœ… $desc: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "- âŒ $desc: $modï¼ˆç¼ºå¤±ï¼‰" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done

          # æ—¥å¿—é“¾æ¥
          echo -e "\n## è¯¦ç»†æ—¥å¿—" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [ç¼–è¯‘æ—¥å¿—](global-compile.log)ï¼ˆå«æ‰€æœ‰ç¼–è¯‘è¾“å‡ºï¼‰" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒæ—¥å¿—](global-coqchk.log)ï¼ˆcoqchkè¾“å‡ºï¼‰" >> ${{ env.REPORT_DIR }}/SUMMARY.md

          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼š${{ env.REPORT_DIR }}/SUMMARY.md"

      - name: å½’æ¡£éªŒè¯äº§ç‰©ï¼ˆé•¿æœŸè¿½æº¯ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            theories/**/*.vo
            theories/**/*.glob
            lib/**/*.vo
            extensions/**/*.vo
            Makefile
            CoqProject
            global-compile.log
            global-coqchk.log
          retention-days: 90  # å»¶é•¿ä¿ç•™æ—¶é—´ï¼Œæ–¹ä¾¿åç»­è¿½æº¯

      - name: éªŒè¯å¤±è´¥ç´§æ€¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯å¤±è´¥"
          echo "=== å¤±è´¥å…³é”®ä¿¡æ¯ ==="
          echo "è§¦å‘äº‹ä»¶ï¼š${{ github.event_name }}"
          echo "æäº¤å“ˆå¸Œï¼š${{ github.sha }}"
          echo "å¤±è´¥æ­¥éª¤ï¼š${{ github.job }} > ${{ github.step_name }}"
          echo "=== æœ€è¿‘10è¡Œç¼–è¯‘é”™è¯¯ ==="
          tail -n 10 ${{ env.REPORT_DIR }}/global-compile.log 2>/dev/null || echo "ç¼–è¯‘æ—¥å¿—æœªç”Ÿæˆ"
          echo "=== è§£å†³æ–¹æ¡ˆå‚è€ƒ ==="
          echo "1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯ï¼šæŸ¥çœ‹ global-compile.log æœ«å°¾é”™è¯¯ä¿¡æ¯"
          echo "2. ä¾èµ–ç‰ˆæœ¬é—®é¢˜ï¼šç¡®è®¤Coq 8.19 + Mathlib 4.0.0 å…¼å®¹æ€§"
          echo "3. èµ„æºä¸è¶³ï¼šå°è¯•å‡å°‘å¹¶è¡Œç¼–è¯‘æ ¸å¿ƒæ•°ï¼ˆä¿®æ”¹ PARALLEL_JOBSï¼‰"
          echo "4. ä»£ç ç¼ºå¤±ï¼šç¡®è®¤ theories ç›®å½•ä¸‹æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨"
          exit 1