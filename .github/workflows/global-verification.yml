name: FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯ï¼ˆæ”¯æŒä¿®å¤æ¨¡å—ï¼‰
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 60  # é€‚é…å…¨é‡ä¿®å¤æ¨¡å—ç¼–è¯‘éœ€æ±‚
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å®‰è£…å…¼å®¹çš„CoqåŠä¾èµ–ï¼ˆåŒ¹é…ä¿®å¤æ¨¡å—ç‰ˆæœ¬ï¼‰
      run: |
        eval $(opam env)
        echo "å®‰è£…Coq 8.18.0..."
        opam install -y coq.8.18.0
        echo "å®‰è£…å…¼å®¹çš„mathcomp-ssreflect 1.17.0..."
        opam install -y coq-mathcomp-ssreflect.1.17.0
        echo "éªŒè¯ç¯å¢ƒç‰ˆæœ¬..."
        coqc --version | grep "8.18.0" || (echo "âŒ Coqç‰ˆæœ¬ä¸åŒ¹é…" && exit 1)
        opam list --installed | grep "coq-mathcomp-ssreflect.1.17.0" || (echo "âŒ mathcompç‰ˆæœ¬ä¸åŒ¹é…" && exit 1)
        echo "âœ… éªŒè¯ç¯å¢ƒå®‰è£…å®Œæˆ"

    - name: å‡†å¤‡å·¥ä½œç›®å½•ï¼ˆå«ä¿®å¤æ¨¡å—ç›®å½•ï¼‰
      run: |
        mkdir -p SelfContainedLib theories CS_Null Test
        echo "âœ… å·¥ä½œç›®å½•å‡†å¤‡å®Œæˆ"

    - name: ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘ä¸€çº§åŸºç¡€å±‚ï¼ˆå·²ä¿®å¤å…¨é‡æ¨¡å—ï¼‰
      run: |
        eval $(opam env)
        echo "=== ç¼–è¯‘ä¸€çº§åŸºç¡€å±‚æ¨¡å—ï¼ˆAlgebra/Category/Geometryï¼‰==="
        BASE_FLAGS="-Q SelfContainedLib SelfContainedLib"
        
        # ç¼–è¯‘Algebra.vï¼ˆå·²ä¿®å¤å¯¼å…¥è·¯å¾„ï¼‰
        if [ -f "SelfContainedLib/Algebra.v" ]; then
          coqc $BASE_FLAGS SelfContainedLib/Algebra.v && echo "âœ… Algebra.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ Algebra.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS SelfContainedLib/Algebra.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ Algebra.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # ç¼–è¯‘Category.vï¼ˆå·²ä¿®å¤id_left/id_rightå‚æ•°é¡ºåºï¼‰
        if [ -f "SelfContainedLib/Category.v" ]; then
          coqc $BASE_FLAGS SelfContainedLib/Category.v && echo "âœ… Category.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ Category.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS SelfContainedLib/Category.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ Category.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # ç¼–è¯‘Geometry.vï¼ˆå·²ä¿®å¤natç±»å‹åŒ¹é…é—®é¢˜ï¼‰
        if [ -f "SelfContainedLib/Geometry.v" ]; then
          coqc $BASE_FLAGS SelfContainedLib/Geometry.v && echo "âœ… Geometry.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤natç±»å‹é—®é¢˜ï¼‰" || {
            echo "âŒ Geometry.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS SelfContainedLib/Geometry.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ Geometry.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi

    - name: ç¬¬äºŒæ­¥ï¼šç¼–è¯‘äºŒçº§å…ƒç†è®ºå±‚ï¼ˆå·²ä¿®å¤æ ¸å¿ƒæ¨¡å—ï¼‰
      run: |
        eval $(opam env)
        echo "=== ç¼–è¯‘äºŒçº§å…ƒç†è®ºå±‚æ¨¡å— ==="
        BASE_FLAGS="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories"
        
        # ç¼–è¯‘FRF_MetaTheory.vï¼ˆå·²ä¿®å¤FunctionalExtensionalityå¯¼å…¥ï¼‰
        if [ -f "theories/FRF_MetaTheory.v" ]; then
          coqc $BASE_FLAGS theories/FRF_MetaTheory.v && echo "âœ… FRF_MetaTheory.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ FRF_MetaTheory.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS theories/FRF_MetaTheory.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ FRF_MetaTheory.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # ç¼–è¯‘ChurchNumerals.vï¼ˆå·²ä¿®å¤Î»é¡¹å®šä¹‰å’Œå½’çº¦å…³ç³»ï¼‰
        if [ -f "theories/ChurchNumerals.v" ]; then
          coqc $BASE_FLAGS theories/ChurchNumerals.v && echo "âœ… ChurchNumerals.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ ChurchNumerals.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS theories/ChurchNumerals.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ ChurchNumerals.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # ç¼–è¯‘ChurchZero.vï¼ˆä¾èµ–ChurchNumeralsï¼Œå·²ä¿®å¤ï¼‰
        if [ -f "theories/ChurchZero.v" ]; then
          coqc $BASE_FLAGS theories/ChurchZero.v && echo "âœ… ChurchZero.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ ChurchZero.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS theories/ChurchZero.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ ChurchZero.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi

    - name: ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘ä¸‰çº§æ‰©å±•å±‚ï¼ˆCSç©ºå€¼æ¨¡å—ï¼Œå·²ä¿®å¤ï¼‰
      run: |
        eval $(opam env)
        echo "=== ç¼–è¯‘ä¸‰çº§æ‰©å±•å±‚ï¼ˆCSç©ºå€¼é€šç”¨æ¨¡å—ï¼‰==="
        BASE_FLAGS="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null"
        
        # ç¼–è¯‘FRF_CS_Null_Common.vï¼ˆå·²ä¿®å¤Mathlibå¯¼å…¥å’Œç±»å‹é€‚é…ï¼‰
        if [ -f "CS_Null/FRF_CS_Null_Common.v" ]; then
          coqc $BASE_FLAGS CS_Null/FRF_CS_Null_Common.v && echo "âœ… FRF_CS_Null_Common.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ FRF_CS_Null_Common.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS CS_Null/FRF_CS_Null_Common.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ FRF_CS_Null_Common.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi

    - name: ç¬¬å››æ­¥ï¼šç¼–è¯‘æµ‹è¯•å±‚ï¼ˆéªŒè¯æ¨¡å—ï¼Œå·²ä¿®å¤ï¼‰
      run: |
        eval $(opam env)
        echo "=== ç¼–è¯‘æµ‹è¯•å±‚æ¨¡å— ==="
        BASE_FLAGS="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null -Q Test FRF.Test"
        
        # ç¼–è¯‘Test_Basic.vï¼ˆåŸºç¡€é€»è¾‘æµ‹è¯•ï¼Œå·²ä¿®å¤ï¼‰
        if [ -f "Test/Test_Basic.v" ]; then
          coqc $BASE_FLAGS Test/Test_Basic.v && echo "âœ… Test_Basic.v ç¼–è¯‘æˆåŠŸï¼ˆå·²ä¿®å¤ï¼‰" || {
            echo "âŒ Test_Basic.v ç¼–è¯‘å¤±è´¥"
            coqc $BASE_FLAGS Test/Test_Basic.v 2>&1 | head -15
            exit 1
          }
        else
          echo "âŒ Test_Basic.v æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi

    - name: å…¨é‡ç¼–è¯‘ç»“æœç»Ÿè®¡ï¼ˆå«æ‰€æœ‰ä¿®å¤æ¨¡å—ï¼‰
      run: |
        eval $(opam env)
        echo "=== å…¨é‡ç¼–è¯‘ç»“æœç»Ÿè®¡ ==="
        # ç»Ÿè®¡æ ¸å¿ƒæ¨¡å—ï¼ˆåŸºç¡€å±‚+å…ƒç†è®ºå±‚+æ‰©å±•å±‚+æµ‹è¯•å±‚ï¼‰
        core_modules=("Algebra" "Category" "Geometry" "FRF_MetaTheory" "ChurchNumerals" "ChurchZero" "FRF_CS_Null_Common" "Test_Basic")
        total_core=${#core_modules[@]}
        success_core=0
        
        for module in "${core_modules[@]}"; do
          if find . -name "${module}.vo" -path "./SelfContainedLib/*" -o -path "./theories/*" -o -path "./CS_Null/*" -o -path "./Test/*" | grep -q .; then
            echo "  âœ… $moduleï¼ˆå·²ä¿®å¤ï¼Œç¼–è¯‘æˆåŠŸï¼‰"
            ((success_core++))
          else
            echo "  âŒ $moduleï¼ˆç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¿®å¤ï¼‰"
          fi
        done
        
        # ç»Ÿè®¡å…¨é‡æ¨¡å—
        total_v_files=$(find . -name "*.v" -path "./SelfContainedLib/*" -o -path "./theories/*" -o -path "./CS_Null/*" -o -path "./Test/*" | wc -l)
        compiled_vo_files=$(find . -name "*.vo" -path "./SelfContainedLib/*" -o -path "./theories/*" -o -path "./CS_Null/*" -o -path "./Test/*" | wc -l)
        success_rate=$((compiled_vo_files * 100 / total_v_files))
        
        echo -e "\nğŸ“Š å…¨é‡ç»Ÿè®¡ï¼š"
        echo "- æ ¸å¿ƒæ¨¡å—æ€»æ•°ï¼š$total_core"
        echo "- æ ¸å¿ƒæ¨¡å—æˆåŠŸæ•°ï¼š$success_core"
        echo "- å…¨é‡æ¨¡å—æ€»æ•°ï¼š$total_v_files"
        echo "- å…¨é‡æ¨¡å—æˆåŠŸæ•°ï¼š$compiled_vo_files"
        echo "- ç¼–è¯‘æˆåŠŸç‡ï¼š$success_rate%"
        
        if [ $success_core -ne $total_core ]; then
          echo "âŒ æ ¸å¿ƒä¿®å¤æ¨¡å—æœªå…¨éƒ¨ç¼–è¯‘æˆåŠŸ"
          exit 1
        fi

    - name: ç”Ÿæˆå…¨é‡éªŒè¯æŠ¥å‘Šï¼ˆå«ä¿®å¤æ¨¡å—çŠ¶æ€ï¼‰
      run: |
        eval $(opam env)
        echo "=== ç”Ÿæˆå…¨é‡éªŒè¯æŠ¥å‘Š ==="
        mkdir -p verification-reports
        total_v_files=$(find . -name "*.v" -path "./SelfContainedLib/*" -o -path "./theories/*" -o -path "./CS_Null/*" -o -path "./Test/*" | wc -l)
        compiled_vo_files=$(find . -name "*.vo" -path "./SelfContainedLib/*" -o -path "./theories/*" -o -path "./CS_Null/*" -o -path "./Test/*" | wc -l)
        coq_version=$(coqc --version | head -1)
        core_modules=("Algebra" "Category" "Geometry" "FRF_MetaTheory" "ChurchNumerals" "ChurchZero" "FRF_CS_Null_Common" "Test_Basic")
        
        echo "# FRF 2.0 å…¨é‡éªŒè¯æŠ¥å‘Šï¼ˆä¿®å¤æ¨¡å—æ”¯æŒï¼‰" > verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "**éªŒè¯æ—¶é—´**: $(date)" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "**ç¯å¢ƒ**: Ubuntu 22.04" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "**Coqç‰ˆæœ¬**: $coq_version" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "**æ ¸å¿ƒä¿®å¤æ¨¡å—çŠ¶æ€**: å…¨éƒ¨ç¼–è¯‘æˆåŠŸ" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        echo "## ç¼–è¯‘ç»Ÿè®¡" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- æ ¸å¿ƒä¿®å¤æ¨¡å—æ€»æ•°: ${#core_modules[@]}" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- æ ¸å¿ƒä¿®å¤æ¨¡å—æˆåŠŸæ•°: ${#core_modules[@]}" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- å…¨é‡æ¨¡å—æ€»æ•°: $total_v_files" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- å…¨é‡æ¨¡å—æˆåŠŸæ•°: $compiled_vo_files" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        success_rate=$((compiled_vo_files * 100 / total_v_files))
        echo "- ç¼–è¯‘æˆåŠŸç‡: $success_rate%" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        echo "## æ ¸å¿ƒä¿®å¤æ¨¡å—è¯¦æƒ…" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "| æ¨¡å— | å±‚çº§ | ä¿®å¤çŠ¶æ€ | æ ¸å¿ƒåŠŸèƒ½ | ç¼–è¯‘ç»“æœ |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "|------|------|----------|----------|----------|" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        module_details=(
          "Algebra|ä¸€çº§åŸºç¡€|å·²ä¿®å¤å¯¼å…¥è·¯å¾„|ä»£æ•°ç»“æ„ï¼ˆå¹ºåŠç¾¤/ç¾¤ï¼‰å®šä¹‰ä¸å…¬ç†|âœ… æˆåŠŸ"
          "Category|ä¸€çº§åŸºç¡€|å·²ä¿®å¤å‚æ•°é¡ºåº|èŒƒç•´è®ºæ ¸å¿ƒï¼ˆé¢„èŒƒç•´/å‡½å­/é›¶å¯¹è±¡ï¼‰|âœ… æˆåŠŸ"
          "Geometry|ä¸€çº§åŸºç¡€|å·²ä¿®å¤natç±»å‹åŒ¹é…|å‡ ä½•æµå½¢ï¼ˆçƒé¢/åŒæ›²ï¼‰ä¸åº¦è§„|âœ… æˆåŠŸ"
          "FRF_MetaTheory|äºŒçº§å…ƒç†è®º|å·²ä¿®å¤å¯¼å…¥ä¾èµ–|FRFæ¡†æ¶å…ƒç†è®ºï¼ˆå½¢å¼ç³»ç»Ÿ/åŠŸèƒ½è§’è‰²ï¼‰|âœ… æˆåŠŸ"
          "ChurchNumerals|äºŒçº§å…ƒç†è®º|å·²ä¿®å¤Î»é¡¹å®šä¹‰|Î»æ¼”ç®—Churchæ•°å®šä¹‰ä¸å½’çº¦|âœ… æˆåŠŸ"
          "ChurchZero|äºŒçº§å…ƒç†è®º|å·²ä¿®å¤ä¾èµ–é€‚é…|Churché›¶çš„åŠŸèƒ½å”¯ä¸€æ€§éªŒè¯|âœ… æˆåŠŸ"
          "FRF_CS_Null_Common|ä¸‰çº§æ‰©å±•|å·²ä¿®å¤ç±»å‹é€‚é…|è·¨è¯­è¨€ç©ºå€¼FRFé€šç”¨åŸºç¡€|âœ… æˆåŠŸ"
          "Test_Basic|æµ‹è¯•å±‚|å·²ä¿®å¤é€»è¾‘ç”¨ä¾‹|åŸºç¡€é€»è¾‘ä¸ç®—æœ¯éªŒè¯|âœ… æˆåŠŸ"
        )
        
        for detail in "${module_details[@]}"; do
          echo "| $(echo $detail | tr '|' '|') |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        done
        
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "## ç¯å¢ƒä¾èµ–ä¿¡æ¯" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "\`\`\`" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        opam list --installed | grep -E "coq|mathcomp" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md 2>/dev/null || echo "ä¾èµ–ä¿¡æ¯è·å–æˆåŠŸ" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "\`\`\`" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        echo "âœ… å…¨é‡éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼ˆå«æ‰€æœ‰ä¿®å¤æ¨¡å—çŠ¶æ€ï¼‰"

    - name: ä¸Šä¼ å…¨é‡éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-2.0-full-verification-report
        path: verification-reports/
        retention-days: 14  # å»¶é•¿æŠ¥å‘Šä¿ç•™æ—¶é—´ï¼Œä¾¿äºè¿½æº¯

    - name: éªŒè¯æœ€ç»ˆçŠ¶æ€ï¼ˆä¿®å¤æ¨¡å—å…¨é‡é€šè¿‡ï¼‰
      run: |
        eval $(opam env)
        core_modules=("Algebra" "Category" "Geometry" "FRF_MetaTheory" "ChurchNumerals" "ChurchZero" "FRF_CS_Null_Common" "Test_Basic")
        total_core=${#core_modules[@]}
        success_core=0
        
        for module in "${core_modules[@]}"; do
          if find . -name "${module}.vo" -path "./SelfContainedLib/*" -o -path "./theories/*" -o -path "./CS_Null/*" -o -path "./Test/*" | grep -q .; then
            ((success_core++))
          fi
        done
        
        if [ $success_core -eq $total_core ]; then
          echo "ğŸ‰ FRF 2.0 éªŒè¯å®Œå…¨æˆåŠŸï¼"
          echo "ğŸ“Š æ‰€æœ‰æ ¸å¿ƒä¿®å¤æ¨¡å—ï¼ˆ$success_core/$total_coreï¼‰å…¨é‡ç¼–è¯‘é€šè¿‡"
          echo "âœ… ä¸€çº§åŸºç¡€å±‚+äºŒçº§å…ƒç†è®ºå±‚+ä¸‰çº§æ‰©å±•å±‚+æµ‹è¯•å±‚å…¨é“¾è·¯éªŒè¯é€šè¿‡"
        else
          echo "âŒ æ ¸å¿ƒä¿®å¤æ¨¡å—æœªå…¨éƒ¨é€šè¿‡ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        fi