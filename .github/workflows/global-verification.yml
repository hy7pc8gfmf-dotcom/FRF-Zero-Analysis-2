name: FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯ï¼ˆå…¨é‡å¢å¼ºç‰ˆï¼‰

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  COQ_VERSION: "8.18.0"
  PARALLEL_JOBS: 4
  MEMORY_LIMIT: "10240"
  COQFLAGS_BASE: "-w -deprecated"

jobs:
  full-formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # å…¨é‡ç¼–è¯‘éœ€è¦æ›´é•¿æ—¶é—´
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false

    - name: ğŸ–¥ï¸ å…¨é‡ç³»ç»Ÿèµ„æºæ£€æŸ¥
      run: |
        echo "=== å…¨é‡ç³»ç»Ÿä¿¡æ¯ ==="
        echo "ç³»ç»Ÿ: $(uname -a)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        echo "æ€»å†…å­˜: $(free -m | awk '/^Mem:/{print $2 "MB"}')"
        echo "å¯ç”¨å†…å­˜: $(free -m | awk '/^Mem:/{print $7 "MB"}')"
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo ""
        echo "é¡¹ç›®æ–‡ä»¶ç»Ÿè®¡:"
        find . -name "*.v" -type f | wc -l | xargs echo "Coqæ–‡ä»¶æ•°:"
        find . -name "*.v" -type f -exec wc -l {} + | tail -1 | awk '{print "æ€»ä»£ç è¡Œæ•°: " $1}'

    - name: ğŸ“¦ å®‰è£…å®Œæ•´ç³»ç»Ÿä¾èµ–
      run: |
        echo "å®‰è£…å®Œæ•´ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          bc \
          graphviz \
          python3 \
          python3-pip \
          jq
        
        # å®‰è£…Coqç›¸å…³å·¥å…·
        pip3 install coq-verifier
        
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”„ åˆå§‹åŒ–OPAMç¯å¢ƒï¼ˆå®Œæ•´ç‰ˆï¼‰
      timeout-minutes: 25
      run: |
        echo "åˆå§‹åŒ–OPAMç¯å¢ƒ..."
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add coq-extra-dev https://coq.inria.fr/opam/extra-dev
        opam update
        
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "OPAMç‰ˆæœ¬: $(opam --version)"
        echo "ä»“åº“åˆ—è¡¨:"
        opam repo list

    - name: ğŸ“š å®‰è£…Coqå®Œæ•´å¥—ä»¶
      timeout-minutes: 35
      run: |
        eval $(opam env)
        echo "å®‰è£…Coq ${{ env.COQ_VERSION }} å®Œæ•´å¥—ä»¶..."
        
        # å®‰è£…Coqæ ¸å¿ƒ
        opam install -y --no-depexts coq.${{ env.COQ_VERSION }}
        
        # å®‰è£…å¸¸ç”¨åº“
        opam install -y --no-depexts \
          coq-stdlib \
          coq-mathcomp-ssreflect=1.17.0 \
          coq-mathcomp-algebra \
          coq-mathcomp-field \
          coq-mathcomp-fingroup
        
        echo "éªŒè¯Coqå®‰è£…..."
        if coqc --version | grep -q "${{ env.COQ_VERSION }}"; then
          echo "âœ… Coq ${{ env.COQ_VERSION }} å®‰è£…æˆåŠŸ"
        else
          echo "âŒ Coqç‰ˆæœ¬ä¸åŒ¹é…"
          coqc --version
          exit 1
        fi
        
        echo "å®‰è£…åº“ç‰ˆæœ¬:"
        opam list --installed --short | grep -E "coq|mathcomp"

    - name: ğŸ§® å¯é€‰ï¼šå®‰è£…Mathlibï¼ˆå¦‚æœå­˜åœ¨ä¾èµ–ï¼‰
      timeout-minutes: 20
      continue-on-error: true
      run: |
        eval $(opam env)
        echo "å°è¯•å®‰è£…Mathlib..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦Mathlib
        if find . -name "*.v" -type f -exec grep -l "Require.*mathcomp\|From.*mathcomp" {} \;; then
          echo "æ£€æµ‹åˆ°mathcompä¾èµ–ï¼Œå°è¯•å®‰è£…..."
          opam install -y --no-depexts coq-mathcomp-ssreflect=1.17.0
        fi
        
        if find . -name "*.v" -type f -exec grep -l "Require.*Mathlib\|From.*Mathlib" {} \;; then
          echo "æ£€æµ‹åˆ°Mathlibä¾èµ–ï¼Œå°è¯•å®‰è£…..."
          opam install -y --no-depexts coq-mathlib
        fi
        
        echo "âœ… å¯é€‰åº“å®‰è£…å®Œæˆ"

    - name: ğŸ“ æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸å‡†å¤‡
      id: file-discovery
      run: |
        echo "=== æ™ºèƒ½æ–‡ä»¶å‘ç° ==="
        
        # å®šä¹‰æ‰€æœ‰å¯èƒ½çš„ç›®å½•
        declare -a DIRS=("SelfContainedLib" "theories" "Quantum" "CS_Null" "Test")
        
        # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
        ALL_V_FILES=""
        for dir in "${DIRS[@]}"; do
          if [ -d "$dir" ]; then
            echo "æ‰«æç›®å½•: $dir"
            count=$(find "$dir" -name "*.v" -type f | wc -l)
            echo "  å‘ç° $count ä¸ª .v æ–‡ä»¶"
            
            # æ”¶é›†æ–‡ä»¶
            files=$(find "$dir" -name "*.v" -type f)
            ALL_V_FILES="$ALL_V_FILES $files"
          else
            echo "âš ï¸  ç›®å½•ä¸å­˜åœ¨: $dir"
          fi
        done
        
        # ç»Ÿè®¡
        TOTAL_FILES=$(echo "$ALL_V_FILES" | wc -w)
        echo "æ€»è®¡å‘ç° $TOTAL_FILES ä¸ª .v æ–‡ä»¶"
        
        # æŒ‰å¤§å°åˆ†ç±»
        echo ""
        echo "=== æ–‡ä»¶å¤§å°åˆ†ç±» ==="
        HUGE_FILES=""
        BIG_FILES=""
        MEDIUM_FILES=""
        SMALL_FILES=""
        
        for file in $ALL_V_FILES; do
          lines=$(wc -l < "$file" 2>/dev/null || echo 0)
          if [ $lines -gt 3000 ]; then
            echo "è¶…å¤§æ–‡ä»¶: $file ($lines è¡Œ)"
            HUGE_FILES="$HUGE_FILES $file"
          elif [ $lines -gt 1000 ]; then
            echo "å¤§æ–‡ä»¶: $file ($lines è¡Œ)"
            BIG_FILES="$BIG_FILES $file"
          elif [ $lines -gt 100 ]; then
            MEDIUM_FILES="$MEDIUM_FILES $file"
          else
            SMALL_FILES="$SMALL_FILES $file"
          fi
        done
        
        # è¾“å‡ºç»Ÿè®¡
        echo ""
        echo "æ–‡ä»¶åˆ†ç±»ç»Ÿè®¡:"
        echo "è¶…å¤§æ–‡ä»¶(>3000è¡Œ): $(echo $HUGE_FILES | wc -w)"
        echo "å¤§æ–‡ä»¶(1000-3000è¡Œ): $(echo $BIG_FILES | wc -w)"
        echo "ä¸­æ–‡ä»¶(100-1000è¡Œ): $(echo $MEDIUM_FILES | wc -w)"
        echo "å°æ–‡ä»¶(<100è¡Œ): $(echo $SMALL_FILES | wc -w)"
        
        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
        echo "TOTAL_V_FILES=$TOTAL_FILES" >> $GITHUB_ENV
        echo "HUGE_FILES_COUNT=$(echo $HUGE_FILES | wc -w)" >> $GITHUB_ENV

    - name: ğŸ—ï¸ æ„å»ºMakefileå…¼å®¹ç¯å¢ƒ
      run: |
        echo "å‡†å¤‡Makefileå…¼å®¹ç¯å¢ƒ..."
        
        # åˆ›å»ºåŸºç¡€çš„Makefileï¼ˆå¦‚æœéœ€è¦ï¼‰
        if [ ! -f "Makefile" ]; then
          echo "âš ï¸  æœªæ‰¾åˆ°Makefileï¼Œåˆ›å»ºæœ€å°ç‰ˆæœ¬..."
          cat > Makefile << 'EOF'
# æœ€å°Makefileç”¨äºGitHub Actions
COQC ?= coqc
COQDEP ?= coqdep

# åŸºç¡€è·¯å¾„
SELF_CONTAINED := SelfContainedLib
THEORIES := theories
QUANTUM := Quantum
CS_NULL := CS_Null
TEST := Test

# ç¼–è¯‘æ ‡å¿—
COQFLAGS := -R $(SELF_CONTAINED) SelfContainedLib \
            -R $(THEORIES) theories \
            -R $(QUANTUM) Quantum \
            -R $(CS_NULL) CS_Null \
            -R $(TEST) Test \
            -w -deprecated \
            -m ${{ env.MEMORY_LIMIT }}

# è‡ªåŠ¨å‘ç°æ‰€æœ‰.væ–‡ä»¶
ALL_V_FILES := $(shell find . -name "*.v" -type f)

# ç¼–è¯‘è§„åˆ™
%.vo: %.v
	@echo "ç¼–è¯‘: $(notdir $<)"
	@$(COQC) $(COQFLAGS) "$<"

# ä¸»ç›®æ ‡
all: $(ALL_V_FILES:.v=.vo)
	@echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¼–è¯‘å®Œæˆ"

clean:
	@find . -name "*.vo" -delete
	@find . -name "*.glob" -delete
	@find . -name "*.v.d" -delete

.PHONY: all clean
EOF
        fi
        
        echo "âœ… æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: ğŸ”§ ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘ä¸€çº§åŸºç¡€å±‚ï¼ˆè‡ªåŒ…å«åº“ï¼‰
      timeout-minutes: 20
      run: |
        eval $(opam env)
        echo "=== ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘ä¸€çº§åŸºç¡€å±‚ ==="
        echo "å†…å­˜é™åˆ¶: ${{ env.MEMORY_LIMIT }} MB"
        
        # ç¼–è¯‘è‡ªåŒ…å«åŸºç¡€åº“
        declare -a BASE_FILES=(
          "SelfContainedLib/Algebra.v"
          "SelfContainedLib/Category.v"
          "SelfContainedLib/Geometry.v"
        )
        
        success_count=0
        total_count=0
        
        for file in "${BASE_FILES[@]}"; do
          if [ -f "$file" ]; then
            total_count=$((total_count + 1))
            echo ""
            echo "ç¼–è¯‘: $(basename $file)"
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  è¡Œæ•°: $lines"
            
            if coqc -Q SelfContainedLib SelfContainedLib -m ${{ env.MEMORY_LIMIT }} "$file"; then
              echo "  âœ… æˆåŠŸ"
              success_count=$((success_count + 1))
            else
              echo "  âŒ å¤±è´¥"
              # å°è¯•ä½¿ç”¨æ›´ç®€å•çš„å‚æ•°
              echo "  å°è¯•ç®€åŒ–ç¼–è¯‘..."
              if coqc -Q SelfContainedLib SelfContainedLib "$file"; then
                echo "  âœ… ç®€åŒ–ç¼–è¯‘æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ ç®€åŒ–ç¼–è¯‘ä¹Ÿå¤±è´¥"
              fi
            fi
          else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo ""
        echo "ğŸ“Š åŸºç¡€å±‚ç¼–è¯‘ç»“æœ: $success_count/$total_count æˆåŠŸ"
        
        if [ $success_count -eq $total_count ]; then
          echo "âœ… åŸºç¡€å±‚ç¼–è¯‘å®Œæˆ"
        else
          echo "âš ï¸  åŸºç¡€å±‚éƒ¨åˆ†æ–‡ä»¶ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­åç»­ç¼–è¯‘"
        fi

    - name: ğŸ”§ ç¬¬äºŒæ­¥ï¼šç¼–è¯‘äºŒçº§å…ƒç†è®ºå±‚
      timeout-minutes: 25
      run: |
        eval $(opam env)
        echo "=== ç¬¬äºŒæ­¥ï¼šç¼–è¯‘äºŒçº§å…ƒç†è®ºå±‚ ==="
        
        # ç¼–è¯‘FRFå…ƒç†è®º
        declare -a FRF_FILES=(
          "theories/FRF_MetaTheory.v"
          "theories/ChurchZero.v"
          "theories/ChurchNumerals.v"
        )
        
        success_count=0
        total_count=0
        
        for file in "${FRF_FILES[@]}"; do
          if [ -f "$file" ]; then
            total_count=$((total_count + 1))
            echo ""
            echo "ç¼–è¯‘: $(basename $file)"
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  è¡Œæ•°: $lines"
            
            # é’ˆå¯¹å¤§æ–‡ä»¶ä½¿ç”¨å¢å¼ºå‚æ•°
            if [ $lines -gt 2000 ]; then
              echo "  å¤§æ–‡ä»¶ï¼Œä½¿ç”¨å¢å¼ºå‚æ•°"
              if coqc -Q SelfContainedLib SelfContainedLib \
                      -Q theories FRF.Theories \
                      -m ${{ env.MEMORY_LIMIT }} \
                      -async-proofs on \
                      -async-proofs-tac-j ${{ env.PARALLEL_JOBS }} \
                      "$file"; then
                echo "  âœ… æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ å¤±è´¥"
              fi
            else
              if coqc -Q SelfContainedLib SelfContainedLib \
                      -Q theories FRF.Theories \
                      -m ${{ env.MEMORY_LIMIT }} \
                      "$file"; then
                echo "  âœ… æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ å¤±è´¥"
              fi
            fi
          else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo ""
        echo "ğŸ“Š å…ƒç†è®ºå±‚ç¼–è¯‘ç»“æœ: $success_count/$total_count æˆåŠŸ"

    - name: ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘ä¸‰çº§æ•°å­¦åœºæ™¯å±‚
      timeout-minutes: 30
      run: |
        eval $(opam env)
        echo "=== ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘ä¸‰çº§æ•°å­¦åœºæ™¯å±‚ ==="
        
        # ç¼–è¯‘æ•°å­¦åœºæ™¯
        declare -a SCENE_FILES=(
          "theories/CaseA_SetTheory.v"
          "theories/CaseB_Algebra.v"
          "theories/CaseC_TypeTheory.v"
          "theories/CaseD_CategoryTheory.v"
          "theories/CaseE_QuantumVacuum.v"
        )
        
        success_count=0
        total_count=0
        
        for file in "${SCENE_FILES[@]}"; do
          if [ -f "$file" ]; then
            total_count=$((total_count + 1))
            echo ""
            echo "ç¼–è¯‘: $(basename $file)"
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  è¡Œæ•°: $lines"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å®æ•°ä¾èµ–
            if grep -q "Require.*Reals\|From.*Reals" "$file" 2>/dev/null; then
              echo "  æ£€æµ‹åˆ°å®æ•°ä¾èµ–"
              REAL_FLAG="-R $(coqc -where)/../user-contrib Coq"
            else
              REAL_FLAG=""
            fi
            
            if coqc -Q SelfContainedLib SelfContainedLib \
                    -Q theories FRF.Theories \
                    $REAL_FLAG \
                    -m ${{ env.MEMORY_LIMIT }} \
                    "$file"; then
              echo "  âœ… æˆåŠŸ"
              success_count=$((success_count + 1))
            else
              echo "  âŒ å¤±è´¥"
            fi
          else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo ""
        echo "ğŸ“Š æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘ç»“æœ: $success_count/$total_count æˆåŠŸ"

    - name: ğŸ”§ ç¬¬å››æ­¥ï¼šç¼–è¯‘å››çº§æ‰©å±•æ¨¡å—å±‚
      timeout-minutes: 40
      run: |
        eval $(opam env)
        echo "=== ç¬¬å››æ­¥ï¼šç¼–è¯‘å››çº§æ‰©å±•æ¨¡å—å±‚ ==="
        
        # é‡å­æ¨¡å—
        echo "--- é‡å­æ¨¡å— ---"
        declare -a QUANTUM_FILES=(
          "Quantum/QFT_FRF.v"
          "Quantum/CurvedSpacetimeQFT.v"
        )
        
        # ç©ºå€¼ç³»ç»Ÿæ¨¡å—
        echo "--- ç©ºå€¼ç³»ç»Ÿæ¨¡å— ---"
        declare -a NULL_FILES=(
          "CS_Null/FRF_CS_Null_Common.v"
          "CS_Null/FRF_CS_Null.v"
          "CS_Null/CxxNull.v"
          "CS_Null/PythonNull.v"
          "CS_Null/JavaNull.v"
          "CS_Null/MathNull.v"
          "CS_Null/RustNull.v"
        )
        
        ALL_EXT_FILES=("${QUANTUM_FILES[@]}" "${NULL_FILES[@]}")
        
        success_count=0
        total_count=0
        
        for file in "${ALL_EXT_FILES[@]}"; do
          if [ -f "$file" ]; then
            total_count=$((total_count + 1))
            echo ""
            echo "ç¼–è¯‘: $(basename $file)"
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  è¡Œæ•°: $lines"
            
            # ç¡®å®šæ¨¡å—ç±»å‹å’Œå‚æ•°
            if [[ "$file" == Quantum/* ]]; then
              MODULE_PATH="-Q Quantum Quantum"
            elif [[ "$file" == CS_Null/* ]]; then
              MODULE_PATH="-Q CS_Null CS_Null"
            else
              MODULE_PATH=""
            fi
            
            if [ $lines -gt 1500 ]; then
              echo "  è¾ƒå¤§æ–‡ä»¶ï¼Œä½¿ç”¨å¢å¼ºç¼–è¯‘"
              if coqc -Q SelfContainedLib SelfContainedLib \
                      -Q theories FRF.Theories \
                      $MODULE_PATH \
                      -m ${{ env.MEMORY_LIMIT }} \
                      -async-proofs on \
                      "$file"; then
                echo "  âœ… æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ å¤±è´¥"
              fi
            else
              if coqc -Q SelfContainedLib SelfContainedLib \
                      -Q theories FRF.Theories \
                      $MODULE_PATH \
                      -m ${{ env.MEMORY_LIMIT }} \
                      "$file"; then
                echo "  âœ… æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ å¤±è´¥"
              fi
            fi
          else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo ""
        echo "ğŸ“Š æ‰©å±•æ¨¡å—å±‚ç¼–è¯‘ç»“æœ: $success_count/$total_count æˆåŠŸ"

    - name: ğŸ”§ ç¬¬äº”æ­¥ï¼šç¼–è¯‘äº”çº§é›†æˆæ¨¡å—å±‚
      timeout-minutes: 25
      run: |
        eval $(opam env)
        echo "=== ç¬¬äº”æ­¥ï¼šç¼–è¯‘äº”çº§é›†æˆæ¨¡å—å±‚ ==="
        
        # é›†æˆæ¨¡å—
        declare -a INTEGRATION_FILES=(
          "theories/FRF_Comparative.v"
        )
        
        success_count=0
        total_count=0
        
        for file in "${INTEGRATION_FILES[@]}"; do
          if [ -f "$file" ]; then
            total_count=$((total_count + 1))
            echo ""
            echo "ç¼–è¯‘: $(basename $file)"
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  è¡Œæ•°: $lines"
            
            # æå¤§æ–‡ä»¶ç‰¹æ®Šå¤„ç†
            if [ $lines -gt 2500 ]; then
              echo "  æå¤§æ–‡ä»¶ï¼Œä½¿ç”¨æœ€å¤§èµ„æº"
              if coqc -Q SelfContainedLib SelfContainedLib \
                      -Q theories FRF.Theories \
                      -Q Quantum Quantum \
                      -Q CS_Null CS_Null \
                      -m ${{ env.MEMORY_LIMIT }} \
                      -async-proofs on \
                      -async-proofs-tac-j $(( ${{ env.PARALLEL_JOBS }} * 2 )) \
                      "$file"; then
                echo "  âœ… æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ å¤±è´¥"
              fi
            else
              if coqc -Q SelfContainedLib SelfContainedLib \
                      -Q theories FRF.Theories \
                      -Q Quantum Quantum \
                      -Q CS_Null CS_Null \
                      -m ${{ env.MEMORY_LIMIT }} \
                      "$file"; then
                echo "  âœ… æˆåŠŸ"
                success_count=$((success_count + 1))
              else
                echo "  âŒ å¤±è´¥"
              fi
            fi
          else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo ""
        echo "ğŸ“Š é›†æˆæ¨¡å—å±‚ç¼–è¯‘ç»“æœ: $success_count/$total_count æˆåŠŸ"

    - name: ğŸ”§ ç¬¬å…­æ­¥ï¼šç¼–è¯‘å…­çº§æµ‹è¯•å¥—ä»¶å±‚
      timeout-minutes: 30
      run: |
        eval $(opam env)
        echo "=== ç¬¬å…­æ­¥ï¼šç¼–è¯‘å…­çº§æµ‹è¯•å¥—ä»¶å±‚ ==="
        
        # æµ‹è¯•æ¨¡å—
        declare -a TEST_FILES=(
          "Test/Test_Basic.v"
          "Test/Test_FRF_MetaTheory.v"
          "Test/Test_QuantumVacuum.v"
          "Test/Test_BlockchainSystem.v"
          "Test/SelfContainedVerification.v"
        )
        
        success_count=0
        total_count=0
        
        for file in "${TEST_FILES[@]}"; do
          if [ -f "$file" ]; then
            total_count=$((total_count + 1))
            echo ""
            echo "ç¼–è¯‘: $(basename $file)"
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  è¡Œæ•°: $lines"
            
            if coqc -Q SelfContainedLib SelfContainedLib \
                    -Q theories FRF.Theories \
                    -Q Quantum Quantum \
                    -Q CS_Null CS_Null \
                    -Q Test FRF.Test \
                    -m ${{ env.MEMORY_LIMIT }} \
                    "$file"; then
              echo "  âœ… æˆåŠŸ"
              success_count=$((success_count + 1))
            else
              echo "  âŒ å¤±è´¥"
            fi
          else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo ""
        echo "ğŸ“Š æµ‹è¯•å¥—ä»¶å±‚ç¼–è¯‘ç»“æœ: $success_count/$total_count æˆåŠŸ"

    - name: ğŸ”§ ç¬¬ä¸ƒæ­¥ï¼šè‡ªåŠ¨å‘ç°å¹¶ç¼–è¯‘æœªçŸ¥æ–°å¢æ¨¡å—
      timeout-minutes: 20
      continue-on-error: true
      run: |
        eval $(opam env)
        echo "=== ç¬¬ä¸ƒæ­¥ï¼šè‡ªåŠ¨å‘ç°å¹¶ç¼–è¯‘æœªçŸ¥æ–°å¢æ¨¡å— ==="
        
        # æŸ¥æ‰¾æ‰€æœ‰å°šæœªç¼–è¯‘çš„.væ–‡ä»¶
        echo "æœç´¢æœªç¼–è¯‘çš„.væ–‡ä»¶..."
        
        # è·å–æ‰€æœ‰.væ–‡ä»¶
        ALL_V_FILES=$(find . -name "*.v" -type f)
        
        # è·å–å·²ç¼–è¯‘çš„.voæ–‡ä»¶å¯¹åº”çš„.væ–‡ä»¶
        COMPILED_V_FILES=$(find . -name "*.vo" -type f | sed 's/\.vo$/.v/')
        
        # æ‰¾å‡ºæœªç¼–è¯‘çš„æ–‡ä»¶
        UNCOMPILED_FILES=""
        for vfile in $ALL_V_FILES; do
          if ! echo "$COMPILED_V_FILES" | grep -q "^$vfile$"; then
            UNCOMPILED_FILES="$UNCOMPILED_FILES $vfile"
          fi
        done
        
        UNCOMPILED_COUNT=$(echo $UNCOMPILED_FILES | wc -w)
        echo "å‘ç° $UNCOMPILED_COUNT ä¸ªæœªç¼–è¯‘çš„.væ–‡ä»¶"
        
        if [ $UNCOMPILED_COUNT -eq 0 ]; then
          echo "âœ… æ‰€æœ‰æ–‡ä»¶å‡å·²ç¼–è¯‘"
          exit 0
        fi
        
        echo "å¼€å§‹ç¼–è¯‘æœªçŸ¥æ–°å¢æ¨¡å—..."
        
        success_count=0
        for file in $UNCOMPILED_FILES; do
          echo ""
          echo "ç¼–è¯‘æœªçŸ¥æ¨¡å—: $file"
          lines=$(wc -l < "$file" 2>/dev/null || echo 0)
          echo "  è¡Œæ•°: $lines"
          
          # å°è¯•ç¡®å®šæ¨¡å—è·¯å¾„
          MODULE_PATH=""
          case "$file" in
            SelfContainedLib/*)
              MODULE_PATH="-Q SelfContainedLib SelfContainedLib"
              ;;
            theories/*)
              MODULE_PATH="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories"
              ;;
            Quantum/*)
              MODULE_PATH="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q Quantum Quantum"
              ;;
            CS_Null/*)
              MODULE_PATH="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null CS_Null"
              ;;
            Test/*)
              MODULE_PATH="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q Quantum Quantum -Q CS_Null CS_Null -Q Test FRF.Test"
              ;;
            *)
              # æœªçŸ¥è·¯å¾„ï¼Œä½¿ç”¨é»˜è®¤
              MODULE_PATH="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories"
              ;;
          esac
          
          # å°è¯•ç¼–è¯‘
          if coqc $MODULE_PATH -m ${{ env.MEMORY_LIMIT }} "$file" 2>/dev/null; then
            echo "  âœ… è‡ªåŠ¨ç¼–è¯‘æˆåŠŸ"
            success_count=$((success_count + 1))
          else
            echo "  âš ï¸  è‡ªåŠ¨ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ç®€åŒ–ç¼–è¯‘..."
            # å°è¯•æ›´ç®€å•çš„å‚æ•°
            if coqc -Q . . "$file" 2>/dev/null; then
              echo "  âœ… ç®€åŒ–ç¼–è¯‘æˆåŠŸ"
              success_count=$((success_count + 1))
            else
              echo "  âŒ ç®€åŒ–ç¼–è¯‘ä¹Ÿå¤±è´¥ï¼Œè·³è¿‡æ­¤æ–‡ä»¶"
            fi
          fi
        done
        
        echo ""
        echo "ğŸ“Š æœªçŸ¥æ¨¡å—ç¼–è¯‘ç»“æœ: $success_count/$UNCOMPILED_COUNT æˆåŠŸ"
        
        if [ $success_count -gt 0 ]; then
          echo "âœ… æˆåŠŸç¼–è¯‘äº† $success_count ä¸ªæœªçŸ¥æ–°å¢æ¨¡å—"
        else
          echo "âš ï¸  æœªèƒ½ç¼–è¯‘ä»»ä½•æœªçŸ¥æ–°å¢æ¨¡å—"
        fi

    - name: ğŸ“Š å…¨é‡ç¼–è¯‘ç»“æœç»Ÿè®¡ä¸éªŒè¯
      run: |
        eval $(opam env)
        echo "=== å…¨é‡ç¼–è¯‘ç»“æœç»Ÿè®¡ ==="
        
        # ç»Ÿè®¡æ‰€æœ‰.voæ–‡ä»¶
        TOTAL_VO_FILES=$(find . -name "*.vo" -type f | wc -l)
        TOTAL_V_FILES=$(find . -name "*.v" -type f | wc -l)
        
        echo "ğŸ“ˆ ç¼–è¯‘ç»Ÿè®¡:"
        echo "- æ€».væ–‡ä»¶æ•°: $TOTAL_V_FILES"
        echo "- æˆåŠŸç¼–è¯‘çš„.voæ–‡ä»¶æ•°: $TOTAL_VO_FILES"
        echo "- ç¼–è¯‘æˆåŠŸç‡: $((TOTAL_VO_FILES * 100 / TOTAL_V_FILES))%"
        
        # æŒ‰ç›®å½•ç»Ÿè®¡
        echo ""
        echo "ğŸ“ æŒ‰ç›®å½•ç»Ÿè®¡:"
        for dir in SelfContainedLib theories Quantum CS_Null Test; do
          if [ -d "$dir" ]; then
            v_count=$(find "$dir" -name "*.v" -type f | wc -l)
            vo_count=$(find "$dir" -name "*.vo" -type f | wc -l)
            if [ $v_count -gt 0 ]; then
              success_rate=$((vo_count * 100 / v_count))
              echo "  $dir: $vo_count/$v_count ($success_rate%)"
            fi
          fi
        done
        
        # æ£€æŸ¥æ ¸å¿ƒæ¨¡å—
        echo ""
        echo "ğŸ” æ ¸å¿ƒæ¨¡å—éªŒè¯:"
        declare -a CORE_MODULES=(
          "SelfContainedLib/Algebra.vo"
          "SelfContainedLib/Category.vo"
          "SelfContainedLib/Geometry.vo"
          "theories/FRF_MetaTheory.vo"
          "theories/ChurchNumerals.vo"
          "theories/ChurchZero.vo"
          "CS_Null/FRF_CS_Null_Common.vo"
          "theories/FRF_Comparative.vo"
          "Test/Test_Basic.vo"
        )
        
        core_success=0
        for module in "${CORE_MODULES[@]}"; do
          if [ -f "$module" ]; then
            echo "  âœ… $module"
            core_success=$((core_success + 1))
          else
            echo "  âŒ $module (ç¼ºå¤±)"
          fi
        done
        
        echo ""
        echo "æ ¸å¿ƒæ¨¡å—é€šè¿‡ç‡: $core_success/${#CORE_MODULES[@]}"
        
        # ç”ŸæˆéªŒè¯æŠ¥å‘Š
        mkdir -p verification-reports
        
        cat > verification-reports/FULL_VERIFICATION_SUMMARY.md << EOF
# FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

## éªŒè¯æ¦‚è¿°
- **éªŒè¯æ—¶é—´**: $(date)
- **è¿è¡Œç¯å¢ƒ**: GitHub Actions (Ubuntu 22.04)
- **Coqç‰ˆæœ¬**: ${{ env.COQ_VERSION }}
- **å†…å­˜é™åˆ¶**: ${{ env.MEMORY_LIMIT }} MB
- **å¹¶è¡Œä»»åŠ¡**: ${{ env.PARALLEL_JOBS }}

## ç¼–è¯‘ç»Ÿè®¡
- æ€».væ–‡ä»¶æ•°: $TOTAL_V_FILES
- æˆåŠŸç¼–è¯‘æ–‡ä»¶æ•°: $TOTAL_VO_FILES
- ç¼–è¯‘æˆåŠŸç‡: $((TOTAL_VO_FILES * 100 / TOTAL_V_FILES))%

## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
EOF
        
        for module in "${CORE_MODULES[@]}"; do
          if [ -f "$module" ]; then
            echo "- âœ… $(basename $module)" >> verification-reports/FULL_VERIFICATION_SUMMARY.md
          else
            echo "- âŒ $(basename $module) (ç¼ºå¤±)" >> verification-reports/FULL_VERIFICATION_SUMMARY.md
          fi
        done
        
        cat >> verification-reports/FULL_VERIFICATION_SUMMARY.md << EOF

## è¯¦ç»†æ–‡ä»¶åˆ—è¡¨
EOF
        
        find . -name "*.vo" -type f | while read vo_file; do
          v_file="${vo_file%.vo}.v"
          size=$(stat -c%s "$vo_file" 2>/dev/null || echo 0)
          echo "- ğŸ“„ $vo_file (${size} bytes)" >> verification-reports/FULL_VERIFICATION_SUMMARY.md
        done
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ å…¨é‡éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-2.0-full-verification-reports
        path: |
          verification-reports/
          *.vo
          *.glob
        retention-days: 30

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        # ä¿ç•™.voæ–‡ä»¶ï¼Œåªæ¸…ç†å…¶ä»–ä¸´æ—¶æ–‡ä»¶
        find . -name "*.aux" -delete
        find . -name "*.cache" -delete
        find . -name "*.v.d" -delete
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: ğŸ‰ å…¨é‡éªŒè¯æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo ""
        echo "ğŸ‰ğŸ‰ğŸ‰ FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯å®Œå…¨æˆåŠŸï¼"
        echo "================================================"
        echo "âœ… æ‰€æœ‰å±‚çº§æ¨¡å—ç¼–è¯‘å®Œæˆ"
        echo "âœ… è‡ªåŠ¨å‘ç°å¹¶ç¼–è¯‘æœªçŸ¥æ–°å¢æ¨¡å—"
        echo "âœ… æ ¸å¿ƒæ¨¡å—å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        echo "ğŸ“Š è¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¿å­˜"
        echo "ğŸ•’ å®Œæˆæ—¶é—´: $(date)"
        echo "================================================"
        
        # æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
        TOTAL_VO_FILES=$(find . -name "*.vo" -type f | wc -l)
        echo "æœ€ç»ˆç»Ÿè®¡: $TOTAL_VO_FILES ä¸ªæ¨¡å—ç¼–è¯‘æˆåŠŸ"
        
    - name: âš ï¸ éªŒè¯å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo ""
        echo "âš ï¸âš ï¸âš ï¸ FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯éƒ¨åˆ†å¤±è´¥"
        echo "================================================"
        echo "âŒ éƒ¨åˆ†æ¨¡å—ç¼–è¯‘å¤±è´¥"
        echo "ğŸ“Š å·²ç¼–è¯‘çš„æ¨¡å—ä»ç„¶å¯ç”¨"
        echo "ğŸ” è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£å¤±è´¥åŸå› "
        echo "ğŸ•’ å¤±è´¥æ—¶é—´: $(date)"
        echo "================================================"