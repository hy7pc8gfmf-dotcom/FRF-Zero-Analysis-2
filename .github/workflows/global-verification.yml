name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', '_CoqProject', 'Makefile' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 180
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
    steps:
      # æ­¥éª¤1ï¼šä¿®å¤ä¸´æ—¶ç›®å½•æƒé™ï¼ˆæå‰åˆ›å»ºï¼Œé¿å…åç»­æŠ¥é”™ï¼‰
      - name: åˆå§‹åŒ–åŸºç¡€ç›®å½•
        run: |
          mkdir -p ${{ env.REPORT_DIR }} ~/.opam ~/.cache/opam
          chmod -R 777 ~/.opam ~/.cache/opam ${{ github.workspace }}
          echo "âœ… åŸºç¡€ç›®å½•åˆå§‹åŒ–+æƒé™ä¿®å¤å®Œæˆ"

      # æ­¥éª¤2ï¼šæ£€å‡ºä»£ç ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œå¿…é¡»åœ¨æƒé™ä¿®å¤åã€ä¾èµ–å®‰è£…å‰ï¼‰
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'

      # æ­¥éª¤3ï¼šç¼“å­˜ä¼˜åŒ–ï¼ˆå‡å°‘é‡å¤å®‰è£…ï¼ŒåŠ é€Ÿæµç¨‹ï¼‰
      - name: ç¼“å­˜ä¾èµ–ä¸ç¼–è¯‘äº§ç‰©
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            _build
            **/*.vo
            **/*.glob
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-

      # æ­¥éª¤4ï¼šå®‰è£…ä¾èµ–ï¼ˆæç®€æ ‡å‡†å†™æ³•ï¼Œé¿å…Shellå…¼å®¹æ€§é—®é¢˜ï¼‰
      - name: é…ç½®opam+å®‰è£…ä¾èµ–
        shell: bash
        run: |
          # åˆå§‹åŒ–opamï¼ˆæ ‡å‡†å†™æ³•ï¼Œæ— å†—ä½™å‚æ•°ï¼‰
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)
          
          # é…ç½®Coqä»“åº“ï¼ˆç›´æ¥ç”¨å®˜æ–¹æºï¼Œé¿å…é•œåƒæºé—®é¢˜ï¼‰
          opam repo add coq-released https://coq.inria.fr/opam/released --all-switches
          opam update -y
          
          # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆæŒ‡å®šç²¾ç¡®ç‰ˆæœ¬ï¼Œé¿å…ç‰ˆæœ¬æ¼‚ç§»ï¼‰
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-equations=1.3+8.18"
            "${{ env.COQ_EXTRA_OPAM }}"
          )
          opam install -y --jobs 2 "${required_pkgs[@]}"
          
          # å®‰è£…PythonæŠ¥å‘Šä¾èµ–
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --no-cache-dir reportlab==4.0.9
          
          # ç‰ˆæœ¬æ ¡éªŒï¼ˆç¡®ä¿ä¾èµ–æ­£ç¡®å®‰è£…ï¼‰
          coqc --version | grep "${{ env.COQ_VERSION }}" || { echo "âŒ Coqç‰ˆæœ¬ä¸åŒ¹é…"; exit 1; }
          opam list | grep "coq-mathcomp-ssreflect.*${{ env.MATHCOMP_VERSION }}" || { echo "âŒ MathCompç‰ˆæœ¬ä¸åŒ¹é…"; exit 1; }
          echo "âœ… ä¾èµ–å®‰è£…+æ ¡éªŒå®Œæˆ"

      # æ­¥éª¤5ï¼šç”ŸæˆCoqProjectï¼ˆå…œåº•é…ç½®ï¼Œé¿å…ç¼ºå¤±ï¼‰
      - name: ç”Ÿæˆ/ä¿®å¤CoqProject
        shell: bash
        run: |
          # ä¼˜å…ˆä½¿ç”¨å·²æœ‰é…ç½®ï¼Œæ— åˆ™ç”Ÿæˆé»˜è®¤é…ç½®
          if [ ! -f "CoqProject" ] && [ ! -f "_CoqProject" ]; then
            cat > CoqProject <<EOF
-R theories FRF.Theories
-R lib FRF.Lib
-R extensions FRF.Extensions
-arg -w -arg -notation-overridden
EOF
            # æ·»åŠ æ‰€æœ‰.væ–‡ä»¶åˆ°CoqProject
            find theories lib extensions -name "*.v" -type f >> CoqProject
            echo "âœ… ç”Ÿæˆé»˜è®¤CoqProjecté…ç½®"
          fi
          # ç»Ÿä¸€ä½¿ç”¨CoqProjectæ–‡ä»¶å
          [ -f "_CoqProject" ] && mv _CoqProject CoqProject
          echo "=== CoqProjecté…ç½® ==="
          head -n 10 CoqProject

      # æ­¥éª¤6ï¼šç”ŸæˆMakefileï¼ˆæç®€å‘½ä»¤ï¼Œé¿å…å‚æ•°è§£æé”™è¯¯ï¼‰
      - name: ç”ŸæˆéªŒè¯Makefile
        shell: bash
        run: |
          eval $(opam env --switch=default)
          # ç›´æ¥è°ƒç”¨coq_makefileï¼Œä»…ä¿ç•™å¿…è¦å‚æ•°
          coq_makefile -f CoqProject -o Makefile
          
          # è¡¥å…¨allç›®æ ‡ï¼ˆæ ‡å‡†Makefileè¯­æ³•ï¼Œæ— è½¬ä¹‰é—®é¢˜ï¼‰
          if ! grep -q "all:" Makefile; then
            echo -e "all: Makefile.coq\n\t\$(MAKE) -f Makefile.coq all" >> Makefile
          fi
          
          echo "âœ… Makefileç”Ÿæˆå®Œæˆ"
          grep -E "^all:|^[[:space:]]+\\\$(MAKE)" Makefile  # éªŒè¯Makefileé…ç½®

      # æ­¥éª¤7ï¼šæ‰§è¡Œå½¢å¼åŒ–éªŒè¯ï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
      - name: ç¼–è¯‘éªŒè¯æ‰€æœ‰æ¨¡å—
        shell: bash
        run: |
          eval $(opam env --switch=default)
          source .venv/bin/activate
          
          # å¹¶è¡Œç¼–è¯‘ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} VERBOSE=1 2>&1 | tee ${{ env.REPORT_DIR }}/compile.log
          
          # æ£€æŸ¥ç¼–è¯‘äº§ç‰©ï¼ˆåªæ ¡éªŒCoqProjectä¸­çš„.væ–‡ä»¶ï¼‰
          failed=0
          while IFS= read -r vfile; do
            [ -z "$vfile" ] && continue
            [[ "$vfile" == -* ]] && continue
            vofile="${vfile%.v}.vo"
            if [ ! -f "$vofile" ]; then
              echo "âŒ ç¼ºå¤±ç¼–è¯‘äº§ç‰©ï¼š$vofile"
              failed=1
            fi
          done < CoqProject
          
          if [ $failed -eq 1 ]; then
            echo "âŒ éƒ¨åˆ†æ¨¡å—ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æ¨¡å—ç¼–è¯‘å®Œæˆ"

      # æ­¥éª¤8ï¼šå…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒ
      - name: é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥
        shell: bash
        run: |
          eval $(opam env --switch=default)
          # è°ƒç”¨coqchkï¼ŒæŒ‡å®šé€»è¾‘è·¯å¾„
          coqchk -silent -R theories FRF.Theories -R lib FRF.Lib -R extensions FRF.Extensions $(find theories lib extensions -name "*.vo") 2>&1 | tee ${{ env.REPORT_DIR }}/coqchk.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          echo "âœ… é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"

      # æ­¥éª¤9ï¼šç”ŸæˆéªŒè¯æŠ¥å‘Š
      - name: ç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Š
        shell: bash
        run: |
          source .venv/bin/activate
          total=$(grep -E '^[^#-].*\.v$' CoqProject | wc -l)
          success=$(find theories lib extensions -name "*.vo" | wc -l)
          
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md <<EOF
# FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š
## éªŒè¯ç¯å¢ƒ
- å®¹å™¨é•œåƒï¼šcoqorg/coq:${{ env.COQ_VERSION }}
- MathCompç‰ˆæœ¬ï¼š${{ env.MATHCOMP_VERSION }}
- ç¼–è¯‘æ ¸å¿ƒæ•°ï¼š$(nproc)
- è§¦å‘äº‹ä»¶ï¼š${{ github.event_name }}
- æäº¤å“ˆå¸Œï¼š${{ github.sha }}

## éªŒè¯ç»“æœ
- æ€»æ¨¡å—æ•°ï¼š$total
- æˆåŠŸç¼–è¯‘ï¼š$success
- é€»è¾‘ä¸€è‡´æ€§ï¼šâœ… æ ¡éªŒé€šè¿‡

## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
EOF
          
          core_modules=(
            "theories/FRF_MetaTheory.vo"
            "lib/Algebra.vo"
            "extensions/Quantum/QFT_FRF.vo"
          )
          for mod in "${core_modules[@]}"; do
            if [ -f "$mod" ]; then
              echo "- âœ… $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "- âŒ $modï¼ˆç¼ºå¤±ï¼‰" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done
          
          echo -e "\n## æ—¥å¿—æ–‡ä»¶" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [ç¼–è¯‘æ—¥å¿—](compile.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [é€»è¾‘æ ¡éªŒæ—¥å¿—](coqchk.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      # æ­¥éª¤10ï¼šå½’æ¡£äº§ç‰©ï¼ˆæ–¹ä¾¿æ’æŸ¥é”™è¯¯ï¼‰
      - name: å½’æ¡£éªŒè¯ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            **/*.vo
            **/*.glob
            Makefile
            CoqProject
          retention-days: 90

      # å¤±è´¥é€šçŸ¥
      - name: éªŒè¯å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯å¤±è´¥"
          echo "ğŸ“Œ æ’æŸ¥æ–¹å‘ï¼š"
          echo "1. æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—ï¼šæ˜¯å¦æœ‰æ¨¡å—ç¼–è¯‘æŠ¥é”™"
          echo "2. æŸ¥çœ‹CoqProjectï¼šæ˜¯å¦è·¯å¾„é…ç½®é”™è¯¯"
          echo "3. æŸ¥çœ‹ä¾èµ–æ—¥å¿—ï¼šæ˜¯å¦ä¾èµ–å®‰è£…ä¸å®Œæ•´"