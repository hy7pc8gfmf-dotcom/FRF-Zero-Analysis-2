name: FRF 2.0 å…¨é‡å¹¶è¡Œå½¢å¼åŒ–éªŒè¯

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      parallel_level:
        description: 'å¹¶è¡Œçº§åˆ« (1=ä¸²è¡Œ, 2=ä¸­ç­‰å¹¶è¡Œ, 3=å®Œå…¨å¹¶è¡Œ)'
        required: false
        default: '2'
      memory_limit:
        description: 'å†…å­˜é™åˆ¶ (MB)'
        required: false
        default: '8192'

jobs:
  full-formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        parallel_level: [2]
    env:
      PARALLEL_LEVEL: ${{ github.event.inputs.parallel_level || matrix.parallel_level }}
      MEMORY_LIMIT: ${{ github.event.inputs.memory_limit || 8192 }}
      
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false
        
    - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        echo "ç³»ç»Ÿ: $(uname -a)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        echo "å¯ç”¨CPUæ ¸å¿ƒ: ${{ env.PARALLEL_LEVEL }}"
        echo "å†…å­˜é™åˆ¶: ${{ env.MEMORY_LIMIT }}MB"
        echo "ç‰©ç†å†…å­˜:"
        free -m
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo "å·¥ä½œç›®å½•ç»“æ„:"
        find . -name "*.v" -type f | head -20

    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          bc \
          python3-pip
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”„ åˆå§‹åŒ–OPAMç¯å¢ƒ
      timeout-minutes: 25
      run: |
        echo "åˆå§‹åŒ–OPAMç¯å¢ƒ..."
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "OPAMç‰ˆæœ¬: $(opam --version)"

    - name: ğŸ“š å®‰è£…Coqæ ¸å¿ƒåŠä¾èµ–
      timeout-minutes: 40
      run: |
        eval $(opam env)
        echo "å®‰è£…Coq 8.18.0åŠæ ¸å¿ƒä¾èµ–..."
        
        opam install -y --no-depexts \
          coq.8.18.0 \
          coq-stdlib \
          coq-flocq \
          coq-bignums \
          coq-mathcomp-ssreflect.1.17.0
        
        echo "éªŒè¯å®‰è£…..."
        if coqc --version | grep -q "8.18.0"; then
          echo "âœ… Coq 8.18.0 å®‰è£…æˆåŠŸ"
        else
          echo "âŒ Coqç‰ˆæœ¬ä¸åŒ¹é…"
          exit 1
        fi

        echo "å·²å®‰è£…åŒ…åˆ—è¡¨:"
        opam list --installed --short | grep -E "coq|mathcomp" | sort

    - name: ğŸ“ é¡¹ç›®ç»“æ„éªŒè¯
      run: |
        echo "=== é¡¹ç›®ç»“æ„éªŒè¯ ==="
        echo "æ€».væ–‡ä»¶æ•°é‡: $(find . -name "*.v" -type f | wc -l)"
        echo "æŒ‰ç›®å½•ç»Ÿè®¡:"
        for dir in SelfContainedLib theories Quantum CS_Null Test; do
          count=$(find "$dir" -name "*.v" -type f 2>/dev/null | wc -l)
          echo "  $dir/: $count ä¸ªæ–‡ä»¶"
        done

    - name: ğŸ”§ é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "é…ç½®ç¼–è¯‘ç¯å¢ƒ..."
        eval $(opam env)
        
        # åˆ›å»ºç¼–è¯‘è„šæœ¬è€Œä¸æ˜¯Makefileç‰‡æ®µ
        cat > compile_base.sh << 'EOF'
#!/bin/bash
echo "å¹¶è¡Œç¼–è¯‘åŸºç¡€åº“..."
BASE_FILES="SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v"
for file in $BASE_FILES; do
    echo "ç¼–è¯‘: $(basename $file)"
    coqc -Q SelfContainedLib SelfContainedLib "$file" &
done
wait
echo "åŸºç¡€åº“ç¼–è¯‘å®Œæˆ"
EOF
        
        chmod +x compile_base.sh
        echo "âœ… ç¼–è¯‘è„šæœ¬ç”Ÿæˆå®Œæˆ"

    - name: ğŸ—ï¸ ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘è‡ªåŒ…å«åŸºç¡€åº“
      timeout-minutes: 25
      run: |
        echo "=== ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘è‡ªåŒ…å«åŸºç¡€åº“ ==="
        eval $(opam env)
        
        echo "æ£€æµ‹æ–‡ä»¶å¤§å°..."
        BASE_FILES="SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v"
        
        for file in $BASE_FILES; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  $(basename $file): $lines è¡Œ"
          fi
        done
        
        echo "å¼€å§‹ç¼–è¯‘..."
        # é¡ºåºç¼–è¯‘ï¼Œé¿å…å¹¶è¡Œé—®é¢˜
        for file in $BASE_FILES; do
          if [ -f "$file" ]; then
            echo "ç¼–è¯‘: $(basename $file)"
            coqc -Q SelfContainedLib SelfContainedLib "$file"
          fi
        done
        
        echo "éªŒè¯ç¼–è¯‘ç»“æœ..."
        success=0
        for file in $BASE_FILES; do
          vo_file="${file%.v}.vo"
          if [ -f "$vo_file" ]; then
            echo "  âœ… $(basename $vo_file) ç”ŸæˆæˆåŠŸ"
            success=$((success+1))
          else
            echo "  âŒ $(basename $vo_file) ç”Ÿæˆå¤±è´¥"
          fi
        done
        
        if [ $success -eq 3 ]; then
          echo "ğŸ‰ åŸºç¡€åº“å…¨éƒ¨ç¼–è¯‘æˆåŠŸ"
        else
          echo "âš ï¸  åŸºç¡€åº“ç¼–è¯‘éƒ¨åˆ†å¤±è´¥ ($success/3)"
        fi

    - name: ğŸ—ï¸ ç¬¬äºŒæ­¥ï¼šç¼–è¯‘FRFå…ƒç†è®ºå±‚
      timeout-minutes: 30
      run: |
        echo "=== ç¬¬äºŒæ­¥ï¼šç¼–è¯‘FRFå…ƒç†è®ºå±‚ ==="
        eval $(opam env)
        
        FRF_FILES="theories/FRF_MetaTheory.v theories/ChurchZero.v theories/ChurchNumerals.v"
        
        echo "æ£€æµ‹å¤§æ–‡ä»¶..."
        for file in $FRF_FILES; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  $(basename $file): $lines è¡Œ"
          fi
        done
        
        echo "å¼€å§‹ç¼–è¯‘..."
        for file in $FRF_FILES; do
          if [ -f "$file" ]; then
            echo "ç¼–è¯‘: $(basename $file)"
            coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories "$file"
          fi
        done
        
        echo "éªŒè¯ç¼–è¯‘ç»“æœ..."
        success=0
        for file in $FRF_FILES; do
          vo_file="${file%.v}.vo"
          if [ -f "$vo_file" ]; then
            echo "  âœ… $(basename $vo_file) ç”ŸæˆæˆåŠŸ"
            success=$((success+1))
          else
            echo "  âŒ $(basename $vo_file) ç”Ÿæˆå¤±è´¥"
          fi
        done

    - name: ğŸ—ï¸ ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘æ•°å­¦åœºæ™¯å±‚
      timeout-minutes: 35
      run: |
        echo "=== ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘æ•°å­¦åœºæ™¯å±‚ ==="
        eval $(opam env)
        
        SCENE_FILES="theories/CaseA_SetTheory.v theories/CaseB_Algebra.v theories/CaseC_TypeTheory.v theories/CaseD_CategoryTheory.v"
        
        echo "ç¼–è¯‘æ•°å­¦åœºæ™¯..."
        for file in $SCENE_FILES; do
          if [ -f "$file" ]; then
            echo "ç¼–è¯‘: $(basename $file)"
            coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories "$file"
          fi
        done
        
        # é‡å­çœŸç©ºæ€åœºæ™¯
        if [ -f "Quantum/CaseE_QuantumVacuum.v" ]; then
          echo "ç¼–è¯‘é‡å­åœºæ™¯: CaseE_QuantumVacuum.v"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q Quantum FRF.Quantum "Quantum/CaseE_QuantumVacuum.v"
        fi
        
        echo "éªŒè¯æ•°å­¦åœºæ™¯ç¼–è¯‘..."
        success=0
        total=0
        for file in $SCENE_FILES; do
          total=$((total+1))
          vo_file="${file%.v}.vo"
          if [ -f "$vo_file" ]; then
            echo "  âœ… $(basename $vo_file) ç”ŸæˆæˆåŠŸ"
            success=$((success+1))
          fi
        done
        
        echo "æ•°å­¦åœºæ™¯ç¼–è¯‘: $success/$total æˆåŠŸ"

    - name: ğŸ—ï¸ ç¬¬å››æ­¥ï¼šç¼–è¯‘æ‰©å±•æ¨¡å—
      timeout-minutes: 40
      run: |
        echo "=== ç¬¬å››æ­¥ï¼šç¼–è¯‘æ‰©å±•æ¨¡å— ==="
        eval $(opam env)
        
        # é‡å­æ¨¡å—
        if [ -f "Quantum/QFT_FRF.v" ]; then
          echo "ç¼–è¯‘é‡å­æ¨¡å—: QFT_FRF.v"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q Quantum FRF.Quantum "Quantum/QFT_FRF.v"
        fi
        
        if [ -f "Quantum/CurvedSpacetimeQFT.v" ]; then
          echo "ç¼–è¯‘é‡å­æ¨¡å—: CurvedSpacetimeQFT.v"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q Quantum FRF.Quantum "Quantum/CurvedSpacetimeQFT.v"
        fi
        
        # ç©ºå€¼ç³»ç»ŸåŸºç¡€
        if [ -f "CS_Null/FRF_CS_Null_Common.v" ]; then
          echo "ç¼–è¯‘ç©ºå€¼ç³»ç»ŸåŸºç¡€: FRF_CS_Null_Common.v"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null "CS_Null/FRF_CS_Null_Common.v"
        fi
        
        # ç©ºå€¼ç³»ç»Ÿé›†æˆ
        if [ -f "CS_Null/FRF_CS_Null.v" ]; then
          echo "ç¼–è¯‘: FRF_CS_Null.v"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null "CS_Null/FRF_CS_Null.v"
        fi
        
        # è¯­è¨€ç©ºå€¼æ¨¡å—
        LANGUAGE_FILES="CS_Null/CxxNull.v CS_Null/PythonNull.v CS_Null/JavaNull.v CS_Null/MathNull.v CS_Null/RustNull.v"
        for file in $LANGUAGE_FILES; do
          if [ -f "$file" ]; then
            echo "ç¼–è¯‘è¯­è¨€æ¨¡å—: $(basename $file)"
            coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null "$file"
          fi
        done

    - name: ğŸ—ï¸ ç¬¬äº”æ­¥ï¼šç¼–è¯‘é›†æˆæ¨¡å—
      timeout-minutes: 30
      run: |
        echo "=== ç¬¬äº”æ­¥ï¼šç¼–è¯‘é›†æˆæ¨¡å— ==="
        eval $(opam env)
        
        if [ -f "theories/FRF_Comparative.v" ]; then
          echo "ç¼–è¯‘é›†æˆæ¨¡å—: FRF_Comparative.v"
          echo "è¿™æ˜¯å¤§æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´..."
          
          lines=$(wc -l < "theories/FRF_Comparative.v" 2>/dev/null || echo 0)
          echo "æ–‡ä»¶å¤§å°: $lines è¡Œ"
          
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories "theories/FRF_Comparative.v"
          
          if [ -f "theories/FRF_Comparative.vo" ]; then
            echo "âœ… FRF_Comparative ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ FRF_Comparative ç¼–è¯‘å¤±è´¥"
          fi
        fi

    - name: ğŸ—ï¸ ç¬¬å…­æ­¥ï¼šç¼–è¯‘æµ‹è¯•å¥—ä»¶
      timeout-minutes: 35
      run: |
        echo "=== ç¬¬å…­æ­¥ï¼šç¼–è¯‘æµ‹è¯•å¥—ä»¶ ==="
        eval $(opam env)
        
        # æŸ¥æ‰¾æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
        TEST_FILES=$(find Test -name "*.v" -type f 2>/dev/null)
        
        if [ -z "$TEST_FILES" ]; then
          echo "æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶ï¼Œæ£€æŸ¥Testç›®å½•..."
          ls -la Test/ 2>/dev/null || echo "Testç›®å½•ä¸å­˜åœ¨"
          TEST_FILES="Test/Test_Basic.v"
        fi
        
        echo "æ‰¾åˆ°æµ‹è¯•æ–‡ä»¶:"
        for file in $TEST_FILES; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "  $(basename $file): $lines è¡Œ"
          fi
        done
        
        echo "å¼€å§‹ç¼–è¯‘æµ‹è¯•..."
        success=0
        total=0
        for file in $TEST_FILES; do
          if [ -f "$file" ]; then
            total=$((total+1))
            echo "ç¼–è¯‘æµ‹è¯•: $(basename $file)"
            if coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q Test FRF.Test "$file"; then
              vo_file="${file%.v}.vo"
              if [ -f "$vo_file" ]; then
                echo "  âœ… $(basename $vo_file) ç”ŸæˆæˆåŠŸ"
                success=$((success+1))
              fi
            else
              echo "  âŒ $(basename $file) ç¼–è¯‘å¤±è´¥"
            fi
          fi
        done
        
        echo "æµ‹è¯•ç¼–è¯‘å®Œæˆ: $success/$total æˆåŠŸ"

    - name: ğŸ“Š å…¨é‡ç¼–è¯‘ç»Ÿè®¡æŠ¥å‘Š
      run: |
        echo "=== å…¨é‡ç¼–è¯‘ç»Ÿè®¡æŠ¥å‘Š ==="
        
        echo "ç”Ÿæˆçš„.voæ–‡ä»¶:"
        find . -name "*.vo" -type f | while read vo_file; do
          size=$(stat -c%s "$vo_file" 2>/dev/null || echo 0)
          echo "  ğŸ“„ $vo_file (${size} bytes)"
        done
        
        total_vo=$(find . -name "*.vo" -type f | wc -l)
        echo ""
        echo "ğŸ“ˆ ç¼–è¯‘ç»Ÿè®¡:"
        echo "æ€»è®¡: $total_vo ä¸ª.voæ–‡ä»¶ç”Ÿæˆ"
        
        # æ£€æŸ¥å¤§æ–‡ä»¶ç¼–è¯‘æƒ…å†µ
        echo ""
        echo "ğŸ” å¤§æ–‡ä»¶ç¼–è¯‘æ£€æŸ¥:"
        huge_files=(
          "SelfContainedLib/Geometry.vo"
          "theories/FRF_MetaTheory.vo"
          "theories/ChurchNumerals.vo"
          "CS_Null/FRF_CS_Null_Common.vo"
          "theories/FRF_Comparative.vo"
        )
        
        for file in "${huge_files[@]}"; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            echo "  âœ… $(basename $file) (${size} bytes)"
          else
            echo "  âŒ $(basename $file) (ç¼ºå¤±)"
          fi
        done

    - name: ğŸ“„ ç”ŸæˆéªŒè¯æŠ¥å‘Š
      run: |
        echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
        
        mkdir -p verification-reports
        
        COQ_VERSION=$(coqc --version 2>/dev/null | head -1 || echo "æœªçŸ¥")
        
        echo "# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š" > verification-reports/VERIFICATION_REPORT.md
        echo "" >> verification-reports/VERIFICATION_REPORT.md
        echo "## éªŒè¯ä¿¡æ¯" >> verification-reports/VERIFICATION_REPORT.md
        echo "- **éªŒè¯æ—¶é—´**: $(date)" >> verification-reports/VERIFICATION_REPORT.md
        echo "- **è¿è¡Œç¯å¢ƒ**: GitHub Actions (Ubuntu 22.04)" >> verification-reports/VERIFICATION_REPORT.md
        echo "- **Coqç‰ˆæœ¬**: $COQ_VERSION" >> verification-reports/VERIFICATION_REPORT.md
        echo "- **å¹¶è¡Œçº§åˆ«**: ${{ env.PARALLEL_LEVEL }}" >> verification-reports/VERIFICATION_REPORT.md
        echo "- **å†…å­˜é™åˆ¶**: ${{ env.MEMORY_LIMIT }} MB" >> verification-reports/VERIFICATION_REPORT.md
        echo "" >> verification-reports/VERIFICATION_REPORT.md
        
        echo "## ç¼–è¯‘ç»“æœ" >> verification-reports/VERIFICATION_REPORT.md
        echo "| æ¨¡å— | çŠ¶æ€ | æ–‡ä»¶å¤§å° |" >> verification-reports/VERIFICATION_REPORT.md
        echo "|------|------|----------|" >> verification-reports/VERIFICATION_REPORT.md
        
        total_vo=0
        for vo_file in $(find . -name "*.vo" -type f); do
          total_vo=$((total_vo + 1))
          size=$(stat -c%s "$vo_file" 2>/dev/null || echo 0)
          echo "| $(basename $vo_file) | âœ… æˆåŠŸ | ${size} bytes |" >> verification-reports/VERIFICATION_REPORT.md
        done
        
        echo "" >> verification-reports/VERIFICATION_REPORT.md
        echo "## ç»Ÿè®¡æ‘˜è¦" >> verification-reports/VERIFICATION_REPORT.md
        echo "- **æ€».voæ–‡ä»¶æ•°**: $total_vo" >> verification-reports/VERIFICATION_REPORT.md
        
        if [ $total_vo -gt 10 ]; then
          echo "ğŸ‰ **FRF 2.0 éªŒè¯æˆåŠŸï¼**" >> verification-reports/VERIFICATION_REPORT.md
          echo "å¤§éƒ¨åˆ†æ¨¡å—ç¼–è¯‘é€šè¿‡ï¼ŒéªŒè¯åŸºæœ¬æˆåŠŸã€‚" >> verification-reports/VERIFICATION_REPORT.md
        elif [ $total_vo -gt 5 ]; then
          echo "âš ï¸ **FRF 2.0 éªŒè¯éƒ¨åˆ†æˆåŠŸ**" >> verification-reports/VERIFICATION_REPORT.md
          echo "éƒ¨åˆ†æ¨¡å—ç¼–è¯‘é€šè¿‡ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚" >> verification-reports/VERIFICATION_REPORT.md
        else
          echo "âŒ **FRF 2.0 éªŒè¯æœªé€šè¿‡**" >> verification-reports/VERIFICATION_REPORT.md
          echo "ç¼–è¯‘é€šè¿‡çš„æ¨¡å—è¾ƒå°‘ï¼Œéœ€è¦æ£€æŸ¥é—®é¢˜ã€‚" >> verification-reports/VERIFICATION_REPORT.md
        fi
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-2.0-verification-report
        path: verification-reports/
        retention-days: 30

    - name: ğŸ‰ éªŒè¯å®Œæˆæ€»ç»“
      if: always()
      run: |
        echo "=== FRF 2.0 éªŒè¯å®Œæˆ ==="
        echo "éªŒè¯æ—¶é—´: $(date)"
        echo "å¹¶è¡Œçº§åˆ«: ${{ env.PARALLEL_LEVEL }}"
        echo ""
        
        total_vo=$(find . -name "*.vo" -type f 2>/dev/null | wc -l)
        echo "ç”Ÿæˆçš„.voæ–‡ä»¶æ€»æ•°: $total_vo"
        
        if [ $total_vo -gt 10 ]; then
          echo "ğŸ‰ å¤§è§„æ¨¡éªŒè¯æˆåŠŸï¼"
          echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘é€šè¿‡"
          echo "ğŸ“Š éªŒè¯æŠ¥å‘Šå·²ä¿å­˜"
        elif [ $total_vo -gt 5 ]; then
          echo "âš ï¸  éªŒè¯ç»“æœéƒ¨åˆ†æˆåŠŸ"
          echo "ğŸ” è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—"
        else
          echo "âŒ éªŒè¯ç»“æœä¸ç†æƒ³"
          echo "ğŸ” è¯·æ£€æŸ¥ç¼–è¯‘é”™è¯¯"
        fi