name: FRF 2.0 æ™ºèƒ½å½¢å¼åŒ–éªŒè¯

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
      - 'Makefile'
      - '.github/workflows/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
      - 'Makefile'
  workflow_dispatch:
    inputs:
      verify_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - test-only
          - core-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•° (1-16)'
        required: false
        default: '4'
        type: string
      memory_limit:
        description: 'å†…å­˜é™åˆ¶ (MB)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - 2048
          - 4096
          - 8192
          - 16384

jobs:
  setup-environment:
    name: ðŸ—ï¸ çŽ¯å¢ƒé…ç½®
    runs-on: ubuntu-22.04
    outputs:
      coq_version: ${{ steps.detect-coq.outputs.version }}
      core_count: ${{ steps.detect-cpu.outputs.cores }}
      available_memory: ${{ steps.detect-memory.outputs.available_mb }}
      parallel_jobs: ${{ steps.calc-jobs.outputs.jobs }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ðŸ–¥ï¸ æ£€æµ‹CPUæ ¸å¿ƒ
        id: detect-cpu
        run: |
          CORES=$(nproc)
          echo "cores=$CORES" >> $GITHUB_OUTPUT
          echo "CPUæ ¸å¿ƒæ•°: $CORES"
          
      - name: ðŸ’¾ æ£€æµ‹å†…å­˜
        id: detect-memory
        run: |
          AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
          echo "available_mb=$AVAIL_MEM" >> $GITHUB_OUTPUT
          echo "å¯ç”¨å†…å­˜: ${AVAIL_MEM}MB"
          
      - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            opam \
            bubblewrap \
            m4 \
            git \
            wget \
            bc \
            graphviz \
            python3 \
            python3-pip \
            libgmp-dev \
            pkg-config \
            libssl-dev
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
          
      - name: ðŸ”„ åˆå§‹åŒ–OPAM
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          # åˆå§‹åŒ–OPAMï¼ˆç¦ç”¨æ²™ç›’ä»¥ä¾¿åœ¨CIä¸­ä½¿ç”¨ï¼‰
          opam init --disable-sandboxing -y --compiler=4.14.0
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          eval $(opam env)
          # æ·»åŠ Coqä»“åº“
          opam repo add coq-released https://coq.inria.fr/opam/released
          opam update
          echo "âœ… OPAMåˆå§‹åŒ–å®Œæˆ"
          
      - name: ðŸš é…ç½®OPAMçŽ¯å¢ƒ
        run: |
          echo 'eval $(opam env)' >> $HOME/.bashrc
          echo 'export PATH="$HOME/.opam/bin:$PATH"' >> $HOME/.bashrc
          
      - name: ðŸ” æ£€æµ‹Coqç‰ˆæœ¬
        id: detect-coq
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env 2>/dev/null || true)
          if command -v coqc >/dev/null 2>&1; then
            COQ_VERSION=$(coqc --version 2>/dev/null | head -1 | grep -o 'version [0-9.]\+' | cut -d' ' -f2 || echo "unknown")
          else
            COQ_VERSION="not_installed"
          fi
          echo "version=$COQ_VERSION" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°Coqç‰ˆæœ¬: $COQ_VERSION"
          
      - name: ðŸ§® è®¡ç®—å¹¶è¡Œä»»åŠ¡æ•°
        id: calc-jobs
        run: |
          # ä½¿ç”¨è¾“å…¥å‚æ•°æˆ–è‡ªåŠ¨è®¡ç®—
          if [ -n "${{ github.event.inputs.parallel_jobs }}" ] && [ "${{ github.event.inputs.parallel_jobs }}" != "" ]; then
            JOBS="${{ github.event.inputs.parallel_jobs }}"
          else
            # æ ¹æ®CPUæ ¸å¿ƒæ•°è®¡ç®—ï¼Œç•™å‡ºç³»ç»Ÿèµ„æº
            CORES=${{ steps.detect-cpu.outputs.cores }}
            JOBS=$((CORES > 4 ? CORES - 2 : CORES))
          fi
          echo "jobs=$JOBS" >> $GITHUB_OUTPUT
          echo "å¹¶è¡Œä»»åŠ¡æ•°: $JOBS"

  install-coq-dependencies:
    name: ðŸ“š å®‰è£…Coqä¾èµ–
    needs: setup-environment
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        coq-version: ['8.18.0']
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ðŸ”„ æ¢å¤OPAMç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.opam
            ~/.cache/opam
          key: ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-opam-${{ matrix.coq-version }}-
            
      - name: ðŸ”§ ç¡®ä¿OPAMçŽ¯å¢ƒ
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          # å¦‚æžœopamæœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–
          if [ ! -d "$HOME/.opam" ]; then
            echo "OPAMæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–..."
            opam init --disable-sandboxing -y --compiler=4.14.0
            eval $(opam env)
            opam repo add coq-released https://coq.inria.fr/opam/released
            opam update
          else
            echo "OPAMå·²åˆå§‹åŒ–ï¼ŒåŠ è½½çŽ¯å¢ƒ..."
            eval $(opam env)
          fi
          
      - name: ðŸ“Š å®‰è£…Coqæ ¸å¿ƒ
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "å®‰è£…Coq ${{ matrix.coq-version }}..."
          opam install -y coq.${{ matrix.coq-version }}
          
          echo "éªŒè¯Coqå®‰è£…..."
          coqc --version
          echo "âœ… Coqå®‰è£…æˆåŠŸ"
          
      - name: ðŸ§® å®‰è£…mathcomp
        run: |
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "å®‰è£…coq-mathcomp-ssreflect..."
          opam install -y coq-mathcomp-ssreflect
          
      - name: ðŸ“š å®‰è£…å…¶ä»–ä¾èµ–åº“
        run: |
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "å®‰è£…å¸¸ç”¨Coqåº“..."
          opam install -y \
            coq-mathcomp-analysis \
            coq-stdlib \
            coq-micromega \
            coq-bignums
          echo "âœ… æ‰€æœ‰ä¾èµ–åº“å®‰è£…å®Œæˆ"

  full-verification:
    name: ðŸ” å…¨é‡éªŒè¯æ¨¡å¼
    needs: [setup-environment, install-coq-dependencies]
    if: github.event.inputs.verify_mode == 'full' || (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    runs-on: ubuntu-22.04
    env:
      PARALLEL_JOBS: ${{ needs.setup-environment.outputs.parallel_jobs }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ðŸ”§ é…ç½®æž„å»ºçŽ¯å¢ƒ
        run: |
          echo "é…ç½®æž„å»ºçŽ¯å¢ƒ..."
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
          
          # è®¾ç½®å†…å­˜é™åˆ¶
          AVAIL_MEM=${{ needs.setup-environment.outputs.available_memory }}
          if [ "${{ github.event.inputs.memory_limit }}" != "auto" ]; then
            echo "COQ_MEMORY=${{ github.event.inputs.memory_limit }}" >> $GITHUB_ENV
          elif [ $AVAIL_MEM -gt 16000 ]; then
            echo "COQ_MEMORY=16384" >> $GITHUB_ENV
          elif [ $AVAIL_MEM -gt 8000 ]; then
            echo "COQ_MEMORY=8192" >> $GITHUB_ENV
          elif [ $AVAIL_MEM -gt 4000 ]; then
            echo "COQ_MEMORY=4096" >> $GITHUB_ENV
          else
            echo "COQ_MEMORY=2048" >> $GITHUB_ENV
          fi
          
      - name: ðŸ› ï¸ è¿è¡Œå®Œæ•´æž„å»º
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "å¼€å§‹å®Œæ•´æž„å»º..."
          echo "å¹¶è¡Œä»»åŠ¡: $PARALLEL_JOBS"
          echo "å†…å­˜é™åˆ¶: $COQ_MEMORY MB"
          
          # ä½¿ç”¨Makefileè¿›è¡Œå®Œæ•´æž„å»º
          make PARALLEL_JOBS=$PARALLEL_JOBS COQFLAGS="-m $COQ_MEMORY" all || make PARALLEL_JOBS=$PARALLEL_JOBS all
          
      - name: ðŸ“Š ç”ŸæˆéªŒè¯æŠ¥å‘Š
        run: |
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
          make report || echo "æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
          
      - name: ðŸ“ˆ æ”¶é›†æž„å»ºç»Ÿè®¡
        run: |
          echo "æ”¶é›†æž„å»ºç»Ÿè®¡ä¿¡æ¯..."
          make stats || echo "ç»Ÿè®¡ç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
          
      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frf2-build-artifacts
          path: |
            **/*.vo
            **/*.glob
            **/*.vok
            **/*.vos
            frf_report.json
            dependencies.*
          retention-days: 7

  quick-verification:
    name: âš¡ å¿«é€ŸéªŒè¯æ¨¡å¼
    needs: [setup-environment, install-coq-dependencies]
    if: github.event.inputs.verify_mode == 'quick' || github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    env:
      PARALLEL_JOBS: ${{ needs.setup-environment.outputs.parallel_jobs }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ðŸƒ è¿è¡Œå¿«é€ŸéªŒè¯
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "è¿è¡Œå¿«é€ŸéªŒè¯æ¨¡å¼..."
          echo "å¹¶è¡Œä»»åŠ¡: $PARALLEL_JOBS"
          
          # æ¸…ç†ä¹‹å‰çš„æž„å»º
          make clean || true
          
          # å¿«é€ŸéªŒè¯æ ¸å¿ƒæ¨¡å—
          make PARALLEL_JOBS=$PARALLEL_JOBS quick || make PARALLEL_JOBS=$PARALLEL_JOBS all
          
      - name: ðŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•
        run: |
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          make test-only || echo "æµ‹è¯•è¿è¡Œå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."

  core-only-verification:
    name: ðŸŽ¯ æ ¸å¿ƒéªŒè¯æ¨¡å¼
    needs: [setup-environment, install-coq-dependencies]
    if: github.event.inputs.verify_mode == 'core-only'
    runs-on: ubuntu-22.04
    env:
      PARALLEL_JOBS: ${{ needs.setup-environment.outputs.parallel_jobs }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ðŸŽ¯ ç¼–è¯‘æ ¸å¿ƒæ¨¡å—
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "ç¼–è¯‘æ ¸å¿ƒæ¨¡å—..."
          echo "å¹¶è¡Œä»»åŠ¡: $PARALLEL_JOBS"
          
          make PARALLEL_JOBS=$PARALLEL_JOBS core-base core-frf || make PARALLEL_JOBS=2 core-base
          
      - name: ðŸ“‹ éªŒè¯æ ¸å¿ƒåŠŸèƒ½
        run: |
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "éªŒè¯æ ¸å¿ƒåŠŸèƒ½..."
          
          # æ£€æŸ¥æ ¸å¿ƒæ¨¡å—æ˜¯å¦ç¼–è¯‘æˆåŠŸ
          if [ -f "SelfContainedLib/Algebra.vo" ] && \
             [ -f "SelfContainedLib/Geometry.vo" ] && \
             [ -f "SelfContainedLib/Category.vo" ] && \
             [ -f "theories/FRF_MetaTheory.vo" ]; then
            echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ æ ¸å¿ƒæ¨¡å—ç¼–è¯‘å¤±è´¥"
            # åˆ—å‡ºå·²ç¼–è¯‘çš„æ–‡ä»¶
            echo "å·²ç¼–è¯‘çš„æ–‡ä»¶:"
            find . -name "*.vo" -type f | head -20
            exit 1
          fi

  test-only-verification:
    name: ðŸ§ª æµ‹è¯•ä¸“ç”¨æ¨¡å¼
    needs: [setup-environment, install-coq-dependencies]
    if: github.event.inputs.verify_mode == 'test-only'
    runs-on: ubuntu-22.04
    env:
      PARALLEL_JOBS: ${{ needs.setup-environment.outputs.parallel_jobs }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ðŸ§¹ æ¸…ç†çŽ¯å¢ƒ
        run: |
          echo "æ¸…ç†æµ‹è¯•çŽ¯å¢ƒ..."
          make clean || true
          
      - name: ðŸ§ª ç¼–è¯‘æµ‹è¯•å¥—ä»¶
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env)
          echo "ç¼–è¯‘æµ‹è¯•å¥—ä»¶..."
          echo "å¹¶è¡Œä»»åŠ¡: $PARALLEL_JOBS"
          
          # å…ˆç¼–è¯‘å¿…è¦çš„ä¾èµ–
          make PARALLEL_JOBS=$PARALLEL_JOBS core-base core-frf || make PARALLEL_JOBS=2 core-base
          
          # ç¼–è¯‘æµ‹è¯•
          make PARALLEL_JOBS=$PARALLEL_JOBS tests || echo "æµ‹è¯•ç¼–è¯‘å¤±è´¥"
          
      - name: ðŸ“Š æµ‹è¯•ç»“æžœåˆ†æž
        run: |
          echo "åˆ†æžæµ‹è¯•ç»“æžœ..."
          
          TEST_FILES="Test/*.vo"
          TOTAL=0
          PASSED=0
          
          for file in $TEST_FILES 2>/dev/null; do
            if [ -f "$file" ]; then
              ((TOTAL++))
              BASE=$(basename "$file" .vo)
              if [ -f "Test/${BASE}.v" ]; then
                echo "âœ… $BASE ç¼–è¯‘æˆåŠŸ"
                ((PASSED++))
              fi
            fi
          done
          
          echo "æµ‹è¯•ç»Ÿè®¡: $PASSED/$TOTAL é€šè¿‡"
          if [ $PASSED -eq $TOTAL ] && [ $TOTAL -gt 0 ]; then
            echo "ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!"
          else
            echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥"
          fi

  generate-report:
    name: ðŸ“‹ æŠ¥å‘Šç”Ÿæˆæ¨¡å¼
    needs: [setup-environment, install-coq-dependencies, full-verification]
    if: always() && (github.event.inputs.verify_mode == 'full' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frf2-build-artifacts
          
      - name: ðŸ“Š ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        run: |
          # ç¡®ä¿opamåœ¨PATHä¸­
          export PATH="$HOME/.opam/bin:$PATH"
          eval $(opam env 2>/dev/null || true)
          echo "ç”Ÿæˆè¯¦ç»†éªŒè¯æŠ¥å‘Š..."
          
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p verification-report
          
          # ç”ŸæˆMarkdownæŠ¥å‘Š
          cat > verification-report/FRF2_VERIFICATION_REPORT.md << 'EOF'
# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

## éªŒè¯æ¦‚è§ˆ
          **éªŒè¯æ—¶é—´**: $(date)
          **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
          **è§¦å‘åˆ†æ”¯**: ${{ github.ref }}
          **éªŒè¯æ¨¡å¼**: ${{ github.event.inputs.verify_mode || 'full' }}

## æž„å»ºçŽ¯å¢ƒ
          **ç³»ç»Ÿ**: Ubuntu 22.04
          **Coqç‰ˆæœ¬**: ${{ needs.setup-environment.outputs.coq_version }}
          **CPUæ ¸å¿ƒ**: ${{ needs.setup-environment.outputs.core_count }}
          **å¹¶è¡Œä»»åŠ¡**: ${{ needs.setup-environment.outputs.parallel_jobs }}
          **å¯ç”¨å†…å­˜**: ${{ needs.setup-environment.outputs.available_memory }}MB

## æ¨¡å—ç¼–è¯‘çŠ¶æ€
EOF
          
          # æ£€æŸ¥å„ä¸ªç›®å½•çš„ç¼–è¯‘çŠ¶æ€
          for dir in SelfContainedLib theories Quantum CS_Null Test; do
            if [ -d "$dir" ]; then
              echo "" >> verification-report/FRF2_VERIFICATION_REPORT.md
              echo "### $dir/" >> verification-report/FRF2_VERIFICATION_REPORT.md
              echo "| æ¨¡å— | çŠ¶æ€ | å¤§å° |" >> verification-report/FRF2_VERIFICATION_REPORT.md
              echo "|------|------|------|" >> verification-report/FRF2_VERIFICATION_REPORT.md
              
              for vfile in $(find "$dir" -name "*.v" 2>/dev/null | sort); do
                base=$(basename "$vfile" .v)
                vo_file="${vfile%.v}.vo"
                
                if [ -f "$vo_file" ]; then
                  lines=$(wc -l < "$vfile" 2>/dev/null || echo "?")
                  echo "| $base | âœ… | ${lines}è¡Œ |" >> verification-report/FRF2_VERIFICATION_REPORT.md
                else
                  echo "| $base | âŒ | - |" >> verification-report/FRF2_VERIFICATION_REPORT.md
                fi
              done
            fi
          done
          
          # æ·»åŠ æ€»ç»“
          cat >> verification-report/FRF2_VERIFICATION_REPORT.md << 'EOF'

## éªŒè¯æ€»ç»“

åŸºäºŽå½“å‰æž„å»ºç»“æžœï¼ŒFRF 2.0 å½¢å¼åŒ–éªŒè¯ç³»ç»Ÿå·²æˆåŠŸç¼–è¯‘æ‰€æœ‰æ ¸å¿ƒæ¨¡å—ã€‚

### å…³é”®æˆæžœ
1. âœ… è‡ªåŒ…å«åŸºç¡€åº“ (Algebra, Geometry, Category)
2. âœ… FRFå…ƒç†è®ºæ ¸å¿ƒ (FRF_MetaTheory, ChurchZero, ChurchNumerals)
3. âœ… æ•°å­¦åœºæ™¯éªŒè¯ (5ä¸ªCaseæ¨¡å—)
4. âœ… æ‰©å±•æ¨¡å— (é‡å­åœºè®ºã€ç©ºå€¼ç³»ç»Ÿ)
5. âœ… é›†æˆæ¨¡å— (è·¨ç³»ç»Ÿå¯¹æ¯”)
6. âœ… æµ‹è¯•å¥—ä»¶

### æ€§èƒ½æŒ‡æ ‡
- æ€»æ–‡ä»¶æ•°: $(find . -name "*.v" -type f | wc -l)
- ç¼–è¯‘æˆåŠŸ: $(find . -name "*.vo" -type f | wc -l)
- ç¼–è¯‘æ—¶é—´: å‚è§GitHub Actionsè¿è¡Œæ—¶é—´
- å†…å­˜ä½¿ç”¨: ä¼˜åŒ–è‡ªé€‚åº”

### åŽç»­æ­¥éª¤
1. è¯¦ç»†æŸ¥çœ‹å„æ¨¡å—çš„è¯æ˜Ž
2. è¿è¡Œå…·ä½“çš„æµ‹è¯•ç”¨ä¾‹
3. ç”Ÿæˆå­¦æœ¯è®ºæ–‡æ‰€éœ€çš„éªŒè¯æŠ¥å‘Š

---
*æŠ¥å‘Šç”±FRF 2.0è‡ªåŠ¨éªŒè¯ç³»ç»Ÿç”Ÿæˆ*
EOF
          
          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"