name: FRF 2.0 å…¨é‡å¹¶è¡Œå½¢å¼åŒ–éªŒè¯

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°ï¼ˆé»˜è®¤è‡ªåŠ¨æ£€æµ‹ï¼‰'
        required: false
        default: 'auto'
      coq_version:
        description: 'Coqç‰ˆæœ¬ï¼ˆé»˜è®¤8.18.0ï¼Œæ”¯æŒ8.18+ï¼‰'
        required: false
        default: '8.18.0'

env:
  PARALLEL_JOBS: ${{ github.event.inputs.parallel_jobs != 'auto' && github.event.inputs.parallel_jobs || '' }}
  COQ_VERSION: ${{ github.event.inputs.coq_version != '' && github.event.inputs.coq_version || '8.18.0' }}

jobs:
  full-formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # å…¨é‡éªŒè¯å¢åŠ è¶…æ—¶æ—¶é—´
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“ï¼ˆåŒ…å«æ‰€æœ‰æ¨¡å—ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: false

    - name: ğŸ–¥ï¸ ç³»ç»Ÿèµ„æºæ£€æµ‹
      id: system-info
      run: |
        echo "=== ç³»ç»Ÿèµ„æºæ£€æµ‹ ==="
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "å†…å­˜æ€»é‡: $(free -g | awk '/^Mem:/{print $2}') GB"
        echo "å¯ç”¨å†…å­˜: $(free -m | awk '/^Mem:/{print $7}') MB"
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo ""
        
        # è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•°ï¼ˆå¦‚æœæœªæ‰‹åŠ¨æŒ‡å®šï¼‰
        if [ -z "$PARALLEL_JOBS" ]; then
          CORES=$(nproc)
          if [ $CORES -gt 16 ]; then
            PARALLEL_JOBS=16
          elif [ $CORES -gt 8 ]; then
            PARALLEL_JOBS=8
          else
            PARALLEL_JOBS=4
          fi
          echo "è‡ªåŠ¨è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•°: $PARALLEL_JOBS"
          echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
        else
          echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šå¹¶è¡Œä»»åŠ¡æ•°: $PARALLEL_JOBS"
        fi
        
        echo "ç›®æ ‡Coqç‰ˆæœ¬: $COQ_VERSION"

    - name: ğŸ“Š é¡¹ç›®ç»“æ„åˆ†æ
      run: |
        echo "=== FRF2.0é¡¹ç›®ç»“æ„åˆ†æ ==="
        echo ""
        echo "ğŸ“ ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        
        echo "ğŸ“Š æ¨¡å—ç»Ÿè®¡:"
        total_files=0
        total_lines=0
        
        for dir in SelfContainedLib theories Quantum CS_Null Test; do
          if [ -d "$dir" ]; then
            files=$(find "$dir" -name "*.v" 2>/dev/null | wc -l)
            lines=$(find "$dir" -name "*.v" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
            total_files=$((total_files + files))
            total_lines=$((total_lines + lines))
            echo "  $dir/: $files ä¸ªæ–‡ä»¶, $lines è¡Œ"
          fi
        done
        
        echo ""
        echo "ğŸ“ˆ æ€»è®¡: $total_files ä¸ª.væ–‡ä»¶, $total_lines è¡Œä»£ç "
        echo ""
        
        # è¯†åˆ«å¤§æ–‡ä»¶
        echo "ğŸ” å¤§æ–‡ä»¶æ£€æµ‹ï¼ˆ>3000è¡Œï¼‰:"
        find . -name "*.v" -exec wc -l {} + 2>/dev/null | sort -rn | head -10 | awk '$1 > 3000 {printf "  %6d è¡Œ: %s\n", $1, $2}'

    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå…¨é‡ç‰ˆï¼‰
      run: |
        echo "å®‰è£…å…¨é‡ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          bc \
          graphviz \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-science \
          pandoc
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”„ åˆå§‹åŒ–OPAMç¯å¢ƒï¼ˆå…¼å®¹ç‰ˆæœ¬ï¼‰
      timeout-minutes: 25
      run: |
        echo "åˆå§‹åŒ–OPAMç¯å¢ƒ..."
        echo "ç›®æ ‡Coqç‰ˆæœ¬: $COQ_VERSION"
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ç¯å¢ƒ
        opam switch remove frf2.0-${COQ_VERSION} --yes 2>/dev/null || true
        
        # åˆå§‹åŒ–OPAM
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        
        # åˆ›å»ºä¸“é—¨ç”¨äºå½“å‰Coqç‰ˆæœ¬çš„switch
        SWITCH_NAME="frf2.0-${COQ_VERSION}"
        echo "åˆ›å»ºswitch: $SWITCH_NAME"
        opam switch create $SWITCH_NAME ocaml-base-compiler.4.14.0
        opam switch set $SWITCH_NAME
        eval $(opam env)
        
        # æ·»åŠ Coqä»“åº“
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add coq-core-dev https://coq.inria.fr/opam/core-dev
        opam update
        
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "OPAMç‰ˆæœ¬: $(opam --version)"
        echo "å½“å‰switch: $(opam switch show)"

    - name: ğŸ“š å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Coqæ ¸å¿ƒï¼ˆå…¼å®¹8.18+ï¼‰
      timeout-minutes: 45
      run: |
        eval $(opam env)
        echo "=== å®‰è£…Coq $COQ_VERSION åŠç›¸å…³åº“ ==="
        
        # å…ˆæŸ¥çœ‹å¯ç”¨çš„Coqç‰ˆæœ¬
        echo "å¯ç”¨çš„Coqç‰ˆæœ¬:"
        opam search coq --all-versions | grep "^coq\s" | head -20
        
        # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Coqï¼ˆä½¿ç”¨ç²¾ç¡®ç‰ˆæœ¬åŒ¹é…ï¼‰
        echo "å®‰è£…Coq $COQ_VERSION..."
        
        # æ ¹æ®ç‰ˆæœ¬å·ç¡®å®šå®‰è£…æ–¹å¼
        if [[ "$COQ_VERSION" == "8.18."* ]] || [[ "$COQ_VERSION" == "8.18" ]]; then
          echo "å®‰è£…Coq 8.18ç³»åˆ—ç‰ˆæœ¬..."
          opam install -y --no-depexts "coq=$COQ_VERSION"
        elif [[ "$COQ_VERSION" == "8.19."* ]] || [[ "$COQ_VERSION" == "8.19" ]]; then
          echo "å®‰è£…Coq 8.19ç³»åˆ—ç‰ˆæœ¬..."
          opam install -y --no-depexts "coq=$COQ_VERSION"
        elif [[ "$COQ_VERSION" == "8.20."* ]] || [[ "$COQ_VERSION" == "8.20" ]]; then
          echo "å®‰è£…Coq 8.20ç³»åˆ—ç‰ˆæœ¬..."
          opam install -y --no-depexts "coq=$COQ_VERSION"
        else
          echo "å®‰è£…æŒ‡å®šç‰ˆæœ¬Coq: $COQ_VERSION"
          opam install -y --no-depexts "coq=$COQ_VERSION"
        fi
        
        # éªŒè¯å®‰è£…
        echo "éªŒè¯Coqå®‰è£…..."
        ACTUAL_VERSION=$(coqc --version 2>/dev/null | grep -oP 'version \K[0-9.]+' || echo "")
        
        if [ -z "$ACTUAL_VERSION" ]; then
          echo "âŒ æ— æ³•è·å–Coqç‰ˆæœ¬"
          exit 1
        fi
        
        echo "å®é™…å®‰è£…çš„Coqç‰ˆæœ¬: $ACTUAL_VERSION"
        
        # æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§ï¼ˆå…è®¸8.18åŠä»¥ä¸Šï¼Œä½†æ’é™¤9.xï¼‰
        MAJOR_VERSION=$(echo "$ACTUAL_VERSION" | cut -d. -f1)
        if [ "$MAJOR_VERSION" -ge 9 ]; then
          echo "âš ï¸ è­¦å‘Š: å®‰è£…çš„æ˜¯Coq 9.xç‰ˆæœ¬ (Rocq Prover)"
          echo "å°è¯•é™çº§åˆ°Coq 8.xç³»åˆ—..."
          opam remove -y coq
          
          # å°è¯•å®‰è£…æœ€æ–°çš„8.xç‰ˆæœ¬
          echo "å°è¯•å®‰è£…æœ€æ–°çš„Coq 8.xç‰ˆæœ¬..."
          LATEST_8X=$(opam search coq --all-versions | grep -oP 'coq\s+\K8\.[0-9]+\.[0-9]+' | sort -V | tail -1)
          
          if [ -z "$LATEST_8X" ]; then
            LATEST_8X="8.18.0"
          fi
          
          echo "å®‰è£…Coq $LATEST_8X"
          opam install -y --no-depexts "coq=$LATEST_8X"
          
          # é‡æ–°éªŒè¯
          ACTUAL_VERSION=$(coqc --version 2>/dev/null | grep -oP 'version \K[0-9.]+' || echo "")
          echo "é‡æ–°å®‰è£…åçš„Coqç‰ˆæœ¬: $ACTUAL_VERSION"
        fi
        
        # æœ€ç»ˆéªŒè¯
        if coqc --version | grep -q "version"; then
          echo "âœ… Coq å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: $ACTUAL_VERSION"
        else
          echo "âŒ Coqå®‰è£…å¤±è´¥"
          exit 1
        fi

    - name: ğŸ“š å®‰è£…mathcomp-ssreflectï¼ˆå…¼å®¹ç‰ˆæœ¬ï¼‰
      timeout-minutes: 20
      run: |
        eval $(opam env)
        echo "=== å®‰è£…mathcomp-ssreflect ==="
        
        # è·å–å½“å‰Coqç‰ˆæœ¬
        COQ_VER=$(coqc --version 2>/dev/null | grep -oP 'version \K[0-9.]+' || echo "8.18.0")
        COQ_MAJOR=$(echo "$COQ_VER" | cut -d. -f1)
        COQ_MINOR=$(echo "$COQ_VER" | cut -d. -f2)
        
        echo "å½“å‰Coqç‰ˆæœ¬: $COQ_VER"
        
        # æ ¹æ®Coqç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„mathcompç‰ˆæœ¬
        if [ "$COQ_MAJOR" -eq 8 ]; then
          if [ "$COQ_MINOR" -eq 18 ]; then
            MATHCOMP_VERSION="1.17.0"
          elif [ "$COQ_MINOR" -eq 19 ]; then
            MATHCOMP_VERSION="1.18.0"
          elif [ "$COQ_MINOR" -eq 20 ]; then
            MATHCOMP_VERSION="1.19.0"
          else
            MATHCOMP_VERSION="1.17.0"
          fi
        else
          # å¯¹äºCoq 9+ï¼Œéœ€è¦ä¸åŒçš„åŒ…å
          echo "Coq 9+ç‰ˆæœ¬ï¼Œå°è¯•å®‰è£…å…¼å®¹çš„mathcomp..."
          MATHCOMP_VERSION="2.0.0"
        fi
        
        echo "å°è¯•å®‰è£…mathcomp-ssreflect $MATHCOMP_VERSION"
        
        # å°è¯•å®‰è£…æŒ‡å®šç‰ˆæœ¬
        if opam install -y --no-depexts "coq-mathcomp-ssreflect=$MATHCOMP_VERSION"; then
          echo "âœ… mathcomp-ssreflect $MATHCOMP_VERSION å®‰è£…æˆåŠŸ"
        else
          echo "âš ï¸ æŒ‡å®šç‰ˆæœ¬å®‰è£…å¤±è´¥ï¼Œå°è¯•å®‰è£…æœ€æ–°å…¼å®¹ç‰ˆæœ¬..."
          opam install -y --no-depexts coq-mathcomp-ssreflect
        fi
        
        # éªŒè¯å®‰è£…
        echo "éªŒè¯mathcompå®‰è£…..."
        if opam list --installed | grep -q "mathcomp"; then
          echo "âœ… mathcompå®‰è£…æˆåŠŸ"
          opam list --installed | grep mathcomp
        else
          echo "âš ï¸ mathcompæœªå®‰è£…ï¼Œä½†å°è¯•ç»§ç»­..."
        fi

    - name: ğŸ“š å®‰è£…å…¶ä»–å¯é€‰åº“
      timeout-minutes: 15
      run: |
        eval $(opam env)
        echo "=== å®‰è£…å…¶ä»–å¯é€‰åº“ ==="
        
        # å®‰è£…åŸºç¡€åº“
        echo "1. å®‰è£…coq-stdlib..."
        opam install -y --no-depexts coq-stdlib || echo "âš ï¸  stdlibå®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
        
        # å°è¯•å®‰è£…å…¶ä»–å¯èƒ½éœ€è¦çš„åº“ï¼ˆä¸å¼ºåˆ¶ï¼‰
        echo "2. å®‰è£…å…¶ä»–å¯é€‰åº“..."
        for pkg in coq-bignums coq-flocq coq-mathlib; do
          echo "å°è¯•å®‰è£… $pkg..."
          opam install -y --no-depexts $pkg 2>/dev/null || echo "  $pkg å®‰è£…å¤±è´¥ï¼Œè·³è¿‡..."
        done
        
        echo "âœ… å¯é€‰åº“å®‰è£…å®Œæˆ"
        
        echo "å·²å®‰è£…åº“åˆ—è¡¨:"
        opam list --installed --short | grep -E "coq|mathcomp" | sort

    - name: ğŸ› ï¸ ç¯å¢ƒéªŒè¯ä¸é…ç½®
      run: |
        eval $(opam env)
        echo "=== ç¯å¢ƒéªŒè¯ ==="
        
        echo "1. CoqéªŒè¯:"
        coqc --version
        echo ""
        
        echo "2. OPAMç¯å¢ƒ:"
        echo "   OPAMROOT: $OPAMROOT"
        echo "   OPAMSWITCH: $OPAMSWITCH"
        echo ""
        
        echo "3. å·¥å…·è·¯å¾„:"
        echo "   COQC: $(which coqc)"
        echo "   COQDEP: $(which coqdep)"
        echo "   COQTOP: $(which coqtop)"
        echo ""
        
        echo "4. è®¾ç½®ç¯å¢ƒå˜é‡..."
        echo "COQC=$(which coqc)" >> $GITHUB_ENV
        echo "COQDEP=$(which coqdep)" >> $GITHUB_ENV
        echo "COQTOP=$(which coqtop)" >> $GITHUB_ENV
        
        echo "âœ… ç¯å¢ƒéªŒè¯å®Œæˆ"

    - name: ğŸ—ï¸ æ™ºèƒ½ç¼–è¯‘é…ç½®ç”Ÿæˆ
      run: |
        echo "=== ç”Ÿæˆæ™ºèƒ½ç¼–è¯‘é…ç½® ==="
        
        # åˆ›å»ºæ™ºèƒ½ç¼–è¯‘è„šæœ¬
        cat > compile_frf.sh << 'EOF'
#!/bin/bash
set -e

# æ™ºèƒ½ç¼–è¯‘å‡½æ•°
compile_module() {
    local file="$1"
    local dir="$2"
    local base_name=$(basename "$file" .v)
    
    echo "ç¼–è¯‘: $base_name.v"
    
    # æ£€æµ‹æ–‡ä»¶å¤§å°
    line_count=$(wc -l < "$file" 2>/dev/null || echo 0)
    
    # åŸºç¡€ç¼–è¯‘å‚æ•°
    local base_flags="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories"
    
    # æ ¹æ®ç›®å½•æ·»åŠ é¢å¤–çš„-Qå‚æ•°
    case "$dir" in
        "Quantum")
            base_flags="$base_flags -Q Quantum FRF.Quantum"
            ;;
        "CS_Null")
            base_flags="$base_flags -Q CS_Null FRF.CS_Null"
            ;;
        "Test")
            base_flags="$base_flags -Q CS_Null FRF.CS_Null -Q Test FRF.Test"
            ;;
    esac
    
    # æ ¹æ®æ–‡ä»¶å¤§å°é€‰æ‹©ç¼–è¯‘å‚æ•°
    if [ "$line_count" -gt 5000 ]; then
        echo "  è¶…å¤§æ–‡ä»¶ (${line_count}è¡Œ)ï¼Œä½¿ç”¨å¢å¼ºå‚æ•°"
        coqc $base_flags -m 16384 -async-proofs on "$file"
    elif [ "$line_count" -gt 3000 ]; then
        echo "  å¤§æ–‡ä»¶ (${line_count}è¡Œ)ï¼Œä½¿ç”¨å¢å¼ºå‚æ•°"
        coqc $base_flags -m 8192 -async-proofs on "$file"
    elif [ "$line_count" -gt 1000 ]; then
        echo "  ä¸­ç­‰æ–‡ä»¶ (${line_count}è¡Œ)ï¼Œä½¿ç”¨æ ‡å‡†å‚æ•°"
        coqc $base_flags -m 4096 "$file"
    else
        echo "  å°æ–‡ä»¶ (${line_count}è¡Œ)ï¼Œä½¿ç”¨åŸºç¡€å‚æ•°"
        coqc $base_flags "$file"
    fi
    
    # æ£€æŸ¥ç¼–è¯‘ç»“æœ
    vo_file="${file%.v}.vo"
    if [ -f "$vo_file" ]; then
        size=$(stat -c%s "$vo_file" 2>/dev/null || echo 0)
        if [ "$size" -gt 100 ]; then
            echo "  âœ… $base_name ç¼–è¯‘æˆåŠŸ (${size}å­—èŠ‚)"
            return 0
        fi
    fi
    
    echo "  âŒ $base_name ç¼–è¯‘å¤±è´¥"
    return 1
}

# å¹¶è¡Œç¼–è¯‘å‡½æ•°
parallel_compile() {
    local files=("$@")
    local pids=()
    local failed=0
    
    echo "å¼€å§‹å¹¶è¡Œç¼–è¯‘ ${#files[@]} ä¸ªæ–‡ä»¶..."
    
    for file in "${files[@]}"; do
        compile_module "$file" "$(dirname "$file" | cut -d'/' -f1)" &
        pids+=($!)
        
        # æ§åˆ¶å¹¶å‘æ•°
        if [ "${#pids[@]}" -ge "$PARALLEL_JOBS" ]; then
            wait -n
            for pid in "${pids[@]}"; do
                if ! kill -0 "$pid" 2>/dev/null; then
                    # è¿›ç¨‹å·²ç»“æŸï¼Œæ£€æŸ¥é€€å‡ºçŠ¶æ€
                    wait "$pid" || ((failed++))
                fi
            done
            # æ¸…ç†å·²ç»“æŸçš„è¿›ç¨‹
            pids=($(for pid in "${pids[@]}"; do kill -0 "$pid" 2>/dev/null && echo $pid; done))
        fi
    done
    
    # ç­‰å¾…å‰©ä½™è¿›ç¨‹
    for pid in "${pids[@]}"; do
        wait "$pid" || ((failed++))
    done
    
    if [ "$failed" -eq 0 ]; then
        echo "âœ… å¹¶è¡Œç¼–è¯‘å®Œæˆï¼Œæ‰€æœ‰æ–‡ä»¶æˆåŠŸ"
        return 0
    else
        echo "âŒ å¹¶è¡Œç¼–è¯‘å®Œæˆï¼Œ$failed ä¸ªæ–‡ä»¶å¤±è´¥"
        return 1
    fi
}

# ä¸»ç¼–è¯‘é€»è¾‘
main() {
    echo "FRF2.0 æ™ºèƒ½ç¼–è¯‘ç³»ç»Ÿ"
    echo "å¹¶è¡Œä»»åŠ¡æ•°: ${PARALLEL_JOBS:-4}"
    echo "Coqç‰ˆæœ¬: $(coqc --version | head -1)"
    echo ""
    
    # å®šä¹‰ç¼–è¯‘é˜¶æ®µ
    stages=(
        "é˜¶æ®µ1:è‡ªåŒ…å«åŸºç¡€åº“"
        "é˜¶æ®µ2:FRFå…ƒç†è®º"
        "é˜¶æ®µ3:æ•°å­¦åœºæ™¯"
        "é˜¶æ®µ4:æ‰©å±•æ¨¡å—"
        "é˜¶æ®µ5:é›†æˆæ¨¡å—"
        "é˜¶æ®µ6:æµ‹è¯•å¥—ä»¶"
    )
    
    # é˜¶æ®µ1: è‡ªåŒ…å«åŸºç¡€åº“
    echo "=== ${stages[0]} ==="
    base_files=(
        "SelfContainedLib/Algebra.v"
        "SelfContainedLib/Category.v"
        "SelfContainedLib/Geometry.v"
    )
    parallel_compile "${base_files[@]}" || exit 1
    
    # é˜¶æ®µ2: FRFå…ƒç†è®º
    echo "=== ${stages[1]} ==="
    frf_files=(
        "theories/FRF_MetaTheory.v"
        "theories/ChurchZero.v"
        "theories/ChurchNumerals.v"
    )
    parallel_compile "${frf_files[@]}" || exit 1
    
    # é˜¶æ®µ3: æ•°å­¦åœºæ™¯ï¼ˆåˆ†æ‰¹æ¬¡ï¼Œè€ƒè™‘ä¾èµ–ï¼‰
    echo "=== ${stages[2]} ==="
    
    # ç¬¬ä¸€æ‰¹ï¼šç‹¬ç«‹åœºæ™¯
    echo "ç¬¬ä¸€æ‰¹ï¼šç‹¬ç«‹æ•°å­¦åœºæ™¯"
    scene_files1=(
        "theories/CaseA_SetTheory.v"
        "theories/CaseB_Algebra.v"
        "theories/CaseC_TypeTheory.v"
    )
    parallel_compile "${scene_files1[@]}" || exit 1
    
    # ç¬¬äºŒæ‰¹ï¼šä¾èµ–åœºæ™¯
    echo "ç¬¬äºŒæ‰¹ï¼šä¾èµ–åœºæ™¯"
    scene_files2=(
        "theories/CaseE_QuantumVacuum.v"
        "theories/CaseD_CategoryTheory.v"
    )
    parallel_compile "${scene_files2[@]}" || exit 1
    
    # é˜¶æ®µ4: æ‰©å±•æ¨¡å—
    echo "=== ${stages[3]} ==="
    
    # é‡å­æ¨¡å—
    echo "é‡å­æ¨¡å—:"
    quantum_files=()
    [ -f "Quantum/QFT_FRF.v" ] && quantum_files+=("Quantum/QFT_FRF.v")
    [ -f "Quantum/CurvedSpacetimeQFT.v" ] && quantum_files+=("Quantum/CurvedSpacetimeQFT.v")
    
    if [ "${#quantum_files[@]}" -gt 0 ]; then
        parallel_compile "${quantum_files[@]}" || exit 1
    fi
    
    # ç©ºå€¼ç³»ç»ŸåŸºç¡€
    echo "ç©ºå€¼ç³»ç»ŸåŸºç¡€:"
    [ -f "CS_Null/FRF_CS_Null_Common.v" ] && compile_module "CS_Null/FRF_CS_Null_Common.v" "CS_Null" || exit 1
    
    # ç©ºå€¼ç³»ç»Ÿé›†æˆ
    [ -f "CS_Null/FRF_CS_Null.v" ] && compile_module "CS_Null/FRF_CS_Null.v" "CS_Null" || exit 1
    
    # è¯­è¨€ç©ºå€¼æ¨¡å—
    echo "è¯­è¨€ç©ºå€¼æ¨¡å—:"
    null_files=()
    for lang in CxxNull PythonNull JavaNull MathNull RustNull; do
        [ -f "CS_Null/${lang}.v" ] && null_files+=("CS_Null/${lang}.v")
    done
    
    if [ "${#null_files[@]}" -gt 0 ]; then
        parallel_compile "${null_files[@]}" || exit 1
    fi
    
    # é˜¶æ®µ5: é›†æˆæ¨¡å—
    echo "=== ${stages[4]} ==="
    [ -f "theories/FRF_Comparative.v" ] && compile_module "theories/FRF_Comparative.v" "theories" || echo "âš ï¸  FRF_Comparative.v è·³è¿‡"
    
    # é˜¶æ®µ6: æµ‹è¯•å¥—ä»¶
    echo "=== ${stages[5]} ==="
    test_files=()
    for test in Test_Basic Test_FRF_MetaTheory Test_QuantumVacuum Test_BlockchainSystem SelfContainedVerification; do
        [ -f "Test/${test}.v" ] && test_files+=("Test/${test}.v")
    done
    
    if [ "${#test_files[@]}" -gt 0 ]; then
        parallel_compile "${test_files[@]}" || exit 1
    fi
    
    echo ""
    echo "ğŸ‰ FRF2.0 å…¨é‡ç¼–è¯‘å®Œæˆï¼"
    
    # ç»Ÿè®¡ç»“æœ
    vo_count=$(find . -name "*.vo" -type f 2>/dev/null | wc -l)
    v_count=$(find . -name "*.v" -type f 2>/dev/null | wc -l)
    echo "ğŸ“Š ç¼–è¯‘ç»Ÿè®¡: $vo_count/$v_count ä¸ªæ–‡ä»¶ç¼–è¯‘æˆåŠŸ"
}

# è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•°
PARALLEL_JOBS=${PARALLEL_JOBS:-4}

# è¿è¡Œä¸»å‡½æ•°
main
EOF
        
        chmod +x compile_frf.sh
        echo "âœ… æ™ºèƒ½ç¼–è¯‘è„šæœ¬ç”Ÿæˆå®Œæˆ"

    - name: ğŸš€ æ‰§è¡Œå…¨é‡å¹¶è¡Œç¼–è¯‘
      timeout-minutes: 90
      run: |
        eval $(opam env)
        echo "=== æ‰§è¡ŒFRF2.0å…¨é‡å¹¶è¡Œç¼–è¯‘ ==="
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PARALLEL_JOBS=$PARALLEL_JOBS
        
        # æ‰§è¡Œç¼–è¯‘è„šæœ¬
        ./compile_frf.sh 2>&1 | tee compilation.log
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… ç¼–è¯‘æ‰§è¡ŒæˆåŠŸ"
        else
            echo "âŒ ç¼–è¯‘æ‰§è¡Œå¤±è´¥"
            echo "æœ€å100è¡Œæ—¥å¿—:"
            tail -100 compilation.log
            exit 1
        fi

    - name: ğŸ“Š ç¼–è¯‘ç»“æœç»Ÿè®¡ä¸åˆ†æ
      run: |
        echo "=== FRF2.0ç¼–è¯‘ç»“æœç»Ÿè®¡ ==="
        
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        total_v=$(find . -name "*.v" -type f 2>/dev/null | wc -l)
        total_vo=$(find . -name "*.vo" -type f 2>/dev/null | wc -l)
        total_glob=$(find . -name "*.glob" -type f 2>/dev/null | wc -l)
        
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        echo "  .v æ–‡ä»¶: $total_v"
        echo "  .vo æ–‡ä»¶: $total_vo"
        echo "  .glob æ–‡ä»¶: $total_glob"
        echo ""
        
        if [ "$total_v" -gt 0 ]; then
            success_rate=$((total_vo * 100 / total_v))
            echo "  ç¼–è¯‘æˆåŠŸç‡: $success_rate% ($total_vo/$total_v)"
        fi
        
        # æŒ‰ç›®å½•ç»Ÿè®¡
        echo "ğŸ“ æŒ‰ç›®å½•ç»Ÿè®¡:"
        for dir in SelfContainedLib theories Quantum CS_Null Test; do
            if [ -d "$dir" ]; then
                v_count=$(find "$dir" -name "*.v" 2>/dev/null | wc -l)
                vo_count=$(find "$dir" -name "*.vo" 2>/dev/null | wc -l)
                
                if [ "$v_count" -gt 0 ]; then
                    rate=$((vo_count * 100 / v_count))
                    echo "  $dir/: $vo_count/$v_count ($rate%)"
                fi
            fi
        done
        
        # æ£€æŸ¥å¤§æ–‡ä»¶ç¼–è¯‘ç»“æœ
        echo ""
        echo "ğŸ” å¤§æ–‡ä»¶ç¼–è¯‘æ£€æŸ¥:"
        big_files=(
            "SelfContainedLib/Geometry.v"
            "theories/FRF_MetaTheory.v"
            "theories/ChurchNumerals.v"
            "theories/CaseE_QuantumVacuum.v"
            "CS_Null/FRF_CS_Null_Common.v"
            "theories/FRF_Comparative.v"
        )
        
        for file in "${big_files[@]}"; do
            if [ -f "$file" ]; then
                vo_file="${file%.v}.vo"
                if [ -f "$vo_file" ]; then
                    lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                    vo_size=$(stat -c%s "$vo_file" 2>/dev/null || echo 0)
                    echo "  âœ… $(basename $file): ${lines}è¡Œ â†’ ${vo_size}å­—èŠ‚"
                else
                    echo "  âŒ $(basename $file): ç¼–è¯‘å¤±è´¥"
                fi
            fi
        done
        
        # ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        echo ""
        echo "ğŸ“„ ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š..."
        cat > compilation_report.md << EOF
# FRF2.0 ç¼–è¯‘æŠ¥å‘Š
## åŸºæœ¬ä¿¡æ¯
- ç¼–è¯‘æ—¶é—´: $(date)
- Coqç‰ˆæœ¬: $(coqc --version | head -1)
- ç³»ç»Ÿç¯å¢ƒ: Ubuntu 22.04
- å¹¶è¡Œä»»åŠ¡æ•°: $PARALLEL_JOBS

## ç¼–è¯‘ç»Ÿè®¡
- æ€»æºæ–‡ä»¶æ•°: $total_v
- æˆåŠŸç¼–è¯‘æ•°: $total_vo
- ç¼–è¯‘æˆåŠŸç‡: $((total_vo * 100 / total_v))%

## æŒ‰æ¨¡å—ç»Ÿè®¡
$(for dir in SelfContainedLib theories Quantum CS_Null Test; do
    if [ -d "$dir" ]; then
        v_count=$(find "$dir" -name "*.v" 2>/dev/null | wc -l)
        vo_count=$(find "$dir" -name "*.vo" 2>/dev/null | wc -l)
        if [ "$v_count" -gt 0 ]; then
            rate=$((vo_count * 100 / v_count))
            echo "- $dir: $vo_count/$v_count ($rate%)"
        fi
    fi
done)

## å¤§æ–‡ä»¶ç¼–è¯‘ç»“æœ
$(for file in "${big_files[@]}"; do
    if [ -f "$file" ]; then
        vo_file="${file%.v}.vo"
        if [ -f "$vo_file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            vo_size=$(stat -c%s "$vo_file" 2>/dev/null || echo 0)
            echo "- âœ… $(basename $file): ${lines}è¡Œ â†’ ${vo_size}å­—èŠ‚"
        else
            echo "- âŒ $(basename $file): ç¼–è¯‘å¤±è´¥"
        fi
    fi
done)

## ç»“è®º
$(if [ "$total_vo" -eq "$total_v" ]; then
    echo "âœ… æ‰€æœ‰æ¨¡å—ç¼–è¯‘æˆåŠŸï¼FRF2.0é¡¹ç›®éªŒè¯é€šè¿‡ã€‚"
elif [ "$total_vo" -ge $((total_v * 80 / 100)) ]; then
    echo "âš ï¸ å¤§éƒ¨åˆ†æ¨¡å—ç¼–è¯‘æˆåŠŸ ($total_vo/$total_v)ï¼Œå¯èƒ½å­˜åœ¨å°‘é‡å…¼å®¹æ€§é—®é¢˜ã€‚"
else
    echo "âŒ ç¼–è¯‘æˆåŠŸç‡è¾ƒä½ ($total_vo/$total_v)ï¼Œéœ€è¦æ£€æŸ¥å…¼å®¹æ€§é—®é¢˜ã€‚"
fi)
EOF
        
        echo "âœ… ç¼–è¯‘æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘ç»“æœå’ŒæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf2.0-compilation-results
        path: |
          *.vo
          *.glob
          *.log
          compilation_report.md
          **/*.vo
          **/*.glob
        retention-days: 30

    - name: ğŸ‰ éªŒè¯æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo ""
        echo "ğŸ‰ğŸ‰ğŸ‰ FRF 2.0 å…¨é‡å¹¶è¡Œå½¢å¼åŒ–éªŒè¯æˆåŠŸï¼"
        echo "=========================================="
        echo "âœ… Coqç¯å¢ƒ: $(coqc --version | head -1)"
        echo "âœ… å¹¶è¡Œä»»åŠ¡: $PARALLEL_JOBS"
        echo "âœ… ç¼–è¯‘æ–‡ä»¶: $(find . -name "*.vo" -type f 2>/dev/null | wc -l) ä¸ª"
        echo "âœ… éªŒè¯æ—¶é—´: $(date)"
        echo "=========================================="
        
        # æ˜¾ç¤ºå…³é”®ç»Ÿè®¡
        echo ""
        echo "ğŸ“ˆ å…³é”®ç»Ÿè®¡æ•°æ®:"
        find . -name "*.v" -type f 2>/dev/null | wc -l | xargs echo "  æºä»£ç æ–‡ä»¶:"
        find . -name "*.vo" -type f 2>/dev/null | wc -l | xargs echo "  ç¼–è¯‘æˆåŠŸæ–‡ä»¶:"
        
        echo ""
        echo "ğŸš€ é¡¹ç›®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥ï¼š"
        echo "  1. è¿è¡Œæµ‹è¯•å¥—ä»¶éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§"
        echo "  2. ç”Ÿæˆè·¨ç³»ç»Ÿå¯¹æ¯”æŠ¥å‘Š"
        echo "  3. è¿›è¡Œå½¢å¼åŒ–è¯æ˜éªŒè¯"

    - name: âš ï¸ éªŒè¯å¤±è´¥å¤„ç†
      if: failure()
      run: |
        echo ""
        echo "âŒ FRF 2.0 éªŒè¯å¤±è´¥"
        echo "====================="
        echo "å¤±è´¥æ—¶é—´: $(date)"
        echo "Coqç‰ˆæœ¬: $(coqc --version 2>/dev/null | head -1 || echo 'æœªçŸ¥')"
        echo ""
        
        # æ£€æŸ¥å¯èƒ½çš„å¤±è´¥åŸå› 
        echo "ğŸ” æ•…éšœè¯Šæ–­:"
        
        # æ£€æŸ¥Coqå®‰è£…
        if ! command -v coqc &> /dev/null; then
            echo "  1. âŒ Coqæœªå®‰è£…æˆ–è·¯å¾„é”™è¯¯"
        else
            echo "  1. âœ… Coqå·²å®‰è£…: $(which coqc)"
        fi
        
        # æ£€æŸ¥æ–‡ä»¶ç»“æ„
        echo "  2. é¡¹ç›®æ–‡ä»¶æ£€æŸ¥:"
        for dir in SelfContainedLib theories; do
            if [ ! -d "$dir" ]; then
                echo "    âŒ ç›®å½•ç¼ºå¤±: $dir"
            else
                v_count=$(find "$dir" -name "*.v" 2>/dev/null | wc -l)
                echo "    âœ… $dir: $v_count ä¸ª.væ–‡ä»¶"
            fi
        done
        
        echo ""
        echo "ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:"
        echo "  1. æ£€æŸ¥Coqç‰ˆæœ¬å…¼å®¹æ€§ï¼ˆå»ºè®®ä½¿ç”¨8.18.0ï¼‰"
        echo "  2. æ£€æŸ¥é¡¹ç›®æ–‡ä»¶å®Œæ•´æ€§"
        echo "  3. æŸ¥çœ‹è¯¦ç»†ç¼–è¯‘æ—¥å¿—"