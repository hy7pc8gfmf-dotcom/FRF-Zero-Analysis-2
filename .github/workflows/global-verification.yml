name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆå¢åŠ æ—¥å¿—è¯¦æƒ…ï¼‰'
        type: boolean
        default: false

jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root --network-alias coq-env
    timeout-minutes: 180
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      OPAM_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/opam-repository/"
      COQ_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/"
      OPAM_FALLBACK_MIRROR: "https://opam.ocaml.org/"
      COQ_FALLBACK_MIRROR: "https://coq.inria.fr/opam/released/"
      VENV_PATH: "${{ github.workspace }}/.venv"
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      - name: ç¯å¢ƒé¢„æ£€æŸ¥
        run: |
          echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯ï¼š$(uname -a)"
          echo "ğŸ“¦ å®¹å™¨é•œåƒï¼š$(cat /etc/issue)"
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´ï¼š$(df -h /__w)"
          echo "ğŸ”§ å†…æ ¸ç‰ˆæœ¬ï¼š$(uname -r)"
          echo "âœ… ç¯å¢ƒé¢„æ£€æŸ¥å®Œæˆ"

      - name: ä¿®å¤ç›®å½•æƒé™ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰
        run: |
          # ä»…å¯¹å¿…è¦ç›®å½•è®¾ç½®æœ€å°æƒé™
          mkdir -p ${{ env.TEMP_DIR }} ~/.opam ~/.cache/opam ${{ github.workspace }}
          chown -R $(id -u):$(id -g) /__w/_temp/ ~/.opam ~/.cache/opam ${{ github.workspace }}
          chmod -R 755 /__w/_temp/ ~/.opam ~/.cache/opam ${{ github.workspace }}
          echo "âœ… ç›®å½•æƒé™ä¿®å¤å®Œæˆ"

      - name: æ£€å‡ºä»£ç ä»“åº“ï¼ˆå¢å¼ºç‰ˆï¼‰
        uses: actions/checkout@v4  # å‡çº§åˆ°æœ€æ–°ç‰ˆcheckout
        with:
          fetch-depth: 0
          submodules: 'recursive'
          lfs: true  # æ”¯æŒLFSæ–‡ä»¶
          persist-credentials: false

      - name: å­æ¨¡å—å®Œæ•´æ€§æ ¡éªŒ
        run: |
          if git submodule status | grep -q '^-'; then
            echo "âŒ å­æ¨¡å—æœªå®Œå…¨æ£€å‡º"
            exit 1
          fi
          echo "âœ… å­æ¨¡å—å®Œæ•´æ€§æ ¡éªŒé€šè¿‡"

      - name: åˆå§‹åŒ–opamç¯å¢ƒï¼ˆå¢å¼ºç‰ˆï¼‰
        run: |
          opam --version || echo "âš ï¸ opamæœªé¢„è£…"
          opam init --disable-sandboxing -y --no-setup --reinit || {
            echo "âŒ opamåˆå§‹åŒ–å¤±è´¥"
            exit 1
          }
          eval $(opam env --switch=default)
          echo "âœ… opamç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          echo "ğŸ“Œ å½“å‰opamç‰ˆæœ¬ï¼š$(opam --version)"
          if command -v coqc &> /dev/null; then
            echo "ğŸ“Œ å½“å‰Coqç‰ˆæœ¬ï¼š$(coqc --version | head -n1)"
          else
            echo "âš ï¸ åˆå§‹Coqæœªæ‰¾åˆ°ï¼Œå°†é€šè¿‡opamå®‰è£…"
          fi

      - name: ç¼“å­˜ä¼˜åŒ–ï¼ˆæ™ºèƒ½ç­–ç•¥ï¼‰
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam/default
            ~/.cache/opam
            _build
            **/*.vo
            **/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-sha-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-sha-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-

      - name: é…ç½®é•œåƒæºï¼ˆå¢å¼ºå®¹é”™ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          # é•œåƒæ£€æŸ¥å·¥å…·å‡½æ•°
          check_mirror() {
            local mirror_url=$1
            if curl --connect-timeout 10 --max-time 20 --head --silent --fail "$mirror_url"index.tar.gz > /dev/null; then
              echo "true"
            else
              echo "false"
            fi
          }

          # é…ç½®ä¸»ä»“åº“
          if [ "$(check_mirror ${{ env.OPAM_MAIN_MIRROR }})" = "true" ]; then
            echo "âœ… ä¸»OPAMé•œåƒå¯ç”¨ï¼š${{ env.OPAM_MAIN_MIRROR }}"
            opam repo set-url default ${{ env.OPAM_MAIN_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_MAIN_MIRROR }} --all-switches
            }
          else
            echo "âš ï¸ ä¸»OPAMé•œåƒä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°å…œåº•ï¼š${{ env.OPAM_FALLBACK_MIRROR }}"
            opam repo set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            }
          fi

          # é…ç½®Coqä»“åº“
          if [ "$(check_mirror ${{ env.COQ_MAIN_MIRROR }})" = "true" ]; then
            echo "âœ… ä¸»Coqé•œåƒå¯ç”¨ï¼š${{ env.COQ_MAIN_MIRROR }}"
            if opam repo list | grep -q "coq-released"; then
              opam repo set-url coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            fi
          else
            echo "âš ï¸ ä¸»Coqé•œåƒä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°å…œåº•ï¼š${{ env.COQ_FALLBACK_MIRROR }}"
            if opam repo list | grep -q "coq-released"; then
              opam repo set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            fi
          fi

          # å¸¦è¶…æ—¶çš„ä»“åº“æ›´æ–°
          update_with_retry() {
            local max_attempts=3
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ“¦ ç¬¬$attemptæ¬¡å°è¯•æ›´æ–°ä»“åº“..."
              if timeout 300 opam update -y; then  # 5åˆ†é’Ÿè¶…æ—¶
                return 0
              fi
              attempt=$((attempt + 1))
              sleep $((attempt * 5))  # æŒ‡æ•°é€€é¿
            done
            return 1
          }

          if update_with_retry; then
            echo "âœ… ä»“åº“æ›´æ–°æˆåŠŸ"
          else
            echo "âš ï¸ ä¸»é•œåƒæ›´æ–°å¤±è´¥ï¼Œå°è¯•å…œåº•é•œåƒç»„åˆ"
            opam repo set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            opam repo set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            if update_with_retry; then
              echo "âœ… å…œåº•é•œåƒæ›´æ–°æˆåŠŸ"
            else
              echo "âŒ æ‰€æœ‰é•œåƒæ›´æ–°å¤±è´¥"
              exit 1
            fi
          fi

      - name: å®‰è£…ä¾èµ–ï¼ˆç²¾å‡†æ§åˆ¶ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-stdlib=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }}"
            "coq-equations=1.3+8.18"
            "${{ env.COQ_EXTRA_OPAM }}"
          )

          # æ£€æŸ¥å·²å®‰è£…åŒ…
          installed_pkgs=$(opam list --short)
          to_install=()
          for pkg in "${required_pkgs[@]}"; do
            pkg_name=$(echo "$pkg" | cut -d'=' -f1)
            if ! echo "$installed_pkgs" | grep -q "^$pkg_name$"; then
              to_install+=("$pkg")
              echo "ğŸ“¥ å¾…å®‰è£…ï¼š$pkg"
            else
              echo "âœ… å·²å®‰è£…ï¼š$pkgï¼Œè·³è¿‡"
            fi
          done

          # å®‰è£…ä¾èµ–ï¼ˆå¸¦èµ„æºæ§åˆ¶ï¼‰
          if [ ${#to_install[@]} -gt 0 ]; then
            install_with_retry() {
              local max_attempts=3
              local attempt=1
              while [ $attempt -le $max_attempts ]; do
                echo "ğŸ”§ ç¬¬$attemptæ¬¡å°è¯•å®‰è£…ä¾èµ–..."
                if timeout 900 opam install -y --jobs 2 --no-depexts "${to_install[@]}"; then  # 15åˆ†é’Ÿè¶…æ—¶
                  return 0
                fi
                attempt=$((attempt + 1))
                sleep $((attempt * 10))
              done
              return 1
            }

            if install_with_retry; then
              echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
            else
              echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
              opam list --installed
              exit 1
            fi
          else
            echo "âœ… æ‰€æœ‰ä¾èµ–å·²å°±ç»ª"
          fi

          # éªŒè¯Pythonç¯å¢ƒ
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv && rm -rf /var/lib/apt/lists/*
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir --timeout 60 reportlab==4.0.9
          
          # æœ€ç»ˆç¯å¢ƒæ ¡éªŒ
          command -v coqc >/dev/null 2>&1 || { echo "âŒ Coqæœªå®‰è£…"; exit 1; }
          coqc --version | grep -q "${{ env.COQ_VERSION }}" || { echo "âŒ Coqç‰ˆæœ¬ä¸åŒ¹é…"; exit 1; }
          opam list | grep -q "coq-mathcomp-ssreflect.*${{ env.MATHCOMP_VERSION }}" || { echo "âŒ MathCompç‰ˆæœ¬ä¸åŒ¹é…"; exit 1; }
          command -v python >/dev/null 2>&1 || { echo "âŒ Pythonç¯å¢ƒå¤±è´¥"; exit 1; }
          echo "âœ… ç¯å¢ƒæ ¡éªŒé€šè¿‡"

      - name: ç”ŸæˆéªŒè¯Makefileï¼ˆå®‰å…¨æ¨¡å¼ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          [ -f "CoqProject" ] || { echo "âŒ ç¼ºå°‘CoqProject"; exit 1; }
          
          # ç”ŸæˆMakefileï¼ˆå¸¦è°ƒè¯•æ—¥å¿—ï¼‰
          if [ -f "Makefile.template" ]; then
            coq_makefile -f CoqProject -o Makefile -extra Makefile.template COQC=coqc || {
              echo "âŒ ç”ŸæˆMakefileå¤±è´¥ï¼ˆå¸¦æ¨¡æ¿ï¼‰"
              exit 1
            }
          else
            coq_makefile -f CoqProject -o Makefile COQC=coqc || {
              echo "âŒ ç”ŸæˆMakefileå¤±è´¥ï¼ˆæ— æ¨¡æ¿ï¼‰"
              exit 1
            }
          fi
          
          grep -q "${{ env.GLOBAL_TARGET }}" Makefile || {
            echo "âŒ Makefileç¼ºå°‘ç›®æ ‡${{ env.GLOBAL_TARGET }}"
            cat Makefile | grep -A 10 "PHONY"  # æ˜¾ç¤ºç›®æ ‡åˆ—è¡¨è¾…åŠ©è°ƒè¯•
            exit 1
          }
          echo "âœ… Makefileç”ŸæˆæˆåŠŸ"

      - name: æ‰§è¡Œå½¢å¼åŒ–éªŒè¯ï¼ˆä¼˜åŒ–å¹¶è¡Œï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          mkdir -p ${{ env.REPORT_DIR }}
          
          # åŠ¨æ€è°ƒæ•´å¹¶è¡Œæ•°ï¼ˆé¿å…èµ„æºè€—å°½ï¼‰
          cpu_cores=$(nproc)
          parallel_jobs=$(( cpu_cores > 2 ? cpu_cores - 1 : 1 ))  # ä¿ç•™1æ ¸é¿å…å¡æ­»
          echo "ğŸš€ å¼€å§‹éªŒè¯ï¼ˆ$parallel_jobsæ ¸å¹¶è¡Œï¼‰"
          
          # æ‰§è¡Œç¼–è¯‘ï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
          make -j$parallel_jobs ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/global-compile.log
          
          # éªŒè¯äº§ç‰©å®Œæ•´æ€§
          failed_files=()
          while IFS= read -r v_file; do
            vo_file="${v_file%.v}.vo"
            if [ ! -f "$vo_file" ] || [ $(stat -c%s "$vo_file") -eq 0 ]; then
              failed_files+=("$vo_file")
            fi
          done < <(grep -E '^[^#].*\.v$' CoqProject)
          
          if [ ${#failed_files[@]} -ne 0 ]; then
            echo "âŒ éªŒè¯å¤±è´¥æ–‡ä»¶ï¼ˆç¼ºå¤±æˆ–ç©ºæ–‡ä»¶ï¼‰ï¼š"
            printf '%s\n' "${failed_files[@]}"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯å®Œæˆ"

      - name: å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒ
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          # æ”¶é›†æ‰€æœ‰voæ–‡ä»¶ï¼ˆå¸¦è¿‡æ»¤ï¼‰
          vo_files=$(find theories/ lib/ extensions/ -name "*.vo" -not -empty | tr '\n' ' ')
          if [ -z "$vo_files" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•éªŒè¯äº§ç‰©"
            exit 1
          fi
          
          echo "ğŸ§ æ£€æŸ¥é€»è¾‘ä¸€è‡´æ€§ï¼š$vo_files"
          coqchk -silent -norecursive $vo_files 2>&1 | tee ${{ env.REPORT_DIR }}/global-coqchk.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          echo "âœ… é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"

      - name: ç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Š
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          mkdir -p ${{ env.REPORT_DIR }}
          
          # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md <<EOF
          # FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š
          
          ## ç¯å¢ƒä¿¡æ¯
          - éªŒè¯æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - è¿è¡Œç¯å¢ƒ: $(uname -a)
          - Coqç‰ˆæœ¬: $(coqc --version | head -n1)
          - MathCompç‰ˆæœ¬: ${{ env.MATHCOMP_VERSION }}
          - å¹¶è¡Œæ ¸å¿ƒæ•°: $(nproc)
          
          ## éªŒè¯ç»Ÿè®¡
          - æ€»æ–‡ä»¶æ•°: $(grep -E '^[^#].*\.v$' CoqProject | wc -l)
          - æˆåŠŸéªŒè¯: $(find theories/ lib/ extensions/ -name "*.vo" -not -empty | wc -l)
          - é€»è¾‘ä¸€è‡´æ€§: âœ… æ ¡éªŒé€šè¿‡
          
          ## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
          EOF
          
          core_modules=(
            "theories/FRF_MetaTheory.vo"
            "theories/Equivalence.vo"
            "lib/Algebra.vo"
            "extensions/Quantum/QFT_FRF.vo"
          )
          for mod in "${core_modules[@]}"; do
            if [ -f "$mod" ] && [ $(stat -c%s "$mod") -gt 0 ]; then
              echo "âœ… $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "âŒ $modï¼ˆç¼ºå¤±æˆ–ç©ºæ–‡ä»¶ï¼‰" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done
          
          echo -e "\n## è¯¦ç»†æ—¥å¿—" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [ç¼–è¯‘æ—¥å¿—](global-compile.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [é€»è¾‘æ£€æŸ¥æ—¥å¿—](global-coqchk.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: å½’æ¡£éªŒè¯ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            **/*.vo
            **/*.glob
            Makefile
            CoqProject
          retention-days: 90

      - name: éªŒè¯å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 éªŒè¯å¤±è´¥"
          echo "å…³é”®æ—¥å¿—ç‰‡æ®µï¼š"
          tail -n 100 ${{ env.REPORT_DIR }}/global-compile.log
          exit 1