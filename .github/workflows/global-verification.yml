# .github/workflows/global-verification.yml
name: FRF 2.0 全局形式化验证
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'  # 每周日凌晨2点自动验证
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.19  # 官方标准镜像，确保兼容性
      options: >-
        --user root
        --workdir /github/workspace  # 明确容器内工作目录（关键修复）
        -v /__w:/__w  # 映射宿主工作目录到容器，确保检出路径一致
    timeout-minutes: 90
    env:
      MATHLIB_VERSION: "4.0.0"
      # 直接使用容器内实际路径，不依赖github.workspace变量（关键修复）
      COQPATH: "/github/workspace/theories:/github/workspace/lib:/github/workspace/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "/github/workspace/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
    steps:
      - name: 修复临时目录权限
        run: |
          mkdir -p ${{ env.TEMP_DIR }}
          chmod -R 777 /__w/_temp/
          echo "✅ 临时目录权限修复完成"

      - name: 检出代码仓库（含子模块）
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
          # 明确指定检出路径为容器内工作目录（关键修复）
          path: "/github/workspace"

      - name: 前置路径校验（容器内实际路径校验）
        run: |
          # 直接使用容器内实际工作目录，不依赖变量（关键修复）
          WORKDIR="/github/workspace"
          
          # 校验工作目录存在性
          if [ ! -d "$WORKDIR" ]; then
            echo "❌ 容器内工作目录 $WORKDIR 不存在" && exit 1
          fi
          # 校验核心代码目录（检出后应有theories目录）
          if [ ! -d "$WORKDIR/theories" ]; then
            echo "❌ 核心代码目录 $WORKDIR/theories 不存在，检出失败" && exit 1
          fi
          # 校验关键配置文件
          if [ ! -f "$WORKDIR/CoqProject" ]; then
            echo "❌ 配置文件 $WORKDIR/CoqProject 缺失" && exit 1
          fi
          echo "✅ 路径校验通过，容器内工作目录：$WORKDIR"

      - name: 缓存依赖与编译产物
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            /github/workspace/_build
            /github/workspace/**/*.vo
            /github/workspace/**/*.glob
          key: ${{ runner.os }}-coq-${{ env.MATHLIB_VERSION }}-global-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.MATHLIB_VERSION }}-global-

      - name: 安装依赖（Mathlib及工具链）
        run: |
          WORKDIR="/github/workspace"
          cd "$WORKDIR"  # 切换到容器内实际工作目录
          
          opam init --disable-sandboxing -y
          eval $(opam env)
          
          # 安装Mathlib（严格版本匹配）
          if ! opam list | grep -q "coq-mathlib.*${{ env.MATHLIB_VERSION }}"; then
            echo "安装Mathlib ${{ env.MATHLIB_VERSION }}..."
            opam install -y coq-mathlib=${{ env.MATHLIB_VERSION }}
          else
            echo "Mathlib ${{ env.MATHLIB_VERSION }} 已缓存，跳过安装"
          fi
          
          # 安装必要工具
          opam install -y coq-equations coq-extraction
          pip3 install --no-cache-dir coq-parser==0.1.5 reportlab==4.0.9
          
          # 版本校验（确保容器内Coq/Mathlib版本正确）
          echo "=== 依赖版本校验 ==="
          coqc --version | grep "8.19" || (echo "❌ Coq版本不匹配（需8.19系列）" && exit 1)
          opam list | grep "coq-mathlib.*${{ env.MATHLIB_VERSION }}" || (echo "❌ Mathlib版本不匹配" && exit 1)

      - name: 生成全局验证Makefile
        run: |
          WORKDIR="/github/workspace"
          cd "$WORKDIR"
          
          if [ ! -f "CoqProject" ]; then
            echo "❌ 未找到CoqProject" && exit 1
          fi
          # 生成Makefile（兼容自定义模板）
          if [ -f "Makefile.template" ]; then
            coq_makefile -f CoqProject -o Makefile -extra Makefile.template
          else
            coq_makefile -f CoqProject -o Makefile
          fi
          # 校验全局目标存在
          if ! grep -q "${{ env.GLOBAL_TARGET }}" Makefile; then
            echo "❌ Makefile未定义目标 '${{ env.GLOBAL_TARGET }}'" && exit 1
          fi

      - name: 执行全局形式化验证
        run: |
          WORKDIR="/github/workspace"
          cd "$WORKDIR"
          eval $(opam env)
          
          # 创建报告目录
          mkdir -p ${{ env.REPORT_DIR }}
          
          echo "=== 开始全局形式化验证（$(nproc)核并行） ==="
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/global-compile.log
          
          # 验证编译完整性（所有.v文件需生成.vo）
          echo "=== 验证编译完整性 ==="
          failed_files=()
          while IFS= read -r v_file; do
            vo_file="${v_file%.v}.vo"
            if [ ! -f "$vo_file" ]; then
              failed_files+=("$vo_file")
            fi
          done < <(grep -E '^[^#].*\.v$' CoqProject | sed 's/^[[:space:]]*//')
          
          if [ ${#failed_files[@]} -ne 0 ]; then
            echo "❌ 以下模块编译失败（未生成.vo）："
            printf '  - %s\n' "${failed_files[@]}"
            exit 1
          fi

      - name: 全局逻辑一致性校验（coqchk）
        run: |
          WORKDIR="/github/workspace"
          cd "$WORKDIR"
          eval $(opam env)
          
          echo "=== 执行全局逻辑一致性检查 ==="
          coqchk -silent -norecursive $(find theories/ lib/ extensions/ -name "*.vo") 2>&1 | tee ${{ env.REPORT_DIR }}/global-coqchk.log
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "❌ 全局一致性检查失败，存在逻辑矛盾"
            exit 1
          fi

      - name: 生成全局验证报告
        run: |
          WORKDIR="/github/workspace"
          cd "$WORKDIR"
          
          # 基础信息采集
          COQ_VERSION=$(coqc --version | head -n1 | awk '{print $3}')
          MATHLIB_INSTALLED=$(opam list --short coq-mathlib | awk '{print $2}')
          TOTAL_FILES=$(grep -E '^[^#].*\.v$' CoqProject | wc -l)
          SUCCESS_FILES=$(find theories/ lib/ extensions/ -name "*.vo" | wc -l)
          
          # 生成报告
          echo "# FRF 2.0 全局形式化验证报告" > ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "## 基本信息" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- 验证时间: $(date +'%Y-%m-%d %H:%M:%S')" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- 触发事件: ${{ github.event_name }}" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- 提交哈希: ${{ github.sha }}" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- Coq版本: $COQ_VERSION" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- Mathlib版本: $MATHLIB_INSTALLED" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          
          echo "## 验证范围" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- 总文件数: $TOTAL_FILES" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- 成功验证: $SUCCESS_FILES" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          
          echo "## 关键模块状态" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          core_modules=(
            "theories/FRF_MetaTheory.vo"
            "theories/CaseF_Logic.vo"
            "theories/FRF2_CrossSystem.vo"
            "lib/Algebra.vo"
            "extensions/Quantum/QFT_FRF.vo"
          )
          for mod in "${core_modules[@]}"; do
            if [ -f "$mod" ]; then
              echo "- ✅ 核心模块: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "- ❌ 核心模块缺失: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done

      - name: 归档验证产物与报告
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-global-verification-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            /github/workspace/**/*.vo
            /github/workspace/**/*.glob
            /github/workspace/Makefile
            /github/workspace/CoqProject
          retention-days: 60

      - name: 验证失败紧急通知
        if: failure()
        run: |
          echo "❌ FRF 2.0 全局形式化验证失败"
          echo "=== 失败关键信息 ==="
          echo "触发事件：${{ github.event_name }}"
          echo "提交哈希：${{ github.sha }}"
          echo "容器内工作目录：/github/workspace"
          echo "代码目录存在性：$(if [ -d "/github/workspace/theories" ]; then echo "是"; else echo "否"; fi)"
          echo "=== 最近10行编译日志 ==="
          tail -n 10 ${{ env.REPORT_DIR }}/global-compile.log 2>/dev/null || echo "编译日志未生成"