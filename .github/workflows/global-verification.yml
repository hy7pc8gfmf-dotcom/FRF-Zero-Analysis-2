name: Global Formal Verification
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  global-verification:
    runs-on: ubuntu-latest
    container: coqorg/coq:8.18.0
    steps:
      - uses: actions/checkout@v4
      - name: Check Coq Version
        run: |
          if ! coqc --version | grep -q "8.18.0"; then
            echo "❌ Coq版本不匹配（需8.18.0，当前：$(coqc --version | head -n1)）"
            exit 1
          fi
      - name: Check MathComp Version
        run: |
          if ! opam list | grep -q "coq-mathcomp-ssreflect.*1.18.0"; then
            echo "❌ MathComp版本不匹配"
            exit 1
          fi
      - name: Configure OPAM Mirrors
        run: |
          opam repo set-url default https://mirrors.tuna.tsinghua.edu.cn/opam-repository/ || opam repo set-url default https://opam.ocaml.org/
          opam repo add coq-released https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/ || opam repo add coq-released https://coq.inria.fr/opam/released/
      - name: Initialize OPAM
        run: |
          opam init --disable-sandboxing --bare
          opam update -y || (sleep 5 && opam update -y) || (sleep 10 && opam update -y)
      - name: Install Dependencies
        run: |
          opam install -y coq-mathcomp-ssreflect.1.18.0 coq-bignums
      - name: Set COQPATH
        run: |
          echo "COQPATH=/home/runner/work/FRF-Zero-Analysis-2/FRF-Zero-Analysis-2/theories:/home/runner/work/FRF-Zero-Analysis-2/FRF-Zero-Analysis-2/lib:/home/runner/work/FRF-Zero-Analysis-2/FRF-Zero-Analysis-2/extensions" >> $GITHUB_ENV
      - name: Execute Global Verification
        run: |
          mkdir -p ${{ env.REPORT_DIR }}
          coqc -R theories FRF theories/*.v
          coqchk -Q theories FRF -o ${{ env.REPORT_DIR }}/consistency.check FRF
        env:
          REPORT_DIR: /home/runner/work/FRF-Zero-Analysis-2/FRF-Zero-Analysis-2/verification-reports
      - name: Archive Reports
        uses: actions/upload-artifact@v4
        with:
          name: verification-reports
          path: ${{ env.REPORT_DIR }}