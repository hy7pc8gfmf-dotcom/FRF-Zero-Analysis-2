name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å®‰è£…Coqå’Œä¾èµ–
      run: |
        eval $(opam env)
        opam install -y \
          coq.8.18.0 \
          coq-mathcomp-ssreflect \
          coq-equations \
          coq-bignums \
          coq-metacoq-template \
          coq-metacoq-checker
        echo "âœ… Coqå’Œä¾èµ–å®‰è£…å®Œæˆ"
        coqc --version

    - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        ls -la
        echo "Coqæ–‡ä»¶æ•°é‡: $(find . -name '*.v' | wc -l)"
        echo "å…³é”®æ–‡ä»¶æ£€æŸ¥:"
        for file in Makefile CoqProject SelfContainedLib/Algebra.v theories/FRF_MetaTheory.v; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file - ç¼ºå¤±"
          fi
        done

    - name: æµ‹è¯•Coqç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== æµ‹è¯•Coqç¼–è¯‘ç¯å¢ƒ ==="
        
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶
        cat > test_coq.v << 'EOF'
        Theorem test : True.
        Proof. exact I. Qed.
        Print test.
        EOF
        
        echo "ç¼–è¯‘æµ‹è¯•æ–‡ä»¶..."
        coqc test_coq.v
        
        if [ -f "test_coq.vo" ]; then
          echo "âœ… Coqç¼–è¯‘ç¯å¢ƒæ­£å¸¸"
          rm test_coq.vo test_coq.glob test_coq.v
        else
          echo "âŒ Coqç¼–è¯‘ç¯å¢ƒæœ‰é—®é¢˜"
          exit 1
        fi

    - name: ä½¿ç”¨Makefileç¼–è¯‘æ ¸å¿ƒæ¨¡å—
      run: |
        echo "=== ä½¿ç”¨Makefileç¼–è¯‘æ ¸å¿ƒæ¨¡å— ==="
        
        # å…ˆå®‰è£…ä¾èµ–
        make deps || echo "ä¾èµ–å®‰è£…è·³è¿‡æˆ–å·²å®Œæˆ"
        
        # ç¼–è¯‘æ ¸å¿ƒæ¨¡å—
        echo "ç¼–è¯‘Level 1åŸºç¡€åº“..."
        make test-level1
        
        echo "ç¼–è¯‘Level 2 FRFå…ƒç†è®º..."
        make test-level2
        
        echo "æ£€æŸ¥ç¼–è¯‘ç»“æœ..."
        make check

    - name: å®Œæ•´ç¼–è¯‘éªŒè¯
      run: |
        echo "=== å®Œæ•´ç¼–è¯‘éªŒè¯ ==="
        
        # å®Œæ•´ç¼–è¯‘
        echo "ç¼–è¯‘æ‰€æœ‰æ¨¡å—..."
        make compile
        
        echo "è¿è¡ŒéªŒè¯..."
        make validate
        
        echo "è¿è¡Œæµ‹è¯•..."
        make test

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      if: always()
      run: |
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        compiled_files=$(find . -name "*.vo" | wc -l)
        echo "å·²ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"
        
        echo "ç¼–è¯‘äº§ç‰©åˆ—è¡¨:"
        find . -name "*.vo" | head -20
        
        if [ $compiled_files -gt 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ‰¾åˆ° $compiled_files ä¸ª.voæ–‡ä»¶"
        else
          echo "âŒ æ²¡æœ‰ç¼–è¯‘äº§ç‰©"
          # å°è¯•è¯Šæ–­é—®é¢˜
          echo "=== è¯Šæ–­ä¿¡æ¯ ==="
          echo "Makefileç‰ˆæœ¬:"
          head -n 10 Makefile
          echo "CoqProjectå†…å®¹:"
          head -n 10 CoqProject
        fi

    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      run: |
        echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
        
        total_files=$(find . -name "*.v" | wc -l)
        compiled_files=$(find . -name "*.vo" | wc -l)
        
        mkdir -p verification-reports
        
        # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        cat > verification-reports/REPORT.md << EOF
# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

**éªŒè¯æ—¶é—´**: $(date)
**ç¯å¢ƒ**: Ubuntu 22.04 + Coq 8.18.0
**Coqç‰ˆæœ¬**: $(coqc --version | head -1)

## ç¼–è¯‘ç»Ÿè®¡
- æ€»Coqæ–‡ä»¶: $total_files
- æˆåŠŸç¼–è¯‘: $compiled_files
EOF

        if [ $total_files -gt 0 ]; then
          success_rate=$((compiled_files * 100 / total_files))
          echo "- æˆåŠŸç‡: $success_rate%" >> verification-reports/REPORT.md
        else
          echo "- æˆåŠŸç‡: 0%" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## é¡¹ç›®ç»“æ„" >> verification-reports/REPORT.md
        echo "\`\`\`" >> verification-reports/REPORT.md
        ls -la >> verification-reports/REPORT.md
        echo "\`\`\`" >> verification-reports/REPORT.md
        
        echo "" >> verification-reports/REPORT.md
        echo "## ç¼–è¯‘äº§ç‰©" >> verification-reports/REPORT.md
        if [ $compiled_files -gt 0 ]; then
          echo "\`\`\`" >> verification-reports/REPORT.md
          find . -name "*.vo" >> verification-reports/REPORT.md
          echo "\`\`\`" >> verification-reports/REPORT.md
        else
          echo "æ— ç¼–è¯‘äº§ç‰©" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## éªŒè¯ç»“æœ" >> verification-reports/REPORT.md
        if [ $compiled_files -ge 3 ]; then
          echo "âœ… **éªŒè¯æˆåŠŸ**: æˆåŠŸç¼–è¯‘äº† $compiled_files ä¸ªæ–‡ä»¶" >> verification-reports/REPORT.md
          echo "**çŠ¶æ€**: FRFæ¡†æ¶æ ¸å¿ƒéªŒè¯é€šè¿‡" >> verification-reports/REPORT.md
        else
          echo "âŒ **éªŒè¯å¤±è´¥**: ç¼–è¯‘æ–‡ä»¶ä¸è¶³ï¼Œä»… $compiled_files ä¸ª" >> verification-reports/REPORT.md
          echo "**å»ºè®®**: æ£€æŸ¥ä¾èµ–å…³ç³»å’Œè·¯å¾„æ˜ å°„" >> verification-reports/REPORT.md
        fi
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-verification-report
        path: verification-reports/
        retention-days: 7

    - name: éªŒè¯æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        compiled_count=$(find . -name "*.vo" | wc -l)
        echo "ğŸ‰ FRF 2.0 å½¢å¼åŒ–éªŒè¯å®Œæˆ!"
        echo "ğŸ“Š ç¼–è¯‘æ¨¡å—: $compiled_count"
        echo "ğŸ“‹ æŠ¥å‘Šä½ç½®: verification-reports/REPORT.md"

    - name: éªŒè¯å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ FRF 2.0 å½¢å¼åŒ–éªŒè¯å¤±è´¥"
        echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„é—®é¢˜:"
        echo "1. Coqç‰ˆæœ¬å…¼å®¹æ€§"
        echo "2. è·¯å¾„æ˜ å°„é…ç½®"
        echo "3. ä¾èµ–åŒ…å®‰è£…"
        echo "4. æ–‡ä»¶ä¾èµ–å…³ç³»"