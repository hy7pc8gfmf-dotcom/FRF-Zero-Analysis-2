name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master, release/final]
    paths: ['**.v', 'CoqProject', 'Makefile', 'validate.sh']
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨éªŒè¯
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root  # ä¿æŒrootæƒé™ä»¥è§£å†³ç›®å½•æƒé™é—®é¢˜ï¼ˆæ³¨é‡Šï¼šè™½ä¸æ¨èï¼Œä½†é€‚é…é¡¹ç›®æƒé™éœ€æ±‚ï¼‰
    timeout-minutes: 180  # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé€‚é…å¤§è§„æ¨¡æ¨¡å—ç¼–è¯‘
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      # ä¼˜åŒ–COQPATHï¼šåŒ…å«æ‰€æœ‰æ ¸å¿ƒç›®å½•ï¼Œé€‚é…ä¼˜åŒ–åçš„CoqProjectè·¯å¾„ç»‘å®š
      COQPATH: "${{ github.workspace }}/SelfContainedLib:${{ github.workspace }}/theories:${{ github.workspace }}/CS_Null:${{ github.workspace }}/Quantum:${{ github.workspace }}/DynamicSystem:${{ github.workspace }}/Toolchain:${{ github.workspace }}/Test"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      OPAM_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/opam-repository/"
      COQ_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/"
      OPAM_FALLBACK_MIRROR: "https://opam.ocaml.org/"
      COQ_FALLBACK_MIRROR: "https://coq.inria.fr/opam/released/"
      VENV_PATH: "${{ github.workspace }}/.venv"
    steps:
      - name: ä¿®å¤ä¸´æ—¶ç›®å½•ä¸ä¾èµ–ç¼“å­˜æƒé™
        run: |
          mkdir -p ${{ env.TEMP_DIR }} ~/.opam ~/.cache/opam
          chmod -R 777 /__w/_temp/ ~/.opam ~/.cache/opam
          # æå‰åˆ›å»ºæ ¸å¿ƒç›®å½•ï¼Œé¿å…ç¼–è¯‘æ—¶æƒé™æŠ¥é”™
          mkdir -p SelfContainedLib theories CS_Null Quantum DynamicSystem Toolchain Test
          chmod -R 777 ${{ github.workspace }}

      - name: æ£€å‡ºä»£ç ä»“åº“ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: å¢å¼ºé¡¹ç›®ç»“æ„åˆ†æï¼ˆæå‰æ’æŸ¥è·¯å¾„/æ–‡ä»¶ç¼ºå¤±ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== é¡¹ç›®ç»“æ„åˆ†æ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ ¸å¿ƒç›®å½•åˆ—è¡¨:"
          ls -la SelfContainedLib theories CS_Null Quantum DynamicSystem Toolchain Test 2>/dev/null || echo "è­¦å‘Šï¼šéƒ¨åˆ†æ ¸å¿ƒç›®å½•æœªæ‰¾åˆ°"
          echo "CoqProjectå®Œæ•´å†…å®¹:"
          if [ -f "CoqProject" ]; then
            cat CoqProject
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°CoqProjectæ–‡ä»¶"
            exit 1
          fi
          echo "=== æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ ==="
          critical_files=(
            "SelfContainedLib/Algebra.v"
            "theories/FRF_MetaTheory.v"
            "CS_Null/FRF_CS_Null_Common.v"
            "Quantum/QFT_FRF.v"
          )
          for file in "${critical_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "é”™è¯¯ï¼šæ ¸å¿ƒæ–‡ä»¶ $file ç¼ºå¤±"
              exit 1
            fi
          done
          echo "æ ¸å¿ƒæ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: åˆå§‹åŒ–opamç¯å¢ƒï¼ˆé€‚é…å›½å†…é•œåƒï¼‰
        run: |
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)

      - name: ç¼“å­˜ä¼˜åŒ–ï¼ˆè¦†ç›–æ‰€æœ‰æ ¸å¿ƒæ¨¡å—ç¼–è¯‘äº§ç‰©ï¼‰
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
            _build
            SelfContainedLib/**/*.vo
            SelfContainedLib/**/*.glob
            theories/**/*.vo
            theories/**/*.glob
            CS_Null/**/*.vo
            CS_Null/**/*.glob
            Quantum/**/*.vo
            Quantum/**/*.glob
            DynamicSystem/**/*.vo
            DynamicSystem/**/*.glob
            Toolchain/**/*.vo
            Toolchain/**/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-venv-

      - name: é…ç½®é•œåƒæº+å®‰è£…ä¾èµ–ï¼ˆå®¹é”™é‡è¯•æœºåˆ¶ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          opam repo list --all-switches

          # é…ç½®OPAMé•œåƒï¼ˆä¼˜å…ˆå›½å†…æºï¼Œå¤±è´¥ fallback å®˜æ–¹æºï¼‰
          if curl --head --silent --fail ${{ env.OPAM_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            opam repository set-url default ${{ env.OPAM_MAIN_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_MAIN_MIRROR }} --all-switches
            }
          else
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            }
          fi

          # é…ç½®Coqä¸“ç”¨é•œåƒ
          if curl --head --silent --fail ${{ env.COQ_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            if opam repo list | grep -q "coq-released"; then
              opam repository set-url coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            fi
          else
            if opam repo list | grep -q "coq-released"; then
              opam repository set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            fi
          fi

          # OPAMæ›´æ–°ï¼ˆæœ€å¤š3æ¬¡é‡è¯•ï¼‰
          update_success=0
          for i in {1..3}; do
            if opam update -y; then
              update_success=1
              break
            fi
            echo "OPAMæ›´æ–°å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
            sleep 2
          done
          if [ $update_success -eq 0 ]; then
            echo "é”™è¯¯ï¼šOPAMæ›´æ–°å¤±è´¥ï¼Œåˆ‡æ¢è‡³å®˜æ–¹é•œåƒé‡è¯•"
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            opam repository set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            for i in {1..3}; do
              if opam update -y; then
                update_success=1
                break
              fi
              sleep 2
            done
          fi
          if [ $update_success -eq 0 ]; then
            exit 1
          fi

          # å®‰è£…å¿…è¦ä¾èµ–åŒ…
          installed_pkgs=$(opam list --short)
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-stdlib=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }}"
            "coq-equations=1.3+8.18"  # é€‚é…Coq 8.18çš„ç‰ˆæœ¬
            "${{ env.COQ_EXTRA_OPAM }}"
          )
          to_install=()
          for pkg in "${required_pkgs[@]}"; do
            pkg_name=$(echo "$pkg" | cut -d'=' -f1)
            if ! echo "$installed_pkgs" | grep -q "^$pkg_name$"; then
              to_install+=("$pkg")
            fi
          done

          # ä¾èµ–å®‰è£…ï¼ˆæœ€å¤š3æ¬¡é‡è¯•ï¼‰
          if [ ${#to_install[@]} -gt 0 ]; then
            install_success=0
            for i in {1..3}; do
              echo "å®‰è£…ä¾èµ–åŒ…ï¼š${to_install[*]}"
              if opam install -y --jobs $(nproc) "${to_install[@]}"; then
                install_success=1
                break
              fi
              echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              sleep 5
            done
            if [ $install_success -eq 0 ]; then
              echo "é”™è¯¯ï¼šä¾èµ–åŒ…å®‰è£…å¤±è´¥"
              exit 1
            fi
          fi

          # å®‰è£…Pythonä¾èµ–ï¼ˆç”¨äºæŠ¥å‘Šç”Ÿæˆï¼‰
          eval $(opam env --switch=default)
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv && rm -rf /var/lib/apt/lists/*
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir --timeout 60 reportlab==4.0.9

          # ç¯å¢ƒæ ¡éªŒ
          if ! command -v coqc &> /dev/null; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°coqcç¼–è¯‘å™¨"
            exit 1
          fi
          if ! coqc --version | grep -q "${{ env.COQ_VERSION }}"; then
            echo "é”™è¯¯ï¼šCoqç‰ˆæœ¬ä¸åŒ¹é…ï¼ˆå½“å‰ç‰ˆæœ¬ï¼š$(coqc --version | head -n1 | awk '{print $2}')ï¼Œéœ€ ${COQ_VERSION}ï¼‰"
            exit 1
          fi
          if ! opam list | grep -q "coq-mathcomp-ssreflect.*${{ env.MATHCOMP_VERSION }}"; then
            echo "é”™è¯¯ï¼šMathCompç‰ˆæœ¬ä¸åŒ¹é…"
            exit 1
          fi
          echo "ç¯å¢ƒé…ç½®ä¸ä¾èµ–å®‰è£…å®Œæˆ"

      - name: é¢„å¤„ç†CoqProjectæ–‡ä»¶ï¼ˆä¿ç•™æ ¸å¿ƒé…ç½®ï¼Œé¿å…è¿‡æ»¤ä¸¢å¤±ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          if [ -f "CoqProject" ]; then
            echo "é¢„å¤„ç†CoqProjectï¼šè¿‡æ»¤æ³¨é‡Šä¸ç©ºè¡Œï¼Œä¿ç•™æ ¸å¿ƒé…ç½®"
            # ä»…è¿‡æ»¤æ³¨é‡Šï¼ˆ#å¼€å¤´ï¼‰å’Œç©ºè¡Œï¼Œä¿ç•™æ‰€æœ‰-Q/-R/-argç»‘å®šåŠ.væ–‡ä»¶è·¯å¾„
            grep -v -E "^#|^$" CoqProject > CoqProject.clean
            mv CoqProject.clean CoqProject
            echo "é¢„å¤„ç†åæ ¸å¿ƒé…ç½®é¢„è§ˆ:"
            grep -E "^-Q|^-R|^-arg" CoqProject
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°CoqProjectæ–‡ä»¶"
            exit 1
          fi

      - name: ç”Ÿæˆå…¨å±€éªŒè¯Makefileï¼ˆåŸºäºä¼˜åŒ–åçš„CoqProjectï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          if [ ! -f "CoqProject" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°CoqProjectæ–‡ä»¶"
            exit 1
          fi
          echo "åŸºäºä¼˜åŒ–åçš„CoqProjectç”ŸæˆMakefile..."
          coq_makefile -f CoqProject -o Makefile
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šMakefileç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          echo "Makefileç”ŸæˆæˆåŠŸï¼Œæ ¸å¿ƒç›®æ ‡é¢„è§ˆ:"
          grep -E "^all:|^compile:|^validate:" Makefile
          cat Makefile | head -20

      - name: æ‰§è¡Œå…¨å±€å½¢å¼åŒ–éªŒè¯ï¼ˆæŒ‰ä¾èµ–é¡ºåºç¼–è¯‘ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          mkdir -p ${{ env.REPORT_DIR }}
          echo "è®¾ç½®Coqç¯å¢ƒå˜é‡..."
          export COQPATH="${{ env.COQPATH }}"
          echo "COQPATH: $COQPATH"

          echo "æŒ‰ä¾èµ–é¡ºåºç¼–è¯‘æ‰€æœ‰æ¨¡å—ï¼ˆå¹¶è¡Œæ ¸å¿ƒæ•°ï¼š$(nproc)ï¼‰..."
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/compile-all.log

          echo "=== ç¼–è¯‘äº§ç‰©æ ¡éªŒ ==="
          # æ ¡éªŒæ ¸å¿ƒæ¨¡å—æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼ˆè¦†ç›–åŸºç¡€å±‚+æ ¸å¿ƒå±‚+æ‰©å±•å±‚ï¼‰
          critical_modules=(
            "SelfContainedLib/Algebra.vo"
            "SelfContainedLib/Category.vo"
            "theories/FRF_MetaTheory.vo"
            "theories/CaseB_Algebra.vo"
            "CS_Null/FRF_CS_Null_Common.vo"
            "Quantum/QFT_FRF.vo"
            "DynamicSystem/TimeVaryingSystem.vo"
          )
          for mod in "${critical_modules[@]}"; do
            if [ ! -f "$mod" ]; then
              echo "é”™è¯¯ï¼šæ ¸å¿ƒæ¨¡å— $mod æœªç¼–è¯‘æˆåŠŸ"
              cat ${{ env.REPORT_DIR }}/compile-all.log | grep -A 10 -B 5 "$(basename $mod .vo)"
              exit 1
            fi
          done

          # ç»Ÿè®¡ç¼–è¯‘ç»“æœ
          total_v=$(find . -name "*.v" -not -path "./.venv/*" -not -path "./_build/*" | wc -l)
          total_vo=$(find . -name "*.vo" -not -path "./.venv/*" -not -path "./_build/*" | wc -l)
          echo "æ€»å¾…éªŒè¯.væ–‡ä»¶æ•°: $total_v"
          echo "æˆåŠŸç¼–è¯‘.voæ–‡ä»¶æ•°: $total_vo"
          if [ $total_v -eq 0 ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•.væ–‡ä»¶"
            exit 1
          fi
          verification_rate=$((total_vo * 100 / total_v))
          echo "ç¼–è¯‘éªŒè¯æˆåŠŸç‡: $verification_rate%"
          if [ $verification_rate -lt 100 ]; then
            echo "è­¦å‘Šï¼šéƒ¨åˆ†æ¨¡å—æœªç¼–è¯‘æˆåŠŸï¼Œè¯¦ç»†æ—¥å¿—è§ compile-all.log"
          fi
          echo "ç¼–è¯‘éªŒè¯é˜¶æ®µå®Œæˆ"

      - name: å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒï¼ˆæ ¸å¿ƒæ¨¡å—å…¨é‡æ ¡éªŒï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          echo "=== å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥ ==="
          # æ”¶é›†æ‰€æœ‰æ ¸å¿ƒæ¨¡å—çš„.voæ–‡ä»¶ï¼ˆæ’é™¤æµ‹è¯•æ¨¡å—å’Œä¸´æ—¶ç›®å½•ï¼‰
          find . -name "*.vo" -not -path "./Test/*" -not -path "./.venv/*" -not -path "./_build/*" > vo_files.list
          if [ ! -s vo_files.list ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•ç¼–è¯‘ç”Ÿæˆçš„.voæ–‡ä»¶"
            exit 1
          fi
          total_vo=$(wc -l < vo_files.list)
          echo "å¾…æ ¡éªŒæ ¸å¿ƒæ¨¡å—æ•°: $total_vo"

          # å…¨é‡æ‰§è¡Œé€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆ-R . FRF é€‚é…CoqProjectçš„é€»è¾‘è·¯å¾„ç»‘å®šï¼‰
          coqchk -silent -R . FRF $(cat vo_files.list) 2>&1 | tee -a ${{ env.REPORT_DIR }}/global-coqchk.log

          # æ£€æŸ¥coqchké€€å‡ºç ï¼ˆ0=æ— é€»è¾‘å†²çªï¼Œé0=å­˜åœ¨å†²çªï¼‰
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šæ ¸å¿ƒæ¨¡å—å­˜åœ¨é€»è¾‘ä¸€è‡´æ€§å†²çª"
            cat ${{ env.REPORT_DIR }}/global-coqchk.log
            exit 1
          fi
          echo "å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡ï¼ˆæ— å…¬ç†å†²çªã€æ— ä¾èµ–çŸ›ç›¾ï¼‰"

      - name: ç”Ÿæˆç»“æ„åŒ–éªŒè¯æŠ¥å‘Šï¼ˆå«å®Œæ•´ç»Ÿè®¡ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          mkdir -p ${{ env.REPORT_DIR }}

          # ç»Ÿè®¡æ ¸å¿ƒæ•°æ®
          total_v=$(find . -name "*.v" -not -path "./.venv/*" -not -path "./_build/*" | wc -l)
          total_vo=$(find . -name "*.vo" -not -path "./.venv/*" -not -path "./_build/*" | wc -l)
          verification_rate=$((total_vo * 100 / total_v))
          critical_mod_pass=$([[ $(find critical_modules[@] -name "*.vo" | wc -l) -eq ${#critical_modules[@]} ]] && echo "âœ…" || echo "âŒ")

          # ç”ŸæˆMarkdownæŠ¥å‘Š
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md << EOF
          # FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š
          ## éªŒè¯æ¦‚è§ˆ
          - éªŒè¯æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - è¿è¡Œç¯å¢ƒ: coqorg/coq:${{ env.COQ_VERSION }} (Ubuntu)
          - Coqç‰ˆæœ¬: $(coqc --version | head -n1 | awk '{print $2}')
          - MathCompç‰ˆæœ¬: ${{ env.MATHCOMP_VERSION }}
          - ç¼–è¯‘æ ¸å¿ƒæ•°: $(nproc)
          - æ€»è€—æ—¶: $(($(date +%s) - $(date +%s -d "@${{ github.event.repository.pushed_at }}"))) ç§’

          ## éªŒè¯ç»“æœç»Ÿè®¡
          - æ€»å¾…éªŒè¯.væ–‡ä»¶æ•°: $total_v
          - æˆåŠŸç¼–è¯‘.voæ–‡ä»¶æ•°: $total_vo
          - éªŒè¯æˆåŠŸç‡: $verification_rate%
          - æ ¸å¿ƒæ¨¡å—ç¼–è¯‘çŠ¶æ€: $critical_mod_pass
          - é€»è¾‘ä¸€è‡´æ€§: âœ… æ— å†²çª

          ## å·²éªŒè¯æ ¸å¿ƒæ¨¡å—ï¼ˆå‰20ä¸ªï¼‰
          EOF
          find . -name "*.vo" -not -path "./Test/*" -not -path "./.venv/*" | head -20 | while read vo_file; do
            echo "- $vo_file" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          done
          if [ $total_vo -gt 20 ]; then
            echo "- ... åŠå…¶ä»– $(($total_vo - 20)) ä¸ªæ¨¡å—" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          fi

          ## æ—¥å¿—è¯´æ˜
          cat >> ${{ env.REPORT_DIR }}/SUMMARY.md << EOF
          ## è¯¦ç»†æ—¥å¿—æ–‡ä»¶
          - ç¼–è¯‘æ—¥å¿—: [compile-all.log](compile-all.log)
          - é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥æ—¥å¿—: [global-coqchk.log](global-coqchk.log)
          - ç¼–è¯‘æ¨¡å—æ¸…å•: [all_coq_files.txt](all_coq_files.txt)
          - æ ¡éªŒæ¨¡å—æ¸…å•: [vo_files.list](vo_files.list)

          ## éªŒè¯ç»“è®º
          $(if [ $verification_rate -eq 100 ] && [ $? -eq 0 ]; then echo "âœ… FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯å®Œå…¨é€šè¿‡ï¼ˆæ— ç¼–è¯‘é”™è¯¯ã€æ— é€»è¾‘å†²çªï¼‰"; else echo "âš ï¸ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯éƒ¨åˆ†é€šè¿‡ï¼ˆéœ€æŸ¥çœ‹æ—¥å¿—æ’æŸ¥ç»†èŠ‚ï¼‰"; fi)
          EOF

          # å¤‡ä»½å…³é”®æ–‡ä»¶åˆ°æŠ¥å‘Šç›®å½•
          cp all_coq_files.txt vo_files.list ${{ env.REPORT_DIR }} 2>/dev/null || true
          echo "ç»“æ„åŒ–éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼š${{ env.REPORT_DIR }}/SUMMARY.md"

      - name: å½’æ¡£éªŒè¯äº§ç‰©ä¸æŠ¥å‘Šï¼ˆ90å¤©ä¿ç•™ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            SelfContainedLib/**/*.vo
            SelfContainedLib/**/*.glob
            theories/**/*.vo
            theories/**/*.glob
            CS_Null/**/*.vo
            CS_Null/**/*.glob
            Quantum/**/*.vo
            Quantum/**/*.glob
            DynamicSystem/**/*.vo
            DynamicSystem/**/*.glob
            Toolchain/**/*.vo
            Toolchain/**/*.glob
            Makefile
            CoqProject
            all_coq_files.txt
            vo_files.list
          retention-days: 90

      - name: éªŒè¯æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“Š éªŒè¯æˆåŠŸç‡ï¼š$((total_vo * 100 / total_v))%"
          echo "âœ… é€»è¾‘ä¸€è‡´æ€§ï¼šæ— å†²çª"
          echo "ğŸ“ æŠ¥å‘Šä¸äº§ç‰©å·²å½’æ¡£ï¼Œä¿ç•™90å¤©"

      - name: éªŒè¯å¤±è´¥ç´§æ€¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯å¤±è´¥"
          echo "ğŸ” å¤±è´¥åŸå› ï¼šæŸ¥çœ‹ compile-all.log æˆ– global-coqchk.log"
          echo "ğŸ“Œ æ ¸å¿ƒæ’æŸ¥æ–¹å‘ï¼šæ¨¡å—ç¼–è¯‘é”™è¯¯ / é€»è¾‘ä¸€è‡´æ€§å†²çª / ä¾èµ–ç¼ºå¤±"
          exit 1