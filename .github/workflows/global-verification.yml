name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master, release/final]
    paths: ['**.v', 'CoqProject', 'Makefile', 'validate.sh']
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 120
    
    env:
      COQ_VERSION: "8.18.0"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      VENV_PATH: "${{ github.workspace }}/.venv"

    steps:
      - name: ä¿®å¤å·¥ä½œç›®å½•æƒé™
        run: |
          mkdir -p ${{ github.workspace }} ~/.opam ~/.cache/opam
          chmod -R 777 ${{ github.workspace }} ~/.opam ~/.cache/opam

      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: åˆ†æé¡¹ç›®ç»“æ„
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== é¡¹ç›®ç»“æ„åˆ†æ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo "Coqæ–‡ä»¶:"
          find . -name "*.v" | wc -l
          echo "å…³é”®æ–‡ä»¶æ£€æŸ¥:"
          for file in Makefile CoqProject; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ç¼ºå¤±"
            fi
          done

      - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
        run: |
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)

      - name: é…ç½®OPAMä»“åº“å’Œå®‰è£…ä¾èµ–
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          echo "=== é…ç½®OPAMä»“åº“ ==="
          # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ä»“åº“å¹¶é‡æ–°æ·»åŠ 
          opam repo remove --all default 2>/dev/null || true
          opam repo remove --all coq-released 2>/dev/null || true
          
          # æ·»åŠ å®˜æ–¹ä»“åº“ï¼ˆé¿å…é•œåƒé—®é¢˜ï¼‰
          opam repo add default https://opam.ocaml.org
          opam repo add coq-released https://coq.inria.fr/opam/released
          
          echo "=== æ›´æ–°åŒ…ä»“åº“ ==="
          opam update -y
          
          echo "=== å®‰è£…Coqæ ¸å¿ƒåŒ… ==="
          # å…ˆå®‰è£…åŸºç¡€CoqåŒ…
          opam install -y coq.${{ env.COQ_VERSION }} coq-stdlib.${{ env.COQ_VERSION }}
          
          echo "=== å®‰è£…MathCompå…¨å®¶æ¡¶ ==="
          # å®‰è£…å®Œæ•´çš„mathcompåŒ…ï¼ˆä½¿ç”¨æ­£ç¡®çš„åŒ…åï¼‰
          opam install -y coq-mathcomp-ssreflect coq-mathcomp-fingroup coq-mathcomp-algebra coq-mathcomp-solvable
          
          echo "=== å®‰è£…å…¶ä»–ä¾èµ– ==="
          opam install -y coq-equations coq-bignums
          
          echo "=== éªŒè¯å®‰è£… ==="
          eval $(opam env --switch=default)
          echo "Coqç‰ˆæœ¬:"
          coqc --version
          echo "å·²å®‰è£…åŒ…:"
          opam list --short | grep coq
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…Pythonç¯å¢ƒ
        run: |
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv
          rm -rf /var/lib/apt/lists/*
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir reportlab

      - name: éªŒè¯é¡¹ç›®é…ç½®
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== éªŒè¯é¡¹ç›®é…ç½® ==="
          mkdir -p ${{ env.REPORT_DIR }}
          
          # éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨
          critical_files=(
            "Makefile"
            "SelfContainedLib/Algebra.v"
            "SelfContainedLib/Category.v" 
            "SelfContainedLib/Geometry.v"
            "theories/FRF_MetaTheory.v"
          )
          
          all_exist=true
          for file in "${critical_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ $file - ç¼ºå¤±"
              all_exist=false
            fi
          done
          
          if [ "$all_exist" = false ]; then
            echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          
          echo "âœ… é¡¹ç›®é…ç½®éªŒè¯é€šè¿‡"

      - name: æ‰§è¡Œç¼–è¯‘éªŒè¯
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== æ‰§è¡Œç¼–è¯‘éªŒè¯ ==="
          mkdir -p ${{ env.REPORT_DIR }}
          
          # æ£€æŸ¥Makefileç›®æ ‡
          echo "å¯ç”¨çš„Makefileç›®æ ‡:"
          make help 2>/dev/null | head -20 || echo "ä½¿ç”¨é»˜è®¤ç¼–è¯‘"
          
          # å°è¯•ç¼–è¯‘æ ¸å¿ƒæ¨¡å—
          echo "ç¼–è¯‘æ ¸å¿ƒåŸºç¡€æ¨¡å—..."
          core_modules=(
            "SelfContainedLib/Algebra.v"
            "SelfContainedLib/Category.v"
            "SelfContainedLib/Geometry.v" 
            "theories/FRF_MetaTheory.v"
          )
          
          for module in "${core_modules[@]}"; do
            if [ -f "$module" ]; then
              echo "ç¼–è¯‘: $module"
              # ä½¿ç”¨ç®€å•çš„coqcå‘½ä»¤ç¼–è¯‘
              coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories "$module" 2>&1 | tee -a ${{ env.REPORT_DIR }}/core-compile.log || true
            fi
          done
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          compiled_files=$(find . -name "*.vo" | wc -l)
          echo "ç¼–è¯‘å®Œæˆçš„.voæ–‡ä»¶æ•°é‡: $compiled_files"
          
          if [ $compiled_files -eq 0 ]; then
            echo "âŒ æ— ç¼–è¯‘äº§ç‰©"
            exit 1
          else
            echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘æˆåŠŸ"
          fi

      - name: å°è¯•å®Œæ•´ç¼–è¯‘
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== å°è¯•å®Œæ•´ç¼–è¯‘ ==="
          
          # å¦‚æœMakefileå­˜åœ¨ä¸”å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å®ƒ
          if [ -f "Makefile" ]; then
            echo "ä½¿ç”¨Makefileç¼–è¯‘..."
            make -j$(nproc) compile 2>&1 | tee ${{ env.REPORT_DIR }}/makefile-compile.log || echo "Makefileç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨å…¶ä»–æ–¹æ³•"
          fi
          
          # ç¼–è¯‘æ‰€æœ‰æ‰¾åˆ°çš„.væ–‡ä»¶
          echo "ç¼–è¯‘æ‰€æœ‰Coqæ–‡ä»¶..."
          find . -name "*.v" | while read v_file; do
            echo "ç¼–è¯‘: $v_file"
            coqc -Q SelfContainedLib SelfContainedLib \
                 -Q theories FRF.Theories \
                 -Q CS_Null FRF.CS_Null \
                 -Q Quantum FRF.Quantum \
                 -Q DynamicSystem FRF.DynamicSystem \
                 -Q Toolchain FRF.Toolchain \
                 -Q Test FRF.Test \
                 -Q CategoryTheory CategoryTheory \
                 "$v_file" 2>&1 | tee -a ${{ env.REPORT_DIR }}/full-compile.log || true
          done
          
          compiled_files=$(find . -name "*.vo" | wc -l)
          echo "æ€»ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"

      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
          
          total_files=$(find . -name "*.v" | wc -l)
          compiled_files=$(find . -name "*.vo" | wc -l)
          if [ $total_files -gt 0 ]; then
            success_rate=$((compiled_files * 100 / total_files))
          else
            success_rate=0
          fi
          
          cat > ${{ env.REPORT_DIR }}/VERIFICATION_REPORT.md << EOF
# FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

## éªŒè¯æ¦‚è§ˆ
- **éªŒè¯æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')
- **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
- **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
- **è¿è¡Œç¯å¢ƒ**: coqorg/coq:${{ env.COQ_VERSION }}
- **Coqç‰ˆæœ¬**: $(coqc --version | head -n1)

## ç¼–è¯‘ç»Ÿè®¡
- **æ€»Coqæ–‡ä»¶æ•°**: $total_files
- **æˆåŠŸç¼–è¯‘æ•°**: $compiled_files
- **ç¼–è¯‘æˆåŠŸç‡**: $success_rate%

## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
EOF

          # æ£€æŸ¥æ ¸å¿ƒæ¨¡å—çŠ¶æ€
          critical_modules=(
            "SelfContainedLib/Algebra.vo"
            "SelfContainedLib/Category.vo"
            "SelfContainedLib/Geometry.vo" 
            "theories/FRF_MetaTheory.vo"
            "theories/ChurchZero.vo"
            "CS_Null/FRF_CS_Null_Common.vo"
          )
          
          for module in "${critical_modules[@]}"; do
            if [ -f "$module" ]; then
              echo "- âœ… $(basename $module .vo)" >> ${{ env.REPORT_DIR }}/VERIFICATION_REPORT.md
            else
              echo "- âŒ $(basename $module .vo)" >> ${{ env.REPORT_DIR }}/VERIFICATION_REPORT.md
            fi
          done
          
          echo "## å„ç›®å½•çŠ¶æ€" >> ${{ env.REPORT_DIR }}/VERIFICATION_REPORT.md
          for dir in SelfContainedLib theories CS_Null Quantum DynamicSystem Toolchain Test; do
            if [ -d "$dir" ]; then
              v_count=$(find "$dir" -name "*.v" 2>/dev/null | wc -l)
              vo_count=$(find "$dir" -name "*.vo" 2>/dev/null | wc -l)
              echo "- **$dir**: $vo_count/$v_count" >> ${{ env.REPORT_DIR }}/VERIFICATION_REPORT.md
            fi
          done
          
          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: å½’æ¡£éªŒè¯äº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frf-verification-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/
            **/*.vo
            **/*.glob
          retention-days: 30

      - name: éªŒè¯æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          compiled_count=$(find . -name "*.vo" | wc -l)
          echo "ğŸ‰ FRF 2.0 éªŒè¯å®Œæˆï¼"
          echo "ğŸ“Š ç¼–è¯‘æ¨¡å—æ•°: $compiled_count"

      - name: éªŒè¯å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 éªŒè¯å¤±è´¥"
          echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—"