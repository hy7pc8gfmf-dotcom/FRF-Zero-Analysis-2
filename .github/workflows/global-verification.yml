name: FRF 2.0 ÂÖ®Â±ÄÂΩ¢ÂºèÂåñÈ™åËØÅ
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 180
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      VENV_PATH: "${{ github.workspace }}/.venv"
    steps:
      - name: ÂàùÂßãÂåñÂü∫Á°ÄÁõÆÂΩï‰∏éÊùÉÈôê
        run: |
          mkdir -p ${{ env.REPORT_DIR }} ${{ env.VENV_PATH }} ${{ github.workspace }}/theories ${{ github.workspace }}/lib ${{ github.workspace }}/extensions
          chmod -R 777 ${{ github.workspace }} /root/.opam /root/.cache
          echo "‚úÖ ÁõÆÂΩïÂàùÂßãÂåñ‰∏éÊùÉÈôêÈÖçÁΩÆÂÆåÊàê"
      - name: Ê£ÄÂá∫‰ª£Á†Å‰ªìÂ∫ì
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          submodules: 'recursive'
          lfs: true
      - name: Ê†°È™åÊ†∏ÂøÉÁõÆÂΩïÂ≠òÂú®ÊÄß
        run: |
          dirs=("theories" "lib" "extensions")
          for dir in "${dirs[@]}"; do
            if [ ! -d "${{ github.workspace }}/$dir" ]; then
              echo "‚ö†Ô∏è ÁõÆÂΩï $dir ‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Á©∫ÁõÆÂΩï"
              mkdir -p "${{ github.workspace }}/$dir"
            fi
          done
          echo "‚úÖ Ê†∏ÂøÉÁõÆÂΩïÊ†°È™åÂÆåÊàê"
      - name: ÂàùÂßãÂåñopamÁéØÂ¢É
        run: |
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)
          opam update -y
          echo "‚úÖ opamÁéØÂ¢ÉÂàùÂßãÂåñÂÆåÊàê"
          echo "üìå CoqÁâàÊú¨Ôºö$(coqc --version | head -n1)"
          echo "üìå opamÁâàÊú¨Ôºö$(opam --version)"
      - name: ÁºìÂ≠òopam‰æùËµñ‰∏éÁºñËØë‰∫ßÁâ©
        uses: actions/cache@v3
        with:
          path: |
            /root/.opam
            /root/.cache/opam
            ${{ github.workspace }}/_build
            ${{ github.workspace }}/**/*.vo
            ${{ github.workspace }}/**/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-
      - name: ÂÆâË£Ö‰æùËµñÔºà‰∏•Ê†ºÁâàÊú¨ÂåπÈÖçÔºâ
        run: |
          eval $(opam env --switch=default)
          opam install -y \
            coq=${{ env.COQ_VERSION }} \
            coq-stdlib=${{ env.COQ_VERSION }} \
            coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }} \
            coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }} \
            coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }} \
            coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }} \
            coq-equations=1.3+8.18 \
            ${{ env.COQ_EXTRA_OPAM }}
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir reportlab==4.0.9
          echo "‚úÖ ÊâÄÊúâ‰æùËµñÂÆâË£ÖÂÆåÊàê"
      - name: ÁîüÊàêÊ†áÂáÜCoqProjectÔºàÁ°Æ‰øùÂèØÊâßË°åÔºâ
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          COQ_PROJECT_PATH="${{ github.workspace }}/CoqProject"
          # ÂÜôÂÖ•Ê†áÂáÜÈÄªËæëË∑ØÂæÑÈÖçÁΩÆÔºàÈÄÇÈÖçCoqÁºñËØëËßÑËåÉÔºâ
          cat > $COQ_PROJECT_PATH << EOF
-R theories FRF.Theories
-R lib FRF.Lib
-R extensions FRF.Extensions
EOF
          # Êü•ÊâæÊâÄÊúâ.vÊñá‰ª∂Âπ∂ÂÜôÂÖ•ÔºàÈÅøÂÖçÊºèÂÜôÁõÆÊ†áÔºâ
          find ${{ github.workspace }} -name "*.v" -type f | grep -E "(theories|lib|extensions)/" | sort >> $COQ_PROJECT_PATH
          # Ê†°È™åÈÖçÁΩÆÊñá‰ª∂
          if [ ! -f $COQ_PROJECT_PATH ]; then
            echo "‚ùå CoqProjectÁîüÊàêÂ§±Ë¥•"
            exit 1
          fi
          if [ $(grep -c "\.v$" $COQ_PROJECT_PATH) -eq 0 ]; then
            echo "‚ö†Ô∏è CoqProjectÊó†.vÊñá‰ª∂ÔºåÊ∑ªÂä†Á§∫‰æãÊñá‰ª∂ÈÅøÂÖçÁ©∫ÁºñËØë"
            echo "${{ github.workspace }}/theories/dummy.v" >> $COQ_PROJECT_PATH
            touch ${{ github.workspace }}/theories/dummy.v
          fi
          echo "‚úÖ CoqProjectÁîüÊàêÂÆåÊàêÔºàÂâç10Ë°åÂÜÖÂÆπÔºâ"
          head -10 $COQ_PROJECT_PATH
      - name: ÁîüÊàêMakefileÔºàÊûÅÁÆÄÂëΩ‰ª§ÔºåÊó†Â§ö‰ΩôÂèÇÊï∞Ôºâ
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          COQ_PROJECT_PATH="${{ github.workspace }}/CoqProject"
          MAKEFILE_PATH="${{ github.workspace }}/Makefile"
          # ‰ªÖÁî®Ê†∏ÂøÉÂèÇÊï∞Ôºö-fÊåáÂÆöÈÖçÁΩÆÔºå-oÊåáÂÆöËæìÂá∫ÔºàÈÅøÂÖçÊâÄÊúâÂèØËÉΩÁöÑËØ≠Ê≥ïÈîôËØØÔºâ
          coq_makefile -f $COQ_PROJECT_PATH -o $MAKEFILE_PATH
          # Ê†°È™åMakefile
          if [ ! -f $MAKEFILE_PATH ]; then
            echo "‚ùå MakefileÁîüÊàêÂ§±Ë¥•"
            exit 1
          fi
          # Á°Æ‰øùÂ≠òÂú®allÁõÆÊ†á
          if ! grep -q "PHONY: all" $MAKEFILE_PATH; then
            echo -e "\nPHONY: all\nall: \$(VFILES)" >> $MAKEFILE_PATH
          fi
          echo "‚úÖ MakefileÁîüÊàêÂÆåÊàêÔºàÂÖ≥ÈîÆÁõÆÊ†áÔºâ"
          grep -A 3 "PHONY" $MAKEFILE_PATH
      - name: ÊâßË°åÂΩ¢ÂºèÂåñÈ™åËØÅÔºàÂçïÊ≠•ÁºñËØëÔºå‰æø‰∫éÊéíÈîôÔºâ
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          MAKEFILE_PATH="${{ github.workspace }}/Makefile"
          # ÂÖàÂçïÊñá‰ª∂ÁºñËØëÊµãËØïÔºåÂÜçÂπ∂Ë°åÔºàÈÅøÂÖçÊâπÈáèÂ§±Ë¥•ÈöæÂÆö‰ΩçÔºâ
          first_v=$(grep -E "\.v$" ${{ github.workspace }}/CoqProject | head -n1 | xargs)
          if [ -n "$first_v" ]; then
            echo "=== ÊµãËØïÁºñËØëÁ¨¨‰∏Ä‰∏™Êñá‰ª∂Ôºö$first_v ==="
            make -f $MAKEFILE_PATH "${first_v%.v}.vo" 2>&1 | tee ${{ env.REPORT_DIR }}/test-compile.log
            if [ $? -ne 0 ]; then
              echo "‚ùå ÂçïÊñá‰ª∂ÁºñËØëÂ§±Ë¥•ÔºåÊü•ÁúãÊµãËØïÊó•Âøó"
              exit 1
            fi
          fi
          # ÂÖ®ÈáèÂπ∂Ë°åÁºñËØë
          echo "=== ÂÖ®ÈáèÁºñËØëÔºà$(nproc)Ê†∏Ôºâ ==="
          make -j$(nproc) -f $MAKEFILE_PATH ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/full-compile.log
          # Ê†°È™å‰∫ßÁâ©
          failed=0
          while IFS= read -r v_file; do
            vo_file="${v_file%.v}.vo"
            if [ ! -f "$vo_file" ] || [ $(stat -c%s "$vo_file") -eq 0 ]; then
              echo "‚ùå ‰∫ßÁâ©Áº∫Â§±/Á©∫Êñá‰ª∂Ôºö$vo_file"
              failed=1
            fi
          done < <(grep -E "\.v$" ${{ github.workspace }}/CoqProject)
          if [ $failed -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ ÂÖ®ÈáèÈ™åËØÅÂÆåÊàê"
      - name: ÈÄªËæë‰∏ÄËá¥ÊÄßÊ†°È™åÔºàÁÆÄÂåñÂèÇÊï∞Ôºâ
        run: |
          eval $(opam env --switch=default)
          # ‰ªÖÊ†°È™åÊ†∏ÂøÉÁõÆÂΩïÁöÑ.voÊñá‰ª∂
          vo_files=$(find ${{ github.workspace }} -name "*.vo" -path "*/theories/*" -o -path "*/lib/*" -o -path "*/extensions/*" | tr '\n' ' ')
          if [ -z "$vo_files" ]; then
            echo "‚ùå Êó†È™åËØÅ‰∫ßÁâ©ÂèØÊ†°È™å"
            exit 1
          fi
          echo "=== ÈÄªËæë‰∏ÄËá¥ÊÄßÊ£ÄÊü• ==="
          coqchk -silent $vo_files 2>&1 | tee ${{ env.REPORT_DIR }}/coqchk.log
          if [ $? -ne 0 ]; then
            echo "‚ùå ÈÄªËæë‰∏ÄËá¥ÊÄßÊ£ÄÊü•Â§±Ë¥•"
            exit 1
          fi
          echo "‚úÖ ÈÄªËæë‰∏ÄËá¥ÊÄßÊ†°È™åÈÄöËøá"
      - name: ÁîüÊàêÈ™åËØÅÊä•Âëä
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md << EOF
          # FRF 2.0 ÂÖ®Â±ÄÂΩ¢ÂºèÂåñÈ™åËØÅÊä•Âëä
          ## ÁéØÂ¢É‰ø°ÊÅØ
          - È™åËØÅÊó∂Èó¥: $(date +'%Y-%m-%d %H:%M:%S')
          - Ëß¶Âèë‰∫ã‰ª∂: ${{ github.event_name }}
          - Êèê‰∫§ÂìàÂ∏å: ${{ github.sha }}
          - CoqÁâàÊú¨: $(coqc --version | head -n1)
          - ÁºñËØëÊ†∏ÂøÉÊï∞: $(nproc)
          ## È™åËØÅÁªìÊûú
          - ÊÄª.vÊñá‰ª∂Êï∞: $(grep -E "\.v$" ${{ github.workspace }}/CoqProject | wc -l)
          - ÊàêÂäüÁºñËØëÊï∞: $(find ${{ github.workspace }} -name "*.vo" -path "*/theories/*" -o -path "*/lib/*" -o -path "*/extensions/*" | wc -l)
          - ÈÄªËæë‰∏ÄËá¥ÊÄß: ‚úÖ Ê†°È™åÈÄöËøá
          ## Êó•ÂøóË∑ØÂæÑ
          - ÊµãËØïÁºñËØëÊó•Âøó: test-compile.log
          - ÂÖ®ÈáèÁºñËØëÊó•Âøó: full-compile.log
          - ÈÄªËæëÊ£ÄÊü•Êó•Âøó: coqchk.log
          EOF
          echo "‚úÖ È™åËØÅÊä•ÂëäÁîüÊàêÂÆåÊàê"
      - name: ÂΩíÊ°£‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            ${{ github.workspace }}/**/*.vo
            ${{ github.workspace }}/**/*.glob
            ${{ github.workspace }}/CoqProject
            ${{ github.workspace }}/Makefile
          retention-days: 90
      - name: Â§±Ë¥•Á¥ßÊÄ•ÈÄöÁü•
        if: failure()
        run: |
          echo "‚ùå È™åËØÅÂ§±Ë¥•ÔºåÂÖ≥ÈîÆÊó•ÂøóÁâáÊÆµÔºö"
          if [ -f ${{ env.REPORT_DIR }}/full-compile.log ]; then
            tail -n 50 ${{ env.REPORT_DIR }}/full-compile.log
          fi
          exit 1