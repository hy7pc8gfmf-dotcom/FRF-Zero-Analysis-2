name: FRF 2.0 ä¼˜åŒ–æ¨¡å—éªŒè¯æµï¼ˆå»Mathlibä¾èµ–ï¼‰
on:
  push:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**.v'
      - 'theories/FRF_MetaTheory.v'
      - '.github/workflows/global-verification.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**.v'
      - 'theories/FRF_MetaTheory.v'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  optimize-module-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    env:
      # éœ€éªŒè¯çš„ä¼˜åŒ–æ¨¡å—ï¼ˆåŸºç¡€åº“+å…ƒç†è®ºï¼‰
      CORE_BASE_MODULES: "SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v"
      CORE_META_MODULE: "theories/FRF_MetaTheory.v"

    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åŠ é€Ÿä»£ç æ‹‰å–

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            opam \
            bubblewrap \
            g++ \
            pkg-config \
            m4 \
            rsync \
            git \
            wget
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: åˆå§‹åŒ–OPAMç¯å¢ƒï¼ˆå…¼å®¹Coq 8.18.0ï¼‰
        run: |
          opam init --disable-sandboxing -y --compiler=4.14.0
          eval $(opam env)
          opam repo add coq-released https://coq.inria.fr/opam/released
          opam update -y
          echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆæ— éœ€Mathlibï¼Œæ¨¡å—å·²è‡ªåŒ…å«ï¼‰
        run: |
          eval $(opam env)
          
          # ä»…å®‰è£…Coq 8.18.0 + mathcomp-ssreflectï¼ˆåŸºç¡€ä»£æ•°ä¾èµ–ï¼‰
          echo "å®‰è£…Coq 8.18.0..."
          opam install -y coq.8.18.0
          
          echo "å®‰è£…mathcomp-ssreflect 1.17.0..."
          opam install -y coq-mathcomp-ssreflect.1.17.0
          
          # éªŒè¯å®‰è£…
          echo "=== ä¾èµ–ç‰ˆæœ¬éªŒè¯ ==="
          coqc --version | head -1
          opam list --installed | grep -E "coq|mathcomp"
          echo "âœ… æ ¸å¿ƒä¾èµ–å®‰è£…å®Œæˆï¼ˆæ— éœ€Mathlibï¼Œæ¨¡å—è‡ªåŒ…å«ï¼‰"

      - name: éªŒè¯ä¼˜åŒ–æ¨¡å—å­˜åœ¨æ€§
        run: |
          eval $(opam env)
          
          echo "=== æ¨¡å—è·¯å¾„éªŒè¯ ==="
          for mod in $CORE_BASE_MODULES $CORE_META_MODULE; do
            if [ -f "$mod" ]; then
              echo "âœ… ä¼˜åŒ–æ¨¡å—å­˜åœ¨ï¼š$mod"
            else
              echo "âŒ ä¼˜åŒ–æ¨¡å—ç¼ºå¤±ï¼š$mod"
              exit 1
            fi
          done
          
          total_v=$(find . -name "*.v" | wc -l)
          echo "=== é¡¹ç›®ç»Ÿè®¡ ==="
          echo "æ€»Coqæ–‡ä»¶æ•°ï¼š$total_v"
          echo "éœ€éªŒè¯ä¼˜åŒ–æ¨¡å—æ•°ï¼š$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)"

      - name: åŸºç¡€ç¯å¢ƒæµ‹è¯•ï¼ˆéªŒè¯coqcå¯ç”¨æ€§ï¼‰
        run: |
          eval $(opam env)
          
          cat > /tmp/test_env.v << 'EOF'
          Theorem env_ok : True. Proof. exact I. Qed.
          EOF
          
          if coqc /tmp/test_env.v && [ -f "/tmp/test_env.vo" ]; then
            echo "âœ… åŸºç¡€ç¼–è¯‘æµ‹è¯•é€šè¿‡"
            rm -f /tmp/test_env.vo /tmp/test_env.glob
          else
            echo "âŒ åŸºç¡€ç¼–è¯‘æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          rm -f /tmp/test_env.v

      - name: åˆ†æ­¥ç¼–è¯‘ä¼˜åŒ–æ¨¡å—ï¼ˆæ— Mathlibä¾èµ–ï¼‰
        run: |
          eval $(opam env)
          
          echo "=== åˆ†æ­¥ç¼–è¯‘ä¼˜åŒ–æ¨¡å— ==="
          # ä»…ç»‘å®šSelfContainedLibè·¯å¾„ï¼ˆæ¨¡å—å·²è‡ªåŒ…å«ï¼Œæ— éœ€Mathlibï¼‰
          BASE_FLAGS="-Q SelfContainedLib SelfContainedLib"
          echo "ç¼–è¯‘å‚æ•°ï¼š$BASE_FLAGS"
          
          # æŒ‰ä¾èµ–é¡ºåºç¼–è¯‘ï¼ˆé¿å…è¿é”å¤±è´¥ï¼‰
          for mod in $CORE_BASE_MODULES $CORE_META_MODULE; do
            echo -e "\nç¼–è¯‘ï¼š$mod"
            if coqc $BASE_FLAGS "$mod"; then
              vo_file=$(echo $mod | sed 's/\.v/\.vo/')
              echo "âœ… æˆåŠŸï¼š$modï¼ˆäº§ç‰©ï¼š$vo_fileï¼‰"
            else
              echo "âŒ å¤±è´¥ï¼š$modï¼ˆé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼‰"
              coqc $BASE_FLAGS "$mod" 2>&1 | head -15
              exit 1
            fi
          done
          
          echo -e "\nğŸ‰ æ‰€æœ‰ä¼˜åŒ–æ¨¡å—ç¼–è¯‘é€šè¿‡ï¼"

      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        run: |
          eval $(opam env)
          
          mkdir -p verification-reports
          report_path="verification-reports/OPTIMIZED_REPORT.md"
          
          # æ”¶é›†ä¿¡æ¯
          verify_time=$(date "+%Y-%m-%d %H:%M:%S UTC")
          coq_version=$(coqc --version | head -1)
          total_optimized=$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)
          compiled_vo=$(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | wc -l)
          success_rate=$((compiled_vo * 100 / total_optimized))
          
          # ç”ŸæˆæŠ¥å‘Š
          cat > $report_path << EOF
          # FRF 2.0 ä¼˜åŒ–æ¨¡å—éªŒè¯æŠ¥å‘Šï¼ˆå»Mathlibä¾èµ–ï¼‰
          
          ## éªŒè¯åŸºæœ¬ä¿¡æ¯
          - **éªŒè¯æ—¶é—´**: $verify_time
          - **ç¯å¢ƒ**: Ubuntu 22.04 (GitHub Actions)
          - **Coqç‰ˆæœ¬**: $coq_version
          - **ä¾èµ–**: coq.8.18.0 + coq-mathcomp-ssreflect.1.17.0
          - **éªŒè¯ç›®æ ‡**: ä¼˜åŒ–åçš„æ ¸å¿ƒæ¨¡å—ï¼ˆåŸºç¡€åº“+å…ƒç†è®ºï¼‰
          
          ## æ ¸å¿ƒä¿®æ­£è¯´æ˜
          ### 1. ç§»é™¤Mathlibä¾èµ–çš„åŸå› 
          - opamä»“åº“æ— ã€Œcoq-mathlib3ã€åŒ…åï¼ŒMathlib 3.74.0æ— éœ€å•ç‹¬å®‰è£…ï¼ˆå·²æ•´åˆåˆ°Coq stdlibï¼‰ï¼›
          - ä¼˜åŒ–åçš„åŸºç¡€æ¨¡å—ï¼ˆAlgebra/Category/Geometryï¼‰å·²å®ç°ã€Œè‡ªåŒ…å«å®šä¹‰ã€ï¼Œç§»é™¤äº†å¯¹Mathlibçš„æ‰€æœ‰å¯¼å…¥ï¼›
          - å…ƒç†è®ºæ¨¡å—ï¼ˆFRF_MetaTheory.vï¼‰çš„Mathlibå¯¼å…¥å·²é€‚é…Coq stdlibï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–ã€‚
          
          ### 2. éªŒè¯ç»Ÿè®¡
          | æŒ‡æ ‡                | æ•°å€¼  |
          |---------------------|-------|
          | éœ€éªŒè¯ä¼˜åŒ–æ¨¡å—æ•°    | $total_optimized |
          | ç¼–è¯‘æˆåŠŸæ¨¡å—æ•°      | $compiled_vo |
          | éªŒè¯æˆåŠŸç‡          | $success_rate% |
          
          ## ç¼–è¯‘äº§ç‰©åˆ—è¡¨
          \`\`\`
          $(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | sed 's|^\./||')
          \`\`\`
          
          ## ä¾èµ–è¯¦æƒ…
          \`\`\`
          $(opam list --installed | grep -E "coq|mathcomp" | sort)
          \`\`\`
          
          ## éªŒè¯ç»“è®º
          - æ‰€æœ‰ä¼˜åŒ–æ¨¡å—å‡é€šè¿‡ç¼–è¯‘ï¼Œæ— å¯¼å…¥é”™è¯¯ã€ä¾èµ–ç¼ºå¤±é—®é¢˜ï¼›
          - åŸºç¡€æ¨¡å—å®ç°å®Œå…¨è‡ªåŒ…å«ï¼Œä¸ä¾èµ–å¤–éƒ¨Mathlibï¼Œç¼–è¯‘ç¨³å®šæ€§å¤§å¹…æå‡ï¼›
          - éªŒè¯æµç¨‹æ‰“é€šï¼Œå¯æ”¯æ’‘åç»­é‡å­æ¨¡å—ã€åŠ¨æ€ç³»ç»Ÿæ¨¡å—å¼€å‘ã€‚
          EOF
          
          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼ˆè·¯å¾„ï¼š$report_pathï¼‰"

      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: frf-optimized-report
          path: verification-reports/
          retention-days: 14
          if-no-files-found: error

      - name: éªŒè¯çŠ¶æ€æ€»ç»“
        run: |
          eval $(opam env)
          
          compiled_vo=$(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | wc -l)
          total_optimized=$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)
          
          if [ $compiled_vo -eq $total_optimized ]; then
            echo "ğŸ‰ FRF 2.0 ä¼˜åŒ–æ¨¡å—å…¨é‡éªŒè¯é€šè¿‡ï¼"
            echo "ğŸ“Š ç»“æœï¼š$compiled_vo/$total_optimized æ¨¡å—ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ éªŒè¯å¤±è´¥"
            exit 1
          fi