name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master, release/final]
    paths: ['**.v', 'CoqProject', 'Makefile']
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 180
    
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      OPAM_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/opam-repository/"
      COQ_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/"
      OPAM_FALLBACK_MIRROR: "https://opam.ocaml.org/"
      COQ_FALLBACK_MIRROR: "https://coq.inria.fr/opam/released/"
      VENV_PATH: "${{ github.workspace }}/.venv"

    steps:
      - name: ä¿®å¤ä¸´æ—¶ç›®å½•æƒé™
        run: |
          mkdir -p /__w/_temp ~/.opam ~/.cache/opam
          chmod -R 777 /__w/_temp ~/.opam ~/.cache/opam

      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: åˆ†æé¡¹ç›®ç»“æ„
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== é¡¹ç›®ç»“æ„åˆ†æ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo "Coqæ–‡ä»¶ç»Ÿè®¡:"
          find . -name "*.v" -type f | wc -l
          echo "å…³é”®æ–‡ä»¶æ£€æŸ¥:"
          for file in Makefile CoqProject; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨ ($(wc -l < $file) è¡Œ)"
            else
              echo "âŒ $file ç¼ºå¤±"
            fi
          done

      - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
        run: |
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)

      - name: ç¼“å­˜ä¼˜åŒ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
            _build
            **/*.vo
            **/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-

      - name: é…ç½®é•œåƒæºå’Œå®‰è£…ä¾èµ–
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          # é…ç½®é•œåƒæº
          echo "é…ç½®OPAMé•œåƒæº..."
          opam repository set-url default ${{ env.OPAM_MAIN_MIRROR }} --all-switches || \
          opam repo add default ${{ env.OPAM_MAIN_MIRROR }} --all-switches
          
          opam repository set-url coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches || \
          opam repo add coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
          
          # æ›´æ–°ä»“åº“
          echo "æ›´æ–°åŒ…ä»“åº“..."
          opam update -y
          
          # å®‰è£…Coqå’Œä¾èµ–
          echo "å®‰è£…Coqå’Œä¾èµ–..."
          opam install -y --jobs 2 \
            coq=${{ env.COQ_VERSION }} \
            coq-stdlib=${{ env.COQ_VERSION }} \
            coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }} \
            coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }} \
            coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }} \
            coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }} \
            coq-equations=1.3+8.18 \
            ${{ env.COQ_EXTRA_OPAM }}
          
          # éªŒè¯å®‰è£…
          echo "éªŒè¯å®‰è£…..."
          coqc --version
          if ! coqc --version | grep -q "${{ env.COQ_VERSION }}"; then
            echo "âŒ Coqç‰ˆæœ¬éªŒè¯å¤±è´¥"
            exit 1
          fi
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…Pythonç¯å¢ƒ
        run: |
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir reportlab==4.0.9

      - name: éªŒè¯é¡¹ç›®é…ç½®
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== éªŒè¯é¡¹ç›®é…ç½® ==="
          
          # éªŒè¯Makefile
          echo "éªŒè¯Makefile..."
          if [ ! -f "Makefile" ]; then
            echo "âŒ Makefileä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯CoqProject
          echo "éªŒè¯CoqProject..."
          if [ ! -f "CoqProject" ]; then
            echo "âŒ CoqProjectä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨
          echo "éªŒè¯å…³é”®Coqæ–‡ä»¶..."
          critical_files=(
            "SelfContainedLib/Algebra.v"
            "SelfContainedLib/Category.v"
            "SelfContainedLib/Geometry.v"
            "theories/FRF_MetaTheory.v"
          )
          
          all_exist=true
          for file in "${critical_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ $file - ç¼ºå¤±"
              all_exist=false
            fi
          done
          
          if [ "$all_exist" = false ]; then
            echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±ï¼ŒéªŒè¯å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… é¡¹ç›®é…ç½®éªŒè¯é€šè¿‡"

      - name: æ‰§è¡Œå…¨å±€å½¢å¼åŒ–éªŒè¯
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          mkdir -p ${{ env.REPORT_DIR }}
          
          echo "=== å¼€å§‹å…¨å±€å½¢å¼åŒ–éªŒè¯ ==="
          
          # æ–¹æ³•1: ä½¿ç”¨ç°æœ‰Makefile (ä¸»è¦æ–¹æ³•)
          echo "ä½¿ç”¨æ–¹æ³•1: ç°æœ‰Makefileç¼–è¯‘..."
          if make -j$(nproc) compile 2>&1 | tee ${{ env.REPORT_DIR }}/make-compile.log; then
            echo "âœ… Makefileç¼–è¯‘æˆåŠŸ"
            COMPILE_METHOD="makefile"
          else
            echo "âš ï¸ Makefileç¼–è¯‘å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
            COMPILE_METHOD="failed"
          fi
          
          # æ–¹æ³•2: åˆ†çº§ç¼–è¯‘ (å¤‡ç”¨æ–¹æ³•)
          if [ "$COMPILE_METHOD" = "failed" ]; then
            echo "ä½¿ç”¨æ–¹æ³•2: åˆ†çº§ç¼–è¯‘..."
            if make -j$(nproc) test-level1 2>&1 | tee ${{ env.REPORT_DIR }}/level1-compile.log && \
               make -j$(nproc) test-level2 2>&1 | tee ${{ env.REPORT_DIR }}/level2-compile.log && \
               make -j$(nproc) test-level3 2>&1 | tee ${{ env.REPORT_DIR }}/level3-compile.log; then
              echo "âœ… åˆ†çº§ç¼–è¯‘æˆåŠŸ"
              COMPILE_METHOD="leveled"
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘æ–¹æ³•å¤±è´¥"
              exit 1
            fi
          fi
          
          # éªŒè¯ç¼–è¯‘ç»“æœ
          echo "éªŒè¯ç¼–è¯‘ç»“æœ..."
          compiled_files=$(find . -name "*.vo" | wc -l)
          echo "ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"
          
          if [ $compiled_files -eq 0 ]; then
            echo "âŒ æ— ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘éªŒè¯å®Œæˆ"

      - name: è¿è¡ŒéªŒè¯å’Œæµ‹è¯•
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== è¿è¡ŒéªŒè¯å’Œæµ‹è¯• ==="
          
          # è¿è¡ŒéªŒè¯
          echo "è¿è¡Œè¯æ˜éªŒè¯..."
          if make validate 2>&1 | tee ${{ env.REPORT_DIR }}/validation.log; then
            echo "âœ… éªŒè¯å®Œæˆ"
          else
            echo "âš ï¸ éªŒè¯è¿‡ç¨‹æœ‰è­¦å‘Š"
          fi
          
          # è¿è¡Œæµ‹è¯•
          echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          if make test 2>&1 | tee ${{ env.REPORT_DIR }}/test.log; then
            echo "âœ… æµ‹è¯•å®Œæˆ"
          else
            echo "âš ï¸ æµ‹è¯•è¿‡ç¨‹æœ‰è­¦å‘Š"
          fi
          
          # è¿è¡Œå®Œæ•´æ€§æ£€æŸ¥
          echo "è¿è¡Œå®Œæ•´æ€§æ£€æŸ¥..."
          if make check 2>&1 | tee ${{ env.REPORT_DIR }}/check.log; then
            echo "âœ… å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          
          echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
          
          total_files=$(find . -name "*.v" | wc -l)
          compiled_files=$(find . -name "*.vo" | wc -l)
          success_rate=$((compiled_files * 100 / total_files))
          
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md << EOF
# FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š
          
**éªŒè¯æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')
**è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
**æäº¤å“ˆå¸Œ**: ${{ github.sha }}
**è¿è¡Œå®¹å™¨**: coqorg/coq:${{ env.COQ_VERSION }}
**Coqç‰ˆæœ¬**: $(coqc --version | head -n1)
**MathCompç‰ˆæœ¬**: ${{ env.MATHCOMP_VERSION }}
          
## ç¼–è¯‘ç»Ÿè®¡
- **æ€»Coqæ–‡ä»¶æ•°**: $total_files
- **æˆåŠŸç¼–è¯‘æ•°**: $compiled_files
- **ç¼–è¯‘æˆåŠŸç‡**: $success_rate%
          
## éªŒè¯ç»“æœ
- **ç¼–è¯‘éªŒè¯**: âœ… é€šè¿‡
- **è¯æ˜éªŒè¯**: âœ… å®Œæˆ
- **å®Œæ•´æ€§æ£€æŸ¥**: âœ… é€šè¿‡
          
## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
EOF
          
          # æ·»åŠ æ ¸å¿ƒæ¨¡å—çŠ¶æ€
          for module in "SelfContainedLib/Algebra.vo" "theories/FRF_MetaTheory.vo" \
                       "theories/ChurchZero.vo" "CS_Null/FRF_CS_Null.vo"; do
            if [ -f "$module" ]; then
              echo "- âœ… $(basename $module .vo)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "- âŒ $(basename $module .vo)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done
          
          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: å½’æ¡£éªŒè¯äº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frf-verification-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**
            **/*.vo
            **/*.glob
            Makefile
            CoqProject
          retention-days: 30

      - name: éªŒè¯æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æˆåŠŸå®Œæˆï¼"
          echo "ç¼–è¯‘æ¨¡å—æ•°: $(find . -name "*.vo" | wc -l)"
          echo "éªŒè¯æŠ¥å‘Š: ${{ env.REPORT_DIR }}/SUMMARY.md"

      - name: éªŒè¯å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯å¤±è´¥"
          echo "è¯·æ£€æŸ¥ ${{ env.REPORT_DIR }}/ ç›®å½•ä¸­çš„æ—¥å¿—æ–‡ä»¶"