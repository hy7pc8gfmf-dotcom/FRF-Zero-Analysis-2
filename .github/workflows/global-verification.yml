name: FRF 2.0 可执行全量形式化验证（精简版）

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 90  # 增加总超时时间
    steps:
    - name: 📥 检出代码仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false

    - name: 🖥️ 系统信息检查
      run: |
        echo "=== 系统信息 ==="
        echo "系统: $(uname -a)"
        echo "CPU核心: $(nproc)"
        echo "内存: $(free -m | awk '/^Mem:/{print "总量:" $2 "MB, 可用:" $7 "MB"}')"
        echo "磁盘:"
        df -h

    - name: 📦 安装系统依赖（精简版）
      run: |
        echo "安装系统依赖..."
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget
        echo "✅ 系统依赖安装完成"

    - name: 🔄 初始化OPAM环境（基于可执行版）
      timeout-minutes: 20
      run: |
        echo "初始化OPAM环境..."
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "✅ OPAM环境初始化完成"
        echo "OPAM版本: $(opam --version)"

    - name: 📚 安装Coq核心（固定版本）
      timeout-minutes: 25
      run: |
        eval $(opam env)
        echo "安装Coq 8.18.0..."
        
        # 安装Coq核心（不安装推荐包）
        opam install -y --no-depexts coq.8.18.0
        
        echo "验证Coq安装..."
        if coqc --version | grep -q "8.18.0"; then
          echo "✅ Coq 8.18.0 安装成功"
        else
          echo "❌ Coq版本不匹配"
          exit 1
        fi

    - name: 🧮 安装mathcomp-ssreflect（精确版本1.17.0）
      timeout-minutes: 15
      run: |
        eval $(opam env)
        echo "安装mathcomp-ssreflect 1.17.0..."
        
        # 精确安装指定版本，避免自动升级
        opam install -y --no-depexts coq-mathcomp-ssreflect=1.17.0
        
        echo "验证mathcomp安装..."
        if opam list --installed | grep -q "coq-mathcomp-ssreflect.1.17.0"; then
          echo "✅ mathcomp-ssreflect 1.17.0 安装成功"
        else
          echo "❌ mathcomp安装失败"
          echo "当前安装的mathcomp版本:"
          opam list --installed | grep mathcomp
          exit 1
        fi

    - name: 📊 环境验证报告
      run: |
        eval $(opam env)
        echo "=== 环境验证报告 ==="
        echo "Coq版本:"
        coqc --version
        echo ""
        echo "核心包列表:"
        opam list --installed --short | grep -E "coq|mathcomp"
        echo ""
        echo "环境变量:"
        echo "OPAMROOT: $OPAMROOT"
        echo "OPAMSWITCH: $OPAMSWITCH"

    - name: 📁 准备工作目录
      run: |
        echo "创建工作目录..."
        mkdir -p SelfContainedLib theories CS_Null Test
        echo "检查文件结构:"
        ls -la
        echo ""
        echo "检查关键文件:"
        for dir in SelfContainedLib theories CS_Null Test; do
          echo "$dir目录:"
          ls -la $dir/*.v 2>/dev/null || echo "  无.v文件"
        done

    - name: 🔧 第一步：编译一级基础层
      timeout-minutes: 15
      run: |
        eval $(opam env)
        echo "=== 编译一级基础层模块 ==="
        echo "编译参数: -Q SelfContainedLib SelfContainedLib"
        
        # 编译Algebra.v
        if [ -f "SelfContainedLib/Algebra.v" ]; then
          echo "编译Algebra.v..."
          if coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Algebra.v; then
            echo "✅ Algebra.v 编译成功"
          else
            echo "❌ Algebra.v 编译失败"
            exit 1
          fi
        else
          echo "❌ Algebra.v 文件缺失"
          echo "当前目录内容:"
          ls -la SelfContainedLib/
          exit 1
        fi
        
        # 编译Category.v
        if [ -f "SelfContainedLib/Category.v" ]; then
          echo "编译Category.v..."
          if coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Category.v; then
            echo "✅ Category.v 编译成功"
          else
            echo "❌ Category.v 编译失败"
            exit 1
          fi
        else
          echo "❌ Category.v 文件缺失"
          exit 1
        fi
        
        # 编译Geometry.v
        if [ -f "SelfContainedLib/Geometry.v" ]; then
          echo "编译Geometry.v..."
          if coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Geometry.v; then
            echo "✅ Geometry.v 编译成功"
          else
            echo "❌ Geometry.v 编译失败"
            exit 1
          fi
        else
          echo "❌ Geometry.v 文件缺失"
          exit 1
        fi

    - name: 🔧 第二步：编译二级元理论层
      timeout-minutes: 20
      run: |
        eval $(opam env)
        echo "=== 编译二级元理论层模块 ==="
        echo "编译参数: -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories"
        
        # 编译FRF_MetaTheory.v
        if [ -f "theories/FRF_MetaTheory.v" ]; then
          echo "编译FRF_MetaTheory.v..."
          if coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/FRF_MetaTheory.v; then
            echo "✅ FRF_MetaTheory.v 编译成功"
          else
            echo "❌ FRF_MetaTheory.v 编译失败"
            exit 1
          fi
        else
          echo "❌ FRF_MetaTheory.v 文件缺失"
          exit 1
        fi
        
        # 编译ChurchNumerals.v
        if [ -f "theories/ChurchNumerals.v" ]; then
          echo "编译ChurchNumerals.v..."
          if coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/ChurchNumerals.v; then
            echo "✅ ChurchNumerals.v 编译成功"
          else
            echo "❌ ChurchNumerals.v 编译失败"
            exit 1
          fi
        else
          echo "❌ ChurchNumerals.v 文件缺失"
          exit 1
        fi
        
        # 编译ChurchZero.v
        if [ -f "theories/ChurchZero.v" ]; then
          echo "编译ChurchZero.v..."
          if coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/ChurchZero.v; then
            echo "✅ ChurchZero.v 编译成功"
          else
            echo "❌ ChurchZero.v 编译失败"
            exit 1
          fi
        else
          echo "❌ ChurchZero.v 文件缺失"
          exit 1
        fi

    - name: 🔧 第三步：编译三级扩展层
      timeout-minutes: 15
      run: |
        eval $(opam env)
        echo "=== 编译三级扩展层模块 ==="
        echo "编译参数: -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null"
        
        # 编译FRF_CS_Null_Common.v
        if [ -f "CS_Null/FRF_CS_Null_Common.v" ]; then
          echo "编译FRF_CS_Null_Common.v..."
          if coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null CS_Null/FRF_CS_Null_Common.v; then
            echo "✅ FRF_CS_Null_Common.v 编译成功"
          else
            echo "❌ FRF_CS_Null_Common.v 编译失败"
            exit 1
          fi
        else
          echo "❌ FRF_CS_Null_Common.v 文件缺失"
          exit 1
        fi

    - name: 🔧 第四步：编译测试层
      timeout-minutes: 10
      run: |
        eval $(opam env)
        echo "=== 编译测试层模块 ==="
        echo "编译参数: -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null -Q Test FRF.Test"
        
        # 编译Test_Basic.v
        if [ -f "Test/Test_Basic.v" ]; then
          echo "编译Test_Basic.v..."
          if coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories -Q CS_Null FRF.CS_Null -Q Test FRF.Test Test/Test_Basic.v; then
            echo "✅ Test_Basic.v 编译成功"
          else
            echo "❌ Test_Basic.v 编译失败"
            exit 1
          fi
        else
          echo "❌ Test_Basic.v 文件缺失"
          exit 1
        fi

    - name: 📊 全量编译结果统计
      run: |
        eval $(opam env)
        echo "=== 全量编译结果统计 ==="
        
        # 定义核心模块
        core_modules=("Algebra" "Category" "Geometry" "FRF_MetaTheory" "ChurchNumerals" "ChurchZero" "FRF_CS_Null_Common" "Test_Basic")
        total_core=${#core_modules[@]}
        success_core=0
        
        echo "核心模块编译状态:"
        for module in "${core_modules[@]}"; do
          # 查找对应的.vo文件
          found=0
          for dir in SelfContainedLib theories CS_Null Test; do
            if [ -f "$dir/$module.vo" ]; then
              size=$(stat -c%s "$dir/$module.vo" 2>/dev/null || echo 0)
              echo "  ✅ $module (位置: $dir, 大小: ${size} bytes)"
              success_core=$((success_core + 1))
              found=1
              break
            fi
          done
          
          if [ $found -eq 0 ]; then
            echo "  ❌ $module (未找到)"
          fi
        done
        
        echo ""
        echo "📊 统计摘要:"
        echo "- 核心模块总数: $total_core"
        echo "- 核心模块成功数: $success_core"
        
        if [ $success_core -eq $total_core ]; then
          echo "🎉 所有核心模块编译成功"
        else
          echo "❌ 部分核心模块编译失败"
          exit 1
        fi
        
        # 列出所有生成的.vo文件
        echo ""
        echo "📁 所有生成的.vo文件:"
        find . -name "*.vo" -type f 2>/dev/null | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || echo 0)
          echo "  📄 $file (${size} bytes)"
        done

    - name: 📄 生成全量验证报告
      run: |
        echo "生成全量验证报告..."
        
        # 创建报告目录
        mkdir -p verification-reports
        
        # 获取环境信息
        COQ_VERSION=$(coqc --version 2>/dev/null | head -1 || echo "未知")
        OPAM_VERSION=$(opam --version 2>/dev/null || echo "未知")
        
        # 统计编译结果
        core_modules=("Algebra" "Category" "Geometry" "FRF_MetaTheory" "ChurchNumerals" "ChurchZero" "FRF_CS_Null_Common" "Test_Basic")
        total_core=${#core_modules[@]}
        success_core=0
        
        # 生成报告
        echo "# FRF 2.0 全量形式化验证报告" > verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "## 验证概述" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- **验证时间**: $(date)" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- **运行环境**: GitHub Actions (Ubuntu 22.04)" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- **Coq版本**: $COQ_VERSION" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- **OPAM版本**: $OPAM_VERSION" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        echo "## 核心模块验证状态" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "| 模块 | 层级 | 状态 | 编译结果 |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "|------|------|------|----------|" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        for module in "${core_modules[@]}"; do
          found=0
          location=""
          for dir in SelfContainedLib theories CS_Null Test; do
            if [ -f "$dir/$module.vo" ]; then
              found=1
              location="$dir"
              break
            fi
          done
          
          if [ $found -eq 1 ]; then
            success_core=$((success_core + 1))
            case $module in
              "Algebra"|"Category"|"Geometry")
                echo "| $module | 一级基础层 | ✅ 成功 | $location/$module.vo |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
              "FRF_MetaTheory"|"ChurchNumerals"|"ChurchZero")
                echo "| $module | 二级元理论层 | ✅ 成功 | $location/$module.vo |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
              "FRF_CS_Null_Common")
                echo "| $module | 三级扩展层 | ✅ 成功 | $location/$module.vo |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
              "Test_Basic")
                echo "| $module | 测试层 | ✅ 成功 | $location/$module.vo |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
            esac
          else
            case $module in
              "Algebra"|"Category"|"Geometry")
                echo "| $module | 一级基础层 | ❌ 失败 | 文件缺失或编译失败 |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
              "FRF_MetaTheory"|"ChurchNumerals"|"ChurchZero")
                echo "| $module | 二级元理论层 | ❌ 失败 | 文件缺失或编译失败 |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
              "FRF_CS_Null_Common")
                echo "| $module | 三级扩展层 | ❌ 失败 | 文件缺失或编译失败 |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
              "Test_Basic")
                echo "| $module | 测试层 | ❌ 失败 | 文件缺失或编译失败 |" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
                ;;
            esac
          fi
        done
        
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "## 统计摘要" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- **核心模块总数**: $total_core" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "- **核心模块成功数**: $success_core" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        success_rate=$((success_core * 100 / total_core))
        echo "- **编译成功率**: $success_rate%" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "## 验证通过" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        if [ $success_core -eq $total_core ]; then
          echo "🎉 **FRF 2.0 全量形式化验证成功完成！**" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
          echo "所有核心模块均已成功编译，验证通过。" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        else
          echo "❌ **验证未通过**" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
          echo "有 $((total_core - success_core)) 个核心模块编译失败。" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        fi
        
        echo "" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "## 环境依赖信息" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "\`\`\`bash" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        opam list --installed 2>/dev/null | grep -E "coq|mathcomp" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md || echo "依赖信息获取成功" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        echo "\`\`\`" >> verification-reports/FRF_FULL_VERIFICATION_REPORT.md
        
        echo "✅ 验证报告生成完成"

    - name: 📤 上传验证报告
      uses: actions/upload-artifact@v4
      with:
        name: frf-2.0-full-verification-report
        path: verification-reports/
        retention-days: 14

    - name: 🎉 验证成功通知
      if: success()
      run: |
        echo "🎉🎉🎉 FRF 2.0 全量形式化验证完全成功！"
        echo "========================================="
        echo "✅ 所有核心模块编译通过"
        echo "✅ 一级基础层 + 二级元理论层 + 三级扩展层 + 测试层"
        echo "✅ 全链路形式化验证完成"
        echo "📊 验证报告已生成并保存"
        echo "🕒 完成时间: $(date)"
        echo "========================================="