name: FRF 2.0 æ™ºèƒ½å…¨é‡å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master, develop]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
      - '.github/workflows/global-verification.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
  workflow_dispatch:
    inputs:
      verify_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - test-only
          - report-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: false
        default: '4'
        type: string

jobs:
  setup-environment:
    name: ğŸ”§ ç¯å¢ƒé…ç½®ä¸æ£€æŸ¥
    runs-on: ubuntu-22.04
    outputs:
      coq_version: ${{ steps.check-coq.outputs.version }}
      memory_available: ${{ steps.check-memory.outputs.available_mb }}
      core_count: ${{ steps.check-cpu.outputs.core_count }}
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
      id: check-cpu
      run: |
        echo "æ ¸å¿ƒæ•°: $(nproc)"
        echo "core_count=$(nproc)" >> $GITHUB_OUTPUT
        
    - name: ğŸ’¾ å†…å­˜æ£€æŸ¥
      id: check-memory
      run: |
        AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
        echo "å¯ç”¨å†…å­˜: ${AVAIL_MEM}MB"
        echo "available_mb=${AVAIL_MEM}" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          bc \
          graphviz \
          python3 \
          python3-pip
        
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”„ é…ç½®OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add mathlib https://github.com/leanprover-community/mathlib.git
        opam update -y
        echo "OPAM_HOME=$OPAM_HOME" >> $GITHUB_ENV
        echo "OPAM_SWITCH_PREFIX=$OPAM_SWITCH_PREFIX" >> $GITHUB_ENV
        
    - name: ğŸ“Š é…ç½®éªŒè¯ç¯å¢ƒ
      run: |
        echo "AVAIL_MEM=${{ steps.check-memory.outputs.available_mb }}" >> $GITHUB_ENV
        echo "CORE_COUNT=${{ steps.check-cpu.outputs.core_count }}" >> $GITHUB_ENV
        
        # æ ¹æ®å†…å­˜è®¾ç½®ç¼–è¯‘å‚æ•°
        if [ ${{ steps.check-memory.outputs.available_mb }} -gt 16000 ]; then
          echo "COQ_MEMORY=16384" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=16384" >> $GITHUB_ENV
        elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 8000 ]; then
          echo "COQ_MEMORY=8192" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=8192" >> $GITHUB_ENV
        elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 4000 ]; then
          echo "COQ_MEMORY=4096" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=4096" >> $GITHUB_ENV
        else
          echo "COQ_MEMORY=2048" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=2048" >> $GITHUB_ENV
        fi
        
        echo "PARALLEL_JOBS=$((${{ steps.check-cpu.outputs.core_count }} / 2))" >> $GITHUB_ENV

    - name: ğŸ” æ£€æŸ¥Coqç‰ˆæœ¬
      id: check-coq
      run: |
        eval $(opam env)
        if command -v coqc &> /dev/null; then
          COQ_VERSION=$(coqc --version | head -1 | grep -o 'version [0-9.]\+' | cut -d' ' -f2)
          echo "å½“å‰Coqç‰ˆæœ¬: $COQ_VERSION"
          echo "version=$COQ_VERSION" >> $GITHUB_OUTPUT
        else
          echo "âŒ Coqæœªå®‰è£…"
          exit 1
        fi

    - name: ğŸ“‹ ç¯å¢ƒæŠ¥å‘Š
      run: |
        echo "=== ç¯å¢ƒé…ç½®æŠ¥å‘Š ==="
        echo "ç³»ç»Ÿ: Ubuntu 22.04"
        echo "CPUæ ¸å¿ƒ: ${{ steps.check-cpu.outputs.core_count }}"
        echo "å¯ç”¨å†…å­˜: ${{ steps.check-memory.outputs.available_mb }}MB"
        echo "åˆ†é…å†…å­˜: ${{ env.COQ_MEMORY }}MB"
        echo "å¹¶è¡Œä»»åŠ¡: ${{ env.PARALLEL_JOBS }}"
        echo "Coqç‰ˆæœ¬: ${{ steps.check-coq.outputs.version }}"

  install-dependencies:
    name: ğŸ“¦ ä¾èµ–å®‰è£…ä¸ç¼“å­˜
    needs: setup-environment
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        coq-version: ['8.18.0']
        mathcomp-version: ['1.17.0']
    steps:
    - name: ğŸ“¥ æ¢å¤OPAMç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.opam
          ~/.cache/opam
        key: ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-${{ hashFiles('*.opam') }}
        restore-keys: |
          ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-
          ${{ runner.os }}-opam-

    - name: ğŸ”„ è®¾ç½®OPAMç¯å¢ƒ
      run: |
        eval $(opam env)
        opam update

    - name: ğŸ“Š å®‰è£…Coqæ ¸å¿ƒ
      run: |
        eval $(opam env)
        echo "å®‰è£…Coq ${{ matrix.coq-version }}..."
        opam install -y coq.${{ matrix.coq-version }}
        
        echo "éªŒè¯Coqå®‰è£…..."
        coqc --version
        if [ $? -ne 0 ]; then
          echo "âŒ Coqå®‰è£…å¤±è´¥"
          exit 1
        fi

    - name: ğŸ§® å®‰è£…mathcomp
      run: |
        eval $(opam env)
        echo "å®‰è£…coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}..."
        opam install -y coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}
        
        echo "éªŒè¯mathcompå®‰è£…..."
        opam list --installed | grep "coq-mathcomp-ssreflect" || (echo "âŒ mathcompå®‰è£…å¤±è´¥" && exit 1)

    - name: ğŸ“š å®‰è£…å¤–éƒ¨åº“
      run: |
        eval $(opam env)
        echo "å®‰è£…å¤–éƒ¨ä¾èµ–åº“..."
        
        # å®æ•°åº“
        opam install -y coq-mathcomp-analysis
        
        # æ ‡å‡†åº“
        opam install -y coq-stdlib
        
        # å¯é€‰ï¼šæ•°å­¦åº“
        opam install -y coq-mathlib || echo "è­¦å‘Š: mathlibå®‰è£…å¤±è´¥ï¼Œéƒ¨åˆ†æ¨¡å—å¯èƒ½æ— æ³•ç¼–è¯‘"
        
        # å¯é€‰ï¼šçŸ©é˜µå’Œå‘é‡åº“
        opam install -y coq-mathcomp-algebra || echo "è­¦å‘Š: çŸ©é˜µåº“å®‰è£…å¤±è´¥"
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ“ ä¾èµ–éªŒè¯æŠ¥å‘Š
      run: |
        eval $(op
