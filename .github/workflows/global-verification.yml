name: FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯ï¼ˆå…¨æ¨¡å—å¹¶è¡Œç¼–è¯‘ç‰ˆï¼‰

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      compile_level:
        description: 'ç¼–è¯‘çº§åˆ« (all, quick, test-only)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - quick
          - test-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: true
        default: '4'
        type: string

jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # å¢åŠ æ€»è¶…æ—¶æ—¶é—´ä»¥é€‚åº”å…¨é‡ç¼–è¯‘
    env:
      COMPILE_LEVEL: ${{ github.event.inputs.compile_level || 'all' }}
      PARALLEL_JOBS: ${{ github.event.inputs.parallel_jobs || '4' }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç¡®ä¿å­æ¨¡å—èƒ½æ­£ç¡®æ£€å‡º
        submodules: recursive

    - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        echo "ç³»ç»Ÿ: $(uname -a)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        echo "å†…å­˜: $(free -m | awk '/^Mem:/{print "æ€»é‡:" $2 "MB, å¯ç”¨:" $7 "MB"}')"
        echo "ç£ç›˜:"
        df -h
        echo "Gitç‰ˆæœ¬: $(git --version)"
        echo "Makeç‰ˆæœ¬: $(make --version | head -1)"

    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå…¨é‡ç‰ˆï¼‰
      run: |
        echo "å®‰è£…å…¨é‡ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          curl \
          ca-certificates \
          gnupg \
          lsb-release \
          software-properties-common \
          graphviz \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-fonts-recommended \
          python3 \
          python3-pip
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
        
        # å®‰è£…Dockerï¼ˆå¯é€‰ï¼Œç”¨äºDockeræ„å»ºï¼‰
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "å®‰è£…Dockerï¼ˆä»…workflow_dispatchæ—¶ï¼‰..."
          sudo apt-get install -y docker.io docker-compose
          sudo usermod -aG docker $USER
        fi

    - name: ğŸ”„ åˆå§‹åŒ–OPAMç¯å¢ƒï¼ˆç¨³å®šç‰ˆï¼‰
      timeout-minutes: 25
      run: |
        echo "åˆå§‹åŒ–OPAMç¯å¢ƒï¼ˆç¨³å®šé…ç½®ï¼‰..."
        
        # è®¾ç½®OPAMé…ç½®
        export OPAMROOT=/opt/opam
        export OPAMYES=1
        export OPAMJOBS=${{ env.PARALLEL_JOBS }}
        
        # å¦‚æœå·²æœ‰OPAMç¯å¢ƒï¼Œå…ˆæ¸…ç†
        if [ -d "$OPAMROOT" ]; then
          echo "æ¸…ç†ç°æœ‰OPAMç¯å¢ƒ..."
          sudo rm -rf $OPAMROOT
        fi
        
        # åˆ›å»ºOPAMç›®å½•å¹¶è®¾ç½®æƒé™
        sudo mkdir -p $OPAMROOT
        sudo chown -R $USER:$USER $OPAMROOT
        
        # åˆå§‹åŒ–OPAMï¼ˆç¦ç”¨æ²™ç›’ï¼Œä½¿ç”¨ç¨³å®šç‰ˆæœ¬ï¼‰
        opam init --disable-sandboxing -y \
          --compiler=4.14.0 \
          --root=$OPAMROOT \
          --no-setup
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        eval $(opam env --root=$OPAMROOT --set-root)
        
        # æ·»åŠ ä»“åº“
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add coq-extra-dev https://coq.inria.fr/opam/extra-dev
        opam repo add coq-core-dev https://coq.inria.fr/opam/core-dev
        opam update
        
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "OPAMæ ¹ç›®å½•: $OPAMROOT"
        echo "OPAMç‰ˆæœ¬: $(opam --version)"

    - name: ğŸ“š å®‰è£…Coqæ ¸å¿ƒï¼ˆç‰ˆæœ¬è‡ªé€‚åº”ï¼‰
      timeout-minutes: 30
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "å®‰è£…Coqæ ¸å¿ƒï¼ˆç‰ˆæœ¬è‡ªé€‚åº”ï¼‰..."
        
        # å°è¯•å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™å®‰è£…æœ€æ–°ç¨³å®šç‰ˆ
        if opam install -y --no-depexts coq.8.18.0; then
          echo "âœ… Coq 8.18.0 å®‰è£…æˆåŠŸ"
        else
          echo "âš ï¸  Coq 8.18.0 å®‰è£…å¤±è´¥ï¼Œå°è¯•å®‰è£…æœ€æ–°ç¨³å®šç‰ˆ..."
          opam install -y --no-depexts coq
          echo "âœ… Coq æœ€æ–°ç¨³å®šç‰ˆ å®‰è£…æˆåŠŸ"
        fi
        
        # éªŒè¯Coqå®‰è£…
        echo "éªŒè¯Coqå®‰è£…..."
        if command -v coqc &> /dev/null; then
          COQ_VERSION=$(coqc --version | head -1)
          echo "âœ… Coq å·²å®‰è£…: $COQ_VERSION"
        else
          echo "âŒ Coq å®‰è£…å¤±è´¥"
          exit 1
        fi
        
        # å®‰è£…æ ‡å‡†åº“
        echo "å®‰è£…Coqæ ‡å‡†åº“..."
        opam install -y --no-depexts coq-stdlib

    - name: ğŸ§® å®‰è£…mathcompåŠå…¶ç»„ä»¶ï¼ˆå…¨é‡ç‰ˆï¼‰
      timeout-minutes: 20
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "å®‰è£…mathcompå…¨å®¶æ¡¶..."
        
        # å®‰è£…mathcompæ ¸å¿ƒåŒ…
        if opam install -y --no-depexts coq-mathcomp-ssreflect=1.17.0; then
          echo "âœ… mathcomp-ssreflect 1.17.0 å®‰è£…æˆåŠŸ"
        else
          echo "âš ï¸  mathcomp-ssreflect 1.17.0 å®‰è£…å¤±è´¥ï¼Œå°è¯•å®‰è£…æœ€æ–°ç‰ˆ..."
          opam install -y --no-depexts coq-mathcomp-ssreflect
        fi
        
        # å®‰è£…å…¶ä»–mathcompç»„ä»¶
        opam install -y --no-depexts \
          coq-mathcomp-algebra \
          coq-mathcomp-field \
          coq-mathcomp-fingroup \
          coq-mathcomp-solvable \
          coq-mathcomp-character
        
        echo "âœ… mathcompå…¨å®¶æ¡¶å®‰è£…å®Œæˆ"

    - name: ğŸ§° å®‰è£…å…¶ä»–Coqåº“ï¼ˆæŒ‰éœ€ï¼‰
      timeout-minutes: 15
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "å®‰è£…å…¶ä»–Coqåº“..."
        
        # å®‰è£…å¸¸ç”¨çš„Coqåº“
        opam install -y --no-depexts \
          coq-flocq \
          coq-bignums \
          coq-numery \
          coq-interval
        
        echo "âœ… å…¶ä»–Coqåº“å®‰è£…å®Œæˆ"

    - name: ğŸ“Š ç¯å¢ƒéªŒè¯ä¸æŠ¥å‘Š
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "=== ç¯å¢ƒéªŒè¯æŠ¥å‘Š ==="
        echo ""
        echo "ğŸ“¦ æ ¸å¿ƒå·¥å…·ç‰ˆæœ¬:"
        echo "Coq: $(coqc --version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "OCaml: $(ocaml -version 2>/dev/null | head -1 || echo 'æœªå®‰è£…')"
        echo "OPAM: $(opam --version 2>/dev/null || echo 'æœªå®‰è£…')"
        echo ""
        
        echo "ğŸ“š å·²å®‰è£…çš„CoqåŒ…:"
        opam list --installed --short --columns=name,version | grep -E "^coq" | sort
        echo ""
        
        echo "ğŸ“ é¡¹ç›®æ–‡ä»¶ç»Ÿè®¡:"
        echo "Coqæ–‡ä»¶æ€»æ•°: $(find . -name "*.v" -type f | wc -l)"
        echo "é¡¹ç›®ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        
        echo "ğŸ§© æ¨¡å—å±‚çº§ç»Ÿè®¡:"
        if [ -f "Makefile" ]; then
          echo "Makefileå­˜åœ¨ï¼Œä½¿ç”¨Makefileç»Ÿè®¡:"
          make stats || echo "Makefileç»Ÿè®¡ä¸å¯ç”¨"
        else
          echo "æ‰‹åŠ¨ç»Ÿè®¡å„ç›®å½•:"
          for dir in SelfContainedLib theories CS_Null Quantum Test; do
            if [ -d "$dir" ]; then
              count=$(find "$dir" -name "*.v" -type f | wc -l)
              echo "  $dir/: $count ä¸ªæ–‡ä»¶"
            fi
          done
        fi

    - name: ğŸ”§ éªŒè¯å¹¶ä¿®å¤Makefile
      run: |
        echo "éªŒè¯å¹¶ä¿®å¤Makefile..."
        
        # æ£€æŸ¥Makefileæ˜¯å¦å­˜åœ¨
        if [ ! -f "Makefile" ]; then
          echo "âŒ Makefileä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºæœ¬Makefile..."
          cat > Makefile << 'EOF'
# åŸºæœ¬Makefile for GitHub Actions
COQC ?= coqc
COQDEP ?= coqdep

# åŸºç¡€ç¼–è¯‘æ ‡å¿—
COQFLAGS := -R SelfContainedLib SelfContainedLib \
            -R theories FRF_Theories \
            -R CS_Null FRF_CS_Null \
            -R Quantum FRF_Quantum \
            -R Test FRF_Test

# åŸºç¡€ç¼–è¯‘è§„åˆ™
%.vo: %.v
	@echo "ç¼–è¯‘ $<"
	@$(COQC) $(COQFLAGS) $<

# ä¸»ç›®æ ‡
all:
	@echo "è¯·ä½¿ç”¨å…¨åŠŸèƒ½Makefile"

.PHONY: all
EOF
          echo "âœ… åŸºæœ¬Makefileå·²åˆ›å»º"
        else
          echo "âœ… Makefileå·²å­˜åœ¨"
          
          # ç¡®ä¿Makefileå¯æ‰§è¡Œ
          chmod +x Makefile 2>/dev/null || true
          
          # æ£€æŸ¥Makefileè¯­æ³•
          if make -n -f Makefile help >/dev/null 2>&1; then
            echo "âœ… Makefileè¯­æ³•æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸  Makefileè¯­æ³•æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
            # å¤‡ä»½åŸMakefile
            cp Makefile Makefile.backup
          fi
        fi

    - name: ğŸ—ï¸ å¹¶è¡Œç¼–è¯‘æ ¸å¿ƒæ¨¡å—ï¼ˆé˜¶æ®µ1-3ï¼‰
      timeout-minutes: 40
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "=== é˜¶æ®µ1-3: å¹¶è¡Œç¼–è¯‘æ ¸å¿ƒæ¨¡å— ==="
        echo "ç¼–è¯‘çº§åˆ«: ${{ env.COMPILE_LEVEL }}"
        echo "å¹¶è¡Œä»»åŠ¡æ•°: ${{ env.PARALLEL_JOBS }}"
        echo ""
        
        # è®¾ç½®å¹¶è¡Œç¼–è¯‘å‚æ•°
        export MAKEFLAGS="-j${{ env.PARALLEL_JOBS }} -l${{ env.PARALLEL_JOBS }}"
        
        # æ ¹æ®ç¼–è¯‘çº§åˆ«é€‰æ‹©ç›®æ ‡
        case "${{ env.COMPILE_LEVEL }}" in
          "quick")
            echo "æ‰§è¡Œå¿«é€Ÿç¼–è¯‘ (core-base + core-frf)..."
            if make -f Makefile check-env core-base core-frf 2>&1; then
              echo "âœ… å¿«é€Ÿç¼–è¯‘å®Œæˆ"
            else
              echo "âŒ å¿«é€Ÿç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åˆ†æ­¥ç¼–è¯‘..."
              # åˆ†æ­¥ç¼–è¯‘
              make -f Makefile check-env || true
              make -f Makefile core-base || true
              make -f Makefile core-frf || true
            fi
            ;;
            
          "test-only")
            echo "æ‰§è¡Œæµ‹è¯•ç¼–è¯‘..."
            if make -f Makefile check-env core-base core-frf core-scenes tests 2>&1; then
              echo "âœ… æµ‹è¯•ç¼–è¯‘å®Œæˆ"
            else
              echo "âŒ æµ‹è¯•ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åŸºç¡€ç¼–è¯‘..."
              make -f Makefile check-env || true
              make -f Makefile core-base || true
            fi
            ;;
            
          "all"|*)
            echo "æ‰§è¡Œå®Œæ•´ç¼–è¯‘ (é˜¶æ®µ1-3)..."
            echo "1. ç¼–è¯‘åŸºç¡€å±‚ (core-base)..."
            if make -f Makefile core-base 2>&1; then
              echo "âœ… åŸºç¡€å±‚ç¼–è¯‘å®Œæˆ"
            else
              echo "âš ï¸  åŸºç¡€å±‚ç¼–è¯‘æœ‰è­¦å‘Š"
            fi
            
            echo ""
            echo "2. ç¼–è¯‘FRFå…ƒç†è®ºå±‚ (core-frf)..."
            if make -f Makefile core-frf 2>&1; then
              echo "âœ… FRFå…ƒç†è®ºå±‚ç¼–è¯‘å®Œæˆ"
            else
              echo "âš ï¸  FRFå…ƒç†è®ºå±‚ç¼–è¯‘æœ‰è­¦å‘Š"
            fi
            
            echo ""
            echo "3. ç¼–è¯‘æ•°å­¦åœºæ™¯å±‚ (core-scenes)..."
            if make -f Makefile core-scenes 2>&1; then
              echo "âœ… æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘å®Œæˆ"
            else
              echo "âš ï¸  æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘æœ‰è­¦å‘Š"
            fi
            ;;
        esac
        
        echo ""
        echo "ğŸ“Š é˜¶æ®µ1-3ç¼–è¯‘å®Œæˆç»Ÿè®¡"

    - name: ğŸ—ï¸ ä¸²è¡Œç¼–è¯‘æ‰©å±•æ¨¡å—ï¼ˆé˜¶æ®µ4-5ï¼‰
      timeout-minutes: 35
      if: ${{ env.COMPILE_LEVEL == 'all' }}
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "=== é˜¶æ®µ4-5: ä¸²è¡Œç¼–è¯‘æ‰©å±•æ¨¡å— ==="
        echo "æ³¨: æ‰©å±•æ¨¡å—ä¾èµ–å¤æ‚ï¼Œä½¿ç”¨ä¸²è¡Œç¼–è¯‘ç¡®ä¿æ­£ç¡®æ€§"
        echo ""
        
        # ä¸²è¡Œç¼–è¯‘æ‰©å±•æ¨¡å—
        echo "4. ç¼–è¯‘æ‰©å±•æ¨¡å— (extensions)..."
        if make -f Makefile -j1 extensions 2>&1; then
          echo "âœ… æ‰©å±•æ¨¡å—ç¼–è¯‘å®Œæˆ"
        else
          echo "âš ï¸  æ‰©å±•æ¨¡å—ç¼–è¯‘æœ‰è­¦å‘Š"
        fi
        
        echo ""
        echo "5. ç¼–è¯‘é›†æˆæ¨¡å— (integrations)..."
        if make -f Makefile -j1 integrations 2>&1; then
          echo "âœ… é›†æˆæ¨¡å—ç¼–è¯‘å®Œæˆ"
        else
          echo "âš ï¸  é›†æˆæ¨¡å—ç¼–è¯‘æœ‰è­¦å‘Š"
        fi

    - name: ğŸ§ª å¹¶è¡Œç¼–è¯‘æµ‹è¯•å¥—ä»¶ï¼ˆé˜¶æ®µ6ï¼‰
      timeout-minutes: 25
      if: ${{ env.COMPILE_LEVEL == 'all' }}
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "=== é˜¶æ®µ6: å¹¶è¡Œç¼–è¯‘æµ‹è¯•å¥—ä»¶ ==="
        echo ""
        
        # å¹¶è¡Œç¼–è¯‘æµ‹è¯•å¥—ä»¶
        echo "6. ç¼–è¯‘æµ‹è¯•å¥—ä»¶ (tests)..."
        export MAKEFLAGS="-j${{ env.PARALLEL_JOBS }} -l${{ env.PARALLEL_JOBS }}"
        
        if make -f Makefile tests 2>&1; then
          echo "âœ… æµ‹è¯•å¥—ä»¶ç¼–è¯‘å®Œæˆ"
        else
          echo "âš ï¸  æµ‹è¯•å¥—ä»¶ç¼–è¯‘æœ‰è­¦å‘Š"
        fi

    - name: ğŸ“ˆ ç¼–è¯‘ç»“æœåˆ†æä¸ç»Ÿè®¡
      run: |
        eval $(opam env --root=/opt/opam)
        
        echo "=== ç¼–è¯‘ç»“æœåˆ†æä¸ç»Ÿè®¡ ==="
        echo ""
        
        # ç»Ÿè®¡ç¼–è¯‘æ–‡ä»¶
        echo "ğŸ“Š ç¼–è¯‘æ–‡ä»¶ç»Ÿè®¡:"
        VO_COUNT=$(find . -name "*.vo" -type f 2>/dev/null | wc -l)
        V_COUNT=$(find . -name "*.v" -type f 2>/dev/null | wc -l)
        
        echo "Coqæºæ–‡ä»¶ (.v): $V_COUNT ä¸ª"
        echo "ç¼–è¯‘æ–‡ä»¶ (.vo): $VO_COUNT ä¸ª"
        
        if [ $V_COUNT -gt 0 ]; then
          SUCCESS_RATE=$((VO_COUNT * 100 / V_COUNT))
          echo "ç¼–è¯‘æˆåŠŸç‡: $SUCCESS_RATE%"
        fi
        
        echo ""
        echo "ğŸ“ å„ç›®å½•ç¼–è¯‘ç»“æœ:"
        
        # å®šä¹‰ç›®å½•å’ŒæœŸæœ›çš„æ¨¡å—
        declare -A EXPECTED_MODULES=(
          ["SelfContainedLib"]="Algebra Category Geometry"
          ["theories"]="FRF_MetaTheory ChurchZero ChurchNumerals CaseA_SetTheory CaseB_Algebra CaseC_TypeTheory CaseD_CategoryTheory CaseE_QuantumVacuum FRF_Comparative"
          ["CS_Null"]="FRF_CS_Null_Common FRF_CS_Null CxxNull PythonNull JavaNull MathNull RustNull"
          ["Quantum"]="QFT_FRF CurvedSpacetimeQFT"
          ["Test"]="Test_Basic Test_FRF_MetaTheory Test_QuantumVacuum Test_BlockchainSystem SelfContainedVerification"
        )
        
        TOTAL_EXPECTED=0
        TOTAL_COMPILED=0
        
        for dir in "${!EXPECTED_MODULES[@]}"; do
          if [ -d "$dir" ]; then
            echo ""
            echo "  $dir/:"
            
            # ç»Ÿè®¡è¯¥ç›®å½•çš„ç¼–è¯‘æƒ…å†µ
            dir_expected=0
            dir_compiled=0
            
            for module in ${EXPECTED_MODULES[$dir]}; do
              ((dir_expected++))
              ((TOTAL_EXPECTED++))
              
              if [ -f "$dir/$module.vo" ]; then
                echo "    âœ… $module.vo"
                ((dir_compiled++))
                ((TOTAL_COMPILED++))
              else
                echo "    âŒ $module.vo (ç¼ºå¤±)"
              fi
            done
            
            if [ $dir_expected -gt 0 ]; then
              rate=$((dir_compiled * 100 / dir_expected))
              echo "    ç¼–è¯‘ç‡: $dir_compiled/$dir_expected ($rate%)"
            fi
          else
            echo "  âŒ $dir/ (ç›®å½•ä¸å­˜åœ¨)"
          fi
        done
        
        echo ""
        echo "ğŸ“ˆ æ€»ä½“ç»Ÿè®¡:"
        echo "æœŸæœ›ç¼–è¯‘æ¨¡å—: $TOTAL_EXPECTED ä¸ª"
        echo "å®é™…ç¼–è¯‘æ¨¡å—: $TOTAL_COMPILED ä¸ª"
        
        if [ $TOTAL_EXPECTED -gt 0 ]; then
          overall_rate=$((TOTAL_COMPILED * 100 / TOTAL_EXPECTED))
          echo "æ€»ä½“ç¼–è¯‘ç‡: $overall_rate%"
        fi
        
        # ä¿å­˜ç»Ÿè®¡ç»“æœåˆ°æ–‡ä»¶
        mkdir -p verification-reports
        echo "æ€»ä½“ç¼–è¯‘ç‡: $overall_rate%" > verification-reports/compile_stats.txt
        echo "æœŸæœ›ç¼–è¯‘æ¨¡å—: $TOTAL_EXPECTED" >> verification-reports/compile_stats.txt
        echo "å®é™…ç¼–è¯‘æ¨¡å—: $TOTAL_COMPILED" >> verification-reports/compile_stats.txt
        date >> verification-reports/compile_stats.txt

    - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†éªŒè¯æŠ¥å‘Š
      run: |
        echo "ç”Ÿæˆè¯¦ç»†éªŒè¯æŠ¥å‘Š..."
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p verification-reports
        
        # è·å–ç¯å¢ƒä¿¡æ¯
        COQ_VERSION=$(coqc --version 2>/dev/null | head -1 || echo "æœªçŸ¥")
        OPAM_VERSION=$(opam --version 2>/dev/null || echo "æœªçŸ¥")
        MAKE_VERSION=$(make --version 2>/dev/null | head -1 || echo "æœªçŸ¥")
        
        # ç”ŸæˆHTMLæŠ¥å‘Š
        cat > verification-reports/full_verification_report.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .success { color: green; }
        .warning { color: orange; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .summary { background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .module-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .progress-bar { width: 100%; background-color: #f0f0f0; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 20px; background-color: #4CAF50; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š</h1>
            <p><strong>éªŒè¯æ—¶é—´:</strong> $(date)</p>
            <p><strong>è¿è¡Œç¯å¢ƒ:</strong> GitHub Actions (Ubuntu 22.04)</p>
        </div>
EOF
        
        # æ·»åŠ ç¯å¢ƒä¿¡æ¯
        cat >> verification-reports/full_verification_report.html << EOF
        <h2>ç¯å¢ƒä¿¡æ¯</h2>
        <ul>
            <li><strong>Coqç‰ˆæœ¬:</strong> $COQ_VERSION</li>
            <li><strong>OPAMç‰ˆæœ¬:</strong> $OPAM_VERSION</li>
            <li><strong>Makeç‰ˆæœ¬:</strong> $MAKE_VERSION</li>
            <li><strong>ç¼–è¯‘çº§åˆ«:</strong> ${{ env.COMPILE_LEVEL }}</li>
            <li><strong>å¹¶è¡Œä»»åŠ¡æ•°:</strong> ${{ env.PARALLEL_JOBS }}</li>
        </ul>
EOF
        
        # æ·»åŠ ç¼–è¯‘ç»Ÿè®¡
        if [ -f "verification-reports/compile_stats.txt" ]; then
            STATS=$(cat verification-reports/compile_stats.txt)
            OVERALL_RATE=$(echo "$STATS" | grep "æ€»ä½“ç¼–è¯‘ç‡" | cut -d: -f2 | tr -d ' %')
            
            cat >> verification-reports/full_verification_report.html << EOF
        <h2>ç¼–è¯‘ç»Ÿè®¡</h2>
        <div class="summary">
            <h3>æ€»ä½“è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${OVERALL_RATE}%"></div>
            </div>
            <p>ç¼–è¯‘å®Œæˆåº¦: ${OVERALL_RATE}%</p>
EOF
            
            # æ·»åŠ è¯¦ç»†ç»Ÿè®¡
            cat >> verification-reports/full_verification_report.html << 'EOF'
            <h3>è¯¦ç»†ç»Ÿè®¡</h3>
            <table>
                <tr>
                    <th>ç›®å½•</th>
                    <th>æœŸæœ›æ¨¡å—</th>
                    <th>ç¼–è¯‘æ¨¡å—</th>
                    <th>ç¼–è¯‘ç‡</th>
                    <th>çŠ¶æ€</th>
                </tr>
EOF
            
            # å„ç›®å½•ç»Ÿè®¡
            declare -A EXPECTED_MODULES=(
                ["SelfContainedLib"]="Algebra Category Geometry"
                ["theories"]="FRF_MetaTheory ChurchZero ChurchNumerals CaseA_SetTheory CaseB_Algebra CaseC_TypeTheory CaseD_CategoryTheory CaseE_QuantumVacuum FRF_Comparative"
                ["CS_Null"]="FRF_CS_Null_Common FRF_CS_Null CxxNull PythonNull JavaNull MathNull RustNull"
                ["Quantum"]="QFT_FRF CurvedSpacetimeQFT"
                ["Test"]="Test_Basic Test_FRF_MetaTheory Test_QuantumVacuum Test_BlockchainSystem SelfContainedVerification"
            )
            
            for dir in "${!EXPECTED_MODULES[@]}"; do
                if [ -d "$dir" ]; then
                    expected_count=$(echo "${EXPECTED_MODULES[$dir]}" | wc -w)
                    compiled_count=0
                    
                    for module in ${EXPECTED_MODULES[$dir]}; do
                        if [ -f "$dir/$module.vo" ]; then
                            ((compiled_count++))
                        fi
                    done
                    
                    if [ $expected_count -gt 0 ]; then
                        rate=$((compiled_count * 100 / expected_count))
                        
                        # ç¡®å®šçŠ¶æ€
                        if [ $rate -eq 100 ]; then
                            status_class="status-success"
                            status_text="å®Œæˆ"
                        elif [ $rate -ge 50 ]; then
                            status_class="status-warning"
                            status_text="éƒ¨åˆ†å®Œæˆ"
                        else
                            status_class="status-error"
                            status_text="å¤±è´¥"
                        fi
                        
                        cat >> verification-reports/full_verification_report.html << EOF
                <tr>
                    <td>$dir/</td>
                    <td>$expected_count</td>
                    <td>$compiled_count</td>
                    <td>$rate%</td>
                    <td><span class="module-status $status_class">$status_text</span></td>
                </tr>
EOF
                    fi
                fi
            done
            
            cat >> verification-reports/full_verification_report.html << 'EOF'
            </table>
        </div>
EOF
        fi
        
        # æ·»åŠ æ¨¡å—è¯¦æƒ…
        cat >> verification-reports/full_verification_report.html << 'EOF'
        <h2>æ¨¡å—è¯¦æƒ…</h2>
        <table>
            <tr>
                <th>æ¨¡å—</th>
                <th>æ–‡ä»¶å¤§å°</th>
                <th>ç¼–è¯‘æ–‡ä»¶</th>
                <th>çŠ¶æ€</th>
                <th>æœ€åä¿®æ”¹</th>
            </tr>
EOF
        
        # éå†æ‰€æœ‰.væ–‡ä»¶
        find . -name "*.v" -type f | sort | while read v_file; do
            filename=$(basename "$v_file")
            dirname=$(dirname "$v_file")
            vo_file="${v_file%.v}.vo"
            
            # æ–‡ä»¶å¤§å°
            if [ -f "$v_file" ]; then
                size=$(stat -c%s "$v_file" 2>/dev/null || echo "0")
                size_kb=$((size / 1024))
                lines=$(wc -l < "$v_file" 2>/dev/null || echo "0")
                
                # æ£€æŸ¥æ˜¯å¦ç¼–è¯‘æˆåŠŸ
                if [ -f "$vo_file" ]; then
                    status="âœ… å·²ç¼–è¯‘"
                    status_class="status-success"
                    vo_size=$(stat -c%s "$vo_file" 2>/dev/null || echo "0")
                    vo_size_kb=$((vo_size / 1024))
                    vo_info="${vo_size_kb}KB"
                else
                    status="âŒ æœªç¼–è¯‘"
                    status_class="status-error"
                    vo_info="-"
                fi
                
                # æœ€åä¿®æ”¹æ—¶é—´
                mtime=$(stat -c "%y" "$v_file" 2>/dev/null | cut -d'.' -f1 || echo "æœªçŸ¥")
                
                cat >> verification-reports/full_verification_report.html << EOF
            <tr>
                <td>$v_file</td>
                <td>${size_kb}KB (${lines}è¡Œ)</td>
                <td>$vo_info</td>
                <td><span class="module-status $status_class">$status</span></td>
                <td>$mtime</td>
            </tr>
EOF
            fi
        done
        
        # ç»“æŸHTML
        cat >> verification-reports/full_verification_report.html << 'EOF'
        </table>
        
        <h2>éªŒè¯ç»“è®º</h2>
        <div class="summary">
EOF
        
        # æ·»åŠ ç»“è®º
        if [ -f "verification-reports/compile_stats.txt" ]; then
            OVERALL_RATE=$(grep "æ€»ä½“ç¼–è¯‘ç‡" verification-reports/compile_stats.txt | cut -d: -f2 | tr -d ' %')
            if [ "$OVERALL_RATE" -eq 100 ]; then
                cat >> verification-reports/full_verification_report.html << EOF
            <h3 class="success">ğŸ‰ éªŒè¯å®Œå…¨æˆåŠŸï¼</h3>
            <p>æ‰€æœ‰æ¨¡å—å‡å·²æˆåŠŸç¼–è¯‘ï¼ŒéªŒè¯é€šè¿‡ç‡ä¸º100%ã€‚</p>
EOF
            elif [ "$OVERALL_RATE" -ge 80 ]; then
                cat >> verification-reports/full_verification_report.html << EOF
            <h3 class="warning">âš ï¸ éªŒè¯åŸºæœ¬æˆåŠŸ</h3>
            <p>æ ¸å¿ƒæ¨¡å—å·²æˆåŠŸç¼–è¯‘ï¼ŒéªŒè¯é€šè¿‡ç‡ä¸º${OVERALL_RATE}%ã€‚</p>
EOF
            else
                cat >> verification-reports/full_verification_report.html << EOF
            <h3 class="error">âŒ éªŒè¯å¤±è´¥</h3>
            <p>ç¼–è¯‘é€šè¿‡ç‡è¾ƒä½ï¼Œä»…ä¸º${OVERALL_RATE}%ã€‚</p>
EOF
            fi
        fi
        
        cat >> verification-reports/full_verification_report.html << 'EOF'
        </div>
        
        <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
            <p>æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)</p>
            <p>FRF 2.0 å½¢å¼åŒ–åˆ†æéªŒè¯ç³»ç»Ÿ - å…¨é‡éªŒè¯å·¥ä½œæµ</p>
        </footer>
    </div>
</body>
</html>
EOF
        
        echo "âœ… è¯¦ç»†éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-2.0-full-verification-report-${{ github.run_id }}
        path: verification-reports/
        retention-days: 30

    - name: ğŸ“§ ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
      run: |
        echo "ç”Ÿæˆæ€»ç»“æŠ¥å‘Š..."
        
        SUMMARY_FILE="verification-summary-${{ github.run_id }}.md"
        
        cat > "$SUMMARY_FILE" << EOF
# FRF 2.0 å…¨é‡éªŒè¯æ€»ç»“æŠ¥å‘Š

**è¿è¡ŒID**: ${{ github.run_id }}
**è¿è¡Œæ—¶é—´**: $(date)
**è§¦å‘æ–¹å¼**: ${{ github.event_name }}
**æäº¤**: ${{ github.sha }}

## ç¼–è¯‘é…ç½®
- **ç¼–è¯‘çº§åˆ«**: ${{ env.COMPILE_LEVEL }}
- **å¹¶è¡Œä»»åŠ¡æ•°**: ${{ env.PARALLEL_JOBS }}
- **è¶…æ—¶æ—¶é—´**: 120åˆ†é’Ÿ

## ç¯å¢ƒä¿¡æ¯
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04
- **Coqç‰ˆæœ¬**: $(coqc --version 2>/dev/null | head -1 || echo "æœªçŸ¥")
- **CPUæ ¸å¿ƒ**: $(nproc)
- **å†…å­˜**: $(free -m | awk '/^Mem:/{print $2 "MB"}')

## ç¼–è¯‘ç»“æœ
EOF
        
        # æ·»åŠ ç¼–è¯‘ç»“æœ
        if [ -f "verification-reports/compile_stats.txt" ]; then
            cat verification-reports/compile_stats.txt >> "$SUMMARY_FILE"
        else
            echo "ç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯ä¸å¯ç”¨" >> "$SUMMARY_FILE"
        fi
        
        echo "" >> "$SUMMARY_FILE"
        echo "## è¯¦ç»†æŠ¥å‘Š" >> "$SUMMARY_FILE"
        echo "å®Œæ•´éªŒè¯æŠ¥å‘Šå·²ä¸Šä¼ ä¸ºArtifact: \`frf-2.0-full-verification-report-${{ github.run_id }}\`" >> "$SUMMARY_FILE"
        
        # ä¸Šä¼ æ€»ç»“æŠ¥å‘Š
        echo "âœ… æ€»ç»“æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
        
        # è¾“å‡ºæ€»ç»“åˆ°æ§åˆ¶å°
        cat "$SUMMARY_FILE"

    - name: ğŸ‰ éªŒè¯å®Œæˆé€šçŸ¥
      if: always()
      run: |
        echo "========================================="
        echo "FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯æµç¨‹å®Œæˆ"
        echo "========================================="
        echo "ğŸ“Š éªŒè¯çº§åˆ«: ${{ env.COMPILE_LEVEL }}"
        echo "âš¡ å¹¶è¡Œä»»åŠ¡: ${{ env.PARALLEL_JOBS }}"
        echo "ğŸ•’ å®Œæˆæ—¶é—´: $(date)"
        echo "========================================="
        
        # æ˜¾ç¤ºç®€ç•¥ç»“æœ
        if [ -f "verification-reports/compile_stats.txt" ]; then
          echo "ğŸ“ˆ ç¼–è¯‘ç»Ÿè®¡:"
          cat verification-reports/compile_stats.txt
        fi
        
        echo "========================================="