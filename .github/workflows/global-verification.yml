name: FRF 2.0 优化模块验证流
on:
  push:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**.v'
      - 'theories/FRF_MetaTheory.v'
      - '.github/workflows/global-verification.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**.v'
      - 'theories/FRF_MetaTheory.v'
  workflow_dispatch:  # 支持手动触发，方便测试优化后的模块

jobs:
  optimize-module-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    env:
      # 预定义核心模块路径（优化后需验证的模块）
      CORE_BASE_MODULES: "SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v"
      CORE_META_MODULE: "theories/FRF_MetaTheory.v"

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 仅拉取最新代码，加速流程

      - name: 安装系统依赖（基础编译环境）
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            opam \
            bubblewrap \
            g++ \
            pkg-config \
            m4 \
            rsync \
            git \
            wget
          echo "✅ 系统依赖安装完成"

      - name: 初始化OPAM环境（兼容Coq 8.18.0）
        run: |
          # 禁用sandboxing避免权限问题，指定OCaml 4.14.0（与Coq 8.18.0兼容）
          opam init --disable-sandboxing -y --compiler=4.14.0
          eval $(opam env)
          # 添加Coq官方仓库，确保能获取Mathlib3包（关键：Mathlib3仅在coq-released仓库中）
          opam repo add coq-released https://coq.inria.fr/opam/released
          opam update -y  # 强制更新包索引，避免找不到Mathlib3
          echo "✅ OPAM环境初始化完成"

      - name: 安装兼容的Coq与依赖库（修正Mathlib包名）
        run: |
          eval $(opam env)
          
          # 1. 安装核心依赖：Coq 8.18.0（与优化模块适配）
          echo "安装Coq 8.18.0..."
          opam install -y coq.8.18.0
          
          # 2. 关键修正：Mathlib 3.x在opam中的标准包名是「coq-mathlib3」，而非「coq-mathlib」
          echo "安装完整Mathlib 3.74.0（包名：coq-mathlib3）..."
          opam install -y coq-mathlib3=3.74.0
          
          # 3. 安装mathcomp-ssreflect 1.17.0（支撑Algebra.v的代数结构）
          echo "安装mathcomp-ssreflect 1.17.0..."
          opam install -y coq-mathcomp-ssreflect.1.17.0
          
          # 验证安装版本，确保无版本冲突
          echo "=== 验证依赖版本 ==="
          coqc --version | head -1
          opam list --installed | grep -E "coq|mathcomp|mathlib3"  # 验证mathlib3是否安装成功
          echo "✅ 依赖环境安装完成"

      - name: 验证项目结构（确保优化模块存在）
        run: |
          eval $(opam env)
          
          echo "=== 优化模块路径验证 ==="
          # 检查基础库模块（Algebra/Category/Geometry）
          for mod in $CORE_BASE_MODULES; do
            if [ -f "$mod" ]; then
              echo "✅ 优化模块存在：$mod"
            else
              echo "❌ 优化模块缺失：$mod"
              exit 1
            fi
          done
          
          # 检查元理论模块（FRF_MetaTheory.v）
          if [ -f "$CORE_META_MODULE" ]; then
            echo "✅ 优化模块存在：$CORE_META_MODULE"
          else
            echo "❌ 优化模块缺失：$CORE_META_MODULE"
            exit 1
          fi
          
          echo "=== 项目文件统计 ==="
          total_v=$(find . -name "*.v" | wc -l)
          echo "总Coq文件数：$total_v"
          echo "需验证优化模块数：$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)"

      - name: 基础环境测试（验证coqc命令可用性）
        run: |
          eval $(opam env)
          
          echo "=== 基础编译能力测试 ==="
          # 编译简单测试文件，排除环境本身问题
          cat > /tmp/verify_env.v << 'EOF'
          Theorem env_test : True.
          Proof. exact I. Qed.
          EOF
          
          if coqc /tmp/verify_env.v; then
            if [ -f "/tmp/verify_env.vo" ]; then
              echo "✅ 基础编译测试通过（coqc命令正常）"
              rm -f /tmp/verify_env.vo /tmp/verify_env.glob
            else
              echo "❌ 基础编译测试失败（未生成.vo文件）"
              exit 1
            fi
          else
            echo "❌ 基础编译测试失败（coqc命令异常）"
            exit 1
          fi
          rm -f /tmp/verify_env.v

      - name: 分步编译优化模块（按依赖顺序）
        run: |
          eval $(opam env)
          
          echo "=== 分步编译优化模块 ==="
          # 1. 获取Mathlib3安装路径（用于路径映射，支撑FRF_MetaTheory.v的导入）
          MATHLIB_PATH=$(opam var coq:user-contrib)/mathlib3  # 注意：mathlib3安装后的目录名是小写「mathlib3」
          echo "Mathlib3物理路径：$MATHLIB_PATH"
          
          # 2. 配置路径映射（关键：绑定SelfContainedLib和Mathlib3的逻辑路径）
          BASE_FLAGS="-Q SelfContainedLib SelfContainedLib -Q $MATHLIB_PATH Mathlib"
          echo "编译参数：$BASE_FLAGS"
          
          # 3. 按依赖顺序编译（避免连锁失败）
          # 顺序：Algebra（无依赖）→Category（依赖Algebra）→Geometry（依赖Algebra）→FRF_MetaTheory（依赖基础库+Mathlib3）
          for mod in $CORE_BASE_MODULES $CORE_META_MODULE; do
            echo -e "\n编译：$mod"
            if coqc $BASE_FLAGS "$mod"; then
              vo_file=$(echo $mod | sed 's/\.v/\.vo/')
              echo "✅ 成功：$mod（生成产物：$vo_file）"
            else
              echo "❌ 失败：$mod（详细错误如下）"
              # 显示前15行错误日志，方便定位问题（如导入路径、语法错误）
              coqc $BASE_FLAGS "$mod" 2>&1 | head -15
              exit 1
            fi
          done
          
          echo -e "\n🎉 所有优化模块编译通过！"

      - name: 编译结果分析（统计验证成功率）
        run: |
          eval $(opam env)
          
          echo "=== 优化模块验证结果分析 ==="
          # 统计总优化模块数和已编译成功数
          total_optimized=$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)
          compiled_vo=$(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | wc -l)
          
          echo "统计信息："
          echo "- 需验证优化模块数：$total_optimized"
          echo "- 编译成功模块数：$compiled_vo"
          
          # 计算成功率（仅针对优化模块）
          if [ $total_optimized -gt 0 ]; then
            success_rate=$((compiled_vo * 100 / total_optimized))
            echo "- 优化模块验证成功率：$success_rate%"
            
            if [ $success_rate -eq 100 ]; then
              echo "✅ 优化模块100%验证通过！"
            else
              echo "⚠️ 部分优化模块未通过（成功率<$success_rate%）"
              exit 1
            fi
          else
            echo "❌ 无优化模块可验证"
            exit 1
          fi
          
          # 列出已编译的优化模块产物
          echo -e "\n已编译的优化模块产物："
          find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | sed 's|^\./||'

      - name: 生成优化模块验证报告
        run: |
          eval $(opam env)
          
          echo "=== 生成优化模块验证报告 ==="
          mkdir -p verification-reports
          report_path="verification-reports/OPTIMIZED_MODULE_REPORT.md"
          
          # 收集基础信息
          verify_time=$(date "+%Y-%m-%d %H:%M:%S UTC")
          coq_version=$(coqc --version | head -1)
          total_optimized=$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)
          compiled_vo=$(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | wc -l)
          success_rate=$((compiled_vo * 100 / total_optimized))
          
          # 生成Markdown报告
          cat > $report_path << EOF
          # FRF 2.0 优化模块验证报告
          
          ## 验证基本信息
          - **验证时间**: $verify_time
          - **运行环境**: Ubuntu 22.04 (GitHub Actions)
          - **Coq版本**: $coq_version
          - **Mathlib版本**: 3.74.0（包名：coq-mathlib3）
          - **验证目标**: 优化后的核心模块（基础库+元理论）
          
          ## 验证统计
          | 指标                | 数值  |
          |---------------------|-------|
          | 需验证优化模块数    | $total_optimized |
          | 编译成功模块数      | $compiled_vo |
          | 验证成功率          | $success_rate% |
          
          ## 详细结果
          ### ✅ 编译成功的优化模块
          | 模块路径                          | 功能说明                  |
          |-----------------------------------|---------------------------|
          | SelfContainedLib/Algebra.v        | 自包含代数核心（无冗余依赖） |
          | SelfContainedLib/Category.v       | 范畴论核心结构（依赖Algebra） |
          | SelfContainedLib/Geometry.v       | 几何流形定义（修正路径错误） |
          | theories/FRF_MetaTheory.v        | FRF元理论核心（依赖基础库+Mathlib3） |
          
          ### 📋 编译产物列表
          \`\`\`
          $(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | sed 's|^\./||')
          \`\`\`
          
          ## 环境依赖详情
          \`\`\`
          $(opam list --installed | grep -E "coq|mathcomp|mathlib3" | sort)
          \`\`\`
          
          ## 关键修正说明
          1. **Mathlib包名修正**: 原错误使用「coq-mathlib」，Mathlib 3.x在opam中的标准包名是「coq-mathlib3」，已修正；
          2. **Mathlib路径绑定**: Mathlib3安装后物理目录为「mathlib3」（小写），路径映射已适配；
          3. **包索引更新**: 初始化OPAM时强制执行「opam update」，确保能获取最新包信息。
          
          ## 验证结论
          - 所有优化模块均通过编译，无导入路径错误、依赖缺失问题；
          - 基础库模块实现自包含，Mathlib3仅用于元理论模块，依赖边界清晰；
          - 验证流程打通，可支撑后续量子模块、动态系统模块的编译。
          EOF
          
          echo "✅ 验证报告生成完成（路径：$report_path）"

      - name: 上传优化模块验证报告
        uses: actions/upload-artifact@v4
        with:
          name: frf-optimized-module-report
          path: verification-reports/
          retention-days: 14  # 报告保留14天，方便回溯
          if-no-files-found: error  # 无报告时触发错误

      - name: 验证状态总结
        run: |
          eval $(opam env)
          
          compiled_vo=$(find . -name "*.vo" | grep -E "$(echo $CORE_BASE_MODULES $CORE_META_MODULE | sed 's/ /\|/g' | sed 's/\.v//g')" | wc -l)
          total_optimized=$(echo $CORE_BASE_MODULES $CORE_META_MODULE | wc -w)
          
          if [ $compiled_vo -eq $total_optimized ]; then
            echo "🎉 FRF 2.0 优化模块全量验证通过！"
            echo "📊 验证结果：$compiled_vo/$total_optimized 模块编译成功"
            echo "✅ 基础库+元理论模块无错误，可支撑后续场景模块开发"
          else
            echo "❌ FRF 2.0 优化模块验证失败"
            echo "📊 验证结果：$compiled_vo/$total_optimized 模块编译成功"
            exit 1
          fi