name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: è®¾ç½®OPAMçŽ¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMçŽ¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: å®‰è£…Coqå’Œæœ€å°ä¾èµ–é›†
      run: |
        eval $(opam env)
        # åªå®‰è£…Coqæ ¸å¿ƒå’Œç¡®è®¤å¯ç”¨çš„åŒ…
        opam install -y coq.8.18.0
        opam install -y coq-mathcomp-ssreflect
        echo "âœ… Coqå’Œæœ€å°ä¾èµ–å®‰è£…å®Œæˆ"
        coqc --version

    - name: éªŒè¯é¡¹ç›®ç»“æž„
      run: |
        echo "=== é¡¹ç›®ç»“æž„éªŒè¯ ==="
        find . -name "*.v" | head -10
        echo "æ€»Coqæ–‡ä»¶æ•°: $(find . -name '*.v' | wc -l)"
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        for dir in SelfContainedLib theories; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir ç›®å½•å­˜åœ¨"
            ls "$dir"/*.v 2>/dev/null | head -5 || echo "  æ— .væ–‡ä»¶"
          else
            echo "âŒ $dir ç›®å½•ç¼ºå¤±"
          fi
        done

    - name: åˆ†æ­¥ç¼–è¯‘æµ‹è¯•
      run: |
        echo "=== åˆ†æ­¥ç¼–è¯‘æµ‹è¯• ==="
        
        # æµ‹è¯•1: æœ€ç®€å•çš„ç¼–è¯‘æµ‹è¯•
        echo "1. åŸºç¡€ç¼–è¯‘æµ‹è¯•..."
        cat > test_basic.v << 'EOF'
        Theorem basic_test : True.
        Proof. exact I. Qed.
        EOF
        coqc test_basic.v
        if [ -f "test_basic.vo" ]; then
          echo "âœ… åŸºç¡€ç¼–è¯‘æµ‹è¯•é€šè¿‡"
          rm test_basic.vo test_basic.glob
        else
          echo "âŒ åŸºç¡€ç¼–è¯‘æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        rm test_basic.v

        # æµ‹è¯•2: ç¼–è¯‘Algebra.v
        echo "2. ç¼–è¯‘Algebra.v..."
        if [ -f "SelfContainedLib/Algebra.v" ]; then
          # ä½¿ç”¨æœ€ç®€å•çš„è·¯å¾„æ˜ å°„
          coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Algebra.v
          if [ -f "SelfContainedLib/Algebra.vo" ]; then
            echo "âœ… Algebra.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ Algebra.v ç¼–è¯‘å¤±è´¥"
            # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
            coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Algebra.v 2>&1 | head -20
          fi
        else
          echo "âŒ Algebra.v æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        # æµ‹è¯•3: ç¼–è¯‘Category.v
        echo "3. ç¼–è¯‘Category.v..."
        if [ -f "SelfContainedLib/Category.v" ] && [ -f "SelfContainedLib/Algebra.vo" ]; then
          coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Category.v
          if [ -f "SelfContainedLib/Category.vo" ]; then
            echo "âœ… Category.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ Category.v ç¼–è¯‘å¯èƒ½æœ‰é—®é¢˜"
          fi
        fi

    - name: æ ¸å¿ƒæ¨¡å—ç¼–è¯‘
      run: |
        echo "=== æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ ==="
        
        # è®¾ç½®åŸºç¡€è·¯å¾„æ˜ å°„
        BASE_FLAGS="-Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories"
        
        # ç¼–è¯‘åŸºç¡€åº“ï¼ˆå¦‚æžœä¹‹å‰å¤±è´¥ï¼Œé‡æ–°å°è¯•ï¼‰
        for base_file in SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v; do
          if [ -f "$base_file" ] && [ ! -f "${base_file%.v}.vo" ]; then
            echo "ç¼–è¯‘: $base_file"
            coqc $BASE_FLAGS "$base_file" || echo "ç¼–è¯‘è·³è¿‡: $base_file"
          fi
        done
        
        # ç¼–è¯‘FRFæ ¸å¿ƒç†è®º
        for frf_file in theories/FRF_MetaTheory.v theories/ChurchNumerals.v theories/ChurchZero.v; do
          if [ -f "$frf_file" ]; then
            echo "ç¼–è¯‘: $frf_file"
            coqc $BASE_FLAGS "$frf_file" || echo "ç¼–è¯‘è·³è¿‡: $frf_file"
          fi
        done

    - name: ç¼–è¯‘ç»“æžœåˆ†æž
      if: always()
      run: |
        echo "=== ç¼–è¯‘ç»“æžœåˆ†æž ==="
        
        total_v_files=$(find . -name "*.v" | wc -l)
        compiled_vo_files=$(find . -name "*.vo" | wc -l)
        
        echo "ç»Ÿè®¡ä¿¡æ¯:"
        echo "- æ€»Coqæ–‡ä»¶: $total_v_files"
        echo "- å·²ç¼–è¯‘æ–‡ä»¶: $compiled_vo_files"
        
        if [ $compiled_vo_files -gt 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ!"
          echo "ç¼–è¯‘äº§ç‰©:"
          find . -name "*.vo" | sed 's|^\./||'
          
          # è®¡ç®—æˆåŠŸçŽ‡
          success_rate=$((compiled_vo_files * 100 / total_v_files))
          echo "ç¼–è¯‘æˆåŠŸçŽ‡: $success_rate%"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "é—®é¢˜è¯Šæ–­:"
          echo "1. æ£€æŸ¥Coqç‰ˆæœ¬å…¼å®¹æ€§"
          echo "2. éªŒè¯æ–‡ä»¶è¯­æ³•"
          echo "3. æ£€æŸ¥ä¾èµ–å…³ç³»"
        fi

    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      run: |
        echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
        
        mkdir -p verification-reports
        
        # æ”¶é›†æ•°æ®
        total_v_files=$(find . -name "*.v" | wc -l)
        compiled_vo_files=$(find . -name "*.vo" | wc -l)
        coq_version=$(coqc --version | head -1)
        
        # ç”ŸæˆæŠ¥å‘Š
        cat > verification-reports/REPORT.md << EOF
# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

**éªŒè¯æ—¶é—´**: $(date)
**çŽ¯å¢ƒ**: Ubuntu 22.04
**Coqç‰ˆæœ¬**: $coq_version

## ç¼–è¯‘ç»Ÿè®¡
- æ€»Coqæ–‡ä»¶: $total_v_files
- æˆåŠŸç¼–è¯‘: $compiled_vo_files
- ç¼–è¯‘æˆåŠŸçŽ‡: $((compiled_vo_files * 100 / total_v_files))%

## è¯¦ç»†ç»“æžœ
EOF

        if [ $compiled_vo_files -gt 0 ]; then
          cat >> verification-reports/REPORT.md << EOF
### âœ… éªŒè¯æˆåŠŸ
æˆåŠŸç¼–è¯‘äº† $compiled_vo_files ä¸ªæ ¸å¿ƒæ¨¡å—ï¼ŒFRFæ¡†æž¶åŸºç¡€éªŒè¯é€šè¿‡ã€‚

**å·²ç¼–è¯‘æ¨¡å—:**
\`\`\`
$(find . -name "*.vo" | sed 's|^\./||')
\`\`\`
EOF
        else
          cat >> verification-reports/REPORT.md << EOF
### âŒ éªŒè¯å¤±è´¥
æœªèƒ½ç¼–è¯‘ä»»ä½•Coqæ¨¡å—ã€‚

**å¯èƒ½åŽŸå› :**
1. CoqçŽ¯å¢ƒé…ç½®é—®é¢˜
2. ä»£ç è¯­æ³•é”™è¯¯
3. ä¾èµ–å…³ç³»ç¼ºå¤±
4. è·¯å¾„æ˜ å°„é…ç½®é”™è¯¯

**å»ºè®®æŽ’æŸ¥æ­¥éª¤:**
1. æ£€æŸ¥Coqç‰ˆæœ¬å…¼å®¹æ€§
2. éªŒè¯å•ä¸ªæ–‡ä»¶ç¼–è¯‘: \`coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Algebra.v\`
3. æ£€æŸ¥æ–‡ä»¶ä¾èµ–å…³ç³»
EOF
        fi

        cat >> verification-reports/REPORT.md << EOF

## çŽ¯å¢ƒä¿¡æ¯
\`\`\`
$(opam list --installed | grep -E "coq|mathcomp")
\`\`\`

## é¡¹ç›®ç»“æž„
\`\`\`
$(find . -name "*.v" -type f | head -20)
\`\`\`
EOF

        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-verification-report
        path: verification-reports/
        retention-days: 7

    - name: éªŒè¯çŠ¶æ€æ€»ç»“
      if: always()
      run: |
        compiled_count=$(find . -name "*.vo" | wc -l)
        if [ $compiled_count -ge 1 ]; then
          echo "ðŸŽ‰ FRF 2.0 éªŒè¯éƒ¨åˆ†æˆåŠŸ!"
          echo "ðŸ“Š ç¼–è¯‘æ¨¡å—æ•°: $compiled_count"
          echo "âœ… åŸºç¡€æ¡†æž¶éªŒè¯é€šè¿‡"
        elif [ $compiled_count -eq 0 ]; then
          echo "âŒ FRF 2.0 éªŒè¯å¤±è´¥"
          echo "ðŸ“‹ è¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆ"
          echo "ðŸ”§ éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•"
        fi