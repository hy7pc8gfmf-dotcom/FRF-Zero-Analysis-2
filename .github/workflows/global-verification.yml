name: FRF 2.0 æ™ºèƒ½å…¨é‡å½¢å¼åŒ–éªŒè¯ï¼ˆç»¼åˆç‰ˆï¼‰

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
      - '.github/workflows/global-verification.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
  workflow_dispatch:
    inputs:
      verify_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - test-only
          - report-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: false
        default: '4'
        type: string

jobs:
  setup-environment:
    name: ğŸ”§ ç¯å¢ƒé…ç½®ä¸æ£€æŸ¥
    runs-on: ubuntu-22.04
    outputs:
      coq_version: ${{ steps.check-coq.outputs.version }}
      memory_available: ${{ steps.check-memory.outputs.available_mb }}
      core_count: ${{ steps.check-cpu.outputs.core_count }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false

      - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
        id: check-cpu
        run: |
          echo "æ ¸å¿ƒæ•°: $(nproc)"
          echo "core_count=$(nproc)" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ å†…å­˜æ£€æŸ¥
        id: check-memory
        run: |
          AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
          echo "å¯ç”¨å†…å­˜: ${AVAIL_MEM}MB"
          echo "available_mb=${AVAIL_MEM}" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            opam \
            bubblewrap \
            g++ \
            pkg-config \
            m4 \
            rsync \
            git \
            wget \
            bc \
            graphviz \
            python3 \
            python3-pip
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ”„ é…ç½®OPAMç¯å¢ƒ
        run: |
          opam init --disable-sandboxing -y --compiler=4.14.0
          eval $(opam env)
          opam repo add coq-released https://coq.inria.fr/opam/released
          opam repo add mathlib https://github.com/leanprover-community/mathlib.git
          opam update -y
          echo "OPAM_HOME=$OPAM_HOME" >> $GITHUB_ENV
          echo "OPAM_SWITCH_PREFIX=$OPAM_SWITCH_PREFIX" >> $GITHUB_ENV

      - name: ğŸ“Š é…ç½®éªŒè¯ç¯å¢ƒ
        run: |
          # æ ¹æ®å†…å­˜è®¾ç½®ç¼–è¯‘å‚æ•°
          if [ ${{ steps.check-memory.outputs.available_mb }} -gt 16000 ]; then
            echo "COQ_MEMORY=16384" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=16384" >> $GITHUB_ENV
          elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 8000 ]; then
            echo "COQ_MEMORY=8192" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=8192" >> $GITHUB_ENV
          elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 4000 ]; then
            echo "COQ_MEMORY=4096" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=4096" >> $GITHUB_ENV
          else
            echo "COQ_MEMORY=2048" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=2048" >> $GITHUB_ENV
          fi

          echo "PARALLEL_JOBS=$(( ${{ steps.check-cpu.outputs.core_count }} / 2 ))" >> $GITHUB_ENV

      - name: ğŸ” æ£€æŸ¥Coqç‰ˆæœ¬
        id: check-coq
        run: |
          eval $(opam env)
          if command -v coqc &> /dev/null; then
            COQ_VERSION=$(coqc --version | head -1 | grep -o 'version [0-9.]\+' | cut -d' ' -f2)
            echo "å½“å‰Coqç‰ˆæœ¬: $COQ_VERSION"
            echo "version=$COQ_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ Coqæœªå®‰è£…"
            exit 1
          fi

      - name: ğŸ“‹ ç¯å¢ƒæŠ¥å‘Š
        run: |
          echo "=== ç¯å¢ƒé…ç½®æŠ¥å‘Š ==="
          echo "ç³»ç»Ÿ: Ubuntu 22.04"
          echo "CPUæ ¸å¿ƒ: ${{ steps.check-cpu.outputs.core_count }}"
          echo "å¯ç”¨å†…å­˜: ${{ steps.check-memory.outputs.available_mb }}MB"
          echo "åˆ†é…å†…å­˜: ${{ env.COQ_MEMORY }}MB"
          echo "å¹¶è¡Œä»»åŠ¡: ${{ env.PARALLEL_JOBS }}"
          echo "Coqç‰ˆæœ¬: ${{ steps.check-coq.outputs.version }}"

  install-dependencies:
    name: ğŸ“¦ ä¾èµ–å®‰è£…ä¸ç¼“å­˜
    needs: setup-environment
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        coq-version: ['8.18.0']
        mathcomp-version: ['1.17.0']
    steps:
      - name: ğŸ“¥ æ¢å¤OPAMç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
          key: ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-${{ hashFiles('*.opam') }}
          restore-keys: |
            ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-
            ${{ runner.os }}-opam-

      - name: ğŸ”„ è®¾ç½®OPAMç¯å¢ƒ
        run: |
          eval $(opam env)
          opam update

      - name: ğŸ“Š å®‰è£…Coqæ ¸å¿ƒ
        run: |
          eval $(opam env)
          echo "å®‰è£…Coq ${{ matrix.coq-version }}..."
          opam install -y coq.${{ matrix.coq-version }}

          echo "éªŒè¯Coqå®‰è£…..."
          coqc --version
          if [ $? -ne 0 ]; then
            echo "âŒ Coqå®‰è£…å¤±è´¥"
            exit 1
          fi

      - name: ğŸ§® å®‰è£…mathcomp
        run: |
          eval $(opam env)
          echo "å®‰è£…coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}..."
          opam install -y coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}

          echo "éªŒè¯mathcompå®‰è£…..."
          opam list --installed | grep "coq-mathcomp-ssreflect" || (echo "âŒ mathcompå®‰è£…å¤±è´¥" && exit 1)

      - name: ğŸ“š å®‰è£…å¤–éƒ¨åº“
        run: |
          eval $(opam env)
          echo "å®‰è£…å¤–éƒ¨ä¾èµ–åº“..."
          opam install -y coq-mathcomp-analysis coq-stdlib
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ“ ä¾èµ–éªŒè¯æŠ¥å‘Š
        run: |
          eval $(opam env)
          echo "=== ä¾èµ–éªŒè¯æŠ¥å‘Š ==="
          echo "Coqç‰ˆæœ¬:"
          coqc --version
          echo ""
          echo "å®‰è£…çš„åŒ…:"
          opam list --installed | grep -E "coq|mathcomp"
          echo ""

  compile-phase-1:
    name: ğŸ—ï¸ é˜¶æ®µ1: åŸºç¡€åº“ç¼–è¯‘
    needs: [setup-environment, install-dependencies]
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

      - name: ğŸ“Š ç¼–è¯‘å‰æ£€æŸ¥
        run: |
          echo "=== åŸºç¡€åº“ç¼–è¯‘å‰æ£€æŸ¥ ==="
          echo "åŸºç¡€åº“æ–‡ä»¶:"
          ls -la SelfContainedLib/*.v 2>/dev/null || echo "æ— åŸºç¡€åº“æ–‡ä»¶"
          echo ""
          echo "ç¼–è¯‘å‚æ•°: $COQFLAGS"
          echo "å†…å­˜é™åˆ¶: ${{ env.COQ_MEMORY }}MB"

      - name: ğŸ”§ ç¼–è¯‘åŸºç¡€åº“ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        run: |
          eval $(opam env)
          echo "å¼€å§‹ç¼–è¯‘åŸºç¡€åº“..."
          
          # ç¼–è¯‘Algebra.v
          if [ -f "SelfContainedLib/Algebra.v" ]; then
            coqc $COQFLAGS SelfContainedLib/Algebra.v && echo "âœ… Algebra.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ Algebra.v ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          else
            echo "âŒ Algebra.v æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          
          # ç¼–è¯‘Category.v
          if [ -f "SelfContainedLib/Category.v" ]; then
            coqc $COQFLAGS SelfContainedLib/Category.v && echo "âœ… Category.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ Category.v ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          else
            echo "âŒ Category.v æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          
          # ç¼–è¯‘Geometry.v
          if [ -f "SelfContainedLib/Geometry.v" ]; then
            coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} SelfContainedLib/Geometry.v && echo "âœ… Geometry.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ Geometry.v ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          else
            echo "âŒ Geometry.v æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi

      - name: ğŸ“ˆ ç¼–è¯‘ç»“æœç»Ÿè®¡
        run: |
          echo "=== åŸºç¡€åº“ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "ç¼–è¯‘æ–‡ä»¶:"
          for file in Algebra Category Geometry; do
            if [ -f "SelfContainedLib/$file.vo" ]; then
              echo "  âœ… $file.vo (å­˜åœ¨)"
            else
              echo "  âŒ $file.vo (ç¼ºå¤±)"
            fi
          done
          echo ""
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -la SelfContainedLib/*.vo SelfContainedLib/*.glob 2>/dev/null || echo "æ— ç”Ÿæˆæ–‡ä»¶"

  compile-phase-2:
    name: ğŸ§  é˜¶æ®µ2: å…ƒç†è®ºå±‚ç¼–è¯‘
    needs: compile-phase-1
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV
          
          # å¤åˆ¶åŸºç¡€åº“çš„.voæ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true

      - name: ğŸ“Š æ£€æŸ¥å…ƒç†è®ºæ–‡ä»¶
        run: |
          echo "=== å…ƒç†è®ºå±‚æ–‡ä»¶æ£€æŸ¥ ==="
          echo "å…ƒç†è®ºæ–‡ä»¶:"
          ls -la theories/*.v 2>/dev/null || echo "æ— å…ƒç†è®ºæ–‡ä»¶"
          echo ""

      - name: ğŸ”§ ç¼–è¯‘å…ƒç†è®ºï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        run: |
          eval $(opam env)
          echo "å¼€å§‹ç¼–è¯‘å…ƒç†è®ºå±‚..."
          
          # 1. ç¼–è¯‘FRF_MetaTheory.v
          if [ -f "theories/FRF_MetaTheory.v" ]; then
            coqc $COQFLAGS theories/FRF_MetaTheory.v && echo "âœ… FRF_MetaTheory.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ FRF_MetaTheory.v ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          else
            echo "âŒ FRF_MetaTheory.v æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          
          # 2. ç¼–è¯‘ChurchNumerals.v
          if [ -f "theories/ChurchNumerals.v" ]; then
            coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} theories/ChurchNumerals.v && echo "âœ… ChurchNumerals.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ ChurchNumerals.v ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          else
            echo "âŒ ChurchNumerals.v æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          
          # 3. ç¼–è¯‘ChurchZero.v
          if [ -f "theories/ChurchZero.v" ]; then
            coqc $COQFLAGS theories/ChurchZero.v && echo "âœ… ChurchZero.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ ChurchZero.v ç¼–è¯‘å¤±è´¥"
              exit 1
            }
          else
            echo "âŒ ChurchZero.v æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi

      - name: ğŸ“ˆ å…ƒç†è®ºç¼–è¯‘ç»Ÿè®¡
        run: |
          echo "=== å…ƒç†è®ºå±‚ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "ç¼–è¯‘æ–‡ä»¶æ•°: 3"
          echo "æˆåŠŸæ–‡ä»¶:"
          for file in FRF_MetaTheory ChurchNumerals ChurchZero; do
            if [ -f "theories/$file.vo" ]; then
              lines=$(wc -l < "theories/$file.v" 2>/dev/null || echo 0)
              echo "  âœ… $file.vo ($lines è¡Œ)"
            else
              echo "  âŒ $file.vo (ç¼ºå¤±)"
            fi
          done

  compile-phase-3:
    name: ğŸ¯ é˜¶æ®µ3: æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘
    needs: compile-phase-2
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV
          
          # å¤åˆ¶ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true

      - name: ğŸ”§ ç¼–è¯‘æ•°å­¦åœºæ™¯ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        run: |
          eval $(opam env)
          echo "å¼€å§‹ç¼–è¯‘æ•°å­¦åœºæ™¯å±‚..."
          
          # æŸ¥æ‰¾æ‰€æœ‰åœºæ™¯æ–‡ä»¶
          SCENE_FILES=$(find theories -name "Case*_*.v" 2>/dev/null | head -5)
          
          if [ -z "$SCENE_FILES" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æ•°å­¦åœºæ™¯æ–‡ä»¶"
            exit 0
          fi
          
          for file in $SCENE_FILES; do
            base=$(basename "$file" .v)
            echo "ç¼–è¯‘ $base.v..."
            if coqc $COQFLAGS "$file" 2>&1; then
              echo "âœ… $base.v ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ $base.v ç¼–è¯‘å¤±è´¥"
              # ä¸ç«‹å³é€€å‡ºï¼Œç»§ç»­ç¼–è¯‘å…¶ä»–æ–‡ä»¶
            fi
          done
          
          echo "âœ… æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘å°è¯•å®Œæˆ"

      - name: ğŸ“ˆ åœºæ™¯å±‚ç»Ÿè®¡
        run: |
          echo "=== æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "åœºæ™¯æ¨¡å—:"
          scene_count=0
          success_count=0
          
          for file in theories/Case*.v 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename "$file" .v)
              ((scene_count++))
              if [ -f "theories/${base}.vo" ]; then
                echo "  âœ… $base"
                ((success_count++))
              else
                echo "  âŒ $base"
              fi
            fi
          done
          
          if [ $scene_count -eq 0 ]; then
            echo "  æ— æ•°å­¦åœºæ™¯æ–‡ä»¶"
          else
            echo "  æ€»è®¡: $success_count/$scene_count ä¸ªåœºæ™¯ç¼–è¯‘æˆåŠŸ"
          fi

  compile-phase-4:
    name: ğŸ”® é˜¶æ®µ4: æ‰©å±•æ¨¡å—ç¼–è¯‘
    needs: 
      - compile-phase-3
      - compile-phase-1
    runs-on: ubuntu-22.04
    timeout-minutes: 50
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -Q CS_Null CS_Null"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV
          
          # å¤åˆ¶ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-3/theories/*.vo theories/ 2>/dev/null || true

      - name: ğŸ“ æ£€æŸ¥æ‰©å±•æ¨¡å—
        run: |
          echo "=== æ‰©å±•æ¨¡å—ç»“æ„æ£€æŸ¥ ==="
          echo "ç©ºå€¼ç³»ç»Ÿ:"
          ls -la CS_Null/*.v 2>/dev/null || echo "æ— ç©ºå€¼ç³»ç»Ÿæ–‡ä»¶"
          echo ""
          echo "é‡å­æ¨¡å—:"
          ls -la Quantum/*.v 2>/dev/null || echo "æ— é‡å­æ¨¡å—æ–‡ä»¶"

      - name: ğŸ”§ ç¼–è¯‘ç©ºå€¼ç³»ç»ŸåŸºç¡€ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        run: |
          eval $(opam env)
          echo "ç¼–è¯‘ç©ºå€¼ç³»ç»ŸåŸºç¡€æ¨¡å—..."
          
          # ç¼–è¯‘FRF_CS_Null_Common.v
          if [ -f "CS_Null/FRF_CS_Null_Common.v" ]; then
            coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} CS_Null/FRF_CS_Null_Common.v && echo "âœ… FRF_CS_Null_Common.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ FRF_CS_Null_Common.v ç¼–è¯‘å¤±è´¥"
              # ä¸é€€å‡ºï¼Œç»§ç»­å°è¯•å…¶ä»–æ–‡ä»¶
            }
          else
            echo "âš ï¸ FRF_CS_Null_Common.v æ–‡ä»¶ç¼ºå¤±"
          fi
          
          # ç¼–è¯‘FRF_CS_Null.v
          if [ -f "CS_Null/FRF_CS_Null.v" ]; then
            coqc $COQFLAGS CS_Null/FRF_CS_Null.v && echo "âœ… FRF_CS_Null.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ FRF_CS_Null.v ç¼–è¯‘å¤±è´¥"
            }
          else
            echo "âš ï¸ FRF_CS_Null.v æ–‡ä»¶ç¼ºå¤±"
          fi

      - name: ğŸ“ˆ æ‰©å±•æ¨¡å—ç»Ÿè®¡
        run: |
          echo "=== æ‰©å±•æ¨¡å—ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "ç©ºå€¼ç³»ç»Ÿ:"
          count=0
          for file in CS_Null/*.vo 2>/dev/null; do
            base=$(basename "$file" .vo)
            echo "  âœ… $base"
            ((count++))
          done
          
          if [ $count -eq 0 ]; then
            echo "  æ— ç©ºå€¼ç³»ç»Ÿæ¨¡å—ç¼–è¯‘æˆåŠŸ"
          else
            echo "  æ€»è®¡: $count ä¸ªæ¨¡å—"
          fi

  compile-phase-5:
    name: ğŸ§© é˜¶æ®µ5: é›†æˆæ¨¡å—ç¼–è¯‘
    needs:
      - compile-phase-4
      - compile-phase-2
      - compile-phase-3
    runs-on: ubuntu-22.04
    timeout-minutes: 35
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -Q CS_Null CS_Null -Q Quantum Quantum"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV
          
          # å¤åˆ¶æ‰€æœ‰ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-3/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-4/CS_Null/*.vo CS_Null/ 2>/dev/null || true

      - name: ğŸ”§ ç¼–è¯‘é›†æˆæ¨¡å—ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        run: |
          eval $(opam env)
          echo "ç¼–è¯‘é›†æˆæ¨¡å— FRF_Comparative.v..."
          
          # æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´
          if [ ! -f "theories/FRF_Comparative.v" ]; then
            echo "âš ï¸ FRF_Comparative.v æ–‡ä»¶ç¼ºå¤±"
            exit 0
          fi
          
          # æ£€æŸ¥å…³é”®ä¾èµ–
          required_files=(
            "theories/FRF_MetaTheory.vo"
            "SelfContainedLib/Algebra.vo"
          )
          
          missing_deps=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘ä¾èµ–: $file"
              ((missing_deps++))
            fi
          done
          
          if [ $missing_deps -gt 0 ]; then
            echo "âš ï¸ ä¾èµ–ä¸å®Œæ•´ï¼Œè·³è¿‡é›†æˆæ¨¡å—ç¼–è¯‘"
            exit 0
          fi
          
          echo "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"
          
          # ç¼–è¯‘é›†æˆæ¨¡å—
          if coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} theories/FRF_Comparative.v 2>&1; then
            echo "âœ… FRF_Comparative.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ FRF_Comparative.v ç¼–è¯‘å¤±è´¥"
          fi

      - name: ğŸ“Š é›†æˆæ¨¡å—éªŒè¯
        run: |
          echo "=== é›†æˆæ¨¡å—éªŒè¯ ==="
          if [ -f "theories/FRF_Comparative.vo" ]; then
            size=$(wc -l < "theories/FRF_Comparative.v" 2>/dev/null || echo 0)
            echo "  âœ… FRF_Comparative.vo ($size è¡Œ)"
          else
            echo "  âš ï¸ FRF_Comparative.vo ç¼ºå¤±"
          fi

  compile-phase-6:
    name: ğŸ§ª é˜¶æ®µ6: æµ‹è¯•å¥—ä»¶ç¼–è¯‘
    needs:
      - compile-phase-5
      - compile-phase-1
      - compile-phase-2
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -Q CS_Null CS_Null -Q Test Test"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV
          
          # å¤åˆ¶æ‰€æœ‰ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-3/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-4/CS_Null/*.vo CS_Null/ 2>/dev/null || true
          cp -r ../compile-phase-5/theories/*.vo theories/ 2>/dev/null || true

      - name: ğŸ§ª æ£€æŸ¥æµ‹è¯•å¥—ä»¶
        run: |
          echo "=== æµ‹è¯•å¥—ä»¶æ£€æŸ¥ ==="
          echo "æµ‹è¯•æ–‡ä»¶:"
          ls -la Test/*.v 2>/dev/null || echo "æ— æµ‹è¯•æ–‡ä»¶"
          echo ""

      - name: ğŸ”§ ç¼–è¯‘æµ‹è¯•ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        run: |
          eval $(opam env)
          echo "ç¼–è¯‘æµ‹è¯•å¥—ä»¶..."
          
          # ç¼–è¯‘Test_Basic.v
          if [ -f "Test/Test_Basic.v" ]; then
            coqc $COQFLAGS Test/Test_Basic.v && echo "âœ… Test_Basic.v ç¼–è¯‘æˆåŠŸ" || {
              echo "âŒ Test_Basic.v ç¼–è¯‘å¤±è´¥"
            }
          else
            echo "âš ï¸ Test_Basic.v æ–‡ä»¶ç¼ºå¤±"
          fi
          
          # æŸ¥æ‰¾å…¶ä»–æµ‹è¯•æ–‡ä»¶
          OTHER_TESTS=$(find Test -name "*.v" ! -name "Test_Basic.v" 2>/dev/null | head -5)
          
          if [ -n "$OTHER_TESTS" ]; then
            for file in $OTHER_TESTS; do
              base=$(basename "$file" .v)
              echo "ç¼–è¯‘ $base.v..."
              if coqc $COQFLAGS "$file" 2>&1; then
                echo "âœ… $base.v ç¼–è¯‘æˆåŠŸ"
              else
                echo "âŒ $base.v ç¼–è¯‘å¤±è´¥"
              fi
            done
          fi

      - name: ğŸ“Š æµ‹è¯•ç¼–è¯‘ç»Ÿè®¡
        run: |
          echo "=== æµ‹è¯•å¥—ä»¶ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "æµ‹è¯•æ–‡ä»¶:"
          total=0
          success=0
          
          for file in Test/*.vo 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename "$file" .vo)
              echo "  âœ… $base"
              ((success++))
            fi
            ((total++))
          done
          
          if [ $total -eq 0 ]; then
            echo "  æ— æµ‹è¯•æ–‡ä»¶"
          else
            echo "  ç»Ÿè®¡: $success/$total ä¸ªæµ‹è¯•ç¼–è¯‘æˆåŠŸ"
          fi

  full-verification-report:
    name: ğŸ“‹ å…¨é‡éªŒè¯æŠ¥å‘Šç”Ÿæˆ
    needs:
      - compile-phase-1
      - compile-phase-2
      - compile-phase-3
      - compile-phase-4
      - compile-phase-5
      - compile-phase-6
    if: always()
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ“Š ç”ŸæˆéªŒè¯æŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆå…¨é‡éªŒè¯æŠ¥å‘Š..."
          
          # ç»Ÿè®¡ç¼–è¯‘ç»“æœ
          TOTAL_FILES=0
          COMPILED_FILES=0
          
          # æ‰«ææ‰€æœ‰.væ–‡ä»¶
          for dir in SelfContainedLib theories Quantum CS_Null Test; do
            if [ -d "$dir" ]; then
              for file in $(find "$dir" -name "*.v" 2>/dev/null); do
                ((TOTAL_FILES++))
                vo_file="${file%.v}.vo"
                
                if [ -f "$vo_file" ]; then
                  ((COMPILED_FILES++))
                fi
              done
            fi
          done
          
          # è®¡ç®—æˆåŠŸç‡
          if [ $TOTAL_FILES -gt 0 ]; then
            SUCCESS_RATE=$((COMPILED_FILES * 100 / TOTAL_FILES))
          else
            SUCCESS_RATE=0
          fi
          
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p verification-report
          
          # ç”ŸæˆMarkdownæŠ¥å‘Š
          cat > verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF
# FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

## éªŒè¯æ¦‚è§ˆ
- **éªŒè¯æ—¶é—´**: $(date)
- **ç¯å¢ƒ**: Ubuntu 22.04
- **æ€»æ–‡ä»¶æ•°**: $TOTAL_FILES
- **ç¼–è¯‘æˆåŠŸ**: $COMPILED_FILES
- **ç¼–è¯‘æˆåŠŸç‡**: ${SUCCESS_RATE}%

## æ¨¡å—ç¼–è¯‘çŠ¶æ€

### å±‚çº§1: è‡ªåŒ…å«åŸºç¡€åº“
| æ¨¡å— | çŠ¶æ€ | è¡Œæ•° |
|------|------|------|
EOF
          
          # åŸºç¡€åº“çŠ¶æ€
          for file in SelfContainedLib/*.v 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename "$file" .v)
              lines=$(wc -l < "$file" 2>/dev/null || echo 0)
              status="âŒ"
              if [ -f "${file%.v}.vo" ]; then
                status="âœ…"
              fi
              echo "| $base | $status | $lines |" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            fi
          done
          
          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

### å±‚çº§2: FRFå…ƒç†è®º
| æ¨¡å— | çŠ¶æ€ | è¡Œæ•° |
|------|------|------|
EOF
          
          # å…ƒç†è®ºçŠ¶æ€
          for file in theories/FRF_MetaTheory.v theories/ChurchZero.v theories/ChurchNumerals.v 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename "$file" .v)
              lines=$(wc -l < "$file" 2>/dev/null || echo 0)
              status="âŒ"
              if [ -f "${file%.v}.vo" ]; then
                status="âœ…"
              fi
              echo "| $base | $status | $lines |" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            fi
          done
          
          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

### å±‚çº§5: é›†æˆæ¨¡å—
| æ¨¡å— | çŠ¶æ€ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|------|
EOF
          
          # é›†æˆæ¨¡å—çŠ¶æ€
          if [ -f "theories/FRF_Comparative.v" ]; then
            lines=$(wc -l < "theories/FRF_Comparative.v" 2>/dev/null || echo 0)
            status="âŒ"
            if [ -f "theories/FRF_Comparative.vo" ]; then
              status="âœ…"
            fi
            echo "| FRF_Comparative | $status | $lines | è·¨ç³»ç»Ÿå¯¹æ¯”æ ¸å¿ƒ |" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
          fi
          
          # æ·»åŠ æ€»ç»“
          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

## éªŒè¯æ€»ç»“

EOF
          
          if [ $COMPILED_FILES -eq $TOTAL_FILES ] && [ $TOTAL_FILES -gt 0 ]; then
            echo "ğŸ‰ **æ‰€æœ‰æ¨¡å—ç¼–è¯‘æˆåŠŸï¼**" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            echo "FRF 2.0 å½¢å¼åŒ–éªŒè¯å®Œå…¨é€šè¿‡ã€‚" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
          else
            echo "âš ï¸  **éƒ¨åˆ†æ¨¡å—ç¼–è¯‘å¤±è´¥**" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            echo "å¤±è´¥æ–‡ä»¶æ•°: $((TOTAL_FILES - COMPILED_FILES))" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
          fi
          
          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

## ç¯å¢ƒä¿¡æ¯
\`\`\`
Coqç‰ˆæœ¬: ${{ needs.setup-environment.outputs.coq_version }}
å¯ç”¨å†…å­˜: ${{ needs.setup-environment.outputs.memory_available }}MB
CPUæ ¸å¿ƒ: ${{ needs.setup-environment.outputs.core_count }}
ç¼–è¯‘æ—¶é—´: $(date +%Y-%m-%d\ %H:%M:%S)
\`\`\`
EOF
          
          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: frf2-verification-report
          path: verification-report/
          retention-days: 30

      - name: ğŸ“§ é€šçŸ¥ç»“æœ
        if: always()
        run: |
          echo "=== éªŒè¯ç»“æœ ==="
          if [ ${{ needs.compile-phase-1.result }} == 'success' ] && [ ${{ needs.compile-phase-2.result }} == 'success' ]; then
            echo "âœ… æ ¸å¿ƒæ¨¡å—éªŒè¯é€šè¿‡"
            echo "::notice title=éªŒè¯é€šè¿‡::FRF 2.0 æ ¸å¿ƒéªŒè¯æˆåŠŸå®Œæˆ"
          else
            echo "âŒ æ ¸å¿ƒæ¨¡å—éªŒè¯å¤±è´¥"
            echo "::error title=éªŒè¯å¤±è´¥::FRF 2.0 æ ¸å¿ƒéªŒè¯å¤±è´¥"
          fi

  quick-verification:
    name: âš¡ å¿«é€ŸéªŒè¯ï¼ˆå¯é€‰ï¼‰
    needs: setup-environment
    if: github.event.inputs.verify_mode == 'quick'
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)

      - name: ğŸ”§ å¿«é€Ÿç¼–è¯‘æ ¸å¿ƒ
        run: |
          echo "âš¡ å¿«é€ŸéªŒè¯æ¨¡å¼..."
          
          # åªç¼–è¯‘åŸºç¡€åº“å’Œå…ƒç†è®ºæ ¸å¿ƒ
          CORE_FILES="
            SelfContainedLib/Algebra.v
            SelfContainedLib/Category.v
            theories/FRF_MetaTheory.v
            theories/ChurchZero.v
          "
          
          for file in $CORE_FILES; do
            if [ -f "$file" ]; then
              echo "ç¼–è¯‘: $(basename $file)"
              coqc -Q SelfContainedLib SelfContainedLib -Q theories theories "$file" 2>&1 | tail -5
            fi
          done
          
          echo "âœ… å¿«é€ŸéªŒè¯å®Œæˆ"

  test-only-mode:
    name: ğŸ§ª ä»…æµ‹è¯•æ¨¡å¼
    needs: [setup-environment, install-dependencies]
    if: github.event.inputs.verify_mode == 'test-only'
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•
        run: |
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼..."
          
          # ç¼–è¯‘å¹¶è¿è¡ŒåŸºç¡€æµ‹è¯•
          if [ -f "Test/Test_Basic.v" ]; then
            echo "è¿è¡ŒåŸºç¡€æµ‹è¯•..."
            coqc -Q SelfContainedLib SelfContainedLib -Q Test Test Test/Test_Basic.v
            echo "âœ… åŸºç¡€æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸ åŸºç¡€æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨"
          fi

  report-generation:
    name: ğŸ“Š æŠ¥å‘Šç”Ÿæˆæ¨¡å¼
    needs: setup-environment
    if: github.event.inputs.verify_mode == 'report-only'
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“ˆ ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
        run: |
          echo "ğŸ“Š æŠ¥å‘Šç”Ÿæˆæ¨¡å¼..."
          echo "æŠ¥å‘Šç”ŸæˆåŠŸèƒ½å°±ç»ª"