name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 180
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      OPAM_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/opam-repository/"
      COQ_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/"
      OPAM_FALLBACK_MIRROR: "https://opam.ocaml.org/"
      COQ_FALLBACK_MIRROR: "https://coq.inria.fr/opam/released/"
      VENV_PATH: "${{ github.workspace }}/.venv"
      COQPROJECT_PATH: "${{ github.workspace }}/CoqProject"
    steps:
      - name: ä¿®å¤å…¨é‡ç›®å½•æƒé™
        run: |
          mkdir -p ${{ env.TEMP_DIR }} ~/.opam ~/.cache/opam ${{ github.workspace }} ${{ env.REPORT_DIR }}
          chmod -R 777 /__w/_temp/ ~/.opam ~/.cache/opam ${{ github.workspace }}
          chown -R root:root /__w/_temp/ ~/.opam ~/.cache/opam ${{ github.workspace }}
          echo "âœ… ç›®å½•æƒé™ä¿®å¤å®Œæˆ"
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: å­æ¨¡å—å®Œæ•´æ€§æ ¡éªŒ
        run: |
          if git submodule status | grep -q '^-'; then
            echo "âŒ å­æ¨¡å—æœªå®Œå…¨æ£€å‡º"
            exit 1
          fi
          echo "âœ… å­æ¨¡å—å®Œæ•´æ€§æ ¡éªŒé€šè¿‡"
      - name: åˆå§‹åŒ–opamç¯å¢ƒ
        run: |
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)
          echo "âœ… opamç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          echo "ğŸ“Œ opamç‰ˆæœ¬ï¼š$(opam --version)"
          echo "ğŸ“Œ coqcè·¯å¾„ï¼š$(which coqc)"
          if command -v coqc &> /dev/null; then
            echo "ğŸ“Œ Coqç‰ˆæœ¬ï¼š$(coqc --version | head -n1)"
          else
            echo "âŒ æœªæ‰¾åˆ°Coqå¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          fi
      - name: ç¼“å­˜ä¼˜åŒ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
            _build
            **/*.vo
            **/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-venv-
      - name: é…ç½®é•œåƒæº+å®‰è£…ä¾èµ–
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          opam repo list --all-switches
          if curl --head --silent --fail ${{ env.OPAM_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            opam repository set-url default ${{ env.OPAM_MAIN_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_MAIN_MIRROR }} --all-switches
            }
          else
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            }
          fi
          if curl --head --silent --fail ${{ env.COQ_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            if opam repo list | grep -q "coq-released"; then
              opam repo set-url coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            fi
          else
            if opam repo list | grep -q "coq-released"; then
              opam repo set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            fi
          fi
          update_success=0
          for i in {1..3}; do
            echo "=== ç¬¬ $i æ¬¡æ›´æ–°ä»“åº“ ==="
            if opam update -y; then
              update_success=1
              break
            fi
            sleep 2
          done
          if [ $update_success -eq 0 ]; then
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            opam repository set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            for i in {1..3}; do
              echo "=== ç¬¬ $i æ¬¡å…œåº•æ›´æ–° ==="
              if opam update -y; then
                update_success=1
                break
              fi
              sleep 2
            done
          fi
          if [ $update_success -eq 0 ]; then
            echo "âŒ ä»“åº“æ›´æ–°å¤±è´¥"
            exit 1
          fi
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-stdlib=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }}"
            "coq-equations=1.3+8.18"
            "${{ env.COQ_EXTRA_OPAM }}"
          )
          installed_pkgs=$(opam list --short)
          to_install=()
          for pkg in "${required_pkgs[@]}"; do
            pkg_name=$(echo "$pkg" | cut -d'=' -f1)
            if ! echo "$installed_pkgs" | grep -q "^$pkg_name$"; then
              to_install+=("$pkg")
            fi
          done
          if [ ${#to_install[@]} -gt 0 ]; then
            install_success=0
            for i in {1..3}; do
              echo "=== ç¬¬ $i æ¬¡å®‰è£…ä¾èµ– ==="
              if opam install -y --jobs 2 "${to_install[@]}"; then
                install_success=1
                break
              fi
              sleep 5
            done
            if [ $install_success -eq 0 ]; then
              echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
              exit 1
            fi
          fi
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv && rm -rf /var/lib/apt/lists/*
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir --timeout 60 reportlab==4.0.9
          echo "âœ… ä¾èµ–å®‰è£…+æ ¡éªŒå®Œæˆ"
      - name: æ ¡éªŒCoqProjectæ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          if [ ! -f "${{ env.COQPROJECT_PATH }}" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°CoqProjectæ–‡ä»¶ï¼Œåˆ›å»ºé»˜è®¤æ–‡ä»¶"
            cat > ${{ env.COQPROJECT_PATH }} <<EOF
-R theories FRF.Theories
-R lib FRF.Lib
-R extensions FRF.Extensions
-Q ~/.opam/default/lib/coq/user-contrib/mathcomp MathComp
EOF
            find theories/ lib/ extensions/ -name "*.v" | sort >> ${{ env.COQPROJECT_PATH }}
            echo "âœ… é»˜è®¤CoqProjectæ–‡ä»¶åˆ›å»ºå®Œæˆ"
          else
            echo "ğŸ“‹ æ ¡éªŒç°æœ‰CoqProjectæ–‡ä»¶"
            grep -v '^#' ${{ env.COQPROJECT_PATH }} | grep -v '^$' > CoqProject.clean
            mv CoqProject.clean ${{ env.COQPROJECT_PATH }}
            echo "âœ… CoqProjectæ–‡ä»¶æ¸…ç†å®Œæˆï¼ˆç§»é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰"
          fi
          echo "ğŸ“‹ CoqProjectæ–‡ä»¶å†…å®¹ï¼š"
          cat ${{ env.COQPROJECT_PATH }}
      - name: ç”Ÿæˆå…¨å±€éªŒè¯Makefileï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          echo "ğŸ“Œ å¼€å§‹ç”ŸæˆMakefileï¼ˆcoq_makefileæ ‡å‡†è°ƒç”¨ï¼‰"
          echo "ğŸ“Œ å‘½ä»¤ï¼šcoq_makefile -f ${{ env.COQPROJECT_PATH }} -o Makefile"
          coq_makefile -f ${{ env.COQPROJECT_PATH }} -o Makefile 2>&1 | tee ${{ env.REPORT_DIR }}/coq_makefile.log
          if [ $? -ne 0 ]; then
            echo "âŒ coq_makefileæ‰§è¡Œå¤±è´¥ï¼Œè¯¦ç»†æ—¥å¿—ï¼š"
            cat ${{ env.REPORT_DIR }}/coq_makefile.log
            exit 1
          fi
          if [ ! -f "Makefile" ]; then
            echo "âŒ Makefileæœªç”Ÿæˆ"
            exit 1
          fi
          if ! grep -q "${{ env.GLOBAL_TARGET }}" Makefile; then
            echo "âš ï¸ Makefileä¸­æ— ${{ env.GLOBAL_TARGET }}ç›®æ ‡ï¼Œæ·»åŠ é»˜è®¤ç›®æ ‡"
            echo -e "\nall: $(find theories/ lib/ extensions/ -name "*.vo" | tr '\n' ' ')" >> Makefile
          fi
          echo "âœ… Makefileç”Ÿæˆå®Œæˆ"
          echo "ğŸ“‹ Makefileå‰20è¡Œï¼š"
          head -n20 Makefile
      - name: æ‰§è¡Œå…¨å±€å½¢å¼åŒ–éªŒè¯
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          echo "=== å¼€å§‹éªŒè¯ï¼ˆ$(nproc)æ ¸å¹¶è¡Œï¼‰ ==="
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/global-compile.log
          failed_files=()
          while IFS= read -r v_file; do
            vo_file="${v_file%.v}.vo"
            if [ ! -f "$vo_file" ]; then
              failed_files+=("$vo_file")
            fi
          done < <(grep -E '^[^#].*\.v$' ${{ env.COQPROJECT_PATH }})
          if [ ${#failed_files[@]} -ne 0 ]; then
            echo "âŒ ä»¥ä¸‹æ–‡ä»¶æœªç”Ÿæˆ.voäº§ç‰©ï¼š"
            printf '%s\n' "${failed_files[@]}"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¼–è¯‘éªŒè¯å®Œæˆ"
      - name: å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒ
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          vo_files=$(find theories/ lib/ extensions/ -name "*.vo" -not -empty | tr '\n' ' ')
          if [ -z "$vo_files" ]; then
            echo "âŒ æœªæ‰¾åˆ°éªŒè¯äº§ç‰©"
            exit 1
          fi
          echo "=== æ‰§è¡Œé€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥ ==="
          coqchk -silent -norecursive $vo_files 2>&1 | tee ${{ env.REPORT_DIR }}/global-coqchk.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          echo "âœ… é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"
      - name: ç”Ÿæˆç»“æ„åŒ–éªŒè¯æŠ¥å‘Š
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md <<EOF
          # FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š
          ## éªŒè¯ç¯å¢ƒä¿¡æ¯
          - éªŒè¯æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - Coqç‰ˆæœ¬: $(coqc --version | head -n1)
          - MathCompç‰ˆæœ¬: ${{ env.MATHCOMP_VERSION }}
          - ç¼–è¯‘æ ¸å¿ƒæ•°: $(nproc)
          ## éªŒè¯ç»Ÿè®¡
          - æ€»æ–‡ä»¶æ•°: $(grep -E '^[^#].*\.v$' ${{ env.COQPROJECT_PATH }} | wc -l)
          - æˆåŠŸéªŒè¯: $(find theories/ lib/ extensions/ -name "*.vo" | wc -l)
          - é€»è¾‘ä¸€è‡´æ€§: âœ… æ ¡éªŒé€šè¿‡
          ## æ ¸å¿ƒæ¨¡å—çŠ¶æ€
          EOF
          core_modules=(
            "theories/FRF_MetaTheory.vo"
            "theories/Equivalence.vo"
            "lib/Algebra.vo"
            "extensions/Quantum/QFT_FRF.vo"
          )
          for mod in "${core_modules[@]}"; do
            if [ -f "$mod" ]; then
              echo "âœ… æ ¸å¿ƒæ¨¡å—: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "âŒ æ ¸å¿ƒæ¨¡å—ç¼ºå¤±: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done
          echo -e "\n## è¯¦ç»†æ—¥å¿—" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [coq_makefileæ—¥å¿—](coq_makefile.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [ç¼–è¯‘æ—¥å¿—](global-compile.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [é€»è¾‘æ£€æŸ¥æ—¥å¿—](global-coqchk.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
      - name: å½’æ¡£éªŒè¯äº§ç‰©ä¸æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            **/*.vo
            **/*.glob
            Makefile
            CoqProject
            ${{ env.VENV_PATH }}/lib/python*/site-packages/*.dist-info
          retention-days: 90
      - name: éªŒè¯å¤±è´¥ç´§æ€¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 éªŒè¯å¤±è´¥"
          echo "ğŸ“Œ å¤±è´¥ç¯èŠ‚ï¼š$(grep -E '===|âŒ' ${{ env.REPORT_DIR }}/*.log | tail -n20)"