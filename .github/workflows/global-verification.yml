name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-22.04  # ä½¿ç”¨æ›´ç¨³å®šçš„Ubuntu 22.04
    timeout-minutes: 60
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å®‰è£…Coqå’Œä¾èµ–
      run: |
        eval $(opam env)
        opam install -y \
          coq.8.18.0 \
          coq-mathcomp-ssreflect \
          coq-equations \
          coq-bignums
        echo "âœ… Coqå’Œä¾èµ–å®‰è£…å®Œæˆ"
        coqc --version

    - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        ls -la
        echo "Coqæ–‡ä»¶æ•°é‡: $(find . -name '*.v' | wc -l)"
        echo "å…³é”®æ–‡ä»¶æ£€æŸ¥:"
        for file in Makefile SelfContainedLib/Algebra.v theories/FRF_MetaTheory.v; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file - ç¼ºå¤±"
          fi
        done

    - name: ç¼–è¯‘æ ¸å¿ƒæ¨¡å—
      run: |
        echo "=== ç¼–è¯‘æ ¸å¿ƒæ¨¡å— ==="
        
        # è®¾ç½®Coqè·¯å¾„å‚æ•°
        COQFLAGS="-Q SelfContainedLib SelfContainedLib \
                  -Q theories FRF.Theories \
                  -Q CS_Null FRF.CS_Null \
                  -Q Quantum FRF.Quantum \
                  -Q DynamicSystem FRF.DynamicSystem \
                  -Q Toolchain FRF.Toolchain \
                  -Q Test FRF.Test \
                  -Q CategoryTheory CategoryTheory"
        
        # ç¼–è¯‘åŸºç¡€åº“
        echo "ç¼–è¯‘åŸºç¡€æ•°å­¦åº“..."
        for file in SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v; do
          if [ -f "$file" ]; then
            echo "ç¼–è¯‘: $file"
            coqc $COQFLAGS "$file" || echo "ç¼–è¯‘è·³è¿‡: $file"
          fi
        done
        
        # ç¼–è¯‘FRFå…ƒç†è®º
        echo "ç¼–è¯‘FRFå…ƒç†è®º..."
        if [ -f "theories/FRF_MetaTheory.v" ]; then
          coqc $COQFLAGS theories/FRF_MetaTheory.v || echo "FRF_MetaTheoryç¼–è¯‘è·³è¿‡"
        fi
        
        # ç¼–è¯‘Churchæ•°å€¼
        echo "ç¼–è¯‘Churchæ•°å€¼..."
        for file in theories/ChurchNumerals.v theories/ChurchZero.v; do
          if [ -f "$file" ]; then
            coqc $COQFLAGS "$file" || echo "ç¼–è¯‘è·³è¿‡: $file"
          fi
        done
        
        echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘å®Œæˆ"

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      run: |
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        compiled_files=$(find . -name "*.vo" | wc -l)
        echo "å·²ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"
        
        echo "æ ¸å¿ƒæ¨¡å—çŠ¶æ€:"
        critical_modules=(
          "SelfContainedLib/Algebra.vo"
          "SelfContainedLib/Category.vo" 
          "SelfContainedLib/Geometry.vo"
          "theories/FRF_MetaTheory.vo"
          "theories/ChurchZero.vo"
        )
        
        for module in "${critical_modules[@]}"; do
          if [ -f "$module" ]; then
            echo "âœ… $module"
          else
            echo "âŒ $module"
          fi
        done
        
        if [ $compiled_files -ge 3 ]; then
          echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘é€šè¿‡"
        else
          echo "âŒ æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ä¸è¶³"
          exit 1
        fi

    - name: å°è¯•å®Œæ•´ç¼–è¯‘
      if: success()
      run: |
        echo "=== å°è¯•å®Œæ•´ç¼–è¯‘ ==="
        
        # å¦‚æœMakefileå­˜åœ¨ä¸”å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å®ƒ
        if [ -f "Makefile" ]; then
          echo "ä½¿ç”¨Makefileç¼–è¯‘..."
          make -j2 compile 2>&1 | head -30 || echo "Makefileç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­å…¶ä»–æ–¹æ³•"
        fi
        
        # ç¼–è¯‘å…¶ä»–é‡è¦æ¨¡å—
        echo "ç¼–è¯‘å…¶ä»–é‡è¦æ¨¡å—..."
        important_modules=(
          "theories/CaseA_SetTheory.v"
          "theories/CaseB_Algebra.v"
          "CS_Null/FRF_CS_Null_Common.v"
          "Quantum/QFT_FRF.v"
        )
        
        COQFLAGS="-Q SelfContainedLib SelfContainedLib \
                  -Q theories FRF.Theories \
                  -Q CS_Null FRF.CS_Null \
                  -Q Quantum FRF.Quantum \
                  -Q DynamicSystem FRF.DynamicSystem \
                  -Q Toolchain FRF.Toolchain \
                  -Q Test FRF.Test \
                  -Q CategoryTheory CategoryTheory"
        
        for module in "${important_modules[@]}"; do
          if [ -f "$module" ]; then
            echo "ç¼–è¯‘: $module"
            coqc $COQFLAGS "$module" 2>&1 | tail -3 || echo "ç¼–è¯‘è·³è¿‡: $module"
          fi
        done

    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      run: |
        echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
        
        total_files=$(find . -name "*.v" | wc -l)
        compiled_files=$(find . -name "*.vo" | wc -l)
        
        mkdir -p verification-reports
        
        # ç”ŸæˆæŠ¥å‘Š
        echo "# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š" > verification-reports/REPORT.md
        echo "" >> verification-reports/REPORT.md
        echo "**éªŒè¯æ—¶é—´**: $(date)" >> verification-reports/REPORT.md
        echo "**ç¯å¢ƒ**: Ubuntu 22.04 + Coq 8.18.0" >> verification-reports/REPORT.md
        echo "**Coqç‰ˆæœ¬**: $(coqc --version | head -1)" >> verification-reports/REPORT.md
        echo "" >> verification-reports/REPORT.md
        echo "## ç¼–è¯‘ç»Ÿè®¡" >> verification-reports/REPORT.md
        echo "- æ€»Coqæ–‡ä»¶: $total_files" >> verification-reports/REPORT.md
        echo "- æˆåŠŸç¼–è¯‘: $compiled_files" >> verification-reports/REPORT.md
        
        if [ $total_files -gt 0 ]; then
          success_rate=$((compiled_files * 100 / total_files))
          echo "- æˆåŠŸç‡: $success_rate%" >> verification-reports/REPORT.md
        else
          echo "- æˆåŠŸç‡: 0%" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## æ ¸å¿ƒæ¨¡å—çŠ¶æ€" >> verification-reports/REPORT.md
        
        # æ¨¡å—çŠ¶æ€åˆ—è¡¨
        modules=(
          "SelfContainedLib/Algebra.vo:åŸºç¡€ä»£æ•°"
          "SelfContainedLib/Category.vo:åŸºç¡€èŒƒç•´" 
          "SelfContainedLib/Geometry.vo:åŸºç¡€å‡ ä½•"
          "theories/FRF_MetaTheory.vo:FRFå…ƒç†è®º"
          "theories/ChurchZero.vo:Churché›¶"
          "theories/CaseA_SetTheory.vo:é›†åˆè®ºåœºæ™¯"
          "theories/CaseB_Algebra.vo:ä»£æ•°åœºæ™¯"
          "CS_Null/FRF_CS_Null_Common.vo:ç©ºå€¼å…¬å…±æ¨¡å—"
          "Quantum/QFT_FRF.vo:é‡å­åœºè®º"
        )
        
        for module_info in "${modules[@]}"; do
          module=$(echo "$module_info" | cut -d: -f1)
          desc=$(echo "$module_info" | cut -d: -f2)
          if [ -f "$module" ]; then
            echo "- âœ… $desc" >> verification-reports/REPORT.md
          else
            echo "- âŒ $desc" >> verification-reports/REPORT.md
          fi
        done
        
        echo "" >> verification-reports/REPORT.md
        echo "## éªŒè¯ç»“æœ" >> verification-reports/REPORT.md
        if [ $compiled_files -ge 3 ]; then
          echo "âœ… **éªŒè¯æˆåŠŸ**: æ ¸å¿ƒæ¡†æ¶ç¼–è¯‘é€šè¿‡" >> verification-reports/REPORT.md
        else
          echo "âŒ **éªŒè¯å¤±è´¥**: æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ä¸è¶³" >> verification-reports/REPORT.md
        fi
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-verification-report
        path: verification-reports/
        retention-days: 7

    - name: éªŒè¯æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        compiled_count=$(find . -name "*.vo" | wc -l)
        echo "ğŸ‰ FRF 2.0 å½¢å¼åŒ–éªŒè¯æˆåŠŸå®Œæˆ!"
        echo "ğŸ“Š ç¼–è¯‘æ¨¡å—: $compiled_count"
        echo "ğŸ“‹ æŠ¥å‘Šä½ç½®: verification-reports/REPORT.md"

    - name: éªŒè¯å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ FRF 2.0 å½¢å¼åŒ–éªŒè¯å¤±è´¥"
        echo "è¯·æ£€æŸ¥æ ¸å¿ƒæ¨¡å—ç¼–è¯‘çŠ¶æ€"