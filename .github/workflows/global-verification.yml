name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å®‰è£…Coqå’Œä¾èµ–
      run: |
        eval $(opam env)
        opam install -y \
          coq.8.18.0 \
          coq-mathcomp-ssreflect \
          coq-equations \
          coq-bignums
        echo "âœ… Coqå’Œä¾èµ–å®‰è£…å®Œæˆ"
        coqc --version

    - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        ls -la
        echo "Coqæ–‡ä»¶æ•°é‡: $(find . -name '*.v' | wc -l)"
        echo "å…³é”®æ–‡ä»¶æ£€æŸ¥:"
        for file in Makefile SelfContainedLib/Algebra.v theories/FRF_MetaTheory.v; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file - ç¼ºå¤±"
          fi
        done

    - name: æµ‹è¯•Coqç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "=== æµ‹è¯•Coqç¼–è¯‘ç¯å¢ƒ ==="
        
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶
        cat > test_coq.v << 'EOF'
        Theorem test : True.
        Proof. exact I. Qed.
        EOF
        
        echo "ç¼–è¯‘æµ‹è¯•æ–‡ä»¶..."
        coqc test_coq.v
        
        if [ -f "test_coq.vo" ]; then
          echo "âœ… Coqç¼–è¯‘ç¯å¢ƒæ­£å¸¸"
          rm test_coq.vo test_coq.glob
        else
          echo "âŒ Coqç¼–è¯‘ç¯å¢ƒæœ‰é—®é¢˜"
          exit 1
        fi
        rm test_coq.v

    - name: ç¼–è¯‘å•ä¸ªæ ¸å¿ƒæ¨¡å—æµ‹è¯•
      run: |
        echo "=== ç¼–è¯‘å•ä¸ªæ ¸å¿ƒæ¨¡å—æµ‹è¯• ==="
        
        # å°è¯•ç¼–è¯‘Algebra.v
        if [ -f "SelfContainedLib/Algebra.v" ]; then
          echo "ç¼–è¯‘ Algebra.v..."
          coqc SelfContainedLib/Algebra.v
          
          if [ -f "SelfContainedLib/Algebra.vo" ]; then
            echo "âœ… Algebra.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ Algebra.v ç¼–è¯‘å¤±è´¥"
            echo "æ£€æŸ¥ç¼–è¯‘é”™è¯¯:"
            coqc SelfContainedLib/Algebra.v 2>&1 || true
          fi
        else
          echo "âŒ Algebra.v æ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: ä½¿ç”¨ç®€å•è·¯å¾„æ˜ å°„ç¼–è¯‘
      run: |
        echo "=== ä½¿ç”¨ç®€å•è·¯å¾„æ˜ å°„ç¼–è¯‘ ==="
        
        # ä½¿ç”¨æœ€ç®€å•çš„è·¯å¾„æ˜ å°„
        echo "ç¼–è¯‘åŸºç¡€æ¨¡å—..."
        
        # ç¼–è¯‘SelfContainedLibæ¨¡å—
        for file in SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v; do
          if [ -f "$file" ]; then
            echo "ç¼–è¯‘: $file"
            coqc -Q SelfContainedLib SelfContainedLib "$file" 2>&1 | head -20 || echo "ç¼–è¯‘è·³è¿‡: $file"
          fi
        done
        
        # ç¼–è¯‘theoriesæ¨¡å—
        if [ -f "theories/FRF_MetaTheory.v" ]; then
          echo "ç¼–è¯‘: theories/FRF_MetaTheory.v"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/FRF_MetaTheory.v 2>&1 | head -20 || echo "ç¼–è¯‘è·³è¿‡"
        fi
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        compiled_files=$(find . -name "*.vo" | wc -l)
        echo "å·²ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"
        
        if [ $compiled_files -eq 0 ]; then
          echo "âŒ ä»ç„¶æ²¡æœ‰ç¼–è¯‘äº§ç‰©ï¼Œæ£€æŸ¥è¯¦ç»†é”™è¯¯:"
          for file in SelfContainedLib/Algebra.v; do
            if [ -f "$file" ]; then
              echo "è¯¦ç»†ç¼–è¯‘ $file:"
              coqc -Q SelfContainedLib SelfContainedLib "$file"
            fi
          done
        fi

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      if: always()
      run: |
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        compiled_files=$(find . -name "*.vo" | wc -l)
        echo "å·²ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"
        
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
        echo "SelfContainedLibç›®å½•å†…å®¹:"
        ls -la SelfContainedLib/ || echo "SelfContainedLibç›®å½•ä¸å­˜åœ¨"
        
        echo "theoriesç›®å½•å†…å®¹:"
        ls -la theories/ || echo "theoriesç›®å½•ä¸å­˜åœ¨"
        
        if [ $compiled_files -gt 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ‰¾åˆ° $compiled_files ä¸ª.voæ–‡ä»¶"
          find . -name "*.vo"
        else
          echo "âŒ æ²¡æœ‰ç¼–è¯‘äº§ç‰©"
          # ä¸é€€å‡ºï¼Œç»§ç»­ç”ŸæˆæŠ¥å‘Š
        fi

    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      run: |
        echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
        
        total_files=$(find . -name "*.v" | wc -l)
        compiled_files=$(find . -name "*.vo" | wc -l)
        
        mkdir -p verification-reports
        
        # ç”ŸæˆæŠ¥å‘Š
        echo "# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š" > verification-reports/REPORT.md
        echo "" >> verification-reports/REPORT.md
        echo "**éªŒè¯æ—¶é—´**: $(date)" >> verification-reports/REPORT.md
        echo "**ç¯å¢ƒ**: Ubuntu 22.04 + Coq 8.18.0" >> verification-reports/REPORT.md
        echo "**Coqç‰ˆæœ¬**: $(coqc --version | head -1)" >> verification-reports/REPORT.md
        echo "" >> verification-reports/REPORT.md
        echo "## ç¼–è¯‘ç»Ÿè®¡" >> verification-reports/REPORT.md
        echo "- æ€»Coqæ–‡ä»¶: $total_files" >> verification-reports/REPORT.md
        echo "- æˆåŠŸç¼–è¯‘: $compiled_files" >> verification-reports/REPORT.md
        
        if [ $total_files -gt 0 ]; then
          success_rate=$((compiled_files * 100 / total_files))
          echo "- æˆåŠŸç‡: $success_rate%" >> verification-reports/REPORT.md
        else
          echo "- æˆåŠŸç‡: 0%" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## è¯¦ç»†è¯Šæ–­" >> verification-reports/REPORT.md
        echo "### é¡¹ç›®ç»“æ„" >> verification-reports/REPORT.md
        echo "- å½“å‰ç›®å½•: $(pwd)" >> verification-reports/REPORT.md
        echo "- ç›®å½•å†…å®¹:" >> verification-reports/REPORT.md
        ls -la >> verification-reports/REPORT.md
        
        echo "### Coqæ–‡ä»¶åˆ—è¡¨" >> verification-reports/REPORT.md
        find . -name "*.v" >> verification-reports/REPORT.md
        
        echo "### ç¼–è¯‘äº§ç‰©" >> verification-reports/REPORT.md
        if [ $compiled_files -gt 0 ]; then
          find . -name "*.vo" >> verification-reports/REPORT.md
        else
          echo "æ— ç¼–è¯‘äº§ç‰©" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## éªŒè¯ç»“æœ" >> verification-reports/REPORT.md
        if [ $compiled_files -ge 1 ]; then
          echo "âœ… **éªŒè¯æˆåŠŸ**: è‡³å°‘ç¼–è¯‘äº† $compiled_files ä¸ªæ–‡ä»¶" >> verification-reports/REPORT.md
        else
          echo "âŒ **éªŒè¯å¤±è´¥**: æ— ç¼–è¯‘äº§ç‰©" >> verification-reports/REPORT.md
        fi
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-verification-report
        path: verification-reports/
        retention-days: 7

    - name: éªŒè¯æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        compiled_count=$(find . -name "*.vo" | wc -l)
        echo "ğŸ‰ FRF 2.0 å½¢å¼åŒ–éªŒè¯å®Œæˆ!"
        echo "ğŸ“Š ç¼–è¯‘æ¨¡å—: $compiled_count"
        echo "ğŸ“‹ æŠ¥å‘Šä½ç½®: verification-reports/REPORT.md"

    - name: éªŒè¯å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ FRF 2.0 å½¢å¼åŒ–éªŒè¯å¤±è´¥"
        echo "è¯·æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒè®¾ç½®"