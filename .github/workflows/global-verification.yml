name: FRF 2.0 æ™ºèƒ½å…¨é‡å½¢å¼åŒ–éªŒè¯

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
      - '.github/workflows/global-verification.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
  workflow_dispatch:
    inputs:
      verify_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - test-only
          - report-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: false
        default: '4'
        type: string

jobs:
  setup-environment:
    name: ğŸ”§ ç¯å¢ƒé…ç½®ä¸æ£€æŸ¥
    runs-on: ubuntu-22.04
    outputs:
      coq_version: ${{ steps.check-coq.outputs.version }}
      memory_available: ${{ steps.check-memory.outputs.available_mb }}
      core_count: ${{ steps.check-cpu.outputs.core_count }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
        id: check-cpu
        run: |
          echo "æ ¸å¿ƒæ•°: $(nproc)"
          echo "core_count=$(nproc)" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ å†…å­˜æ£€æŸ¥
        id: check-memory
        run: |
          AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
          echo "å¯ç”¨å†…å­˜: ${AVAIL_MEM}MB"
          echo "available_mb=${AVAIL_MEM}" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            opam \
            bubblewrap \
            g++ \
            pkg-config \
            m4 \
            rsync \
            git \
            wget \
            bc \
            graphviz \
            python3 \
            python3-pip

          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ”„ é…ç½®OPAMç¯å¢ƒ
        run: |
          opam init --disable-sandboxing -y --compiler=4.14.0
          eval $(opam env)
          opam repo add coq-released https://coq.inria.fr/opam/released
          opam repo add mathlib https://github.com/leanprover-community/mathlib.git
          opam update -y
          echo "OPAM_HOME=$OPAM_HOME" >> $GITHUB_ENV
          echo "OPAM_SWITCH_PREFIX=$OPAM_SWITCH_PREFIX" >> $GITHUB_ENV

      - name: ğŸ“Š é…ç½®éªŒè¯ç¯å¢ƒ
        run: |
          # æ ¹æ®å†…å­˜è®¾ç½®ç¼–è¯‘å‚æ•°
          if [ ${{ steps.check-memory.outputs.available_mb }} -gt 16000 ]; then
            echo "COQ_MEMORY=16384" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=16384" >> $GITHUB_ENV
          elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 8000 ]; then
            echo "COQ_MEMORY=8192" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=8192" >> $GITHUB_ENV
          elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 4000 ]; then
            echo "COQ_MEMORY=4096" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=4096" >> $GITHUB_ENV
          else
            echo "COQ_MEMORY=2048" >> $GITHUB_ENV
            echo "BIGFILE_MEMORY=2048" >> $GITHUB_ENV
          fi

          echo "PARALLEL_JOBS=$(( ${{ steps.check-cpu.outputs.core_count }} / 2 ))" >> $GITHUB_ENV

      - name: ğŸ” æ£€æŸ¥Coqç‰ˆæœ¬
        id: check-coq
        run: |
          eval $(opam env)
          if command -v coqc &> /dev/null; then
            COQ_VERSION=$(coqc --version | head -1 | grep -o 'version [0-9.]\+' | cut -d' ' -f2)
            echo "å½“å‰Coqç‰ˆæœ¬: $COQ_VERSION"
            echo "version=$COQ_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ Coqæœªå®‰è£…"
            exit 1
          fi

      - name: ğŸ“‹ ç¯å¢ƒæŠ¥å‘Š
        run: |
          echo "=== ç¯å¢ƒé…ç½®æŠ¥å‘Š ==="
          echo "ç³»ç»Ÿ: Ubuntu 22.04"
          echo "CPUæ ¸å¿ƒ: ${{ steps.check-cpu.outputs.core_count }}"
          echo "å¯ç”¨å†…å­˜: ${{ steps.check-memory.outputs.available_mb }}MB"
          echo "åˆ†é…å†…å­˜: ${{ env.COQ_MEMORY }}MB"
          echo "å¹¶è¡Œä»»åŠ¡: ${{ env.PARALLEL_JOBS }}"
          echo "Coqç‰ˆæœ¬: ${{ steps.check-coq.outputs.version }}"

  install-dependencies:
    name: ğŸ“¦ ä¾èµ–å®‰è£…ä¸ç¼“å­˜
    needs: setup-environment
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        coq-version: ['8.18.0']
        mathcomp-version: ['1.17.0']
    steps:
      - name: ğŸ“¥ æ¢å¤OPAMç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
          key: ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-${{ hashFiles('*.opam') }}
          restore-keys: |
            ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-
            ${{ runner.os }}-opam-

      - name: ğŸ”„ è®¾ç½®OPAMç¯å¢ƒ
        run: |
          eval $(opam env)
          opam update

      - name: ğŸ“Š å®‰è£…Coqæ ¸å¿ƒ
        run: |
          eval $(opam env)
          echo "å®‰è£…Coq ${{ matrix.coq-version }}..."
          opam install -y coq.${{ matrix.coq-version }}

          echo "éªŒè¯Coqå®‰è£…..."
          coqc --version
          if [ $? -ne 0 ]; then
            echo "âŒ Coqå®‰è£…å¤±è´¥"
            exit 1
          fi

      - name: ğŸ§® å®‰è£…mathcomp
        run: |
          eval $(opam env)
          echo "å®‰è£…coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}..."
          opam install -y coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}

          echo "éªŒè¯mathcompå®‰è£…..."
          opam list --installed | grep "coq-mathcomp-ssreflect" || (echo "âŒ mathcompå®‰è£…å¤±è´¥" && exit 1)

      - name: ğŸ“š å®‰è£…å¤–éƒ¨åº“
        run: |
          eval $(opam env)
          echo "å®‰è£…å¤–éƒ¨ä¾èµ–åº“..."

          # å®æ•°åº“
          opam install -y coq-mathcomp-analysis

          # æ ‡å‡†åº“
          opam install -y coq-stdlib

          # å¯é€‰ï¼šæ•°å­¦åº“
          opam install -y coq-mathlib || echo "è­¦å‘Š: mathlibå®‰è£…å¤±è´¥ï¼Œéƒ¨åˆ†æ¨¡å—å¯èƒ½æ— æ³•ç¼–è¯‘"

          # å¯é€‰ï¼šçŸ©é˜µå’Œå‘é‡åº“
          opam install -y coq-mathcomp-algebra || echo "è­¦å‘Š: çŸ©é˜µåº“å®‰è£…å¤±è´¥"

          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ“ ä¾èµ–éªŒè¯æŠ¥å‘Š
        run: |
          eval $(opam env)
          echo "=== ä¾èµ–éªŒè¯æŠ¥å‘Š ==="
          echo "Coqç‰ˆæœ¬:"
          coqc --version
          echo ""
          echo "å®‰è£…çš„åŒ…:"
          opam list --installed | grep -E "coq|mathcomp"
          echo ""
          echo "ä¾èµ–æ ‘:"
          opam list --tree --installed | head -50

  compile-phase-1:
    name: ğŸ—ï¸ é˜¶æ®µ1: åŸºç¡€åº“ç¼–è¯‘
    needs: [setup-environment, install-dependencies]
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -m ${{ env.COQ_MEMORY }}"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

      - name: ğŸ“Š ç¼–è¯‘å‰æ£€æŸ¥
        run: |
          echo "=== åŸºç¡€åº“ç¼–è¯‘å‰æ£€æŸ¥ ==="
          echo "åŸºç¡€åº“æ–‡ä»¶:"
          ls -la SelfContainedLib/*.v
          echo ""
          echo "ç¼–è¯‘å‚æ•°: $COQFLAGS"
          echo "å†…å­˜é™åˆ¶: ${{ env.COQ_MEMORY }}MB"
          echo "å¹¶è¡Œç¼–è¯‘: å¯ç”¨"

      - name: ğŸ”§ å¹¶è¡Œç¼–è¯‘åŸºç¡€åº“
        run: |
          eval $(opam env)

          # å®šä¹‰ç¼–è¯‘å‡½æ•°
          compile_file() {
            local file=$1
            local base=$(basename $file .v)
            echo "ğŸš€ ç¼–è¯‘ $base.v..."

            # å¤§æ–‡ä»¶ç‰¹æ®Šå¤„ç†
            local line_count=$(wc -l < "$file" 2>/dev/null || echo 0)
            local extra_flags=""

            if [ "$base" = "Geometry" ]; then
              extra_flags="-m ${{ env.BIGFILE_MEMORY }} -async-proofs on -async-proofs-tac-j 4"
              echo "  å¤§æ–‡ä»¶æ£€æµ‹: $line_count è¡Œï¼Œä½¿ç”¨å¢å¼ºå‚æ•°"
            fi

            if coqc $COQFLAGS $extra_flags "$file" 2>&1; then
              echo "âœ… $base.v ç¼–è¯‘æˆåŠŸ"
              return 0
            else
              echo "âŒ $base.v ç¼–è¯‘å¤±è´¥"
              # è¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
              coqc $COQFLAGS $extra_flags "$file" 2>&1 | head -30
              return 1
            fi
          }

          export -f compile_file
          export COQFLAGS

          # å¹¶è¡Œç¼–è¯‘ä¸‰ä¸ªåŸºç¡€æ–‡ä»¶
          echo "å¼€å§‹å¹¶è¡Œç¼–è¯‘åŸºç¡€åº“..."

          # ç¼–è¯‘Algebra.v
          compile_file "SelfContainedLib/Algebra.v" &
          ALGEBRA_PID=$!

          # ç¼–è¯‘Category.v
          compile_file "SelfContainedLib/Category.v" &
          CATEGORY_PID=$!

          # ç¼–è¯‘Geometry.vï¼ˆå¤§æ–‡ä»¶ï¼Œæœ€åç¼–è¯‘ï¼‰
          sleep 2  # è®©å…¶ä»–æ–‡ä»¶å…ˆå¼€å§‹
          compile_file "SelfContainedLib/Geometry.v" &
          GEOMETRY_PID=$!

          # ç­‰å¾…æ‰€æœ‰ç¼–è¯‘å®Œæˆ
          wait $ALGEBRA_PID || ALGEBRA_FAILED=1
          wait $CATEGORY_PID || CATEGORY_FAILED=1
          wait $GEOMETRY_PID || GEOMETRY_FAILED=1

          # æ£€æŸ¥ç»“æœ
          if [ -n "$ALGEBRA_FAILED" ] || [ -n "$CATEGORY_FAILED" ] || [ -n "$GEOMETRY_FAILED" ]; then
            echo "âŒ åŸºç¡€åº“ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

          echo "âœ… åŸºç¡€åº“ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“ˆ ç¼–è¯‘ç»“æœç»Ÿè®¡
        run: |
          echo "=== åŸºç¡€åº“ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "ç¼–è¯‘æ–‡ä»¶:"
          for file in Algebra Category Geometry; do
            if [ -f "SelfContainedLib/$file.vo" ]; then
              echo "  âœ… $file.vo (å­˜åœ¨)"
            else
              echo "  âŒ $file.vo (ç¼ºå¤±)"
            fi
          done
          echo ""
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -la SelfContainedLib/*.vo SelfContainedLib/*.glob 2>/dev/null || echo "æ— ç”Ÿæˆæ–‡ä»¶"

  compile-phase-2:
    name: ğŸ§  é˜¶æ®µ2: å…ƒç†è®ºå±‚ç¼–è¯‘
    needs: compile-phase-1
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -m ${{ env.COQ_MEMORY }}"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

          # å¤åˆ¶åŸºç¡€åº“çš„.voæ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true

      - name: ğŸ“Š æ£€æŸ¥å…ƒç†è®ºæ–‡ä»¶
        run: |
          echo "=== å…ƒç†è®ºå±‚æ–‡ä»¶æ£€æŸ¥ ==="
          echo "å…ƒç†è®ºæ–‡ä»¶:"
          ls -la theories/*.v
          echo ""
          echo "æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          for file in theories/*.v; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file" 2>/dev/null || echo 0)
              echo "  $(basename $file): $lines è¡Œ"
            fi
          done

      - name: ğŸ”§ æ™ºèƒ½ç¼–è¯‘å…ƒç†è®º
        run: |
          eval $(opam env)

          # ç¼–è¯‘é¡ºåºï¼šå…ˆå°æ–‡ä»¶ï¼Œåå¤§æ–‡ä»¶
          echo "å¼€å§‹ç¼–è¯‘å…ƒç†è®ºå±‚..."

          # 1. ç¼–è¯‘ChurchZero.vï¼ˆä¸­ç­‰å¤§å°ï¼‰
          echo "ğŸ“˜ ç¼–è¯‘ ChurchZero.v..."
          if coqc $COQFLAGS theories/ChurchZero.v 2>&1; then
            echo "âœ… ChurchZero.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ChurchZero.v ç¼–è¯‘å¤±è´¥"
            coqc $COQFLAGS theories/ChurchZero.v 2>&1 | head -20
            exit 1
          fi

          # 2. ç¼–è¯‘FRF_MetaTheory.vï¼ˆå¤§æ–‡ä»¶ï¼‰
          echo "ğŸ“— ç¼–è¯‘ FRF_MetaTheory.v (å¤§æ–‡ä»¶)..."
          if coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} -async-proofs on theories/FRF_MetaTheory.v 2>&1; then
            echo "âœ… FRF_MetaTheory.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ FRF_MetaTheory.v ç¼–è¯‘å¤±è´¥"
            coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} theories/FRF_MetaTheory.v 2>&1 | head -30
            exit 1
          fi

          # 3. ç¼–è¯‘ChurchNumerals.vï¼ˆæå¤§æ–‡ä»¶ï¼‰
          echo "ğŸ“™ ç¼–è¯‘ ChurchNumerals.v (æå¤§æ–‡ä»¶)..."
          if coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} -async-proofs on -async-proofs-tac-j 8 theories/ChurchNumerals.v 2>&1; then
            echo "âœ… ChurchNumerals.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ ChurchNumerals.v ç¼–è¯‘å¤±è´¥"
            coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} theories/ChurchNumerals.v 2>&1 | head -40
            exit 1
          fi

      - name: ğŸ“ˆ å…ƒç†è®ºç¼–è¯‘ç»Ÿè®¡
        run: |
          echo "=== å…ƒç†è®ºå±‚ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "ç¼–è¯‘æ–‡ä»¶æ•°: 3/3"
          echo "æˆåŠŸæ–‡ä»¶:"
          for file in FRF_MetaTheory ChurchZero ChurchNumerals; do
            if [ -f "theories/$file.vo" ]; then
              lines=$(wc -l < "theories/$file.v" 2>/dev/null || echo 0)
              echo "  âœ… $file.vo ($lines è¡Œ)"
            fi
          done
          echo ""
          echo "æ€»ä»£ç è¡Œæ•°:"
          wc -l theories/*.v | tail -1

  compile-phase-3:
    name: ğŸ¯ é˜¶æ®µ3: æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘
    needs: compile-phase-2
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -m ${{ env.COQ_MEMORY }}"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

          # å¤åˆ¶ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true

      - name: ğŸ”§ å¹¶è¡Œç¼–è¯‘æ•°å­¦åœºæ™¯
        run: |
          eval $(opam env)

          # ç¼–è¯‘å‡½æ•°
          compile_scene() {
            local file=$1
            local base=$(basename $file .v)

            echo "ğŸ¨ ç¼–è¯‘ $base.v..."

            case $base in
              CaseA_SetTheory|CaseC_TypeTheory)
                # å°æ–‡ä»¶ï¼Œæ™®é€šç¼–è¯‘
                coqc $COQFLAGS "$file" 2>&1
                ;;
              CaseB_Algebra)
                # ä¸­ç­‰æ–‡ä»¶ï¼Œå®æ•°ä¾èµ–
                coqc $COQFLAGS -async-proofs on "$file" 2>&1
                ;;
              CaseE_QuantumVacuum)
                # å¤§æ–‡ä»¶ï¼Œç‰¹æ®Šå¤„ç†
                coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} -async-proofs on -async-proofs-tac-j 4 "$file" 2>&1
                ;;
              *)
                # é»˜è®¤ç¼–è¯‘
                coqc $COQFLAGS "$file" 2>&1
                ;;
            esac

            if [ $? -eq 0 ]; then
              echo "âœ… $base.v ç¼–è¯‘æˆåŠŸ"
              return 0
            else
              echo "âŒ $base.v ç¼–è¯‘å¤±è´¥"
              return 1
            fi
          }

          export -f compile_scene
          export COQFLAGS

          # å¹¶è¡Œç¼–è¯‘å‰ä¸‰ä¸ªåœºæ™¯
          echo "å¼€å§‹å¹¶è¡Œç¼–è¯‘æ•°å­¦åœºæ™¯..."

          compile_scene "theories/CaseA_SetTheory.v" &
          PID_A=$!

          compile_scene "theories/CaseB_Algebra.v" &
          PID_B=$!

          compile_scene "theories/CaseC_TypeTheory.v" &
          PID_C=$!

          # ç­‰å¾…ç¬¬ä¸€é˜¶æ®µå®Œæˆ
          wait $PID_A || FAIL_A=1
          wait $PID_B || FAIL_B=1
          wait $PID_C || FAIL_C=1

          # ç¼–è¯‘é‡å­åœºæ™¯
          echo "ğŸ”¬ ç¼–è¯‘é‡å­åœºæ™¯ CaseE_QuantumVacuum.v..."
          compile_scene "theories/CaseE_QuantumVacuum.v" || FAIL_E=1

          # ç¼–è¯‘èŒƒç•´è®ºåœºæ™¯ï¼ˆä¾èµ–é‡å­åœºæ™¯ï¼‰
          if [ -z "$FAIL_E" ]; then
            echo "ğŸ“ ç¼–è¯‘èŒƒç•´è®ºåœºæ™¯ CaseD_CategoryTheory.v..."
            compile_scene "theories/CaseD_CategoryTheory.v" || FAIL_D=1
          else
            echo "âš ï¸  è·³è¿‡CaseD_CategoryTheory.vï¼ˆä¾èµ–é¡¹å¤±è´¥ï¼‰"
            FAIL_D=1
          fi

          # æ£€æŸ¥ç»“æœ
          if [ -n "$FAIL_A" ] || [ -n "$FAIL_B" ] || [ -n "$FAIL_C" ] || [ -n "$FAIL_D" ] || [ -n "$FAIL_E" ]; then
            echo "âŒ æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘æœ‰å¤±è´¥"
            exit 1
          fi

          echo "âœ… æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“ˆ åœºæ™¯å±‚ç»Ÿè®¡
        run: |
          echo "=== æ•°å­¦åœºæ™¯å±‚ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "åœºæ™¯æ¨¡å—:"
          for scene in A B C D E; do
            file="theories/Case${scene}_"
            file=$(ls theories/Case${scene}_*.v 2>/dev/null | head -1)
            if [ -n "$file" ]; then
              base=$(basename $file .v)
              if [ -f "theories/${base}.vo" ]; then
                lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                echo "  âœ… Case${scene}: $lines è¡Œ"
              else
                echo "  âŒ Case${scene}: ç¼–è¯‘å¤±è´¥"
              fi
            fi
          done

  compile-phase-4:
    name: ğŸ”® é˜¶æ®µ4: æ‰©å±•æ¨¡å—ç¼–è¯‘
    needs: [compile-phase-3, compile-phase-1]
    runs-on: ubuntu-22.04
    timeout-minutes: 50
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -Q Quantum Quantum -Q CS_Null CS_Null -m ${{ env.COQ_MEMORY }}"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

          # å¤åˆ¶ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-3/theories/*.vo theories/ 2>/dev/null || true

      - name: ğŸ“ æ£€æŸ¥æ‰©å±•æ¨¡å—
        run: |
          echo "=== æ‰©å±•æ¨¡å—ç»“æ„æ£€æŸ¥ ==="
          echo "é‡å­æ¨¡å—:"
          ls -la Quantum/*.v 2>/dev/null || echo "æ— é‡å­æ¨¡å—"
          echo ""
          echo "ç©ºå€¼ç³»ç»Ÿ:"
          ls -la CS_Null/*.v 2>/dev/null || echo "æ— ç©ºå€¼ç³»ç»Ÿ"
          echo ""
          echo "æ€»æ–‡ä»¶æ•°:"
          find Quantum CS_Null -name "*.v" 2>/dev/null | wc -l

      - name: ğŸ”§ ç¼–è¯‘é‡å­æ¨¡å—
        run: |
          eval $(opam env)
          echo "ğŸ”¬ ç¼–è¯‘é‡å­æ¨¡å—..."

          # æ£€æŸ¥æ˜¯å¦ä¾èµ–Geometryï¼ˆæ›²ç‡è®¡ç®—ï¼‰
          if grep -q "Geometry" Quantum/*.v 2>/dev/null; then
            echo "æ£€æµ‹åˆ°å‡ ä½•ä¾èµ–ï¼Œéœ€è¦Geometry.vo"
            if [ ! -f "SelfContainedLib/Geometry.vo" ]; then
              echo "âŒ ç¼ºå°‘Geometry.voï¼Œé‡å­æ¨¡å—æ— æ³•ç¼–è¯‘"
              exit 1
            fi
          fi

          # ç¼–è¯‘QFT_FRF.v
          echo "1. ç¼–è¯‘ QFT_FRF.v..."
          if coqc $COQFLAGS Quantum/QFT_FRF.v 2>&1; then
            echo "âœ… QFT_FRF.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ QFT_FRF.v ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

          # ç¼–è¯‘CurvedSpacetimeQFT.v
          echo "2. ç¼–è¯‘ CurvedSpacetimeQFT.v..."
          if coqc $COQFLAGS -async-proofs on Quantum/CurvedSpacetimeQFT.v 2>&1; then
            echo "âœ… CurvedSpacetimeQFT.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ CurvedSpacetimeQFT.v ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ğŸ”§ ç¼–è¯‘ç©ºå€¼ç³»ç»ŸåŸºç¡€
        run: |
          eval $(opam env)
          echo "ğŸ“Š ç¼–è¯‘ç©ºå€¼ç³»ç»ŸåŸºç¡€æ¨¡å—..."

          # FRF_CS_Null_Common.væ˜¯æå¤§æ–‡ä»¶ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
          echo "1. ç¼–è¯‘ FRF_CS_Null_Common.v (æå¤§æ–‡ä»¶)..."
          if coqc $COQFLAGS -m ${{ env.BIGFILE_MEMORY }} -async-proofs on -async-proofs-tac-j 8 CS_Null/FRF_CS_Null_Common.v 2>&1; then
            echo "âœ… FRF_CS_Null_Common.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ FRF_CS_Null_Common.v ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

          # FRF_CS_Null.v
          echo "2. ç¼–è¯‘ FRF_CS_Null.v..."
          if coqc $COQFLAGS CS_Null/FRF_CS_Null.v 2>&1; then
            echo "âœ… FRF_CS_Null.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ FRF_CS_Null.v ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ğŸ”§ å¹¶è¡Œç¼–è¯‘è¯­è¨€ç©ºå€¼æ¨¡å—
        run: |
          eval $(opam env)
          echo "ğŸŒ å¹¶è¡Œç¼–è¯‘è¯­è¨€ç©ºå€¼æ¨¡å—..."

          # ç¼–è¯‘å‡½æ•°
          compile_lang_null() {
            local lang=$1
            local file="CS_Null/${lang}Null.v"

            if [ ! -f "$file" ]; then
              echo "âš ï¸  $file ä¸å­˜åœ¨"
              return 0
            fi

            echo "  ç¼–è¯‘ ${lang}Null.v..."

            # æ ¹æ®ä¸åŒè¯­è¨€è®¾ç½®ç¼–è¯‘å‚æ•°
            case $lang in
              Java|Math)
                # å®æ•°ä¾èµ–
                coqc $COQFLAGS -async-proofs on "$file" 2>&1
                ;;
              Cxx)
                # ä¸­ç­‰å¤§å°
                coqc $COQFLAGS "$file" 2>&1
                ;;
              *)
                # é»˜è®¤
                coqc $COQFLAGS "$file" 2>&1
                ;;
            esac

            if [ $? -eq 0 ]; then
              echo "    âœ… ${lang}Null.v ç¼–è¯‘æˆåŠŸ"
              return 0
            else
              echo "    âŒ ${lang}Null.v ç¼–è¯‘å¤±è´¥"
              return 1
            fi
          }

          export -f compile_lang_null
          export COQFLAGS

          # å¹¶è¡Œç¼–è¯‘æ‰€æœ‰è¯­è¨€æ¨¡å—
          for lang in Cxx Python Java Math Rust; do
            compile_lang_null "$lang" &
          done

          # ç­‰å¾…æ‰€æœ‰ç¼–è¯‘å®Œæˆ
          wait

          echo "âœ… è¯­è¨€ç©ºå€¼æ¨¡å—ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“ˆ æ‰©å±•æ¨¡å—ç»Ÿè®¡
        run: |
          echo "=== æ‰©å±•æ¨¡å—ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "é‡å­æ¨¡å—:"
          for file in Quantum/*.vo 2>/dev/null; do
            base=$(basename $file .vo)
            echo "  âœ… $base"
          done || echo "  æ— é‡å­æ¨¡å—"

          echo ""
          echo "ç©ºå€¼ç³»ç»Ÿ:"
          count=0
          for file in CS_Null/*.vo 2>/dev/null; do
            base=$(basename $file .vo)
            echo "  âœ… $base"
            ((count++))
          done
          echo "  æ€»è®¡: $count ä¸ªæ¨¡å—"

  compile-phase-5:
    name: ğŸ§© é˜¶æ®µ5: é›†æˆæ¨¡å—ç¼–è¯‘
    needs: [compile-phase-4, compile-phase-2, compile-phase-3]
    runs-on: ubuntu-22.04
    timeout-minutes: 35
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -Q Quantum Quantum -Q CS_Null CS_Null -m ${{ env.BIGFILE_MEMORY }}"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

          # å¤åˆ¶æ‰€æœ‰ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-3/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-4/Quantum/*.vo Quantum/ 2>/dev/null || true
          cp -r ../compile-phase-4/CS_Null/*.vo CS_Null/ 2>/dev/null || true

      - name: ğŸ”§ ç¼–è¯‘é›†æˆæ¨¡å—
        run: |
          eval $(opam env)
          echo "ğŸ§© ç¼–è¯‘é›†æˆæ¨¡å— FRF_Comparative.v..."

          # æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´
          echo "æ£€æŸ¥ä¾èµ–..."
          required_files=(
            "theories/FRF_MetaTheory.vo"
            "CS_Null/FRF_CS_Null_Common.vo"
            "SelfContainedLib/Algebra.vo"
            "SelfContainedLib/Category.vo"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘ä¾èµ–: $file"
              exit 1
            fi
          done

          echo "âœ… æ‰€æœ‰ä¾èµ–å°±ç»ª"

          # ç¼–è¯‘é›†æˆæ¨¡å—ï¼ˆæå¤§æ–‡ä»¶ï¼‰
          echo "å¼€å§‹ç¼–è¯‘ FRF_Comparative.v..."

          if coqc $COQFLAGS -async-proofs on -async-proofs-tac-j 6 theories/FRF_Comparative.v 2>&1; then
            echo "âœ… FRF_Comparative.v ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ FRF_Comparative.v ç¼–è¯‘å¤±è´¥"
            coqc $COQFLAGS theories/FRF_Comparative.v 2>&1 | head -40
            exit 1
          fi

      - name: ğŸ“Š é›†æˆæ¨¡å—éªŒè¯
        run: |
          echo "=== é›†æˆæ¨¡å—éªŒè¯ ==="
          echo "ç¼–è¯‘æ–‡ä»¶:"
          if [ -f "theories/FRF_Comparative.vo" ]; then
            size=$(wc -l < "theories/FRF_Comparative.v" 2>/dev/null || echo 0)
            echo "  âœ… FRF_Comparative.vo ($size è¡Œ)"
            echo ""
            echo "ç”ŸæˆæŠ¥å‘ŠåŠŸèƒ½éªŒè¯..."
            # æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆå‡½æ•°æ˜¯å¦å­˜åœ¨
            if grep -q "default_comparative_report" theories/FRF_Comparative.v; then
              echo "  âœ… æŠ¥å‘Šç”Ÿæˆå‡½æ•°å­˜åœ¨"
            else
              echo "  âš ï¸  æŠ¥å‘Šç”Ÿæˆå‡½æ•°æœªæ‰¾åˆ°"
            fi
          else
            echo "  âŒ FRF_Comparative.vo ç¼ºå¤±"
          fi

  compile-phase-6:
    name: ğŸ§ª é˜¶æ®µ6: æµ‹è¯•å¥—ä»¶ç¼–è¯‘
    needs: [compile-phase-5, compile-phase-1, compile-phase-2, compile-phase-3]
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -Q Quantum Quantum -Q CS_Null CS_Null -Q Test Test -m ${{ env.COQ_MEMORY }}"
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)
          echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

          # å¤åˆ¶æ‰€æœ‰ä¾èµ–æ–‡ä»¶
          cp -r ../compile-phase-1/SelfContainedLib/*.vo SelfContainedLib/ 2>/dev/null || true
          cp -r ../compile-phase-2/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-3/theories/*.vo theories/ 2>/dev/null || true
          cp -r ../compile-phase-4/Quantum/*.vo Quantum/ 2>/dev/null || true
          cp -r ../compile-phase-4/CS_Null/*.vo CS_Null/ 2>/dev/null || true
          cp -r ../compile-phase-5/theories/*.vo theories/ 2>/dev/null || true

      - name: ğŸ§ª æ£€æŸ¥æµ‹è¯•å¥—ä»¶
        run: |
          echo "=== æµ‹è¯•å¥—ä»¶æ£€æŸ¥ ==="
          echo "æµ‹è¯•æ–‡ä»¶:"
          ls -la Test/*.v 2>/dev/null || echo "æ— æµ‹è¯•æ–‡ä»¶"
          echo ""
          echo "æµ‹è¯•ç»Ÿè®¡:"
          find Test -name "*.v" 2>/dev/null | wc -l

      - name: ğŸ”§ å¹¶è¡Œç¼–è¯‘æµ‹è¯•
        run: |
          eval $(opam env)
          echo "ğŸ§ª å¹¶è¡Œç¼–è¯‘æµ‹è¯•å¥—ä»¶..."

          # ç¼–è¯‘å‡½æ•°
          compile_test() {
            local file=$1
            local base=$(basename $file .v)

            echo "  æµ‹è¯•: $base.v..."

            case $base in
              Test_FRF_MetaTheory|Test_BlockchainSystem)
                # å¤§æµ‹è¯•æ–‡ä»¶
                coqc $COQFLAGS -async-proofs on "$file" 2>&1
                ;;
              Test_QuantumVacuum|SelfContainedVerification)
                # ä¸­ç­‰æµ‹è¯•æ–‡ä»¶
                coqc $COQFLAGS "$file" 2>&1
                ;;
              Test_Basic)
                # å°æµ‹è¯•æ–‡ä»¶
                coqc $COQFLAGS "$file" 2>&1
                ;;
              *)
                # é»˜è®¤
                coqc $COQFLAGS "$file" 2>&1
                ;;
            esac

            if [ $? -eq 0 ]; then
              echo "    âœ… $base.v ç¼–è¯‘æˆåŠŸ"
              return 0
            else
              echo "    âŒ $base.v ç¼–è¯‘å¤±è´¥"
              return 1
            fi
          }

          export -f compile_test
          export COQFLAGS

          # æ‰¾åˆ°æ‰€æœ‰æµ‹è¯•æ–‡ä»¶å¹¶å¹¶è¡Œç¼–è¯‘
          test_files=$(find Test -name "*.v" 2>/dev/null | head -10)

          if [ -z "$test_files" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶"
            exit 0
          fi

          echo "æ‰¾åˆ°æµ‹è¯•æ–‡ä»¶:"
          echo "$test_files" | while read file; do
            echo "  - $(basename $file)"
          done

          # å¹¶è¡Œç¼–è¯‘
          for file in $test_files; do
            compile_test "$file" &
          done

          # ç­‰å¾…æ‰€æœ‰ç¼–è¯‘å®Œæˆ
          wait

          echo "âœ… æµ‹è¯•å¥—ä»¶ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“Š æµ‹è¯•ç¼–è¯‘ç»Ÿè®¡
        run: |
          echo "=== æµ‹è¯•å¥—ä»¶ç¼–è¯‘ç»Ÿè®¡ ==="
          echo "æµ‹è¯•æ–‡ä»¶:"
          total=0
          success=0

          for file in Test/*.vo 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename $file .vo)
              echo "  âœ… $base"
              ((success++))
            fi
            ((total++))
          done

          if [ $total -eq 0 ]; then
            echo "  æ— æµ‹è¯•æ–‡ä»¶"
          else
            echo ""
            echo "ç»Ÿè®¡: $success/$total ä¸ªæµ‹è¯•ç¼–è¯‘æˆåŠŸ"
          fi

  full-verification-report:
    name: ğŸ“‹ å…¨é‡éªŒè¯æŠ¥å‘Šç”Ÿæˆ
    needs: [compile-phase-1, compile-phase-2, compile-phase-3, compile-phase-4, compile-phase-5, compile-phase-6]
    if: always()
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ“¥ æ”¶é›†ç¼–è¯‘ç»“æœ
        run: |
          echo "=== æ”¶é›†å„é˜¶æ®µç¼–è¯‘ç»“æœ ==="

          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p verification-report
          mkdir -p compilation-artifacts

          # æ”¶é›†å„é˜¶æ®µæ–‡ä»¶
          for phase in 1 2 3 4 5 6; do
            mkdir -p compilation-artifacts/phase-$phase
            if [ -d "../compile-phase-$phase" ]; then
              find "../compile-phase-$phase" -name "*.vo" -o -name "*.glob" | head -20 | while read file; do
                cp "$file" "compilation-artifacts/phase-$phase/" 2>/dev/null || true
              done
            fi
          done

      - name: ğŸ“Š ç”ŸæˆéªŒè¯æŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆå…¨é‡éªŒè¯æŠ¥å‘Š..."

          # ç»Ÿè®¡ç¼–è¯‘ç»“æœ
          TOTAL_FILES=0
          COMPILED_FILES=0
          HUGE_FILES=0
          HUGE_COMPILED=0

          # æ‰«ææ‰€æœ‰.væ–‡ä»¶
          for dir in SelfContainedLib theories Quantum CS_Null Test; do
            if [ -d "$dir" ]; then
              for file in $(find "$dir" -name "*.v"); do
                ((TOTAL_FILES++))
                base=$(basename $file .v)
                vo_file="${file%.v}.vo"

                if [ -f "$vo_file" ]; then
                  ((COMPILED_FILES++))

                  # æ£€æŸ¥æ˜¯å¦æ˜¯å¤§æ–‡ä»¶
                  lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                  if [ $lines -gt 3000 ]; then
                    ((HUGE_FILES++))
                    ((HUGE_COMPILED++))
                  fi
                else
                  # æ£€æŸ¥æ˜¯å¦æ˜¯å¤§æ–‡ä»¶
                  lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                  if [ $lines -gt 3000 ]; then
                    ((HUGE_FILES++))
                  fi
                fi
              done
            fi
          done

          # è®¡ç®—æˆåŠŸç‡
          if [ $TOTAL_FILES -gt 0 ]; then
            SUCCESS_RATE=$((COMPILED_FILES * 100 / TOTAL_FILES))
          else
            SUCCESS_RATE=0
          fi

          # ç”ŸæˆMarkdownæŠ¥å‘Š
          cat > verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF
# FRF 2.0 å…¨é‡å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š

## éªŒè¯æ¦‚è§ˆ
- **éªŒè¯æ—¶é—´**: $(date)
- **ç¯å¢ƒ**: Ubuntu 22.04
- **æ€»æ–‡ä»¶æ•°**: $TOTAL_FILES
- **ç¼–è¯‘æˆåŠŸ**: $COMPILED_FILES
- **ç¼–è¯‘æˆåŠŸç‡**: ${SUCCESS_RATE}%
- **å¤§æ–‡ä»¶(>3000è¡Œ)**: $HUGE_FILES
- **å¤§æ–‡ä»¶ç¼–è¯‘æˆåŠŸ**: $HUGE_COMPILED

## æ¨¡å—ç¼–è¯‘çŠ¶æ€

### å±‚çº§1: è‡ªåŒ…å«åŸºç¡€åº“
| æ¨¡å— | çŠ¶æ€ | è¡Œæ•° | å®æ•°ä¾èµ– |
|------|------|------|----------|
EOF

          # åŸºç¡€åº“çŠ¶æ€
          for file in SelfContainedLib/*.v 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename $file .v)
              lines=$(wc -l < "$file" 2>/dev/null || echo 0)
              status="âŒ"
              if [ -f "${file%.v}.vo" ]; then
                status="âœ…"
              fi

              real_dep="å¦"
              if grep -q "Require.*Reals" "$file" 2>/dev/null; then
                real_dep="æ˜¯"
              fi

              echo "| $base | $status | $lines | $real_dep |" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            fi
          done

          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

### å±‚çº§2: FRFå…ƒç†è®º
| æ¨¡å— | çŠ¶æ€ | è¡Œæ•° | å®æ•°ä¾èµ– |
|------|------|------|----------|
EOF

          # å…ƒç†è®ºçŠ¶æ€
          for file in theories/FRF_MetaTheory.v theories/ChurchZero.v theories/ChurchNumerals.v 2>/dev/null; do
            if [ -f "$file" ]; then
              base=$(basename $file .v)
              lines=$(wc -l < "$file" 2>/dev/null || echo 0)
              status="âŒ"
              if [ -f "${file%.v}.vo" ]; then
                status="âœ…"
              fi

              real_dep="å¦"
              if grep -q "Require.*Reals" "$file" 2>/dev/null; then
                real_dep="æ˜¯"
              fi

              echo "| $base | $status | $lines | $real_dep |" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            fi
          done

          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

### å±‚çº§5: é›†æˆæ¨¡å—
| æ¨¡å— | çŠ¶æ€ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|------|
EOF

          # é›†æˆæ¨¡å—çŠ¶æ€
          if [ -f "theories/FRF_Comparative.v" ]; then
            lines=$(wc -l < "theories/FRF_Comparative.v" 2>/dev/null || echo 0)
            status="âŒ"
            if [ -f "theories/FRF_Comparative.vo" ]; then
              status="âœ…"
            fi
            echo "| FRF_Comparative | $status | $lines | è·¨ç³»ç»Ÿå¯¹æ¯”æ ¸å¿ƒ |" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
          fi

          # æ·»åŠ æ€»ç»“
          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

## éªŒè¯æ€»ç»“

EOF

          if [ $COMPILED_FILES -eq $TOTAL_FILES ]; then
            echo "ğŸ‰ **æ‰€æœ‰æ¨¡å—ç¼–è¯‘æˆåŠŸï¼**" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            echo "FRF 2.0 å½¢å¼åŒ–éªŒè¯å®Œå…¨é€šè¿‡ã€‚" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
          else
            echo "âš ï¸  **éƒ¨åˆ†æ¨¡å—ç¼–è¯‘å¤±è´¥**" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
            echo "å¤±è´¥æ–‡ä»¶æ•°: $((TOTAL_FILES - COMPILED_FILES))" >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md
          fi

          cat >> verification-report/FRF2_FULL_VERIFICATION_REPORT.md << EOF

## ç¯å¢ƒä¿¡æ¯
\`\`\`
Coqç‰ˆæœ¬: ${{ needs.setup-environment.outputs.coq_version }}
å¯ç”¨å†…å­˜: ${{ needs.setup-environment.outputs.memory_available }}MB
CPUæ ¸å¿ƒ: ${{ needs.setup-environment.outputs.core_count }}
ç¼–è¯‘æ—¶é—´: $(date +%Y-%m-%d\ %H:%M:%S)
\`\`\`
EOF

          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: frf2-verification-report
          path: |
            verification-report/
            compilation-artifacts/
          retention-days: 30

      - name: ğŸ“§ é€šçŸ¥ç»“æœ
        if: always()
        run: |
          echo "=== éªŒè¯ç»“æœ ==="
          if [ -f "verification-report/FRF2_FULL_VERIFICATION_REPORT.md" ]; then
            # æå–å…³é”®ä¿¡æ¯
            SUCCESS=$(grep -A5 "éªŒè¯æ€»ç»“" verification-report/FRF2_FULL_VERIFICATION_REPORT.md | grep -c "âœ…" || echo 0)
            FAILURE=$(grep -A5 "éªŒè¯æ€»ç»“" verification-report/FRF2_FULL_VERIFICATION_REPORT.md | grep -c "âŒ" || echo 0)

            if [ $FAILURE -eq 0 ]; then
              echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡"
              echo "::notice title=éªŒè¯é€šè¿‡::FRF 2.0 å…¨é‡éªŒè¯æˆåŠŸå®Œæˆ"
            else
              echo "âŒ éªŒè¯æœ‰å¤±è´¥"
              echo "::error title=éªŒè¯å¤±è´¥::FRF 2.0 éªŒè¯æœ‰ $FAILURE ä¸ªå¤±è´¥"
            fi
          else
            echo "âš ï¸  æŠ¥å‘Šæ–‡ä»¶æœªç”Ÿæˆ"
          fi

  quick-verification:
    name: âš¡ å¿«é€ŸéªŒè¯ï¼ˆå¯é€‰ï¼‰
    needs: setup-environment
    if: github.event.inputs.verify_mode == 'quick'
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
        run: |
          eval $(opam env)

      - name: ğŸ”§ å¿«é€Ÿç¼–è¯‘æ ¸å¿ƒ
        run: |
          echo "âš¡ å¿«é€ŸéªŒè¯æ¨¡å¼..."

          # åªç¼–è¯‘åŸºç¡€åº“å’Œå…ƒç†è®ºæ ¸å¿ƒ
          CORE_FILES="
            SelfContainedLib/Algebra.v
            SelfContainedLib/Category.v
            theories/FRF_MetaTheory.v
            theories/ChurchZero.v
          "

          for file in $CORE_FILES; do
            if [ -f "$file" ]; then
              echo "ç¼–è¯‘: $(basename $file)"
              coqc -Q SelfContainedLib SelfContainedLib -Q theories theories "$file" 2>&1 | head -5
            fi
          done

          echo "âœ… å¿«é€ŸéªŒè¯å®Œæˆ"

  test-only-mode:
    name: ğŸ§ª ä»…æµ‹è¯•æ¨¡å¼
    needs: [compile-phase-1, compile-phase-2]
    if: github.event.inputs.verify_mode == 'test-only'
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•
        run: |
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼..."

          # ç¼–è¯‘å¹¶è¿è¡ŒåŸºç¡€æµ‹è¯•
          if [ -f "Test/Test_Basic.v" ]; then
            echo "è¿è¡ŒåŸºç¡€æµ‹è¯•..."
            coqc -Q SelfContainedLib SelfContainedLib -Q Test Test Test/Test_Basic.v
            echo "âœ… åŸºç¡€æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸  åŸºç¡€æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨"
          fi

  report-generation:
    name: ğŸ“Š æŠ¥å‘Šç”Ÿæˆæ¨¡å¼
    needs: compile-phase-5
    if: github.event.inputs.verify_mode == 'report-only'
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“ˆ ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
        run: |
          echo "ğŸ“Š æŠ¥å‘Šç”Ÿæˆæ¨¡å¼..."

          # æ£€æŸ¥é›†æˆæ¨¡å—æ˜¯å¦ç¼–è¯‘
          if [ -f "theories/FRF_Comparative.vo" ]; then
            echo "ç”ŸæˆFRFè·¨ç³»ç»Ÿå¯¹æ¯”æŠ¥å‘Š..."
            # è¿™é‡Œå¯ä»¥è°ƒç”¨æŠ¥å‘Šç”Ÿæˆå‡½æ•°
            echo "æŠ¥å‘Šç”ŸæˆåŠŸèƒ½å°±ç»ª"
          else
            echo "âŒ é›†æˆæ¨¡å—æœªç¼–è¯‘ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Š"
          fi