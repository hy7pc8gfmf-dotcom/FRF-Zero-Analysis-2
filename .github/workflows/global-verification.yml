name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Coqç¯å¢ƒ
        uses: coq-community/setup-coq-action@v1
        with:
          coq-version: 8.18.0
          opam-repositories: |
            default: https://opam.ocaml.org
            coq-released: https://coq.inria.fr/opam/released

      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          opam update -y
          opam install -y coq-mathcomp-ssreflect coq-equations coq-bignums
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
        run: |
          echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
          ls -la
          echo "Coqæ–‡ä»¶æ•°é‡: $(find . -name '*.v' | wc -l)"
          echo "å…³é”®æ–‡ä»¶æ£€æŸ¥:"
          for file in Makefile SelfContainedLib/Algebra.v theories/FRF_MetaTheory.v; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ $file - ç¼ºå¤±"
            fi
          done

      - name: ç¼–è¯‘æ ¸å¿ƒæ¨¡å—
        run: |
          echo "=== ç¼–è¯‘æ ¸å¿ƒæ¨¡å— ==="
          
          # ç¼–è¯‘åŸºç¡€åº“
          echo "ç¼–è¯‘åŸºç¡€æ•°å­¦åº“..."
          coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Algebra.v || echo "Algebraç¼–è¯‘è·³è¿‡"
          coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Category.v || echo "Categoryç¼–è¯‘è·³è¿‡"
          coqc -Q SelfContainedLib SelfContainedLib SelfContainedLib/Geometry.v || echo "Geometryç¼–è¯‘è·³è¿‡"
          
          # ç¼–è¯‘FRFå…ƒç†è®º
          echo "ç¼–è¯‘FRFå…ƒç†è®º..."
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/FRF_MetaTheory.v || echo "FRF_MetaTheoryç¼–è¯‘è·³è¿‡"
          
          # ç¼–è¯‘Churchæ•°å€¼
          echo "ç¼–è¯‘Churchæ•°å€¼..."
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/ChurchNumerals.v || echo "ChurchNumeralsç¼–è¯‘è·³è¿‡"
          coqc -Q SelfContainedLib SelfContainedLib -Q theories FRF.Theories theories/ChurchZero.v || echo "ChurchZeroç¼–è¯‘è·³è¿‡"
          
          echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘å°è¯•å®Œæˆ"

      - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
        run: |
          echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
          compiled_files=$(find . -name "*.vo" | wc -l)
          echo "å·²ç¼–è¯‘æ–‡ä»¶æ•°: $compiled_files"
          
          echo "æ ¸å¿ƒæ¨¡å—çŠ¶æ€:"
          for module in SelfContainedLib/Algebra.vo SelfContainedLib/Category.vo SelfContainedLib/Geometry.vo theories/FRF_MetaTheory.vo theories/ChurchZero.vo; do
            if [ -f "$module" ]; then
              echo "âœ… $module"
            else
              echo "âŒ $module - ç¼ºå¤±"
            fi
          done
          
          if [ $compiled_files -ge 3 ]; then
            echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘é€šè¿‡"
          else
            echo "âŒ æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ä¸è¶³"
            exit 1
          fi

      - name: å°è¯•Makefileç¼–è¯‘
        if: success()
        run: |
          echo "=== å°è¯•Makefileç¼–è¯‘ ==="
          if [ -f "Makefile" ]; then
            echo "ä½¿ç”¨Makefileç¼–è¯‘..."
            make -j2 compile || echo "Makefileç¼–è¯‘å¤±è´¥ï¼Œä½†ç»§ç»­æµç¨‹"
          else
            echo "Makefileä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        if: always()
        run: |
          echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
          
          total_files=$(find . -name "*.v" | wc -l)
          compiled_files=$(find . -name "*.vo" | wc -l)
          
          mkdir -p verification-reports
          
          # ç”ŸæˆæŠ¥å‘Š
          echo "# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š" > verification-reports/REPORT.md
          echo "" >> verification-reports/REPORT.md
          echo "**éªŒè¯æ—¶é—´**: $(date)" >> verification-reports/REPORT.md
          echo "**ç¯å¢ƒ**: Ubuntu + Coq 8.18.0" >> verification-reports/REPORT.md
          echo "**Coqç‰ˆæœ¬**: $(coqc --version | head -1)" >> verification-reports/REPORT.md
          echo "" >> verification-reports/REPORT.md
          echo "## ç¼–è¯‘ç»Ÿè®¡" >> verification-reports/REPORT.md
          echo "- æ€»Coqæ–‡ä»¶: $total_files" >> verification-reports/REPORT.md
          echo "- æˆåŠŸç¼–è¯‘: $compiled_files" >> verification-reports/REPORT.md
          
          if [ $total_files -gt 0 ]; then
            success_rate=$((compiled_files * 100 / total_files))
            echo "- æˆåŠŸç‡: $success_rate%" >> verification-reports/REPORT.md
          else
            echo "- æˆåŠŸç‡: 0%" >> verification-reports/REPORT.md
          fi
          
          echo "" >> verification-reports/REPORT.md
          echo "## æ ¸å¿ƒæ¨¡å—çŠ¶æ€" >> verification-reports/REPORT.md
          
          # æ¨¡å—çŠ¶æ€åˆ—è¡¨
          modules=(
            "SelfContainedLib/Algebra.vo:åŸºç¡€ä»£æ•°"
            "SelfContainedLib/Category.vo:åŸºç¡€èŒƒç•´" 
            "SelfContainedLib/Geometry.vo:åŸºç¡€å‡ ä½•"
            "theories/FRF_MetaTheory.vo:FRFå…ƒç†è®º"
            "theories/ChurchZero.vo:Churché›¶"
          )
          
          for module_info in "${modules[@]}"; do
            module=$(echo "$module_info" | cut -d: -f1)
            desc=$(echo "$module_info" | cut -d: -f2)
            if [ -f "$module" ]; then
              echo "- âœ… $desc" >> verification-reports/REPORT.md
            else
              echo "- âŒ $desc" >> verification-reports/REPORT.md
            fi
          done
          
          echo "" >> verification-reports/REPORT.md
          echo "## éªŒè¯ç»“æœ" >> verification-reports/REPORT.md
          if [ $compiled_files -ge 3 ]; then
            echo "âœ… **éªŒè¯æˆåŠŸ**: æ ¸å¿ƒæ¡†æ¶ç¼–è¯‘é€šè¿‡" >> verification-reports/REPORT.md
          else
            echo "âŒ **éªŒè¯å¤±è´¥**: æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ä¸è¶³" >> verification-reports/REPORT.md
          fi
          
          echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: frf-verification-report
          path: verification-reports/
          retention-days: 7

      - name: éªŒè¯æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          compiled_count=$(find . -name "*.vo" | wc -l)
          echo "ğŸ‰ FRF 2.0 å½¢å¼åŒ–éªŒè¯æˆåŠŸå®Œæˆ!"
          echo "ğŸ“Š ç¼–è¯‘æ¨¡å—: $compiled_count"
          echo "ğŸ“‹ æŠ¥å‘Šä½ç½®: verification-reports/REPORT.md"

      - name: éªŒè¯å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 å½¢å¼åŒ–éªŒè¯å¤±è´¥"
          echo "è¯·æ£€æŸ¥æ ¸å¿ƒæ¨¡å—ç¼–è¯‘çŠ¶æ€"