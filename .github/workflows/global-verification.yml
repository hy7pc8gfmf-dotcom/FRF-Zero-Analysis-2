name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  formal-verification:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: åˆå§‹åŒ–OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam update
        echo "âœ… OPAMç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: å®‰è£…å…¼å®¹çš„Coqå’Œä¾èµ–
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        eval $(opam env)
        
        # å®‰è£…Coq 8.18.0
        echo "å®‰è£…Coq 8.18.0..."
        opam install -y coq.8.18.0
        
        # å®‰è£…ä¸Coq 8.18.0å…¼å®¹çš„mathcompç‰ˆæœ¬
        echo "å®‰è£…å…¼å®¹çš„mathcomp-ssreflect..."
        opam install -y coq-mathcomp-ssreflect.1.17.0
        
        # éªŒè¯ç‰ˆæœ¬
        echo "éªŒè¯å®‰è£…ç‰ˆæœ¬..."
        coqc --version
        opam list --installed | grep -E "coq|mathcomp"
        
        echo "âœ… å…¼å®¹ç¯å¢ƒå®‰è£…å®Œæˆ"

    - name: éªŒè¯é¡¹ç›®ç»“æ„
      run: |
        eval $(opam env)
        
        echo "=== é¡¹ç›®ç»“æ„éªŒè¯ ==="
        echo "æ€»Coqæ–‡ä»¶æ•°: $(find . -name '*.v' | wc -l)"
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        for dir in SelfContainedLib theories; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir ç›®å½•å­˜åœ¨"
            find "$dir" -name "*.v" | head -3
          else
            echo "âŒ $dir ç›®å½•ç¼ºå¤±"
          fi
        done

    - name: åŸºç¡€ç¯å¢ƒæµ‹è¯•
      run: |
        eval $(opam env)
        
        echo "=== åŸºç¡€ç¯å¢ƒæµ‹è¯• ==="
        
        # æµ‹è¯•coqcå‘½ä»¤
        echo "1. æµ‹è¯•coqcå‘½ä»¤..."
        which coqc
        coqc --version
        
        # æµ‹è¯•ç®€å•ç¼–è¯‘
        echo "2. æµ‹è¯•ç®€å•ç¼–è¯‘..."
        cat > /tmp/simple_test.v << 'EOF'
        Theorem simple_test : True.
        Proof. exact I. Qed.
        EOF
        
        coqc /tmp/simple_test.v
        
        if [ -f "/tmp/simple_test.vo" ]; then
          echo "âœ… åŸºç¡€ç¼–è¯‘æµ‹è¯•é€šè¿‡"
          rm /tmp/simple_test.vo /tmp/simple_test.glob
        else
          echo "âŒ åŸºç¡€ç¼–è¯‘æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        rm /tmp/simple_test.v

    - name: åˆ†æ­¥ç¼–è¯‘æ ¸å¿ƒæ¨¡å—
      run: |
        eval $(opam env)
        
        echo "=== åˆ†æ­¥ç¼–è¯‘æ ¸å¿ƒæ¨¡å— ==="
        
        # ä½¿ç”¨ç®€åŒ–çš„è·¯å¾„æ˜ å°„
        BASE_FLAGS="-Q SelfContainedLib SelfContainedLib"
        
        # ç¼–è¯‘åŸºç¡€åº“
        echo "1. ç¼–è¯‘åŸºç¡€åº“..."
        for base_file in SelfContainedLib/Algebra.v SelfContainedLib/Category.v SelfContainedLib/Geometry.v; do
          if [ -f "$base_file" ]; then
            echo "ç¼–è¯‘: $base_file"
            if coqc $BASE_FLAGS "$base_file"; then
              echo "âœ… æˆåŠŸ: $base_file"
            else
              echo "âŒ å¤±è´¥: $base_file"
              # æ˜¾ç¤ºå‰5è¡Œé”™è¯¯ä¿¡æ¯
              coqc $BASE_FLAGS "$base_file" 2>&1 | head -5
            fi
          fi
        done

    - name: ç¼–è¯‘ç»“æœåˆ†æ
      if: always()
      run: |
        eval $(opam env)
        
        echo "=== ç¼–è¯‘ç»“æœåˆ†æ ==="
        
        total_v_files=$(find . -name "*.v" | wc -l)
        compiled_vo_files=$(find . -name "*.vo" | wc -l)
        
        echo "ç»Ÿè®¡ä¿¡æ¯:"
        echo "- æ€»Coqæ–‡ä»¶: $total_v_files"
        echo "- å·²ç¼–è¯‘æ–‡ä»¶: $compiled_vo_files"
        
        if [ $compiled_vo_files -gt 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ!"
          echo "ç¼–è¯‘äº§ç‰©:"
          find . -name "*.vo" | sed 's|^\./||'
          
          success_rate=$((compiled_vo_files * 100 / total_v_files))
          echo "ç¼–è¯‘æˆåŠŸç‡: $success_rate%"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "é—®é¢˜è¯Šæ–­:"
          echo "1. Coqç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜"
          echo "2. ä»£ç è¯­æ³•éœ€è¦é€‚é…"
          echo "3. ä¾èµ–æ¨¡å—ç¼ºå¤±"
        fi

    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      run: |
        eval $(opam env)
        
        echo "=== ç”ŸæˆéªŒè¯æŠ¥å‘Š ==="
        
        mkdir -p verification-reports
        
        # æ”¶é›†æ•°æ®
        total_v_files=$(find . -name "*.v" | wc -l)
        compiled_vo_files=$(find . -name "*.vo" | wc -l)
        coq_version=$(coqc --version | head -1)
        
        # ç”ŸæˆæŠ¥å‘Š
        echo "# FRF 2.0 å½¢å¼åŒ–éªŒè¯æŠ¥å‘Š" > verification-reports/REPORT.md
        echo "" >> verification-reports/REPORT.md
        echo "**éªŒè¯æ—¶é—´**: $(date)" >> verification-reports/REPORT.md
        echo "**ç¯å¢ƒ**: Ubuntu 22.04" >> verification-reports/REPORT.md
        echo "**Coqç‰ˆæœ¬**: $coq_version" >> verification-reports/REPORT.md
        echo "" >> verification-reports/REPORT.md
        echo "## ç¼–è¯‘ç»Ÿè®¡" >> verification-reports/REPORT.md
        echo "- æ€»Coqæ–‡ä»¶: $total_v_files" >> verification-reports/REPORT.md
        echo "- æˆåŠŸç¼–è¯‘: $compiled_vo_files" >> verification-reports/REPORT.md
        
        if [ $total_v_files -gt 0 ]; then
          success_rate=$((compiled_vo_files * 100 / total_v_files))
          echo "- ç¼–è¯‘æˆåŠŸç‡: $success_rate%" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## è¯¦ç»†ç»“æœ" >> verification-reports/REPORT.md
        
        if [ $compiled_vo_files -gt 0 ]; then
          echo "### âœ… éªŒè¯æˆåŠŸ" >> verification-reports/REPORT.md
          echo "æˆåŠŸç¼–è¯‘äº† $compiled_vo_files ä¸ªæ ¸å¿ƒæ¨¡å—ã€‚" >> verification-reports/REPORT.md
          echo "" >> verification-reports/REPORT.md
          echo "**å·²ç¼–è¯‘æ¨¡å—:**" >> verification-reports/REPORT.md
          echo "\`\`\`" >> verification-reports/REPORT.md
          find . -name "*.vo" | sed 's|^\./||' >> verification-reports/REPORT.md
          echo "\`\`\`" >> verification-reports/REPORT.md
        else
          echo "### âŒ éªŒè¯å¤±è´¥" >> verification-reports/REPORT.md
          echo "æœªèƒ½ç¼–è¯‘ä»»ä½•Coqæ¨¡å—ã€‚" >> verification-reports/REPORT.md
          echo "" >> verification-reports/REPORT.md
          echo "**ç¯å¢ƒä¿¡æ¯:**" >> verification-reports/REPORT.md
          echo "- Coqç‰ˆæœ¬: $coq_version" >> verification-reports/REPORT.md
          echo "- é¡¹ç›®æ–‡ä»¶: $total_v_files ä¸ª" >> verification-reports/REPORT.md
          echo "" >> verification-reports/REPORT.md
          echo "**è§£å†³æ–¹æ¡ˆå»ºè®®:**" >> verification-reports/REPORT.md
          echo "1. æ£€æŸ¥å¹¶ä¿®å¤ä»£ç ä¸­çš„å¯¼å…¥è¯­å¥" >> verification-reports/REPORT.md
          echo "2. ç¡®ä¿ä½¿ç”¨å…¼å®¹çš„Coqå’Œmathcompç‰ˆæœ¬" >> verification-reports/REPORT.md
          echo "3. ç®€åŒ–è·¯å¾„æ˜ å°„é…ç½®" >> verification-reports/REPORT.md
        fi
        
        echo "" >> verification-reports/REPORT.md
        echo "## ç¯å¢ƒä¿¡æ¯" >> verification-reports/REPORT.md
        echo "\`\`\`" >> verification-reports/REPORT.md
        opam list --installed | grep -E "coq|mathcomp" >> verification-reports/REPORT.md 2>/dev/null || echo "æ— æ³•è·å–åŒ…ä¿¡æ¯" >> verification-reports/REPORT.md
        echo "\`\`\`" >> verification-reports/REPORT.md
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf-verification-report
        path: verification-reports/
        retention-days: 7

    - name: éªŒè¯çŠ¶æ€æ€»ç»“
      if: always()
      run: |
        eval $(opam env)
        
        compiled_count=$(find . -name "*.vo" | wc -l)
        if [ $compiled_count -ge 1 ]; then
          echo "ğŸ‰ FRF 2.0 éªŒè¯å–å¾—è¿›å±•!"
          echo "ğŸ“Š ç¼–è¯‘æ¨¡å—æ•°: $compiled_count"
          echo "âœ… åŸºç¡€ç¯å¢ƒéªŒè¯é€šè¿‡"
        else
          echo "âŒ FRF 2.0 éªŒè¯é‡åˆ°é˜»ç¢"
          echo "ğŸ“‹ è¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆ"
          echo "ğŸ”§ éœ€è¦ä»£ç çº§é€‚é…"
        fi