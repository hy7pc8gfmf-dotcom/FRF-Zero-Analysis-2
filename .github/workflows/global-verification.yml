name: FRF 2.0 æ™ºèƒ½å…¨é‡å½¢å¼åŒ–éªŒè¯
on:
  push:
    branches: [main, master, develop]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
      - '.github/workflows/global-verification.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'SelfContainedLib/**'
      - 'theories/**'
      - 'Quantum/**'
      - 'CS_Null/**'
      - 'Test/**'
  workflow_dispatch:
    inputs:
      verify_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - test-only
          - report-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: false
        default: '4'
        type: string

jobs:
  setup-environment:
    name: ğŸ”§ ç¯å¢ƒé…ç½®ä¸æ£€æŸ¥
    runs-on: ubuntu-22.04
    outputs:
      coq_version: ${{ steps.check-coq.outputs.version }}
      memory_available: ${{ steps.check-memory.outputs.available_mb }}
      core_count: ${{ steps.check-cpu.outputs.core_count }}
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
      id: check-cpu
      run: |
        echo "æ ¸å¿ƒæ•°: $(nproc)"
        echo "core_count=$(nproc)" >> $GITHUB_OUTPUT
        
    - name: ğŸ’¾ å†…å­˜æ£€æŸ¥
      id: check-memory
      run: |
        AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
        echo "å¯ç”¨å†…å­˜: ${AVAIL_MEM}MB"
        echo "available_mb=${AVAIL_MEM}" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          bc \
          graphviz \
          python3 \
          python3-pip
        
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”„ é…ç½®OPAMç¯å¢ƒ
      run: |
        opam init --disable-sandboxing -y --compiler=4.14.0
        eval $(opam env)
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add mathlib https://github.com/leanprover-community/mathlib.git
        opam update -y
        echo "OPAM_HOME=$OPAM_HOME" >> $GITHUB_ENV
        echo "OPAM_SWITCH_PREFIX=$OPAM_SWITCH_PREFIX" >> $GITHUB_ENV
        
    - name: ğŸ“Š é…ç½®éªŒè¯ç¯å¢ƒ
      run: |
        echo "AVAIL_MEM=${{ steps.check-memory.outputs.available_mb }}" >> $GITHUB_ENV
        echo "CORE_COUNT=${{ steps.check-cpu.outputs.core_count }}" >> $GITHUB_ENV
        
        # æ ¹æ®å†…å­˜è®¾ç½®ç¼–è¯‘å‚æ•°
        if [ ${{ steps.check-memory.outputs.available_mb }} -gt 16000 ]; then
          echo "COQ_MEMORY=16384" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=16384" >> $GITHUB_ENV
        elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 8000 ]; then
          echo "COQ_MEMORY=8192" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=8192" >> $GITHUB_ENV
        elif [ ${{ steps.check-memory.outputs.available_mb }} -gt 4000 ]; then
          echo "COQ_MEMORY=4096" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=4096" >> $GITHUB_ENV
        else
          echo "COQ_MEMORY=2048" >> $GITHUB_ENV
          echo "BIGFILE_MEMORY=2048" >> $GITHUB_ENV
        fi
        
        echo "PARALLEL_JOBS=$((${{ steps.check-cpu.outputs.core_count }} / 2))" >> $GITHUB_ENV

    - name: ğŸ” æ£€æŸ¥Coqç‰ˆæœ¬
      id: check-coq
      run: |
        eval $(opam env)
        if command -v coqc &> /dev/null; then
          COQ_VERSION=$(coqc --version | head -1 | grep -o 'version [0-9.]\+' | cut -d' ' -f2)
          echo "å½“å‰Coqç‰ˆæœ¬: $COQ_VERSION"
          echo "version=$COQ_VERSION" >> $GITHUB_OUTPUT
        else
          echo "âŒ Coqæœªå®‰è£…"
          exit 1
        fi

    - name: ğŸ“‹ ç¯å¢ƒæŠ¥å‘Š
      run: |
        echo "=== ç¯å¢ƒé…ç½®æŠ¥å‘Š ==="
        echo "ç³»ç»Ÿ: Ubuntu 22.04"
        echo "CPUæ ¸å¿ƒ: ${{ steps.check-cpu.outputs.core_count }}"
        echo "å¯ç”¨å†…å­˜: ${{ steps.check-memory.outputs.available_mb }}MB"
        echo "åˆ†é…å†…å­˜: ${{ env.COQ_MEMORY }}MB"
        echo "å¹¶è¡Œä»»åŠ¡: ${{ env.PARALLEL_JOBS }}"
        echo "Coqç‰ˆæœ¬: ${{ steps.check-coq.outputs.version }}"

  install-dependencies:
    name: ğŸ“¦ ä¾èµ–å®‰è£…ä¸ç¼“å­˜
    needs: setup-environment
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        coq-version: ['8.18.0']
        mathcomp-version: ['1.17.0']
    steps:
    - name: ğŸ“¥ æ¢å¤OPAMç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.opam
          ~/.cache/opam
        key: ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-${{ hashFiles('*.opam') }}
        restore-keys: |
          ${{ runner.os }}-opam-${{ matrix.coq-version }}-${{ matrix.mathcomp-version }}-
          ${{ runner.os }}-opam-

    - name: ğŸ”„ è®¾ç½®OPAMç¯å¢ƒ
      run: |
        eval $(opam env)
        opam update

    - name: ğŸ“Š å®‰è£…Coqæ ¸å¿ƒ
      run: |
        eval $(opam env)
        echo "å®‰è£…Coq ${{ matrix.coq-version }}..."
        opam install -y coq.${{ matrix.coq-version }}
        
        echo "éªŒè¯Coqå®‰è£…..."
        coqc --version
        if [ $? -ne 0 ]; then
          echo "âŒ Coqå®‰è£…å¤±è´¥"
          exit 1
        fi

    - name: ğŸ§® å®‰è£…mathcomp
      run: |
        eval $(opam env)
        echo "å®‰è£…coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}..."
        opam install -y coq-mathcomp-ssreflect.${{ matrix.mathcomp-version }}
        
        echo "éªŒè¯mathcompå®‰è£…..."
        opam list --installed | grep "coq-mathcomp-ssreflect" || (echo "âŒ mathcompå®‰è£…å¤±è´¥" && exit 1)

    - name: ğŸ“š å®‰è£…å¤–éƒ¨åº“
      run: |
        eval $(opam env)
        echo "å®‰è£…å¤–éƒ¨ä¾èµ–åº“..."
        
        # å®æ•°åº“
        opam install -y coq-mathcomp-analysis
        
        # æ ‡å‡†åº“
        opam install -y coq-stdlib
        
        # å¯é€‰ï¼šæ•°å­¦åº“
        opam install -y coq-mathlib || echo "è­¦å‘Š: mathlibå®‰è£…å¤±è´¥ï¼Œéƒ¨åˆ†æ¨¡å—å¯èƒ½æ— æ³•ç¼–è¯‘"
        
        # å¯é€‰ï¼šçŸ©é˜µå’Œå‘é‡åº“
        opam install -y coq-mathcomp-algebra || echo "è­¦å‘Š: çŸ©é˜µåº“å®‰è£…å¤±è´¥"
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ“ ä¾èµ–éªŒè¯æŠ¥å‘Š
      run: |
        eval $(opam env)
        echo "=== ä¾èµ–éªŒè¯æŠ¥å‘Š ==="
        echo "Coqç‰ˆæœ¬:"
        coqc --version
        echo ""
        echo "å®‰è£…çš„åŒ…:"
        opam list --installed | grep -E "coq|mathcomp"
        echo ""
        echo "ä¾èµ–æ ‘:"
        opam list --tree --installed | head -50

  compile-phase-1:
    name: ğŸ—ï¸ é˜¶æ®µ1: åŸºç¡€åº“ç¼–è¯‘
    needs: [setup-environment, install-dependencies]
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -m ${{ env.COQ_MEMORY }}"
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ”„ è®¾ç½®ç¯å¢ƒ
      run: |
        eval $(opam env)
        echo "COQFLAGS=${{ env.COQFLAGS }}" >> $GITHUB_ENV

    - name: ğŸ“Š ç¼–è¯‘å‰æ£€æŸ¥
      run: |
        echo "=== åŸºç¡€åº“ç¼–è¯‘å‰æ£€æŸ¥ ==="
        echo "åŸºç¡€åº“æ–‡ä»¶:"
        ls -la SelfContainedLib/*.v
        echo ""
        echo "ç¼–è¯‘å‚æ•°: $COQFLAGS"
        echo "å†…å­˜é™åˆ¶: ${{ env.COQ_MEMORY }}MB"
        echo "å¹¶è¡Œç¼–è¯‘: å¯ç”¨"

    - name: ğŸ”§ å¹¶è¡Œç¼–è¯‘åŸºç¡€åº“
      run: |
        eval $(opam env)
        
        # å®šä¹‰ç¼–è¯‘å‡½æ•°
        compile_file() {
          local file=$1
          local base=$(basename $file .v)
          echo "ğŸš€ ç¼–è¯‘ $base.v..."
          
          # å¤§æ–‡ä»¶ç‰¹æ®Šå¤„ç†
          local line_count=$(wc -l < "$file" 2>/dev/null || echo 0)
          local extra_flags=""
          
          if [ "$base" = "Geometry" ]; then
            extra_flags="-m ${{ env.BIGFILE_MEMORY }} -async-proofs on -async-proofs-tac-j 4"
            echo "  å¤§æ–‡ä»¶æ£€æµ‹: $line_count è¡Œï¼Œä½¿ç”¨å¢å¼ºå‚æ•°"
          fi
          
          if coqc $COQFLAGS $extra_flags "$file" 2>&1; then
            echo "âœ… $base.v ç¼–è¯‘æˆåŠŸ"
            return 0
          else
            echo "âŒ $base.v ç¼–è¯‘å¤±è´¥"
            # è¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            coqc $COQFLAGS $extra_flags "$file" 2>&1 | head -30
            return 1
          fi
        }
        
        export -f compile_file
        export COQFLAGS
        
        # å¹¶è¡Œç¼–è¯‘ä¸‰ä¸ªåŸºç¡€æ–‡ä»¶
        echo "å¼€å§‹å¹¶è¡Œç¼–è¯‘åŸºç¡€åº“..."
        
        # ç¼–è¯‘Algebra.v
        compile_file "SelfContainedLib/Algebra.v" &
        ALGEBRA_PID=$!
        
        # ç¼–è¯‘Category.v
        compile_file "SelfContainedLib/Category.v" &
        CATEGORY_PID=$!
        
        # ç¼–è¯‘Geometry.vï¼ˆå¤§æ–‡ä»¶ï¼Œæœ€åç¼–è¯‘ï¼‰
        sleep 2  # è®©å…¶ä»–æ–‡ä»¶å…ˆå¼€å§‹
        compile_file "SelfContainedLib/Geometry.v" &
        GEOMETRY_PID=$!
        
        # ç­‰å¾…æ‰€æœ‰ç¼–è¯‘å®Œæˆ
        wait $ALGEBRA_PID || ALGEBRA_FAILED=1
        wait $CATEGORY_PID || CATEGORY_FAILED=1
        wait $GEOMETRY_PID || GEOMETRY_FAILED=1
        
        # æ£€æŸ¥ç»“æœ
        if [ -n "$ALGEBRA_FAILED" ] || [ -n "$CATEGORY_FAILED" ] || [ -n "$GEOMETRY_FAILED" ]; then
          echo "âŒ åŸºç¡€åº“ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… åŸºç¡€åº“ç¼–è¯‘å®Œæˆ"

    - name: ğŸ“ˆ ç¼–è¯‘ç»“æœç»Ÿè®¡
      run: |
        echo "=== åŸºç¡€åº“ç¼–è¯‘ç»Ÿè®¡ ==="
        echo "ç¼–è¯‘æ–‡ä»¶:"
        for file in Algebra Category Geometry; do
          if [ -f "SelfContainedLib/$file.vo" ]; then
            echo "  âœ… $file.vo (å­˜åœ¨)"
          else
            echo "  âŒ $file.vo (ç¼ºå¤±)"
          fi
        done
        echo ""
        echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
        ls -la SelfContainedLib/*.vo SelfContainedLib/*.glob 2>/dev/null || echo "æ— ç”Ÿæˆæ–‡ä»¶"

  compile-phase-2:
    name: ğŸ§  é˜¶æ®µ2: å…ƒç†è®ºå±‚ç¼–è¯‘
    needs: compile-phase-1
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    env:
      COQFLAGS: "-Q SelfContainedLib SelfContainedLib -Q theories theories -m ${{ env.COQ_MEMORY }}"
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v

