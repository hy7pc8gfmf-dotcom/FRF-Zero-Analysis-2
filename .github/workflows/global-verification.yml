name: FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯ï¼ˆæœ€ç»ˆç¨³å®šç‰ˆï¼‰
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0  # ç»Ÿä¸€ç¨³å®šç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
      options: --user root
    timeout-minutes: 180  # å……è¶³è¶…æ—¶æ—¶é—´ï¼Œé€‚é…ç¼–è¯‘+ä¾èµ–å®‰è£…
    env:
      MATHCOMP_VERSION: "1.18.0"  # ä¸Coq 8.18.0å…¼å®¹çš„ç¨³å®šç‰ˆæœ¬
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      # å›½å†…é«˜é€Ÿé•œåƒæºï¼Œå½»åº•è§£å†³ç½‘ç»œæ‹¥å µ
      OPAM_MIRROR: "https://mirrors.ustc.edu.cn/opam/"
      COQ_RELEASED_MIRROR: "https://mirrors.ustc.edu.cn/coq-opam/released"
    steps:
      - name: ä¿®å¤ç›®å½•æƒé™+åˆå§‹åŒ–opamç¯å¢ƒ
        run: |
          # ä¿®å¤ä¸´æ—¶ç›®å½•æƒé™ï¼Œé¿å…è¯»å†™å¤±è´¥
          mkdir -p ${{ env.TEMP_DIR }} ~/.opam ~/.cache/opam
          chmod -R 777 /__w/_temp/ ~/.opam ~/.cache/opam ${{ github.workspace }}
          
          # åˆå§‹åŒ–opamï¼Œç¦ç”¨æ²™ç®±ï¼ˆå®¹å™¨ç¯å¢ƒå…¼å®¹ï¼‰
          opam init --disable-sandboxing -y --no-setup
          
          # åŠ è½½opamç¯å¢ƒï¼ˆå…¼å®¹æ‰€æœ‰shellï¼Œæ›¿ä»£source ~/.profileï¼‰
          eval $(opam env --switch=default)
          
          echo "âœ… ç›®å½•æƒé™ä¿®å¤+opamç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          echo "ğŸ“Œ å½“å‰opamç‰ˆæœ¬ï¼š$(opam --version)"
          echo "ğŸ“Œ å½“å‰Coqç‰ˆæœ¬ï¼š$(coqc --version | head -n1)"

      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'  # é€’å½’æ‹‰å–å­æ¨¡å—ï¼Œç¡®ä¿ä¾èµ–å®Œæ•´

      - name: ç¼“å­˜ä¼˜åŒ–ï¼ˆæ–­ç‚¹ç»­è£…æ ¸å¿ƒï¼‰
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam  # ç¼“å­˜ä¸‹è½½åŒ…ï¼Œæ–­ç‚¹ç»­è£…ä¸é‡å¤ä¸‹è½½
            _build
            **/*.vo
            **/*.glob
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-final-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-final-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-final-

      - name: åˆ‡æ¢é•œåƒæº+å®‰è£…ä¾èµ–ï¼ˆç¨³å®šæ— é”™ç‰ˆï¼‰
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          # æ›¿æ¢ä¸ºå›½å†…é•œåƒæºï¼Œå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦
          opam repo remove coq-released || true
          opam repo remove default || true
          opam repo add default ${{ env.OPAM_MIRROR }} --all-switches --allow-root
          opam repo add coq-released ${{ env.COQ_RELEASED_MIRROR }} --all-switches --allow-root
          
          # å¼ºåˆ¶æ›´æ–°é•œåƒæºç´¢å¼•ï¼Œç¡®ä¿åŒ…åˆ—è¡¨æœ€æ–°
          opam update -y --allow-root --retry 8  # 8æ¬¡é‡è¯•ï¼Œåº”å¯¹ä¸´æ—¶ç½‘ç»œæ³¢åŠ¨
          
          # æ£€æµ‹å·²å®‰è£…åŒ…ï¼Œä»…å®‰è£…æœªå®Œæˆé¡¹ï¼ˆæ–­ç‚¹ç»­è£…ï¼‰
          echo "=== ğŸ” æ£€æµ‹å·²å®‰è£…ä¾èµ– ==="
          installed_pkgs=$(opam list --short --allow-root)
          
          # æ ¸å¿ƒä¾èµ–åˆ—è¡¨ï¼ˆç§»é™¤ä¸å­˜åœ¨çš„coq-extractionï¼Œå†…ç½®åœ¨coq-coreä¸­ï¼‰
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-stdlib=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }}"
            "coq-equations"
            "${{ env.COQ_EXTRA_OPAM }}"
          )
          
          # ç­›é€‰æœªå®‰è£…çš„ä¾èµ–
          to_install=()
          for pkg in "${required_pkgs[@]}"; do
            pkg_name=$(echo "$pkg" | cut -d'=' -f1)
            if ! echo "$installed_pkgs" | grep -q "^$pkg_name$"; then
              to_install+=("$pkg")
              echo "ğŸ“¥ å¾…å®‰è£…ï¼š$pkg"
            else
              echo "âœ… å·²å®‰è£…ï¼š$pkgï¼Œè·³è¿‡"
            fi
          done
          
          # å®‰è£…æœªå®Œæˆä¾èµ–ï¼ˆ2çº¿ç¨‹ä¸‹è½½ï¼Œå¹³è¡¡é€Ÿåº¦ä¸ç¨³å®šæ€§ï¼‰
          if [ ${#to_install[@]} -gt 0 ]; then
            echo "=== ğŸš€ å¼€å§‹å®‰è£…ä¾èµ– ==="
            opam install -y --allow-root --retry 10 --jobs 2 "${to_install[@]}"
          else
            echo "=== âœ… æ‰€æœ‰ä¾èµ–å·²å®Œæ•´å®‰è£…ï¼Œæ— éœ€é¢å¤–æ“ä½œ ==="
          fi
          
          # å®‰è£…Pythonè¾…åŠ©å·¥å…·ï¼ˆç”¨äºç”ŸæˆæŠ¥å‘Šï¼‰
          pip3 install --no-cache-dir --timeout 60 coq-parser==0.1.5 reportlab==4.0.9
          
          # æœ€ç»ˆç‰ˆæœ¬æ ¡éªŒï¼Œç¡®ä¿ä¾èµ–ä¸€è‡´æ€§
          echo "=== ğŸ“‹ ä¾èµ–ç‰ˆæœ¬æœ€ç»ˆæ ¡éªŒ ==="
          if ! coqc --version | grep -q "${{ env.COQ_VERSION }}"; then
            echo "âŒ Coqç‰ˆæœ¬ä¸åŒ¹é…ï¼ˆéœ€${{ env.COQ_VERSION }}ï¼Œå½“å‰ï¼š$(coqc --version | head -n1)ï¼‰"
            exit 1
          fi
          if ! opam list | grep -q "coq-mathcomp-ssreflect.*${{ env.MATHCOMP_VERSION }}"; then
            echo "âŒ MathCompç‰ˆæœ¬ä¸åŒ¹é…"
            exit 1
          fi
          echo "=== âœ… ä¾èµ–å®‰è£…+æ ¡éªŒå…¨é‡å®Œæˆï¼Œå‡†å¤‡è¿›å…¥éªŒè¯é˜¶æ®µ ==="

      - name: ç”Ÿæˆå…¨å±€éªŒè¯Makefileï¼ˆè‡ªåŠ¨é€‚é…ï¼‰
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          # æ£€æŸ¥CoqProjectæ˜¯å¦å­˜åœ¨
          if [ ! -f "CoqProject" ]; then
            echo "âŒ æœªæ‰¾åˆ°CoqProjectæ–‡ä»¶ï¼Œæ— æ³•ç”ŸæˆéªŒè¯ç›®æ ‡"
            exit 1
          fi
          
          # ç”ŸæˆMakefileï¼ˆå…¼å®¹æœ‰æ— æ¨¡æ¿çš„æƒ…å†µï¼‰
          if [ -f "Makefile.template" ]; then
            coq_makefile -f CoqProject -o Makefile -extra Makefile.template
          else
            coq_makefile -f CoqProject -o Makefile
          fi
          
          # æ£€æŸ¥å…¨å±€éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨
          if ! grep -q "${{ env.GLOBAL_TARGET }}" Makefile; then
            echo "âŒ Makefileä¸­æœªå®šä¹‰å…¨å±€éªŒè¯ç›®æ ‡ '${{ env.GLOBAL_TARGET }}'"
            exit 1
          fi
          echo "âœ… Makefileç”Ÿæˆå®Œæˆï¼ŒéªŒè¯ç›®æ ‡å°±ç»ª"

      - name: æ‰§è¡Œå…¨å±€å½¢å¼åŒ–éªŒè¯ï¼ˆå¹¶è¡Œç¼–è¯‘ï¼‰
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p ${{ env.REPORT_DIR }}
          
          echo "=== ğŸ¯ å¼€å§‹å…¨å±€å½¢å¼åŒ–éªŒè¯ï¼ˆ$(nproc)æ ¸å¹¶è¡Œç¼–è¯‘ï¼‰ ==="
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/global-compile.log
          
          # éªŒè¯ç¼–è¯‘å®Œæ•´æ€§ï¼ˆæ£€æŸ¥æ‰€æœ‰.væ–‡ä»¶æ˜¯å¦ç”Ÿæˆ.voï¼‰
          echo "=== ğŸ“ éªŒè¯ç¼–è¯‘äº§ç‰©å®Œæ•´æ€§ ==="
          failed_files=()
          while IFS= read -r v_file; do
            vo_file="${v_file%.v}.vo"
            if [ ! -f "$vo_file" ]; then
              failed_files+=("$vo_file")
            fi
          done < <(grep -E '^[^#].*\.v$' CoqProject)
          
          if [ ${#failed_files[@]} -ne 0 ]; then
            echo "âŒ ä»¥ä¸‹æ–‡ä»¶éªŒè¯å¤±è´¥ï¼ˆæœªç”Ÿæˆ.voäº§ç‰©ï¼‰ï¼š"
            printf '%s\n' "${failed_files[@]}"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¼–è¯‘éªŒè¯å®Œæˆï¼Œæ— ç¼ºå¤±äº§ç‰©"

      - name: å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒï¼ˆcoqchkï¼‰
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          echo "=== ğŸ§ æ‰§è¡Œå…¨å±€é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥ ==="
          coqchk -silent -norecursive $(find theories/ lib/ extensions/ -name "*.vo") 2>&1 | tee ${{ env.REPORT_DIR }}/global-coqchk.log
          
          # æ£€æŸ¥coqchké€€å‡ºç ï¼Œ0ä¸ºæ­£å¸¸
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼Œå­˜åœ¨é€»è¾‘çŸ›ç›¾æˆ–ä¾èµ–ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… å…¨å±€é€»è¾‘ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡ï¼Œæ— é€»è¾‘é”™è¯¯"

      - name: ç”Ÿæˆç»“æ„åŒ–éªŒè¯æŠ¥å‘Š
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          
          # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md <<EOF
          # FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯æŠ¥å‘Šï¼ˆæœ€ç»ˆç‰ˆï¼‰
          
          ## ğŸ”§ éªŒè¯ç¯å¢ƒä¿¡æ¯
          - éªŒè¯æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - è¿è¡Œå®¹å™¨: coqorg/coq:${{ env.COQ_VERSION }}
          - Coqç‰ˆæœ¬: $(coqc --version | head -n1)
          - MathCompç‰ˆæœ¬: ${{ env.MATHCOMP_VERSION }}
          - ç¼–è¯‘æ ¸å¿ƒæ•°: $(nproc)
          
          ## ğŸ“Š éªŒè¯èŒƒå›´ç»Ÿè®¡
          - æ€»å¾…éªŒè¯æ–‡ä»¶æ•°: $(grep -E '^[^#].*\.v$' CoqProject | wc -l)
          - æˆåŠŸéªŒè¯æ–‡ä»¶æ•°: $(find theories/ lib/ extensions/ -name "*.vo" | wc -l)
          - é€»è¾‘ä¸€è‡´æ€§: âœ… æ ¡éªŒé€šè¿‡
          
          ## ğŸ¯ æ ¸å¿ƒæ¨¡å—éªŒè¯çŠ¶æ€
          EOF
          
          # å…³é”®æ¨¡å—çŠ¶æ€æ£€æŸ¥
          core_modules=(
            "theories/FRF_MetaTheory.vo"
            "theories/Equivalence.vo"
            "lib/Algebra.vo"
            "extensions/Quantum/QFT_FRF.vo"
          )
          for mod in "${core_modules[@]}"; do
            if [ -f "$mod" ]; then
              echo "- âœ… æ ¸å¿ƒæ¨¡å—: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            else
              echo "- âŒ æ ¸å¿ƒæ¨¡å—ç¼ºå¤±: $mod" >> ${{ env.REPORT_DIR }}/SUMMARY.md
            fi
          done
          
          # é™„åŠ æ—¥å¿—é“¾æ¥
          echo -e "\n## ğŸ“‹ è¯¦ç»†æ—¥å¿—" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [ç¼–è¯‘æ—¥å¿—](global-compile.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "- [é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥æ—¥å¿—](global-coqchk.log)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          
          echo "âœ… ç»“æ„åŒ–éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: å½’æ¡£éªŒè¯äº§ç‰©ä¸æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            **/*.vo
            **/*.glob
            Makefile
            CoqProject
            global-compile.log
            global-coqchk.log
          retention-days: 90  # å»¶é•¿å½’æ¡£ä¿ç•™æ—¶é—´ï¼Œä¾¿äºåç»­è¿½æº¯

      - name: éªŒè¯å¤±è´¥ç´§æ€¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ FRF 2.0 å…¨å±€å½¢å¼åŒ–éªŒè¯å¤±è´¥"
          echo "ğŸ“Œ å¤±è´¥åŸå› ï¼šè¯·æŸ¥çœ‹ã€Œå½’æ¡£äº§ç‰©ã€ä¸­çš„ç¼–è¯‘æ—¥å¿—å’Œä¸€è‡´æ€§æ£€æŸ¥æ—¥å¿—"
          echo "ğŸ“Œ å…³é”®æ’æŸ¥ç‚¹ï¼š1. ä¾èµ–å®‰è£…æ˜¯å¦å®Œæ•´ 2. å•ä¸ª.væ–‡ä»¶ç¼–è¯‘é”™è¯¯ 3. é€»è¾‘ä¸€è‡´æ€§å†²çª"