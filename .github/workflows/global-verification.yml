name: FRF 2.0 å…¨é‡å¹¶è¡Œç¼–è¯‘éªŒè¯

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      compile_mode:
        description: 'ç¼–è¯‘æ¨¡å¼'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - quick
        - test-only
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: false
        default: '4'

jobs:
  setup-environment:
    name: ğŸ“¦ ç¯å¢ƒé…ç½®
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    outputs:
      coq_version: ${{ steps.coq-version.outputs.version }}
      opam_root: ${{ steps.opam-env.outputs.opam_root }}
      opam_switch: ${{ steps.opam-env.outputs.opam_switch }}
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        echo "ç³»ç»Ÿ: $(uname -a)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        echo "å†…å­˜: $(free -m | awk '/^Mem:/{printf "%.0f MBå¯ç”¨", $7}')"
        echo "ç£ç›˜: $(df -h . | tail -1 | awk '{print $4 "å¯ç”¨"}')"
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          opam \
          bubblewrap \
          g++ \
          pkg-config \
          m4 \
          rsync \
          git \
          wget \
          bc \
          graphviz \
          python3-pip
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ”„ åˆå§‹åŒ–OPAMç¯å¢ƒ
      id: opam-init
      timeout-minutes: 15
      run: |
        echo "åˆå§‹åŒ–OPAMç¯å¢ƒ..."
        # ä½¿ç”¨æ— æ²™ç›’æ¨¡å¼ï¼Œé¿å…æƒé™é—®é¢˜
        opam init --disable-sandboxing -y --auto-setup
        echo "OPAMROOT=$(opam config var root)" >> $GITHUB_OUTPUT
        echo "OPAMSWITCH=$(opam switch show)" >> $GITHUB_OUTPUT
        
    - name: ğŸ”§ é…ç½®OPAMä»“åº“
      run: |
        eval $(opam env)
        echo "é…ç½®OPAMä»“åº“..."
        opam repo add coq-released https://coq.inria.fr/opam/released
        opam repo add coq-extra-dev https://coq.inria.fr/opam/extra-dev
        opam update
        echo "âœ… OPAMä»“åº“é…ç½®å®Œæˆ"
        
    - name: ğŸ“š å®‰è£…Coqæ ¸å¿ƒï¼ˆå®½æ¾ç‰ˆæœ¬ï¼‰
      id: coq-install
      timeout-minutes: 30
      run: |
        eval $(opam env)
        echo "å®‰è£…Coqæ ¸å¿ƒ..."
        
        # å°è¯•å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œä½†å…è®¸é™çº§/å‡çº§
        if opam install -y coq.8.18.0; then
          echo "âœ… Coq 8.18.0 å®‰è£…æˆåŠŸ"
          COQ_VERSION="8.18.0"
        else
          echo "âš ï¸  å°è¯•å®‰è£…æœ€æ–°ç¨³å®šç‰ˆCoq"
          opam install -y coq
          COQ_VERSION=$(coqc --version | head -1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' || echo "æœªçŸ¥")
          echo "âœ… Coq $COQ_VERSION å®‰è£…æˆåŠŸ"
        fi
        
        # è®°å½•ç‰ˆæœ¬ä¿¡æ¯
        echo "version=$COQ_VERSION" >> $GITHUB_OUTPUT
        
    - name: ğŸ§® å®‰è£…mathcomp-ssreflect
      timeout-minutes: 20
      run: |
        eval $(opam env)
        echo "å®‰è£…mathcomp-ssreflect..."
        
        # å°è¯•å®‰è£…æŒ‡å®šç‰ˆæœ¬
        if opam install -y coq-mathcomp-ssreflect.1.17.0; then
          echo "âœ… mathcomp-ssreflect 1.17.0 å®‰è£…æˆåŠŸ"
        else
          echo "âš ï¸  å°è¯•å®‰è£…å…¶ä»–ç‰ˆæœ¬çš„mathcomp"
          opam install -y coq-mathcomp-ssreflect
          echo "âœ… mathcomp-ssreflect å®‰è£…æˆåŠŸ"
        fi
        
        # å®‰è£…å…¶ä»–å¯èƒ½éœ€è¦çš„æ•°å­¦åº“
        opam install -y coq-mathcomp-algebra || true
        opam install -y coq-mathcomp-fingroup || true
        opam install -y coq-mathcomp-solvable || true
        
    - name: ğŸ“Š ç¯å¢ƒéªŒè¯
      id: coq-version
      run: |
        eval $(opam env)
        echo "=== ç¯å¢ƒéªŒè¯ ==="
        echo "Coqç‰ˆæœ¬:"
        coqc --version 2>/dev/null || echo "æœªæ‰¾åˆ°coqc"
        echo ""
        echo "å·²å®‰è£…çš„CoqåŒ…:"
        opam list --installed --short | grep -E "^coq" | sort || echo "æ— "
        echo ""
        echo "OPAMç¯å¢ƒ:"
        echo "OPAMROOT: $OPAMROOT"
        echo "OPAMSWITCH: $OPAMSWITCH"
        
        # æå–ç‰ˆæœ¬å·
        VERSION=$(coqc --version 2>/dev/null | grep -o 'version [0-9.]\+' | cut -d' ' -f2 || echo "unknown")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¦ ç¼“å­˜OPAMåŒ…
      uses: actions/cache@v3
      with:
        path: ~/.opam
        key: opam-${{ runner.os }}-${{ hashFiles('Makefile') }}
        restore-keys: |
          opam-${{ runner.os }}-
          
  parallel-compilation:
    name: ğŸ”§ å¹¶è¡Œç¼–è¯‘éªŒè¯
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    needs: setup-environment
    strategy:
      matrix:
        compile_stage:
          - core-base
          - core-frf
          - core-scenes
          - extensions
          - integrations
          - tests
        parallel_jobs: [4]
      fail-fast: false  # å…è®¸éƒ¨åˆ†å¤±è´¥ç»§ç»­å…¶ä»–ç¼–è¯‘
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ æ¢å¤OPAMç¯å¢ƒ
      uses: actions/cache@v3
      with:
        path: ~/.opam
        key: opam-${{ runner.os }}-${{ hashFiles('Makefile') }}
        
    - name: âš™ï¸ è®¾ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "PARALLEL_JOBS=${{ matrix.parallel_jobs }}" >> $GITHUB_ENV
        echo "COMPILE_STAGE=${{ matrix.compile_stage }}" >> $GITHUB_ENV
        
    - name: ğŸ“Š ç¼–è¯‘å‰æ£€æŸ¥
      run: |
        eval $(opam env)
        echo "=== ç¼–è¯‘é˜¶æ®µ: $COMPILE_STAGE ==="
        echo "å¹¶è¡Œä»»åŠ¡æ•°: $PARALLEL_JOBS"
        echo "Coqç‰ˆæœ¬:"
        coqc --version 2>/dev/null || echo "æœªæ‰¾åˆ°coqc"
        echo ""
        echo "é¡¹ç›®ç»“æ„:"
        find . -name "*.v" -type f | head -20 | sort
        echo "..."
        
    - name: ğŸ”§ æ‰§è¡Œç¼–è¯‘é˜¶æ®µ
      timeout-minutes: 45
      run: |
        eval $(opam env)
        
        # é€‰æ‹©ç¼–è¯‘æ¨¡å¼
        case "${{ github.event.inputs.compile_mode || 'full' }}" in
          quick)
            echo "å¿«é€ŸéªŒè¯æ¨¡å¼"
            make -j$PARALLEL_JOBS check-env core-base core-frf
            ;;
          test-only)
            echo "ä»…æµ‹è¯•æ¨¡å¼"
            make -j$PARALLEL_JOBS check-env test-only
            ;;
          *)
            echo "å…¨é‡ç¼–è¯‘æ¨¡å¼"
            # æ‰§è¡ŒæŒ‡å®šç¼–è¯‘é˜¶æ®µ
            if [ "$COMPILE_STAGE" = "extensions" ]; then
              # extensionsé˜¶æ®µéœ€è¦ä¸²è¡Œç¼–è¯‘
              echo "ä¸²è¡Œç¼–è¯‘æ‰©å±•æ¨¡å—..."
              make -j1 check-env $COMPILE_STAGE
            else
              # å…¶ä»–é˜¶æ®µå¹¶è¡Œç¼–è¯‘
              echo "å¹¶è¡Œç¼–è¯‘é˜¶æ®µ: $COMPILE_STAGE"
              make -j$PARALLEL_JOBS check-env $COMPILE_STAGE
            fi
            ;;
        esac
        
    - name: ğŸ“ˆ ç¼–è¯‘ç»Ÿè®¡
      if: always()
      run: |
        echo "=== ç¼–è¯‘ç»Ÿè®¡: $COMPILE_STAGE ==="
        
        # ç»Ÿè®¡ç¼–è¯‘æ–‡ä»¶
        VO_COUNT=$(find . -name "*.vo" -type f 2>/dev/null | wc -l)
        GLOB_COUNT=$(find . -name "*.glob" -type f 2>/dev/null | wc -l)
        
        echo "ç”Ÿæˆ .vo æ–‡ä»¶: $VO_COUNT"
        echo "ç”Ÿæˆ .glob æ–‡ä»¶: $GLOB_COUNT"
        
        # åˆ—å‡ºæœ¬é˜¶æ®µç”Ÿæˆçš„æ–‡ä»¶
        echo "ç¼–è¯‘è¾“å‡ºæ–‡ä»¶:"
        find . -name "*.vo" -newer /tmp/start_time 2>/dev/null | head -10 || true
        
  full-verification:
    name: âœ… å…¨é‡éªŒè¯æŠ¥å‘Š
    runs-on: ubuntu-22.04
    needs: 
      - setup-environment
      - parallel-compilation
    timeout-minutes: 30
    if: always()  # å³ä½¿éƒ¨åˆ†ç¼–è¯‘å¤±è´¥ä¹Ÿç”ŸæˆæŠ¥å‘Š
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ æ¢å¤OPAMç¯å¢ƒ
      uses: actions/cache@v3
      with:
        path: ~/.opam
        key: opam-${{ runner.os }}-${{ hashFiles('Makefile') }}
        
    - name: ğŸ“Š æ”¶é›†ç¼–è¯‘ç»“æœ
      id: collect-results
      run: |
        eval $(opam env)
        echo "=== æ”¶é›†ç¼–è¯‘ç»“æœ ==="
        
        # å®šä¹‰æ‰€æœ‰æ¨¡å—åŠå…¶è·¯å¾„
        declare -A modules=(
          # å±‚çº§1: åŸºç¡€åº“
          ["Algebra"]="SelfContainedLib/Algebra.vo"
          ["Geometry"]="SelfContainedLib/Geometry.vo"
          ["Category"]="SelfContainedLib/Category.vo"
          
          # å±‚çº§2: FRFå…ƒç†è®º
          ["FRF_MetaTheory"]="theories/FRF_MetaTheory.vo"
          ["ChurchZero"]="theories/ChurchZero.vo"
          ["ChurchNumerals"]="theories/ChurchNumerals.vo"
          
          # å±‚çº§3: æ•°å­¦åœºæ™¯
          ["CaseA_SetTheory"]="theories/CaseA_SetTheory.vo"
          ["CaseB_Algebra"]="theories/CaseB_Algebra.vo"
          ["CaseC_TypeTheory"]="theories/CaseC_TypeTheory.vo"
          ["CaseD_CategoryTheory"]="theories/CaseD_CategoryTheory.vo"
          ["CaseE_QuantumVacuum"]="theories/CaseE_QuantumVacuum.vo"
          
          # å±‚çº§4: æ‰©å±•æ¨¡å—
          ["QFT_FRF"]="Quantum/QFT_FRF.vo"
          ["CurvedSpacetimeQFT"]="Quantum/CurvedSpacetimeQFT.vo"
          ["FRF_CS_Null_Common"]="CS_Null/FRF_CS_Null_Common.vo"
          ["FRF_CS_Null"]="CS_Null/FRF_CS_Null.vo"
          ["CxxNull"]="CS_Null/CxxNull.vo"
          ["PythonNull"]="CS_Null/PythonNull.vo"
          ["JavaNull"]="CS_Null/JavaNull.vo"
          ["MathNull"]="CS_Null/MathNull.vo"
          ["RustNull"]="CS_Null/RustNull.vo"
          
          # å±‚çº§5: é›†æˆæ¨¡å—
          ["FRF_Comparative"]="theories/FRF_Comparative.vo"
          
          # å±‚çº§6: æµ‹è¯•å¥—ä»¶
          ["Test_Basic"]="Test/Test_Basic.vo"
          ["Test_FRF_MetaTheory"]="Test/Test_FRF_MetaTheory.vo"
          ["Test_QuantumVacuum"]="Test/Test_QuantumVacuum.vo"
          ["Test_BlockchainSystem"]="Test/Test_BlockchainSystem.vo"
          ["SelfContainedVerification"]="Test/SelfContainedVerification.vo"
        )
        
        # ç»Ÿè®¡ç»“æœ
        TOTAL_MODULES=${#modules[@]}
        SUCCESS_COUNT=0
        FAILED_MODULES=""
        
        echo "æ£€æŸ¥ç¼–è¯‘æ–‡ä»¶..."
        for module in "${!modules[@]}"; do
          file="${modules[$module]}"
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            if [ "$size" -gt 0 ]; then
              echo "âœ… $module: $size bytes"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âš ï¸  $module: æ–‡ä»¶å¤§å°ä¸º0"
              FAILED_MODULES="$FAILED_MODULES $module(ç©ºæ–‡ä»¶)"
            fi
          else
            echo "âŒ $module: æ–‡ä»¶ç¼ºå¤±"
            FAILED_MODULES="$FAILED_MODULES $module(ç¼ºå¤±)"
          fi
        done
        
        # è®¡ç®—æˆåŠŸç‡
        SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_MODULES))
        
        # è¾“å‡ºç»“æœ
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
        echo "total_modules=$TOTAL_MODULES" >> $GITHUB_OUTPUT
        echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        echo "failed_modules=$FAILED_MODULES" >> $GITHUB_OUTPUT
        
    - name: ğŸ“„ ç”ŸæˆéªŒè¯æŠ¥å‘Š
      run: |
        eval $(opam env)
        echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
        
        mkdir -p verification-reports
        
        # è·å–ç¯å¢ƒä¿¡æ¯
        COQ_VERSION=$(coqc --version 2>/dev/null | head -1 || echo "æœªçŸ¥ç‰ˆæœ¬")
        OPAM_VERSION=$(opam --version 2>/dev/null || echo "æœªçŸ¥ç‰ˆæœ¬")
        CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
        
        # ç”Ÿæˆè¯¦ç»†çš„MarkdownæŠ¥å‘Š
        cat > verification-reports/FRF2_FULL_VERIFICATION.md << EOF
# FRF 2.0 å…¨é‡å¹¶è¡Œç¼–è¯‘éªŒè¯æŠ¥å‘Š

## éªŒè¯æ¦‚è¿°
- **éªŒè¯æ—¶é—´**: $CURRENT_TIME
- **è¿è¡Œç¯å¢ƒ**: GitHub Actions (Ubuntu 22.04)
- **Coqç‰ˆæœ¬**: $COQ_VERSION
- **OPAMç‰ˆæœ¬**: $OPAM_VERSION
- **ç¼–è¯‘æ¨¡å¼**: ${{ github.event.inputs.compile_mode || 'full' }}
- **å¹¶è¡Œä»»åŠ¡æ•°**: ${{ github.event.inputs.parallel_jobs || '4' }}

## ç¼–è¯‘ç»“æœç»Ÿè®¡
- **æ€»æ¨¡å—æ•°**: ${{ steps.collect-results.outputs.total_modules }}
- **æˆåŠŸç¼–è¯‘æ•°**: ${{ steps.collect-results.outputs.success_count }}
- **ç¼–è¯‘æˆåŠŸç‡**: ${{ steps.collect-results.outputs.success_rate }}%

### å„å±‚çº§ç¼–è¯‘ç»“æœ

#### å±‚çº§1: è‡ªåŒ…å«åŸºç¡€åº“ (3ä¸ªæ¨¡å—)
$(check_module "Algebra" "SelfContainedLib/Algebra.vo")
$(check_module "Geometry" "SelfContainedLib/Geometry.vo")
$(check_module "Category" "SelfContainedLib/Category.vo")

#### å±‚çº§2: FRFå…ƒç†è®º (3ä¸ªæ¨¡å—)
$(check_module "FRF_MetaTheory" "theories/FRF_MetaTheory.vo")
$(check_module "ChurchZero" "theories/ChurchZero.vo")
$(check_module "ChurchNumerals" "theories/ChurchNumerals.vo")

#### å±‚çº§3: æ•°å­¦åœºæ™¯ (5ä¸ªæ¨¡å—)
$(check_module "CaseA_SetTheory" "theories/CaseA_SetTheory.vo")
$(check_module "CaseB_Algebra" "theories/CaseB_Algebra.vo")
$(check_module "CaseC_TypeTheory" "theories/CaseC_TypeTheory.vo")
$(check_module "CaseD_CategoryTheory" "theories/CaseD_CategoryTheory.vo")
$(check_module "CaseE_QuantumVacuum" "theories/CaseE_QuantumVacuum.vo")

#### å±‚çº§4: æ‰©å±•æ¨¡å— (10ä¸ªæ¨¡å—)
$(check_module "QFT_FRF" "Quantum/QFT_FRF.vo")
$(check_module "CurvedSpacetimeQFT" "Quantum/CurvedSpacetimeQFT.vo")
$(check_module "FRF_CS_Null_Common" "CS_Null/FRF_CS_Null_Common.vo")
$(check_module "FRF_CS_Null" "CS_Null/FRF_CS_Null.vo")
$(check_module "CxxNull" "CS_Null/CxxNull.vo")
$(check_module "PythonNull" "CS_Null/PythonNull.vo")
$(check_module "JavaNull" "CS_Null/JavaNull.vo")
$(check_module "MathNull" "CS_Null/MathNull.vo")
$(check_module "RustNull" "CS_Null/RustNull.vo")

#### å±‚çº§5: é›†æˆæ¨¡å— (1ä¸ªæ¨¡å—)
$(check_module "FRF_Comparative" "theories/FRF_Comparative.vo")

#### å±‚çº§6: æµ‹è¯•å¥—ä»¶ (5ä¸ªæ¨¡å—)
$(check_module "Test_Basic" "Test/Test_Basic.vo")
$(check_module "Test_FRF_MetaTheory" "Test/Test_FRF_MetaTheory.vo")
$(check_module "Test_QuantumVacuum" "Test/Test_QuantumVacuum.vo")
$(check_module "Test_BlockchainSystem" "Test/Test_BlockchainSystem.vo")
$(check_module "SelfContainedVerification" "Test/SelfContainedVerification.vo")

## å¤±è´¥æ¨¡å—è¯¦æƒ…
$(if [ -n "${{ steps.collect-results.outputs.failed_modules }}" ]; then
  echo "ä»¥ä¸‹æ¨¡å—ç¼–è¯‘å¤±è´¥:"
  echo "${{ steps.collect-results.outputs.failed_modules }}" | tr ' ' '\n'
else
  echo "æ‰€æœ‰æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
fi)

## ç¯å¢ƒä¾èµ–
\`\`\`bash
$(opam list --installed 2>/dev/null | grep -E "coq|mathcomp" || echo "ä¾èµ–ä¿¡æ¯è·å–å¤±è´¥")
\`\`\`

## ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
\`\`\`
$(find . -name "*.vo" -type f 2>/dev/null | sort | head -50)
$(if [ $(find . -name "*.vo" -type f 2>/dev/null | wc -l) -gt 50 ]; then echo "... æ›´å¤šæ–‡ä»¶çœç•¥"; fi)
\`\`\`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: $CURRENT_TIME  
**GitHub Actions Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
EOF
        
        # è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ¨¡å—çŠ¶æ€
        check_module() {
          local module=$1
          local file=$2
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            if [ "$size" -gt 0 ]; then
              echo "- âœ… **$module**: $size bytes"
            else
              echo "- âš ï¸  **$module**: ç©ºæ–‡ä»¶ (0 bytes)"
            fi
          else
            echo "- âŒ **$module**: æ–‡ä»¶ç¼ºå¤±"
          fi
        }
        
        echo "âœ… éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
        
    - name: ğŸ“Š ç”ŸæˆJSONæŠ¥å‘Š
      run: |
        echo "ç”ŸæˆJSONæ ¼å¼æŠ¥å‘Š..."
        
        cat > verification-reports/verification_summary.json << EOF
{
  "project": "FRF2.0",
  "timestamp": "$(date -Iseconds)",
  "github_run_id": "${{ github.run_id }}",
  "repository": "${{ github.repository }}",
  "coq_version": "$(coqc --version 2>/dev/null | head -1 || echo 'unknown')",
  "compile_mode": "${{ github.event.inputs.compile_mode || 'full' }}",
  "parallel_jobs": "${{ github.event.inputs.parallel_jobs || '4' }}",
  "statistics": {
    "total_modules": ${{ steps.collect-results.outputs.total_modules }},
    "successful": ${{ steps.collect-results.outputs.success_count }},
    "failed": $((steps.collect-results.outputs.total_modules - steps.collect-results.outputs.success_count)),
    "success_rate": ${{ steps.collect-results.outputs.success_rate }}
  },
  "failed_modules": [
    $(if [ -n "${{ steps.collect-results.outputs.failed_modules }}" ]; then
      echo "${{ steps.collect-results.outputs.failed_modules }}" | tr ' ' '\n' | grep -v '^$' | sed 's/.*/"&",/' | sed '$ s/,$//'
    else
      echo ""
    fi)
  ]
}
EOF
        
    - name: ğŸ“¤ ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: frf2.0-full-verification-reports
        path: verification-reports/
        retention-days: 30
        
    - name: ğŸ“ˆ å‘å¸ƒéªŒè¯çŠ¶æ€
      if: always()
      run: |
        echo "=== éªŒè¯çŠ¶æ€ ==="
        
        SUCCESS_COUNT=${{ steps.collect-results.outputs.success_count }}
        TOTAL_MODULES=${{ steps.collect-results.outputs.total_modules }}
        SUCCESS_RATE=${{ steps.collect-results.outputs.success_rate }}
        
        if [ "$SUCCESS_COUNT" -eq "$TOTAL_MODULES" ]; then
          echo "ğŸ‰ FRF 2.0 å…¨é‡éªŒè¯å®Œå…¨æˆåŠŸ!"
          echo "âœ… æ‰€æœ‰ $TOTAL_MODULES ä¸ªæ¨¡å—ç¼–è¯‘é€šè¿‡"
          echo "ğŸš€ ç¼–è¯‘æˆåŠŸç‡: 100%"
        elif [ "$SUCCESS_RATE" -ge 80 ]; then
          echo "âœ… FRF 2.0 éªŒè¯åŸºæœ¬æˆåŠŸ"
          echo "ğŸ“Š $SUCCESS_COUNT/$TOTAL_MODULES ä¸ªæ¨¡å—ç¼–è¯‘é€šè¿‡"
          echo "ğŸ“ˆ ç¼–è¯‘æˆåŠŸç‡: $SUCCESS_RATE%"
        else
          echo "âš ï¸  FRF 2.0 éªŒè¯éƒ¨åˆ†å¤±è´¥"
          echo "âš ï¸  $SUCCESS_COUNT/$TOTAL_MODULES ä¸ªæ¨¡å—ç¼–è¯‘é€šè¿‡"
          echo "ğŸ“‰ ç¼–è¯‘æˆåŠŸç‡: $SUCCESS_RATE%"
        fi
        
        # å¦‚æœæœ‰å¤±è´¥æ¨¡å—ï¼Œåˆ—å‡ºè¯¦ç»†ä¿¡æ¯
        if [ -n "${{ steps.collect-results.outputs.failed_modules }}" ]; then
          echo ""
          echo "âŒ å¤±è´¥æ¨¡å—:"
          echo "${{ steps.collect-results.outputs.failed_modules }}" | tr ' ' '\n' | grep -v '^$'
        fi