name: FRF 2.0 全局形式化验证（全量可执行版）
on:
  push:
    branches: [main, dev]
    paths:
      - '**.v'
      - 'CoqProject'
      - 'global-verification.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.v'
      - 'CoqProject'
      - 'global-verification.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COQ_VERSION: '8.19'
  OCAML_VERSION: '4.14-flambda'
  VERIFICATION_REPORT_DIR: verification-reports
  COQPROJECT_PATH: ./CoqProject

jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 初始化 Coq 环境（标准化 Docker 镜像）
        uses: coq-community/docker-coq-action@v1.5.1
        with:
          coq_version: ${{ env.COQ_VERSION }}
          ocaml_version: ${{ env.OCAML_VERSION }}
          opam_file: ${{ env.COQPROJECT_PATH }}
          custom_script: |
            startgroup "创建报告目录"
            mkdir -p ${{ env.VERIFICATION_REPORT_DIR }}
            endgroup

            startgroup "预处理 CoqProject（修复参数格式）"
            if [ ! -f "${{ env.COQPROJECT_PATH }}" ]; then
              echo "错误：未找到 CoqProject 文件，路径：${{ env.COQPROJECT_PATH }}"
              exit 1
            fi
            # 修复 -arg 多选项参数的引号包裹
            sed -i 's/-arg -w \(-notation-overridden[^ ]*\)/-arg "-w \1"/g' ${{ env.COQPROJECT_PATH }}
            # 过滤注释和空行，保留有效配置
            grep -v -E "^#|^$" ${{ env.COQPROJECT_PATH }} > CoqProject.clean
            mv CoqProject.clean ${{ env.COQPROJECT_PATH }}
            echo "预处理后 CoqProject 内容："
            cat ${{ env.COQPROJECT_PATH }}
            endgroup

            startgroup "校验 CoqProject 参数格式"
            if grep -qE "^-arg -w [^\"']" ${{ env.COQPROJECT_PATH }}; then
              echo "错误：-arg 参数未正确用引号包裹多选项，请修正 CoqProject"
              exit 1
            fi
            echo "参数格式校验通过"
            endgroup

            startgroup "提取编译参数和 .v 文件列表"
            # 提取 -Q/-R/-arg 等配置参数
            ARGS=$(grep -E "^-Q|^-R|^-arg" ${{ env.COQPROJECT_PATH }} | tr '\n' ' ')
            # 提取 CoqProject 中声明的 .v 文件
            DECLARED_V_FILES=$(grep -E "\.v$" ${{ env.COQPROJECT_PATH }} | tr '\n' ' ')
            # 补充目录中所有 .v 文件（防止声明遗漏）
            ALL_V_FILES=$(find . -name "*.v" -type f | grep -E "^./(SelfContainedLib|CS_Null|Quantum|DynamicSystem|Toolchain|Test|theories)/" | tr '\n' ' ')
            V_FILES="${DECLARED_V_FILES} ${ALL_V_FILES}"
            echo "最终编译参数：$ARGS"
            echo "最终 .v 文件列表：$V_FILES"
            endgroup

            startgroup "生成 Coq Makefile"
            coq_makefile $ARGS $V_FILES -o Makefile.coq
            if [ $? -ne 0 ]; then
              echo "错误：Makefile 生成失败"
              echo "参数调试：$ARGS"
              echo "文件调试：$V_FILES"
              exit 1
            fi
            mv Makefile.coq Makefile
            echo "Makefile 生成成功，核心目标预览："
            grep -E "^all:|^compile:|^validate:" Makefile
            endgroup

            startgroup "执行全局形式化编译验证"
            # 并行编译（使用最大核心数）
            make -j $(nproc)
            if [ $? -ne 0 ]; then
              echo "错误：全局形式化验证编译失败，查看日志："
              cat ${{ env.VERIFICATION_REPORT_DIR }}/global-compile.log
              exit 1
            fi
            endgroup

            startgroup "生成结构化验证报告"
            # 收集编译日志
            make print-log > ${{ env.VERIFICATION_REPORT_DIR }}/global-compile.log 2>&1
            # 收集已验证模块列表
            find . -name "*.vo" -type f | grep -E "^./(theories|CS_Null|Quantum|DynamicSystem)/" > ${{ env.VERIFICATION_REPORT_DIR }}/verified-modules.txt
            # 统计编译成功率
            TOTAL_V=$(find . -name "*.v" -type f | grep -E "^./(theories|CS_Null|Quantum|DynamicSystem)/" | wc -l)
            TOTAL_VO=$(find . -name "*.vo" -type f | grep -E "^./(theories|CS_Null|Quantum|DynamicSystem)/" | wc -l)
            SUCCESS_RATE=$((TOTAL_VO * 100 / TOTAL_V))
            echo "验证成功率：${SUCCESS_RATE}%" > ${{ env.VERIFICATION_REPORT_DIR }}/summary.txt
            echo "验证报告生成完成"
            endgroup

      - name: 上传验证报告（无论成功/失败均保留）
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-verification-reports-${{ github.sha }}
          path: ${{ env.VERIFICATION_REPORT_DIR }}/
          retention-days: 14

      - name: 清理临时文件
        if: always()
        run: |
          make clean || true
          rm -f CoqProject.clean || true