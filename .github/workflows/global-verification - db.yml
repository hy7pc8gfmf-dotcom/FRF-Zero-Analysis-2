name: FRF 2.0 全局形式化验证
on:
  push:
    branches: [main, dev]
    paths:
      - '**.v'
      - 'CoqProject'
      - 'global-verification.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.v'
      - 'CoqProject'
      - 'global-verification.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COQ_VERSION: '8.19'
  OCAML_VERSION: '4.14-flambda'
  VENV_PATH: /home/runner/work/FRF-Zero-Analysis-2/FRF-Zero-Analysis-2/.venv
  VERIFICATION_REPORT_DIR: verification-reports

jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 初始化 Coq 环境（基于 Docker-Coq-Action）
        uses: coq-community/docker-coq-action@v1.5.1
        with:
          coq_version: ${{ env.COQ_VERSION }}
          ocaml_version: ${{ env.OCAML_VERSION }}
          opam_file: 'CoqProject'
          custom_script: |
            startgroup "激活虚拟环境"
            source ${{ env.VENV_PATH }}/bin/activate
            endgroup

            startgroup "预处理 CoqProject（修复参数格式+保留.v文件）"
            if [ ! -f "CoqProject" ]; then
              echo "错误：未找到 CoqProject 文件"
              exit 1
            fi
            # 修复 -arg 参数格式（多子选项用引号包裹）
            sed -i 's/-arg -w \(-notation-overridden[^ ]*\)/-arg "-w \1"/g' CoqProject
            # 过滤注释和空行，保留所有有效内容（含.v文件和路径配置）
            grep -v -E "^#|^$" CoqProject > CoqProject.clean
            mv CoqProject.clean CoqProject
            echo "预处理后 CoqProject 内容："
            cat CoqProject
            endgroup

            startgroup "校验 CoqProject 参数格式"
            if grep -qE "^-arg -w [^\"']" CoqProject; then
              echo "错误：-arg 参数未用引号包裹多选项，请修正 CoqProject"
              exit 1
            fi
            echo "参数格式校验通过"
            endgroup

            startgroup "提取参数和.v文件列表"
            # 提取 -Q/-arg 等配置参数
            ARGS=$(grep -E "^-Q|^-R|^-arg" CoqProject | tr '\n' ' ')
            # 提取所有 .v 源文件（含子目录）
            V_FILES=$(grep -E "\.v$" CoqProject | tr '\n' ' ')
            # 补充遗漏的子目录.v文件（防止过滤失效）
            V_FILES+=$(find . -name "*.v" -type f | grep -E "^./(SelfContainedLib|CS_Null|Quantum|DynamicSystem|Toolchain|Test|theories)/" | tr '\n' ' ')
            echo "最终参数列表：$ARGS"
            echo "最终 .v 文件列表：$V_FILES"
            endgroup

            startgroup "生成 Coq Makefile"
            coq_makefile $ARGS $V_FILES -o Makefile.coq
            if [ $? -ne 0 ]; then
              echo "错误：Makefile 生成失败"
              echo "参数调试：$ARGS"
              echo "文件调试：$V_FILES"
              exit 1
            fi
            mv Makefile.coq Makefile
            echo "Makefile 生成成功"
            endgroup

            startgroup "执行全局形式化编译验证"
            # 并行编译（使用所有可用核心）
            make -j $(nproc)
            if [ $? -ne 0 ]; then
              echo "错误：全局形式化验证失败"
              exit 1
            fi
            endgroup

            startgroup "生成验证报告"
            mkdir -p ${{ env.VERIFICATION_REPORT_DIR }}
            # 收集编译日志
            make print-log > ${{ env.VERIFICATION_REPORT_DIR }}/global-compile.log 2>&1
            # 收集已验证模块列表
            find . -name "*.vo" -type f | grep -E "^./(theories|CS_Null|Quantum|DynamicSystem)/" > ${{ env.VERIFICATION_REPORT_DIR }}/verified-modules.txt
            echo "验证报告生成完成"
            endgroup

      - name: 上传验证报告（失败时保留）
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: formal-verification-reports
          path: ${{ env.VERIFICATION_REPORT_DIR }}/
          retention-days: 14

      - name: 清理构建产物
        if: always()
        run: |
          make clean
          rm -f CoqProject.clean