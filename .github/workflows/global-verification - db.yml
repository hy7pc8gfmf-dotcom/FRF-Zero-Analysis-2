name: FRF 2.0 全局形式化验证
on:
  push:
    branches: [ main, master, release/final ]
    paths: [ '**.v', 'CoqProject', 'Makefile', 'validate.sh' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 120
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums coq-unimath"
      COQPATH: "${{ github.workspace }}/theories:${{ github.workspace }}/lib:${{ github.workspace }}/extensions"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      OPAM_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/opam-repository/"
      COQ_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/"
      OPAM_FALLBACK_MIRROR: "https://opam.ocaml.org/"
      COQ_FALLBACK_MIRROR: "https://coq.inria.fr/opam/released/"
      VENV_PATH: "${{ github.workspace }}/.venv"
    steps:
      - name: 修复临时目录权限
        run: |
          mkdir -p ${{ env.TEMP_DIR }} ~/.opam ~/.cache/opam
          chmod -R 777 /__w/_temp/ ~/.opam ~/.cache/opam
      - name: 检出代码仓库
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: 修复工作目录权限+初始化opam环境
        run: |
          mkdir -p ${{ github.workspace }}
          chmod -R 777 ${{ github.workspace }}
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)
      - name: 缓存优化
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
            _build
            **/*.vo
            **/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-venv-
      - name: 配置镜像源+安装依赖
        shell: bash -x
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          opam repo list --all-switches
          # 镜像源配置（简化重试）
          if curl --head --silent --fail ${{ env.OPAM_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            opam repository set-url default ${{ env.OPAM_MAIN_MIRROR }} --all-switches || opam repo add default ${{ env.OPAM_MAIN_MIRROR }} --all-switches
          else
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches || opam repo add default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
          fi
          if curl --head --silent --fail ${{ env.COQ_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            opam repo list | grep -q "coq-released" && opam repository set-url coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches || opam repo add coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
          else
            opam repo list | grep -q "coq-released" && opam repository set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches || opam repo add coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
          fi
          # 精简更新重试
          for i in {1..2}; do
            opam update -y && break || sleep 2
          done
          # 依赖安装（减少重试和等待）
          installed_pkgs=$(opam list --short)
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-stdlib=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }}"
            "coq-equations=1.3+8.18"
            ${{ env.COQ_EXTRA_OPAM }}
          )
          to_install=()
          for pkg in "${required_pkgs[@]}"; do
            pkg_name=$(echo "$pkg" | cut -d'=' -f1)
            echo "$installed_pkgs" | grep -q "^$pkg_name$" || to_install+=("$pkg")
          done
          if [ ${#to_install[@]} -gt 0 ]; then
            # 主安装（最多2次重试，间隔2秒）
            for i in {1..2}; do
              opam install -y --jobs 4 "${to_install[@]}" && break || sleep 2
            done
            # 检查未安装包，单独快速重试
            for pkg in "${to_install[@]}"; do
              pkg_name=$(echo "$pkg" | cut -d'=' -f1)
              if ! opam list --short | grep -q "^$pkg_name$"; then
                opam install -y "$pkg" || { echo "包 $pkg 安装失败"; exit 1; }
              fi
            done
          fi
          # 快速验证依赖
          eval $(opam env --switch=default)
          coqc --version | grep -q "${{ env.COQ_VERSION }}" || exit 1
          opam list | grep -q "coq-mathcomp-ssreflect.*${{ env.MATHCOMP_VERSION }}" || exit 1
          # 简化Python环境配置
          apt-get update && apt-get install -y python3-pip python3-venv && rm -rf /var/lib/apt/lists/*
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir reportlab==4.0.9
      - name: 预处理CoqProject文件
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          if [ -f "CoqProject" ]; then
            grep -v -E 'coq=8.19.0|opam install' CoqProject > CoqProject.clean
            mv CoqProject.clean CoqProject
          else
            echo "-R theories FRF" > CoqProject
            echo "-R lib Lib" >> CoqProject
          fi
      - name: 生成全局验证Makefile
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          [ -f "CoqProject" ] || { echo "未找到CoqProject"; exit 1; }
          cat CoqProject
          if [ -f "Makefile.template" ]; then
            coq_makefile -f CoqProject -o Makefile -extra Makefile.template
          else
            coq_makefile -f CoqProject -o Makefile
          fi
          grep -q "${{ env.GLOBAL_TARGET }}" Makefile || echo "${{ env.GLOBAL_TARGET }}: all.v" >> Makefile
      - name: 执行全局形式化验证
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          mkdir -p ${{ env.REPORT_DIR }}
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/global-compile.log
      - name: 全局逻辑一致性校验
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          coqchk -silent -norecursive $(find theories/ -name "*.vo") 2>&1 | tee ${{ env.REPORT_DIR }}/global-coqchk.log
      - name: 生成验证报告
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          source ${{ env.VENV_PATH }}/bin/activate
          cat > ${{ env.REPORT_DIR }}/SUMMARY.md <<EOF
          # 验证报告
          时间: $(date)
          Coq版本: $(coqc --version | head -n1)
          成功文件数: $(find theories/ -name "*.vo" | wc -l)
          EOF
      - name: 归档结果
        uses: actions/upload-artifact@v4
        with:
          name: verification-results
          path: |
            ${{ env.REPORT_DIR }}
            **/*.vo
            Makefile