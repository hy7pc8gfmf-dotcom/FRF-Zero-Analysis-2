name: FRF 2.0 全局形式化验证
on:
  push:
    branches: [main, master, release/final]
    paths: ['**.v', 'CoqProject', 'Makefile', 'validate.sh']
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
jobs:
  global-formal-verification:
    runs-on: ubuntu-latest
    container:
      image: coqorg/coq:8.18.0
      options: --user root
    timeout-minutes: 180
    env:
      MATHCOMP_VERSION: "1.18.0"
      COQ_VERSION: "8.18.0"
      COQ_EXTRA_OPAM: "coq-bignums"
      COQPATH: "${{ github.workspace }}/SelfContainedLib:${{ github.workspace }}/theories:${{ github.workspace }}/CS_Null:${{ github.workspace }}/Quantum:${{ github.workspace }}/DynamicSystem"
      GLOBAL_TARGET: "all"
      REPORT_DIR: "${{ github.workspace }}/verification-reports"
      TEMP_DIR: "/__w/_temp/_runner_file_commands"
      OPAM_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/opam-repository/"
      COQ_MAIN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/coq-opam/released/"
      OPAM_FALLBACK_MIRROR: "https://opam.ocaml.org/"
      COQ_FALLBACK_MIRROR: "https://coq.inria.fr/opam/released/"
      VENV_PATH: "${{ github.workspace }}/.venv"
    steps:
      - name: 修复临时目录权限
        run: |
          mkdir -p ${{ env.TEMP_DIR }} ~/.opam ~/.cache/opam
          chmod -R 777 /__w/_temp/ ~/.opam ~/.cache/opam
      - name: 检出代码仓库
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: 分析项目结构
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== 项目结构分析 ==="
          echo "当前目录: $(pwd)"
          echo "目录内容:"
          ls -la
          echo "理论目录结构:"
          find theories -type f -name "*.v" | head -20
          echo "CoqProject内容:"
          if [ -f "CoqProject" ]; then
            cat CoqProject
          fi
      - name: 修复工作目录权限+初始化opam环境
        run: |
          mkdir -p ${{ github.workspace }}
          chmod -R 777 ${{ github.workspace }}
          opam init --disable-sandboxing -y --no-setup --reinit
          eval $(opam env --switch=default)
      - name: 缓存优化
        uses: actions/cache@v3
        with:
          path: |
            ~/.opam
            ~/.cache/opam
            _build
            **/*.vo
            **/*.glob
            ${{ env.VENV_PATH }}
          key: ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-mathcomp-${{ env.MATHCOMP_VERSION }}-venv-
            ${{ runner.os }}-coq-${{ env.COQ_VERSION }}-venv-
      - name: 配置镜像源+安装依赖
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          opam repo list --all-switches
          if curl --head --silent --fail ${{ env.OPAM_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            opam repository set-url default ${{ env.OPAM_MAIN_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_MAIN_MIRROR }} --all-switches
            }
          else
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches || {
              opam repo remove default --all-switches || true
              opam repo add default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            }
          fi
          if curl --head --silent --fail ${{ env.COQ_MAIN_MIRROR }}index.tar.gz > /dev/null; then
            if opam repo list | grep -q "coq-released"; then
              opam repository set-url coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_MAIN_MIRROR }} --all-switches
            fi
          else
            if opam repo list | grep -q "coq-released"; then
              opam repository set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            else
              opam repo add coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            fi
          fi
          update_success=0
          for i in {1..3}; do
            if opam update -y; then
              update_success=1
              break
            fi
            sleep 2
          done
          if [ $update_success -eq 0 ]; then
            opam repository set-url default ${{ env.OPAM_FALLBACK_MIRROR }} --all-switches
            opam repository set-url coq-released ${{ env.COQ_FALLBACK_MIRROR }} --all-switches
            for i in {1..3}; do
              if opam update -y; then
                update_success=1
                break
              fi
              sleep 2
            done
          fi
          if [ $update_success -eq 0 ]; then
            exit 1
          fi
          installed_pkgs=$(opam list --short)
          required_pkgs=(
            "coq=${{ env.COQ_VERSION }}"
            "coq-stdlib=${{ env.COQ_VERSION }}"
            "coq-mathcomp-ssreflect=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-fingroup=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-algebra=${{ env.MATHCOMP_VERSION }}"
            "coq-mathcomp-solvable=${{ env.MATHCOMP_VERSION }}"
            "coq-equations=1.3+8.18"
            "${{ env.COQ_EXTRA_OPAM }}"
          )
          to_install=()
          for pkg in "${required_pkgs[@]}"; do
            pkg_name=$(echo "$pkg" | cut -d'=' -f1)
            if ! echo "$installed_pkgs" | grep -q "^$pkg_name$"; then
              to_install+=("$pkg")
            fi
          done
          if [ ${#to_install[@]} -gt 0 ]; then
            install_success=0
            for i in {1..3}; do
              if opam install -y --jobs 2 "${to_install[@]}"; then
                install_success=1
                break
              fi
              sleep 5
            done
            if [ $install_success -eq 0 ]; then
              exit 1
            fi
          fi
          eval $(opam env --switch=default)
          apt-get update && apt-get install -y --no-install-recommends python3-pip python3-venv && rm -rf /var/lib/apt/lists/*
          python3 -m venv ${{ env.VENV_PATH }}
          source ${{ env.VENV_PATH }}/bin/activate
          pip install --no-cache-dir --timeout 60 reportlab==4.0.9
          if ! command -v coqc &> /dev/null; then
            exit 1
          fi
          if ! coqc --version | grep -q "${{ env.COQ_VERSION }}"; then
            exit 1
          fi
          if ! opam list | grep -q "coq-mathcomp-ssreflect.*${{ env.MATHCOMP_VERSION }}"; then
            exit 1
          fi
          if ! command -v python &> /dev/null; then
            exit 1
          fi
      - name: 预处理CoqProject文件（保留核心路径绑定）
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          if [ -f "CoqProject" ]; then
            echo "清理CoqProject冗余注释与空行..."
            # 仅过滤注释和空行，保留所有-Q/-R/-arg绑定及.v文件路径
            grep -v -E "^#|^$" CoqProject > CoqProject.clean
            mv CoqProject.clean CoqProject
            echo "CoqProject预处理完成，核心配置如下："
            grep -E "^-Q|^-R|^-arg" CoqProject
            else
            echo "错误：未找到CoqProject文件"
            exit 1
            fi
      - name: 生成全局验证Makefile
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          if [ ! -f "CoqProject" ]; then
            echo "错误：未找到CoqProject文件"
            exit 1
          fi
          echo "开始生成Makefile..."
          echo "使用超强方法生成Makefile..."
          echo "CoqProject文件内容："
          cat CoqProject
          echo "方法1: 直接生成Makefile"
          coq_makefile -f CoqProject -o Makefile
          if [ $? -ne 0 ]; then
            echo "方法1失败，使用方法2: 提取有效参数"
            valid_args=""
            while IFS= read -r line; do
              if [[ $line == -R* ]] || [[ $line == -Q* ]] || [[ $line == -I* ]]; then
                valid_args="$valid_args $line"
              elif [[ $line == *.v ]]; then
                valid_args="$valid_args $line"
              fi
            done < CoqProject
            echo "有效参数: $valid_args"
            coq_makefile $valid_args -o Makefile
          fi
          if [ $? -ne 0 ]; then
            echo "方法2失败，使用方法3: 仅使用核心文件"
            echo "-R theories FRF" > CoqProject.core
            find theories -name "*.v" -maxdepth 2 >> CoqProject.core
            coq_makefile -f CoqProject.core -o Makefile
          fi
          if [ $? -ne 0 ]; then
            echo "方法3失败，直接创建简单Makefile"
            echo 'all:' > Makefile
            echo '	find theories -name "*.v" -exec coqc -q {} \;' >> Makefile
            echo "使用简单Makefile"
          else
            echo "Makefile生成成功"
          fi
      - name: 执行全局形式化验证（按依赖顺序编译）
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          mkdir -p ${{ env.REPORT_DIR }}
          echo "设置Coq路径..."
          export COQPATH="${{ env.COQPATH }}"
          echo "基于优化后的CoqProject生成Makefile..."
          coq_makefile -f CoqProject -o Makefile
          if [ $? -ne 0 ]; then
          echo "Makefile生成失败"
          exit 1
          fi
          echo "按依赖顺序编译（并行核心数：$(nproc)）..."
          make -j$(nproc) ${{ env.GLOBAL_TARGET }} 2>&1 | tee ${{ env.REPORT_DIR }}/compile-all.log
          echo "检查编译产物..."
          # 检查所有核心模块是否生成.vo文件（基础层+核心层关键模块）
          critical_modules=(
          "SelfContainedLib/Algebra.vo"
          "theories/FRF_MetaTheory.vo"
          "theories/CaseB_Algebra.vo"
          "CS_Null/FRF_CS_Null.vo"
          "Quantum/QFT_FRF.vo"
          )
          for mod in "${critical_modules[@]}"; do
            if [ ! -f "$mod" ]; then
              echo "错误：核心模块 $mod 未编译成功"
              exit 1
            fi
          done
          total_compiled=$(find . -name "*.vo" | wc -l)
          total_v=$(find . -name "*.v" | grep -v "test" | grep -v "mock" | wc -l)
          echo "总待验证.v文件数: $total_v"
          echo "成功编译.vo文件数: $total_compiled"
          echo "编译验证完成"
      - name: 全局逻辑一致性校验（核心模块全量校验）
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          echo "开始逻辑一致性检查..."
          # 收集所有核心模块的.vo文件（排除测试模块）
          find . -name "*.vo" -not -path "./Test/*" > vo_files.list
          if [ ! -s vo_files.list ]; then
            echo "未找到任何.vo文件，跳过逻辑一致性检查"
            exit 1
          fi
          echo "全量校验核心模块一致性（共 $(wc -l < vo_files.list) 个模块）..."
          coqchk -silent -R . FRF $(cat vo_files.list) 2>&1 | tee -a ${{ env.REPORT_DIR }}/global-coqchk.log
          # 检查coqchk退出码（0=无冲突，非0=存在逻辑冲突）
          if [ $? -ne 0 ]; then
            echo "错误：核心模块存在逻辑一致性冲突"
            cat ${{ env.REPORT_DIR }}/global-coqchk.log
            exit 1
          fi
          echo "逻辑一致性检查通过"
      - name: 生成结构化验证报告
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          eval $(opam env --switch=default)
          source ${{ env.VENV_PATH }}/bin/activate
          total_files=$(find theories -name "*.v" | wc -l)
          success_files=$(find theories -name "*.vo" | wc -l)
          echo "# FRF 2.0 全局形式化验证报告" > ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "验证时间: $(date +'%Y-%m-%d %H:%M:%S')" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "触发事件: ${{ github.event_name }}" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "提交哈希: ${{ github.sha }}" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "运行容器: coqorg/coq:${{ env.COQ_VERSION }}" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "Coq版本: $(coqc --version | head -n1)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "MathComp版本: ${{ env.MATHCOMP_VERSION }}" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "编译核心数: $(nproc)" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "总待验证文件数: $total_files" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "成功验证文件数: $success_files" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          if [ $total_files -gt 0 ]; then
            echo "验证成功率: $((success_files * 100 / total_files))%" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          fi
          echo "已验证的核心模块:" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          find theories -name "*.vo" | head -10 | while read vo_file; do
            echo "- $vo_file" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          done
          echo "详细日志" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          echo "编译日志: compile-all.log" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          if [ -f "${{ env.REPORT_DIR }}/makefile-compile.log" ]; then
            echo "Makefile编译日志: makefile-compile.log" >> ${{ env.REPORT_DIR }}/SUMMARY.md
          fi
          echo "逻辑一致性检查日志: global-coqchk.log" >> ${{ env.REPORT_DIR }}/SUMMARY.md
      - name: 归档验证产物与报告
        uses: actions/upload-artifact@v4
        with:
          name: frf-2.0-verification-results-${{ github.sha }}
          path: |
            ${{ env.REPORT_DIR }}/**/*
            **/*.vo
            **/*.glob
            Makefile
            CoqProject
            CoqProject.core
            all_coq_files.txt
            vo_files.list
            ${{ env.VENV_PATH }}/lib/python*/site-packages/*.dist-info
          retention-days: 90
      - name: 验证成功通知
        if: success()
        run: echo "FRF 2.0 全局形式化验证成功完成"
      - name: 验证失败紧急通知
        if: failure()
        run: echo "FRF 2.0 全局形式化验证失败"